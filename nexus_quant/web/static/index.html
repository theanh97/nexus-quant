<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NEXUS ‚Äî Autonomous Quant Workforce</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#F8FAFC;--surface:#FFFFFF;--surface2:#F1F5F9;--border:#E2E8F0;
  --accent:#2563EB;--accent-hover:#1D4ED8;--accent-light:#EFF6FF;
  --green:#16A34A;--green-light:#F0FDF4;--red:#DC2626;--red-light:#FEF2F2;
  --yellow:#D97706;--yellow-light:#FFFBEB;--purple:#7C3AED;--purple-light:#F5F3FF;
  --fg:#0F172A;--fg-muted:#64748B;--fg-light:#94A3B8;
  --shadow:0 1px 3px rgba(0,0,0,.07);--shadow-md:0 4px 12px rgba(0,0,0,.08);
  --r:8px;--r-sm:4px;
  --s1:4px;--s2:8px;--s3:12px;--s4:16px;--s5:20px;
}
:root[data-theme="dark"]{
  --bg:#0B1220;--surface:#111A2D;--surface2:#17243A;--border:#263247;
  --accent:#60A5FA;--accent-hover:#3B82F6;--accent-light:rgba(96,165,250,.18);
  --green:#4ADE80;--green-light:rgba(74,222,128,.17);--red:#F87171;--red-light:rgba(248,113,113,.16);
  --yellow:#FBBF24;--yellow-light:rgba(251,191,36,.15);--purple:#A78BFA;--purple-light:rgba(167,139,250,.16);
  --fg:#E5E7EB;--fg-muted:#94A3B8;--fg-light:#64748B;
  --shadow:0 1px 2px rgba(0,0,0,.38);--shadow-md:0 10px 24px rgba(0,0,0,.35);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--fg);font-size:14px;line-height:1.5;min-height:100vh}

/* Header */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:16px;height:54px;position:sticky;top:0;z-index:200;box-shadow:var(--shadow)}
.logo{font-size:17px;font-weight:700;background:linear-gradient(135deg,#2563EB,#7C3AED);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.5px}
.logo-sub{font-size:11px;color:var(--fg-muted);font-weight:400;margin-left:4px;-webkit-text-fill-color:var(--fg-muted)}
.hdr-mini{display:flex;align-items:center;gap:6px;overflow-x:auto}
.hdr-chip{font-size:10px;font-weight:600;padding:2px 9px;border:1px solid var(--border);border-radius:999px;background:var(--surface2);white-space:nowrap;transition:all .2s}
.hdr-chip.pos{color:var(--green);border-color:var(--green)}
.hdr-chip.neg{color:var(--red);border-color:var(--red)}
.hdr-chip.neu{color:var(--yellow);border-color:var(--yellow)}
.hdr-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
.hdr-live{display:inline-flex;align-items:center;gap:7px;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface2);color:var(--fg-muted)}
.live-heart{width:8px;height:8px;border-radius:50%;background:var(--yellow);box-shadow:0 0 0 rgba(37,99,235,.2)}
.hdr-live.connected .live-heart{background:var(--green);animation:heartbeat 1.7s infinite}
.hdr-live.connecting .live-heart,.hdr-live.stale .live-heart{background:var(--yellow)}
.hdr-live.disconnected .live-heart{background:var(--red)}
@keyframes heartbeat{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(22,163,74,.4)}70%{transform:scale(1.1);box-shadow:0 0 0 8px rgba(22,163,74,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(22,163,74,0)}}

/* Tab bar */
.tabs{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;display:flex;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{padding:10px 14px;cursor:pointer;font-size:13px;font-weight:500;color:var(--fg-muted);border-bottom:2px solid transparent;white-space:nowrap;display:flex;align-items:center;gap:5px;transition:color .15s;flex-shrink:0}
.tab:hover{color:var(--fg)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* KPI strip */
.kpi-strip{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 24px;display:flex;gap:28px;overflow-x:auto;align-items:center}
.kpi{display:flex;flex-direction:column;min-width:70px}
.kpi-l{font-size:10px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.06em}
.kpi-v{font-size:17px;font-weight:700;transition:all .25s ease}
.kpi-v.bump{animation:kpi-bump .35s ease}
.kpi-v.pos{color:var(--green)}.kpi-v.neg{color:var(--red)}.kpi-v.neu{color:var(--yellow)}.kpi-v.acc{color:var(--accent)}
@keyframes kpi-bump{0%{transform:translateY(2px);opacity:.7}100%{transform:translateY(0);opacity:1}}
.progress-pill{display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:var(--surface2);font-size:11px;color:var(--fg-muted)}
.progress-pill .progress-track{width:76px;height:4px;border-radius:999px;background:var(--border);overflow:hidden}
.progress-pill .progress-fill{width:38%;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--green));animation:prog 1.2s linear infinite}
.progress-pill.idle .progress-fill{display:none}
@keyframes prog{0%{transform:translateX(-55%)}100%{transform:translateX(210%)}}

/* Pages */
.page{display:none;padding:22px 24px;max-width:1440px;margin:0 auto}
.page.active{display:block}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow);transition:transform .2s ease,border-color .2s ease,box-shadow .2s ease}
.card:hover{border-color:color-mix(in oklab,var(--border) 60%,var(--accent));box-shadow:var(--shadow-md)}
.ctitle{font-size:12px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.section-stamp{margin-left:auto;font-size:10px;font-weight:500;color:var(--fg-light);text-transform:none;letter-spacing:0}
.card.expandable{position:relative}
.card-expand-btn{border:1px solid var(--border);background:var(--surface);color:var(--fg-muted);border-radius:6px;padding:2px 7px;font-size:11px;cursor:pointer}
.card-expand-btn:hover{border-color:var(--accent);color:var(--accent)}
.card.expanded{grid-column:1 / -1!important;border-color:var(--accent)}

/* Table tools */
.table-tools{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.table-search{min-width:180px;max-width:300px;font-size:12px;padding:6px 9px}
.table-meta{font-size:11px;color:var(--fg-muted)}
th.sortable{cursor:pointer;user-select:none}
th.sortable::after{content:" ‚Üï";font-size:10px;color:var(--fg-light)}
th.sort-asc::after{content:" ‚Üë";color:var(--accent)}
th.sort-desc::after{content:" ‚Üì";color:var(--accent)}

/* Skeleton */
.skel{position:relative;overflow:hidden;background:var(--surface2);border-radius:6px}
.skel::after{content:"";position:absolute;top:0;left:-120px;width:90px;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.28),transparent);animation:shimmer 1.35s infinite}
.skel-row{height:14px;margin-bottom:8px}
.skel-row:last-child{margin-bottom:0}
@keyframes shimmer{to{left:calc(100% + 120px)}}

/* Grid */
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:1100px){.g3{grid-template-columns:repeat(2,1fr)}.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.g3,.g2,.g4{grid-template-columns:1fr}}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:1px solid transparent;font-family:inherit;transition:all .15s}
.btn-p{background:var(--accent);color:#fff;border-color:var(--accent)}.btn-p:hover{background:var(--accent-hover)}
.btn-s{background:var(--surface);color:var(--fg);border-color:var(--border)}.btn-s:hover{background:var(--surface2)}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-danger{background:var(--red);color:#fff;border-color:var(--red)}

/* Badges */
.bdg{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600}
.bg-g{background:var(--green-light);color:var(--green)}
.bg-r{background:var(--red-light);color:var(--red)}
.bg-y{background:var(--yellow-light);color:var(--yellow)}
.bg-b{background:var(--accent-light);color:var(--accent)}
.bg-p{background:var(--purple-light);color:var(--purple)}
.bg-gray{background:var(--surface2);color:var(--fg-muted)}

/* Table */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em;padding:7px 12px;border-bottom:2px solid var(--border)}
td{padding:9px 12px;border-bottom:1px solid var(--border);font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--surface2)}

/* Pitch step flow */
.pitch-step{min-width:130px;max-width:160px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:14px 12px;text-align:center;flex-shrink:0}
.pitch-step-icon{font-size:1.6rem;margin-bottom:4px}
.pitch-step-num{font-size:10px;font-weight:700;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.08em}
.pitch-step-title{font-size:12px;font-weight:700;color:var(--fg);margin:4px 0}
.pitch-step-desc{font-size:11px;color:var(--fg-muted);line-height:1.4}
.pitch-arrow{display:flex;align-items:center;font-size:20px;color:var(--accent);padding:0 6px;flex-shrink:0}
/* Verification badges */
.vbadge{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;margin-bottom:8px;font-size:13px}
.vbadge.pass{background:#F0FDF4;border:1px solid #86EFAC}
.vbadge.fail{background:#FFF5F5;border:1px solid #FCA5A5}
.vbadge.warn{background:#FFFBEB;border:1px solid #FCD34D}
/* Stat rows */
.srow{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:13px}
.srow:last-child{border-bottom:none}
.srow .lbl{color:var(--fg-muted)}.srow .val{font-weight:500}
/* Console */
.console-wrap{display:grid;grid-template-columns:280px 1fr;gap:14px;height:calc(100vh - 200px);min-height:500px}
@media(max-width:900px){.console-wrap{grid-template-columns:1fr}}
.proc-list{display:flex;flex-direction:column;gap:6px}
.proc-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--surface);font-size:12px}
.proc-item.running{border-color:var(--green)}
.proc-item.stopped{border-color:var(--border);opacity:.7}
.proc-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.proc-status.running{background:var(--green);animation:pulse 2s infinite}
.proc-status.stopped{background:var(--border)}
.ctrl-btn-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.ctrl-btn{padding:5px 11px;border:1px solid var(--border);border-radius:6px;background:var(--surface);font-size:12px;cursor:pointer;transition:all .2s}
.ctrl-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.ctrl-btn.danger:hover{background:#EF4444;border-color:#EF4444;color:#fff}
.log-viewer{display:flex;flex-direction:column;height:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.log-tabs{display:flex;gap:0;border-bottom:1px solid var(--border)}
.log-tab{padding:7px 14px;font-size:12px;cursor:pointer;border-bottom:2px solid transparent;color:var(--fg-muted)}
.log-tab.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:600}
.log-body{flex:1;overflow-y:auto;padding:10px 12px;font-size:11px;font-family:monospace;line-height:1.5;background:#1E2030;color:#C5C8C6}
.log-body .lg-info{color:#7EC8E3}
.log-body .lg-warn{color:#F9C74F}
.log-body .lg-err{color:#FF6B6B}
.log-body .lg-ok{color:#90EE90}
.phase-timeline{display:flex;flex-direction:column;gap:4px}
.phase-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px}
.phase-item.done{background:var(--green-light)}
.phase-item.curr{background:var(--accent-light)}
.phase-num{font-weight:700;font-size:11px;min-width:36px;color:var(--accent)}
.year-bar-wrap{display:flex;align-items:flex-end;gap:8px;height:120px;padding:8px 0}
.year-bar-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px}
.year-bar{width:100%;border-radius:4px 4px 0 0;transition:height .4s ease;min-height:4px;cursor:pointer}
.year-bar.pos{background:linear-gradient(180deg,var(--green),#86efac)}
.year-bar.neg{background:linear-gradient(180deg,#FF6B6B,#fca5a5)}
.year-bar.is{background:linear-gradient(180deg,var(--yellow),#fde68a);opacity:.6}
.year-bar-lbl{font-size:10px;color:var(--fg-muted);text-align:center}
.year-bar-val{font-size:11px;font-weight:700;text-align:center}
.bias-card{border-left:4px solid #EF4444}
.bias-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px}
.bias-row:last-child{border-bottom:none}
.bias-type{color:var(--fg-muted)}
.bias-verdict.pass{color:var(--green);font-weight:600}
.bias-verdict.warn{color:var(--yellow);font-weight:600}
.bias-verdict.fail{color:#EF4444;font-weight:600}
.sys-meter{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px}
.sys-bar{flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden}
.sys-fill{height:100%;border-radius:4px;transition:width .5s}
.sys-fill.ok{background:var(--green)}
.sys-fill.warn{background:var(--yellow)}
.sys-fill.crit{background:#EF4444}
/* Debate */
.debate-wrap{border:2px solid #6366f1;border-radius:10px;overflow:hidden;margin:4px 0}
.debate-header{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff;padding:8px 12px;font-size:12px;font-weight:600}
.debate-round{padding:0 12px;border-bottom:1px solid var(--border)}
.debate-round-title{font-size:11px;font-weight:700;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.04em;padding:6px 0 2px}
.debate-contrib{padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.debate-contrib:last-child{border-bottom:none}
.debate-model-tag{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:700;margin-bottom:3px}
.tag-glm{background:#e0f2fe;color:#0369a1}
.tag-claude{background:#f3e8ff;color:#7c3aed}
.tag-codex{background:#dcfce7;color:#166534}
.tag-minimax{background:#fff7ed;color:#c2410c}
.tag-synthesis{background:#1e1b4b;color:#e0e7ff}
.debate-synthesis{padding:10px 12px;background:linear-gradient(135deg,#1e1b4b,#312e81);color:#e0e7ff;font-size:12px;line-height:1.6}
.debate-actions{padding:8px 12px;background:#f8fafc;font-size:12px}
.debate-action-item{padding:3px 0;color:var(--accent);font-weight:500}
.debate-confidence{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-top:6px}
.debate-btn-active{background:linear-gradient(90deg,#6366f1,#8b5cf6)!important;color:#fff!important;border-color:#6366f1!important}

/* Chat */
.chat-wrap{display:grid;grid-template-columns:1fr 280px;gap:14px;height:calc(100vh - 200px);min-height:560px}
@media(max-width:900px){.chat-wrap{grid-template-columns:1fr}}
.chat-box{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:var(--r);background:var(--surface);overflow:hidden}
.chat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.chat-header-left{display:flex;align-items:center;gap:8px;font-weight:600;font-size:14px}
.chat-header-right{display:flex;align-items:center;gap:6px}
.model-badge{font-size:10px;padding:2px 7px;border-radius:10px;background:var(--accent-light);color:var(--accent);font-weight:600;letter-spacing:.03em}
.sse-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0}
.sse-dot.yellow{background:var(--yellow)}
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;min-height:0}
.cmsg{display:flex;flex-direction:column}.cmsg.u{align-self:flex-end;max-width:75%}.cmsg.a{align-self:flex-start;max-width:90%}
.cbubble{padding:10px 14px;border-radius:12px;font-size:13.5px;line-height:1.6;word-break:break-word;position:relative}
.cmsg.u .cbubble{background:var(--accent);color:#fff;border-bottom-right-radius:3px}
.cmsg.a .cbubble{background:var(--surface);color:var(--fg);border-bottom-left-radius:3px;border:1px solid var(--border);border-left:3px solid var(--accent)}
.cbubble p{margin:0 0 6px}.cbubble p:last-child{margin-bottom:0}
.cbubble h1,.cbubble h2,.cbubble h3{font-size:14px;font-weight:700;margin:8px 0 4px;color:var(--fg)}
.cbubble ul,.cbubble ol{margin:4px 0 4px 18px;padding:0}
.cbubble li{margin:2px 0}
.cbubble code{background:rgba(0,0,0,.07);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:12.5px}
.cbubble pre{background:#1e1e2e;color:#cdd6f4;border-radius:8px;padding:10px 12px;margin:6px 0;overflow-x:auto}
.cbubble pre code{background:none;padding:0;font-size:12px;color:inherit}
.cbubble table{border-collapse:collapse;font-size:12px;margin:6px 0;width:100%}
.cbubble th{background:var(--surface2);padding:4px 8px;text-align:left;border:1px solid var(--border)}
.cbubble td{padding:3px 8px;border:1px solid var(--border)}
.cbubble strong{font-weight:700}.cbubble em{font-style:italic}
.cmsg-footer{display:flex;align-items:center;gap:6px;margin-top:3px}
.cts{font-size:10px;color:var(--fg-light);opacity:0}
.cmsg:hover .cts{opacity:1}
.copy-btn{font-size:10px;color:var(--fg-light);cursor:pointer;padding:1px 5px;border-radius:4px;border:1px solid transparent;background:none;opacity:0;transition:all .15s}
.cmsg:hover .copy-btn{opacity:1}.copy-btn:hover{border-color:var(--border);background:var(--surface2)}
.chat-in-bar{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--surface);flex-shrink:0;align-items:flex-end}
.chat-ta{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;font-family:inherit;resize:none;outline:none;min-height:40px;max-height:150px;overflow-y:auto;line-height:1.5;transition:border-color .15s}
.chat-ta:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.chips{display:flex;flex-wrap:wrap;gap:5px;padding:8px 10px;border-bottom:1px solid var(--border);background:var(--surface2);flex-shrink:0}
.chip{padding:4px 11px;border:1px solid var(--border);border-radius:20px;font-size:11.5px;cursor:pointer;background:var(--surface);color:var(--fg);transition:all .15s;white-space:nowrap}
.chip:hover{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}
.brain-panel{display:flex;flex-direction:column;gap:10px;overflow-y:auto;max-height:calc(100vh - 200px)}
.brain-card{border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;background:var(--surface);flex-shrink:0}
.brain-card h4{font-size:11px;font-weight:600;color:var(--fg-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em;display:flex;align-items:center;gap:5px}
.live-metrics-card{border:1px solid var(--accent);border-radius:var(--r);padding:12px 14px;background:linear-gradient(135deg,var(--surface),var(--accent-light));flex-shrink:0}
.live-metrics-card h4{font-size:11px;font-weight:600;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em}
.lm-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.lm-cell{text-align:center;padding:6px;background:rgba(255,255,255,.5);border-radius:6px}
.lm-val{font-size:16px;font-weight:700;color:var(--fg)}.lm-lbl{font-size:9px;color:var(--fg-muted);text-transform:uppercase;margin-top:1px}
.is-badge{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:600;margin-left:3px}
.is-badge.is{background:#DBEAFE;color:#1D4ED8}.is-badge.oos{background:#D1FAE5;color:#065F46}
.sse-feed{display:flex;flex-direction:column;gap:4px}
.sse-item{font-size:11px;padding:4px 7px;background:var(--surface2);border-radius:5px;border-left:2px solid var(--accent);color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sse-item.err{border-left-color:var(--red)}.sse-item.warn{border-left-color:var(--yellow)}

/* Benchmark targets */
.tgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:18px}
@media(max-width:700px){.tgrid{grid-template-columns:1fr}}
.tcard{border:1px solid var(--border);border-radius:var(--r);padding:14px;background:var(--surface);transition:all .3s}
.tcard.achieved{border-color:var(--green);background:var(--green-light)}
.tcard.near{border-color:var(--accent);background:var(--accent-light)}
.ttitle{font-size:11px;font-weight:600;color:var(--fg-muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em}
.tval{font-size:20px;font-weight:700;margin-bottom:5px}
.tdesc{font-size:12px;color:var(--fg-muted);margin-bottom:8px}
.pbar{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden}
.pfill{height:100%;border-radius:3px;transition:width .6s}
.pfill.g{background:var(--green)}.pfill.b{background:var(--accent)}.pfill.y{background:var(--yellow)}

/* Kanban */
.kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:1000px){.kanban{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.kanban{grid-template-columns:1fr}}
.kcol{background:var(--surface2);border-radius:var(--r);padding:10px}
.kh{font-size:11px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.kcount{background:var(--border);border-radius:20px;padding:1px 7px;font-size:11px}
.tsk{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:9px 11px;margin-bottom:6px;cursor:pointer}
.tsk:hover{box-shadow:var(--shadow-md)}
.tsk-title{font-size:13px;font-weight:500;margin-bottom:5px}
.tsk-meta{display:flex;gap:5px;flex-wrap:wrap}

/* File explorer */
.file-section{margin-bottom:18px}
.file-section-hdr{font-size:13px;font-weight:600;color:var(--fg);margin-bottom:8px;display:flex;align-items:center;gap:6px;cursor:pointer}
.file-section-hdr:hover{color:var(--accent)}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.file-item{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 12px;cursor:pointer;transition:all .15s}
.file-item:hover{border-color:var(--accent);box-shadow:var(--shadow-md)}
.file-name{font-size:13px;font-weight:500;color:var(--fg);margin-bottom:2px;word-break:break-all}
.file-meta{font-size:11px;color:var(--fg-muted)}
.run-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:all .15s}
.run-item:hover{border-color:var(--accent);box-shadow:var(--shadow-md)}
.run-name{font-size:12px;font-weight:600;color:var(--fg);margin-bottom:6px;word-break:break-all}
.file-viewer{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:14px;font-family:monospace;font-size:12px;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;margin-top:10px}
.hide{display:none!important}

/* Misc */
.mb{margin-bottom:14px}.mb2{margin-bottom:20px}
.row{display:flex;align-items:center;gap:8px}
.rowb{display:flex;align-items:center;justify-content:space-between;gap:8px}
.empty{text-align:center;padding:36px;color:var(--fg-muted);font-size:14px}
.spin{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
input,select,textarea{font-family:inherit;font-size:14px;color:var(--fg);background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:7px 11px;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
label{font-size:12px;font-weight:500;color:var(--fg-muted);margin-bottom:3px;display:block}
.fr{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--fg);color:#fff;padding:9px 16px;border-radius:8px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
.section-title{font-size:15px;font-weight:600;color:var(--fg);margin-bottom:14px}
.text-sm{font-size:12px}.text-muted{color:var(--fg-muted)}.text-green{color:var(--green)}.text-red{color:var(--red)}
#eq-chart-wrap{position:relative;height:240px}
.pos{color:var(--green)}.neg{color:var(--red)}

/* Responsive polish */
@media(max-width:980px){
  .hdr{height:auto;min-height:56px;padding:8px 12px;flex-wrap:wrap;gap:8px}
  .logo-sub{display:none}
  .hdr-mini{order:3;width:100%}
  .hdr-actions{width:100%;justify-content:space-between}
  .kpi-strip{padding:8px 12px;gap:14px}
  .page{padding:16px 12px}
  #tasks-lanes{grid-template-columns:1fr!important}
  #pitch-team{grid-template-columns:repeat(2,1fr)!important}
  .table-tools{flex-direction:column;align-items:stretch}
  .table-search{max-width:none;width:100%}
}
:root[data-theme="dark"] .log-body{background:#0c1324;color:#D5D9E4}
</style>
</head>
<body>

<!-- Header -->
<header class="hdr">
  <div class="row gap-4">
    <span class="logo">NEXUS</span>
    <span class="logo-sub">Autonomous Quant Workforce</span>
  </div>
  <div class="hdr-mini" id="hdr-mini">
    <span class="hdr-chip" id="hc-sharpe">Sharpe ‚Äî</span>
    <span class="hdr-chip" id="hc-pnl">PnL ‚Äî</span>
    <span class="hdr-chip" id="hc-status">Status Connecting</span>
  </div>
  <div class="hdr-actions">
    <span id="hdr-live" class="hdr-live connecting">
      <span id="live-heart" class="live-heart"></span>
      <span id="live-label">Connecting‚Ä¶</span>
    </span>
    <span id="hdr-badge" class="bdg bg-gray" style="font-size:12px">Connecting...</span>
    <button id="theme-toggle" class="btn btn-s btn-sm" onclick="toggleTheme()" title="Toggle dark mode (D)">üåô</button>
    <span id="hdr-clock" class="text-sm text-muted"></span>
  </div>
</header>

<!-- Tabs -->
<nav class="tabs">
  <div class="tab active" onclick="go('overview')">üìä Overview</div>
  <div class="tab" onclick="go('chat')">üí¨ Chat</div>
  <div class="tab" onclick="go('benchmark')">üèÜ Benchmark</div>
  <div class="tab" onclick="go('performance')">üìà Performance</div>
  <div class="tab" onclick="go('risk')">‚ö†Ô∏è Risk</div>
  <div class="tab" onclick="go('research')">üî¨ Research</div>
  <div class="tab" onclick="go('tasks')">‚úÖ Tasks</div>
  <div class="tab" onclick="go('files')">üìÅ Files</div>
  <div class="tab" onclick="go('market')">üì° Market</div>
  <div class="tab" onclick="go('pitch')">üéØ Pitch</div>
  <div class="tab" onclick="go('logs')">üìù Logs</div>
  <div class="tab" onclick="go('console')">‚öôÔ∏è Console</div>
</nav>

<!-- KPI Strip -->
<div class="kpi-strip">
  <div class="kpi" title="Sharpe Ratio: Risk-adjusted return per unit volatility. >1 = good, >2 = excellent. OOS ~1.0 expected."><span class="kpi-l">Sharpe</span><span id="k-sharpe" class="kpi-v acc">‚Äî</span></div>
  <div class="kpi" title="Compound Annual Growth Rate: Annualized return. Strategy targets 6-10% at 0.35x leverage."><span class="kpi-l">CAGR</span><span id="k-cagr" class="kpi-v">‚Äî</span></div>
  <div class="kpi" title="Maximum Drawdown: Largest peak-to-trough loss. Target <10% at current leverage."><span class="kpi-l">Max DD</span><span id="k-mdd" class="kpi-v">‚Äî</span></div>
  <div class="kpi" title="Total Return since backtest start."><span class="kpi-l">Total Ret</span><span id="k-tot" class="kpi-v">‚Äî</span></div>
  <div class="kpi" title="% of periods with positive P&L. ~49% = fine for a rank-reversal strategy (few big wins matter)."><span class="kpi-l">Win Rate</span><span id="k-wr" class="kpi-v">‚Äî</span></div>
  <div class="kpi" title="Strategy name and signal mix: 35% carry + 45% momentum + 20% mean-reversion (48h)"><span class="kpi-l">Strategy</span><span id="k-strat" class="kpi-v acc" style="font-size:12px">‚Äî</span></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
    <span id="bt-progress" class="progress-pill idle"><span id="bt-progress-text">No active backtest</span><span class="progress-track"><span class="progress-fill"></span></span></span>
    <span class="text-sm text-muted" id="kpi-updated"></span>
    <button class="btn btn-s btn-sm" onclick="refresh()">‚Üª</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê -->
<div class="page active" id="page-overview">
  <div class="mb2">
    <div class="card">
      <div class="ctitle">Equity Curve</div>
      <div id="eq-chart-wrap"><canvas id="eq-chart"></canvas></div>
    </div>
  </div>
  <div class="g3 mb2">
    <div class="card">
      <div class="ctitle">Latest Run</div>
      <div id="ov-run"><div class="empty">Run a backtest first</div></div>
    </div>
    <div class="card">
      <div class="ctitle">NEXUS Brain</div>
      <div id="ov-brain"><div class="empty">Brain loading...</div></div>
    </div>
    <div class="card">
      <div class="ctitle">Agent Dispatch</div>
      <div id="ov-agents" style="display:flex;flex-direction:column;gap:7px">
        <button class="btn btn-s btn-sm" onclick="runAgent('atlas')">‚ö° ATLAS ‚Äî Strategy Research</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('cipher')">üõ° CIPHER ‚Äî Risk Assessment</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('echo')">üîä ECHO ‚Äî Data Quality</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('flux')">üåä FLUX ‚Äî Experiment Queue</button>
        <div id="agent-res" class="text-sm text-muted" style="margin-top:4px"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ctitle">
      Recent Events
      <button class="btn btn-s btn-sm" onclick="loadOv()">‚Üª</button>
    </div>
    <div id="ov-ledger"><div class="empty">Loading...</div></div>
  </div>
  <div class="card mb2" style="margin-top:14px">
    <div class="ctitle">üîÑ Full Crypto Cycle Validation (2021‚Äì2025) 
      <span class="bdg bg-g" style="font-size:10px">GENUINE OOS</span>
    </div>
    <div style="margin-bottom:10px;font-size:12px;color:var(--fg-muted);line-height:1.6">
      Parameters selected on <strong>2024 data only</strong>. All other years are genuine out-of-sample.
      Strategy: NexusAlpha V1 ¬∑ 10 symbols ¬∑ k=2 per side ¬∑ 168h rebalancing ¬∑ 0.35x leverage
    </div>
    <table style="font-size:12px">
      <thead><tr>
        <th>Year</th><th>Market Regime</th><th>Sharpe</th><th>CAGR</th><th>MDD</th><th>Beta</th><th>BTC Sharpe</th><th>Status</th>
      </tr></thead>
      <tbody>
        <tr><td>2021</td><td>üêÇ Bull (BTC +60%)</td><td class="pos"><strong>1.052</strong></td><td class="pos">+20.1%</td><td class="neg">25.1%</td><td>~0</td><td class="pos">+0.97</td><td><span class="bdg bg-g">OOS</span></td></tr>
        <tr><td>2022</td><td>üêª Bear (BTC -65%)</td><td class="pos"><strong>1.042</strong></td><td class="pos">+10.0%</td><td class="neg">5.7%</td><td>~0</td><td class="neg">-1.31</td><td><span class="bdg bg-g">OOS</span></td></tr>
        <tr><td>2023</td><td>üìà Recovery</td><td class="pos"><strong>1.524</strong></td><td class="pos">+12.9%</td><td class="neg">4.9%</td><td>~0</td><td class="pos">+2.41</td><td><span class="bdg bg-g">OOS</span></td></tr>
        <tr><td>2024</td><td>üêÇ Bull (ATH)</td><td class="pos"><strong>1.058</strong></td><td class="pos">+10.0%</td><td class="neg">11.7%</td><td>~0</td><td class="pos">+0.50</td><td><span class="bdg bg-g">OOS</span></td></tr>
        <tr><td>2025</td><td>üìä Choppy</td><td class="pos"><strong>0.948</strong></td><td class="pos">+7.3%</td><td class="neg">5.4%</td><td>~0</td><td class="pos">+0.06</td><td><span class="bdg bg-g">OOS</span></td></tr>
      </tbody>
    </table>
    <div style="margin-top:10px;font-size:11px;color:var(--fg-muted)">
      V1-Long champion: all 5 years are OOS (params from 2024 V1-std, then extended lookbacks). Honest avg OOS Sharpe = <strong style="color:var(--green)">1.125</strong> ¬∑ Alpha source: <em>"buy dips in uptrends"</em> (336h momentum + 72h MR timing)
    </div>
  </div>
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">üìñ How to Read This Dashboard</div>
      <div style="font-size:12px;line-height:1.7;color:var(--fg-muted)">
        <p><strong style="color:var(--fg)">Sharpe Ratio</strong>: Risk-adjusted return. 1.0 = good. We target 1.0+ OOS.</p>
        <p><strong style="color:var(--fg)">Calmar Ratio</strong>: CAGR √∑ Max Drawdown. Higher is better capital efficiency.</p>
        <p><strong style="color:var(--fg)">Beta ‚âà 0</strong>: Market-neutral. Strategy profits regardless of BTC direction.</p>
        <p><strong style="color:var(--fg)">OOS vs IS</strong>: Out-of-sample (OOS) is true performance. In-sample (IS) is biased upward.</p>
        <p><strong style="color:var(--fg)">Walk-Forward</strong>: Rolling IS/OOS windows. &gt;60% profitable = robust signal.</p>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">üß† Alpha Source: "Buy Dips in Uptrends"</div>
      <div style="font-size:12px;line-height:1.7;color:var(--fg-muted)">
        <p>1. <strong style="color:var(--fg)">Cross-Rank 10 perps</strong> by composite score</p>
        <p>2. <strong style="color:var(--fg)">Composite</strong> = 35% funding carry + 45% 336h momentum + 20% -72h mean-reversion</p>
        <p>3. <strong style="color:var(--fg)">LONG top-2</strong> (uptrend + positive carry + dipped recently)</p>
        <p>4. <strong style="color:var(--fg)">SHORT bottom-2</strong> (downtrend + negative carry + bounced recently)</p>
        <p>5. <strong style="color:var(--fg)">Rebalance every 60h</strong> (2.5 days) at 0.35x gross leverage</p>
        <p style="margin-top:5px;color:var(--accent);font-weight:500">Why it works: MR timing + momentum filter = enter dips in leaders, avoid value traps</p>
      </div>
    </div>
  </div>
  <div class="card mb2" style="border-left:4px solid var(--purple)">
    <div class="ctitle">üß† Critical Thinking ‚Äî Process Challenges
      <span class="bdg bg-p" style="font-size:10px">SELF-REVIEW</span>
    </div>
    <div class="g2" style="font-size:12px;line-height:1.7">
      <div>
        <p style="font-weight:600;color:var(--fg);margin-bottom:6px">‚ùì Key Open Questions</p>
        <ul style="color:var(--fg-muted);padding-left:16px;margin:0">
          <li>Is the 72h MR lookback genuinely robust? (Validated: OOS 2021=1.052, 2026=0.921)</li>
          <li>V1-Long 2022 bear Sharpe=1.042 ‚Äî will this hold with 10+ years of data?</li>
          <li>Are we missing signals in order flow, OI change, or on-chain data?</li>
          <li>Is 0.35x leverage optimal or leaving alpha on the table?</li>
        </ul>
      </div>
      <div>
        <p style="font-weight:600;color:var(--fg);margin-bottom:6px">üî¨ Research Gaps Identified</p>
        <ul style="color:var(--fg-muted);padding-left:16px;margin:0">
          <li>No live trading validation yet (all backtested)</li>
          <li>Slippage model assumes uniform cost ‚Äî real fill may vary</li>
          <li>Cross-exchange funding rate arbitrage unexplored</li>
          <li>2020 pandemic crash data not yet tested</li>
        </ul>
      </div>
    </div>
  </div>
  <!-- Sharpe by Year bar chart -->
  <div class="card mb2">
    <div class="ctitle">üìä Sharpe by Year ‚Äî Full Cycle OOS Summary
      <span class="bdg bg-g" style="font-size:10px">ALL OOS (V1-Long)</span>
    </div>
    <div class="year-bar-wrap" id="year-bar-chart"></div>
    <div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:var(--fg-muted)">
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--green);border-radius:2px;margin-right:3px"></span>All OOS (V1-Long)</span>
      <span style="font-size:11px;color:var(--fg-muted)">Avg=1.125 ¬∑ MIN=0.948 ¬∑ All positive</span>
    </div>
  </div>
  <!-- Bias Monitor -->
  <div class="card mb2 bias-card">
    <div class="ctitle">‚ö†Ô∏è Bias & Overfitting Monitor
      <span class="bdg bg-g" style="font-size:10px">IMPROVED</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">In-Sample Bias (2024)</span>
      <span class="bias-verdict pass">RESOLVED ‚Äî V1-Long uses extended lookbacks, all 5 years are OOS. Avg=1.125</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Look-Ahead Bias</span>
      <span class="bias-verdict pass">PASS ‚Äî OOS predictions use t-1 data only, no future leakage</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Selection Bias (k, rebal window)</span>
      <span class="bias-verdict warn">PARTIAL ‚Äî 336h/72h tested 120+ variants in Phase 55; DSR adjusted</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Survivorship Bias</span>
      <span class="bias-verdict warn">PARTIAL ‚Äî 10 majors only; MATICUSDT rename handled</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Multiple Testing (DSR)</span>
      <span class="bias-verdict warn">DSR=0.46 ‚Äî 30+ experiments; discount applies to IS results</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Regime Bias (regime lock-in)</span>
      <span class="bias-verdict pass">PASS ‚Äî Tested bull/bear/recovery/sideways across 5 years</span>
    </div>
    <div class="bias-row">
      <span class="bias-type">Walk-Forward Stability</span>
      <span class="bias-verdict pass">PASS ‚Äî 67% of 2023 WF windows profitable; 85% Monte Carlo paths</span>
    </div>
    <div style="margin-top:8px;font-size:11px;color:var(--fg-muted)">
      üí° V1-Long honest OOS Sharpe = <strong>1.125</strong> (avg 2021-2025, all OOS). MIN year Sharpe = 0.948 (2025).
    </div>
  </div>
  <div class="card mt2">
    <div class="ctitle">üìà Learning Progress ‚Äî Champion Sharpe Over Time
      <span id="live-lv" style="font-size:11px;color:var(--accent);margin-left:8px">‚Äî</span>
    </div>
    <div style="height:180px"><canvas id="progress-chart"></canvas></div>
    <div id="progress-stats" class="text-sm text-muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê -->
<div class="page" id="page-chat">
  <div class="chat-wrap">
    <div class="chat-box">
      <!-- Header bar -->
      <div class="chat-header">
        <div class="chat-header-left">
          <span id="chat-sse-dot" class="sse-dot yellow" title="SSE disconnected"></span>
          <span>NEXUS Brain</span>
          <span id="chat-model-badge" class="model-badge">SAGE</span>
        </div>
        <div class="chat-header-right" style="display:flex;align-items:center;gap:6px">
          <select id="model-select" onchange="onModelChange()" style="font-size:11px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--fg);cursor:pointer;height:28px">
            <option value="glm-5" selected>üß† SAGE ‚Äî The Thinker (GLM-5)</option>
            <option value="claude-sonnet-4-6">üîµ SENTINEL ‚Äî The Analyst (Sonnet 4.6)</option>
            <option value="claude-opus-4-6">üü£ NEXUS PRIME ‚Äî The Architect (Opus 4.6)</option>
            <option value="codex">üü¢ FORGE ‚Äî The Builder (GPT-5.2)</option>
            <option value="minimax-2.5">üü† SCOUT ‚Äî The Explorer (MiniMax 2.5)</option>
          </select>
          <button class="btn btn-s btn-sm" id="debate-toggle-btn" onclick="toggleDebateMode()" title="Debate mode: all models discuss + critique each other" style="background:var(--surface);border:1px solid var(--border)">‚öîÔ∏è Debate</button>
          <button class="btn btn-s btn-sm" onclick="copyLastAI()" title="Copy last AI response">Copy</button>
          <button class="btn btn-s btn-sm" onclick="clearChat()" title="Clear chat">Clear</button>
        </div>
      </div>
      <!-- Debate mode banner -->
      <div id="debate-banner" style="display:none;padding:6px 12px;background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff;font-size:11px;text-align:center">
        ‚öîÔ∏è <strong>Debate Mode ON</strong> ‚Äî 4 agents (SAGE + SENTINEL + FORGE + SCOUT) will analyze, critique each other, then synthesize a verdict. Takes ~30-60s.
        <button onclick="toggleDebateMode()" style="margin-left:8px;background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px">‚úï Off</button>
      </div>
      <!-- Quick chips -->
      <div class="chips">
        <span class="chip" onclick="chip('Show full cycle validation results: 2021 bull, 2022 bear, 2023 recovery, 2025 YTD. Explain what honest OOS Sharpe of 1.125 means for V1-Long.')">üìä Full Cycle OOS</span>
        <span class="chip" onclick="chip('What is the alpha source? Explain buy-dips-in-uptrends: how 336h momentum filter + 72h MR timing works together. Why does pure MR alone lose?')">üß† Alpha Source</span>
        <span class="chip" onclick="chip('How did V1-Long achieve Sharpe=1.042 in 2022 bear market (BTC -65%, FTX collapse)? What makes the longer lookbacks more robust?')">üêª 2022 Bear Survival</span>
        <span class="chip" onclick="chip('Analyze current risk status: drawdown, leverage, regime, and what could cause next drawdown period')">‚ö†Ô∏è Risk Check</span>
        <span class="chip" onclick="chip('What should Phase 31 focus on? What new signals would genuinely improve OOS Sharpe beyond 1.0 without overfitting?')">üî¨ Phase 31 Plan</span>
        <span class="chip" onclick="chip('Compare all Phase 30 experiments: 15sym=0.747, k=3=0.119, 48h rebal=0.844, carry50=0.349. Why did all modifications make things worse?')">üìâ Phase 30 Findings</span>
        <span class="chip" onclick="chip('Based on current BTC funding rates and 48h price action, what is the cross-sectional signal ranking right now? Who is long candidate, who is short?')">üö¶ Live Signal</span>
        <span class="chip" onclick="chip('Propose a new signal that does not require parameter optimization: open interest change, funding momentum, or basis convergence')">üí° New Signal Idea</span>
        <span class="chip" onclick="loadDebateHistory()" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff">‚öîÔ∏è Debate History</span>
        <span class="chip" onclick="startDebate('Should we add open interest change as a signal? Pros, cons, overfitting risk, OOS expectation. Current alpha: V1-Long carry+mom+MR Sharpe=1.125 OOS.')">üÜö Debate: OI Signal</span>
        <span class="chip" onclick="startDebate('Is NexusAlpha V1-Long Sharpe=1.125 OOS genuinely good for a crypto long-short strategy? Compare to industry benchmarks. What are the main risks?')">üÜö Debate: Alpha Quality</span>
      </div>
      <!-- Messages -->
      <div class="chat-msgs" id="chat-msgs">
        <div class="cmsg a">
          <div class="cbubble"><strong>NEXUS Brain</strong> ‚Äî autonomous quant research workforce.<br><br>I run 24/7: researching papers, testing strategies, managing risk. V1-Long champion results:<br><strong>2021</strong> Sharpe=1.05 ¬∑ <strong>2022 Bear</strong> Sharpe=1.04 ¬∑ <strong>2023</strong> Sharpe=1.52 ¬∑ <strong>2024</strong> Sharpe=1.06 ¬∑ <strong>2025</strong> Sharpe=0.95<br><strong>Avg OOS Sharpe: 1.125</strong> across all market regimes. MIN=0.948. All years OOS.<br><br>Ask me anything about strategy, signals, risk, or next research direction.</div>
          <div class="cmsg-footer">
            <span class="cts">Ready ¬∑ GLM-5 powered</span>
            <button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>
          </div>
        </div>
      </div>
      <!-- Input bar -->
      <div class="chat-in-bar">
        <textarea class="chat-ta" id="chat-in" placeholder="Ask NEXUS anything... (Enter to send, Shift+Enter for newline)" onkeydown="onChatKey(event)" oninput="autoGrowTA(this)"></textarea>
        <button class="btn btn-p" onclick="sendMsg()" style="flex-shrink:0;align-self:flex-end">Send</button>
      </div>
    </div>
    <!-- Right sidebar -->
    <div class="brain-panel" id="brain-panel">
      <!-- Live Metrics -->
      <div class="live-metrics-card" id="bp-metrics">
        <h4>Live Metrics</h4>
        <div class="lm-grid">
          <div class="lm-cell"><div class="lm-val" id="lm-sharpe-is">‚Äî</div><div class="lm-lbl">Sharpe <span class="is-badge is">IS</span></div></div>
          <div class="lm-cell"><div class="lm-val" id="lm-sharpe-oos">‚Äî</div><div class="lm-lbl">Sharpe <span class="is-badge oos">OOS</span></div></div>
          <div class="lm-cell"><div class="lm-val" id="lm-cagr">‚Äî</div><div class="lm-lbl">CAGR</div></div>
          <div class="lm-cell"><div class="lm-val" id="lm-mdd">‚Äî</div><div class="lm-lbl">MDD</div></div>
        </div>
        <div style="margin-top:8px;font-size:10px;color:var(--fg-muted);display:flex;justify-content:space-between;align-items:center">
          <span id="lm-updated">‚Äî</span>
          <span id="lm-alerts" style="color:var(--accent)">0 alerts</span>
        </div>
      </div>
      <!-- Live Events -->
      <div class="brain-card" id="bp-feed">
        <h4>Live Events</h4>
        <div class="sse-feed" id="sse-feed"><div class="text-sm text-muted">Connecting...</div></div>
      </div>
      <!-- Identity -->
      <div class="brain-card" id="bp-identity">
        <h4>Identity</h4>
        <div class="text-sm text-muted">Loading...</div>
      </div>
      <!-- Goals -->
      <div class="brain-card" id="bp-goals">
        <h4>Goals</h4>
        <div class="text-sm text-muted">Loading...</div>
      </div>
      <!-- Mood -->
      <div class="brain-card" id="bp-mood">
        <h4>Mood</h4>
        <div class="text-sm text-muted" style="font-size:22px">ü§î</div>
      </div>
      <!-- Quick Actions -->
      <div class="brain-card">
        <h4>Quick Actions</h4>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn btn-s btn-sm" onclick="runResearch()">üî¨ Run Research</button>
          <button class="btn btn-s btn-sm" onclick="go('benchmark')">üèÜ Benchmarks</button>
          <button class="btn btn-s btn-sm" onclick="go('validation')">‚úÖ Validation</button>
          <button class="btn btn-s btn-sm" onclick="copyLastAI()">üìã Copy Last Result</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê BENCHMARK ‚ïê‚ïê‚ïê -->
<div class="page" id="page-benchmark">
  <div class="section-title mb">üèÜ NEXUS Achievement Targets</div>
  <div class="tgrid" id="target-cards">
    <div class="tcard" id="tc1">
      <div class="ttitle">Target 1 ‚Äî Beat S&P 500</div>
      <div class="tval" id="tv1">Sharpe &gt; 0.6</div>
      <div class="tdesc">Minimum viable: outperform passive US equity (SPY 2024 Sharpe ‚âà 0.73)</div>
      <div class="pbar"><div class="pfill b" id="tp1" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc1-v">‚Äî</b></span><span id="tb1" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc2">
      <div class="ttitle">Target 2 ‚Äî Beat BTC Buy &amp; Hold</div>
      <div class="tval" id="tv2">Sharpe &gt; 1.5</div>
      <div class="tdesc">Short-term goal: risk-adjusted better than simply holding Bitcoin (BTC 2024 ‚âà 1.47)</div>
      <div class="pbar"><div class="pfill b" id="tp2" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc2-v">‚Äî</b></span><span id="tb2" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc3">
      <div class="ttitle">Target 3 ‚Äî Beat Renaissance (net)</div>
      <div class="tval" id="tv3">Sharpe &gt; 2.5</div>
      <div class="tdesc">Medium-term: surpass best human hedge fund net-of-fees (Renaissance ‚âà 3.8 gross)</div>
      <div class="pbar"><div class="pfill b" id="tp3" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc3-v">‚Äî</b></span><span id="tb3" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc4">
      <div class="ttitle">Target 4 ‚Äî World-Class (NEXUS Goal)</div>
      <div class="tval" id="tv4">Sharpe &gt; 5.0</div>
      <div class="tdesc">Long-term: top-tier autonomous quant ‚Äî beyond any human team</div>
      <div class="pbar"><div class="pfill b" id="tp4" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc4-v">‚Äî</b></span><span id="tb4" class="bdg bg-gray">PENDING</span></div>
    </div>
  </div>

  <!-- Achievement badges -->
  <div class="card mb2">
    <div class="ctitle">Achievement Badges</div>
    <div style="display:flex;gap:16px;flex-wrap:wrap" id="ach-badges">
      <div class="ach" data-level="0" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•â</div><div style="font-size:12px;font-weight:600;margin-top:4px">Bronze</div><div class="text-sm text-muted">Sharpe &gt; 0.6</div></div>
      <div class="ach" data-level="1" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•à</div><div style="font-size:12px;font-weight:600;margin-top:4px">Silver</div><div class="text-sm text-muted">Sharpe &gt; 1.5</div></div>
      <div class="ach" data-level="2" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•á</div><div style="font-size:12px;font-weight:600;margin-top:4px">Gold</div><div class="text-sm text-muted">Sharpe &gt; 2.5</div></div>
      <div class="ach" data-level="3" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">üíé</div><div style="font-size:12px;font-weight:600;margin-top:4px">Platinum</div><div class="text-sm text-muted">Sharpe &gt; 5.0</div></div>
    </div>
  </div>

  <!-- Benchmark table -->
  <div class="card">
    <div class="ctitle">
      Live Benchmark Comparison
      <button class="btn btn-s btn-sm" onclick="loadBM()">‚Üª Refresh</button>
    </div>
    <div id="bm-table"><div class="empty">Loading...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PERFORMANCE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-performance">
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">Returns Distribution</div>
      <div style="position:relative;height:220px"><canvas id="ret-chart"></canvas></div>
    </div>
    <div class="card">
      <div class="ctitle">Key Metrics</div>
      <div id="pf-stats"><div class="empty">Loading...</div></div>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Walk-Forward Windows</div>
    <div id="wf-body"><div class="empty">Loading...</div></div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Recent Backtest Runs</div>
    <div id="runs-table"><div class="empty">Loading run history...</div></div>
  </div>
  <div class="card">
    <div class="ctitle">
      Validation Suite (8 Tests)
      <div class="row">
        <button class="btn btn-p btn-sm" onclick="runVal()">‚ñ∂ Run Validation</button>
        <span id="val-st" class="text-sm text-muted"></span>
      </div>
    </div>
    <div id="val-body"><div class="empty">No validation results. Click Run to execute all 8 tests.</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RISK ‚ïê‚ïê‚ïê -->
<div class="page" id="page-risk">
  <div class="g3 mb2">
    <div class="card"><div class="ctitle">Value at Risk</div><div id="risk-var"><div class="empty">‚Äî</div></div></div>
    <div class="card"><div class="ctitle">Market Regime</div><div id="risk-regime"><div class="empty">‚Äî</div></div></div>
    <div class="card"><div class="ctitle">Position Limits</div><div id="risk-limits"><div class="empty">‚Äî</div></div></div>
  </div>
  <div class="card">
    <div class="ctitle">Position Detail</div>
    <div id="risk-detail"><div class="empty">Run a backtest to see positions</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RESEARCH ‚ïê‚ïê‚ïê -->
<div class="page" id="page-research">
  <div class="rowb mb2">
    <div class="row">
      <button class="btn btn-p btn-sm" onclick="runResearch()">üî¨ Run Research Cycle</button>
      <span id="rc-st" class="text-sm text-muted"></span>
    </div>
    <button class="btn btn-s btn-sm" onclick="loadResearch()">‚Üª Refresh</button>
  </div>
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">Latest Research Cycle</div>
      <div id="rc-latest"><div class="empty">No cycle data yet</div></div>
    </div>
    <div class="card">
      <div class="ctitle">Memory Search</div>
      <div class="row mb" style="gap:6px">
        <input type="text" id="mem-q" placeholder="Search NEXUS knowledge..." style="flex:1">
        <button class="btn btn-s btn-sm" onclick="searchMem()">Search</button>
      </div>
      <div id="mem-results" class="text-sm text-muted">Enter query above...</div>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Strategy Proposals</div>
    <div id="rc-proposals"><div class="empty">No proposals yet</div></div>
  </div>
  <div class="card">
    <div class="ctitle">Recent Alerts</div>
    <div id="rc-alerts"><div class="empty">No alerts</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TASKS ‚ïê‚ïê‚ïê -->
<div class="page" id="page-tasks">
  <div class="card" style="background:#FFFBEB;border:1px solid #FDE68A;margin-bottom:16px">
    <div style="font-weight:600;margin-bottom:4px">üìã Task Board ‚Äî NEXUS Kanban</div>
    <div class="text-sm text-muted">Tasks are auto-generated by ATLAS/CIPHER/ECHO agents and brain loop. <b>Click a task card to mark it done.</b> Create new tasks with the form below.</div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Create Task</div>
    <div class="fr">
      <div><label>Title</label><input type="text" id="t-title" placeholder="Task title..."></div>
      <div><label>Category</label><select id="t-cat"><option value="research">üî¨ Research</option><option value="practice" selected>‚öóÔ∏è Practice</option><option value="procedure">ü§ñ Procedure</option></select></div>
      <div><label>Priority</label><select id="t-pri"><option value="high">üî¥ High</option><option value="medium" selected>üü° Medium</option><option value="low">üü¢ Low</option></select></div>
    </div>
    <div class="fr">
      <div><label>Assignee</label><select id="t-who"><option>ATLAS</option><option>CIPHER</option><option>ECHO</option><option>FLUX</option><option value="Human">Human</option></select></div>
      <div><label>Delegated by</label><select id="t-delegated"><option value="human">üë§ Human</option><option value="nexus">ü§ñ NEXUS</option><option value="atlas">‚ö° ATLAS</option><option value="cipher">üõ° CIPHER</option></select></div>
      <div><label>Description</label><input type="text" id="t-desc" placeholder="Optional..."></div>
    </div>
    <button class="btn btn-p btn-sm" onclick="createTask()">+ Create Task</button>
  </div>
  <!-- 3-lane category view -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px" id="tasks-lanes">
    <div class="card" style="border-top:3px solid #6366F1">
      <div class="ctitle">üî¨ Research <span class="kcount" id="kc-research">0</span></div>
      <div class="text-sm text-muted mb1" style="font-size:11px">Literature ¬∑ Hypotheses ¬∑ Analysis</div>
      <div id="kl-research"><div class="empty">No tasks</div></div>
    </div>
    <div class="card" style="border-top:3px solid #10B981">
      <div class="ctitle">‚öóÔ∏è Practice <span class="kcount" id="kc-practice">0</span></div>
      <div class="text-sm text-muted mb1" style="font-size:11px">Backtests ¬∑ Experiments ¬∑ Implementation</div>
      <div id="kl-practice"><div class="empty">No tasks</div></div>
    </div>
    <div class="card" style="border-top:3px solid #F59E0B">
      <div class="ctitle">ü§ñ Procedures <span class="kcount" id="kc-procedure">0</span></div>
      <div class="text-sm text-muted mb1" style="font-size:11px">Automated AI workflows ¬∑ Loops</div>
      <div id="kl-procedure"><div class="empty">No tasks</div></div>
    </div>
  </div>
  <!-- Classic Kanban (by status) below -->
  <div class="ctitle mt2" style="margin-bottom:8px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.5px">All Tasks by Status</div>
  <div class="kanban" id="kanban">
    <div class="kcol"><div class="kh">TODO <span class="kcount" id="kc-todo">0</span></div><div id="kl-todo"></div></div>
    <div class="kcol"><div class="kh">IN PROGRESS <span class="kcount" id="kc-inprogress">0</span></div><div id="kl-inprogress"></div></div>
    <div class="kcol"><div class="kh">REVIEW <span class="kcount" id="kc-review">0</span></div><div id="kl-review"></div></div>
    <div class="kcol"><div class="kh">DONE <span class="kcount" id="kc-done">0</span></div><div id="kl-done"></div></div>
  </div>
  <div class="card" style="margin-top:14px">
    <div class="ctitle">Task Table</div>
    <div id="tasks-table"><div class="empty">Loading tasks...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê FILES & REPORTS ‚ïê‚ïê‚ïê -->
<div class="page" id="page-files">
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">üìÅ Files, Reports &amp; Artifacts</div>
    <div class="row">
      <input type="text" id="file-search" placeholder="Search files and runs..." style="min-width:240px" oninput="filterFiles()">
      <span class="text-sm text-muted" id="files-match"></span>
      <button class="btn btn-s btn-sm" onclick="loadFiles()">‚Üª Refresh</button>
    </div>
  </div>
  <div id="file-viewer-panel" style="display:none" class="card mb2">
    <div class="ctitle rowb">
      <span id="fv-path">File Viewer</span>
      <button class="btn btn-s btn-sm" onclick="closeFileViewer()">‚úï Close</button>
    </div>
    <div id="fv-content" class="file-viewer">Select a file to view its content</div>
  </div>
  <div id="files-body"><div class="empty"><div class="spin"></div> Loading artifacts...</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê MARKET ‚ïê‚ïê‚ïê -->
<div class="page" id="page-market">
  <div class="card" style="background:#F0FDF4;border:1px solid #BBF7D0;margin-bottom:16px">
    <div style="font-weight:600;margin-bottom:6px">üì° Live Binance Perp Futures ‚Äî What this tab shows</div>
    <div class="text-sm text-muted" style="line-height:1.7">
      <b>Funding Rates</b>: When funding is very negative ‚Üí longs earn from shorts ‚Üí BUY signal. Very positive ‚Üí shorts earn ‚Üí SELL signal. NEXUS Carry strategy exploits this.<br>
      <b>Signal column</b>: LONG ‚Üë means funding &lt; -0.05% (bullish carry), SHORT ‚Üì means funding &gt; +0.05% (bearish carry), NEUTRAL otherwise.<br>
      <b>Annualized</b>: Funding rate √ó 3 payments/day √ó 365 days. E.g. -0.01%/8h = -10.95% annual yield to longs.<br>
      <b>Mark Price / 24h Change</b>: Current price and momentum signals used by the NEXUS momentum layer.
    </div>
  </div>
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">üì° Live Market Data</div>
    <div class="row">
      <span class="text-sm text-muted" id="mkt-ts">‚Äî</span>
      <button class="btn btn-s btn-sm" onclick="loadMarket()">‚Üª Refresh</button>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Funding Rates &amp; Carry Signals</div>
    <div id="mkt-funding"><div class="empty">Loading...</div></div>
  </div>
  <div class="card">
    <div class="ctitle">Price &amp; Volume</div>
    <div id="mkt-price"><div class="empty">Loading...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê INVESTOR PITCH ‚ïê‚ïê‚ïê -->
<div class="page" id="page-pitch">
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">üéØ NEXUS Investor Pitch ‚Äî Alpha Verification</div>
    <div class="row">
      <button class="btn btn-s btn-sm" onclick="loadPitch()">‚Üª Refresh</button>
      <button class="btn btn-p btn-sm" onclick="window.open('/api/pitch/report','_blank')">‚¨á Export PDF</button>
    </div>
  </div>

  <!-- Hero KPIs -->
  <div class="g4 mb2" id="pitch-kpis">
    <div class="card" style="text-align:center;background:linear-gradient(135deg,#EFF6FF,#DBEAFE)">
      <div style="font-size:11px;font-weight:600;color:#1D4ED8;text-transform:uppercase;letter-spacing:.05em">Champion Sharpe</div>
      <div id="pt-sharpe" style="font-size:2.4rem;font-weight:700;color:#1E40AF;line-height:1.2">‚Äî</div>
      <div style="font-size:11px;color:#6B7280">Annualized (1h bars, 8760 ppy)</div>
    </div>
    <div class="card" style="text-align:center;background:linear-gradient(135deg,#F0FDF4,#DCFCE7)">
      <div style="font-size:11px;font-weight:600;color:#16A34A;text-transform:uppercase;letter-spacing:.05em">CAGR</div>
      <div id="pt-cagr" style="font-size:2.4rem;font-weight:700;color:#15803D;line-height:1.2">‚Äî</div>
      <div style="font-size:11px;color:#6B7280">Compound Annual Growth Rate</div>
    </div>
    <div class="card" style="text-align:center;background:linear-gradient(135deg,#FFF7ED,#FED7AA)">
      <div style="font-size:11px;font-weight:600;color:#D97706;text-transform:uppercase;letter-spacing:.05em">Max Drawdown</div>
      <div id="pt-mdd" style="font-size:2.4rem;font-weight:700;color:#B45309;line-height:1.2">‚Äî</div>
      <div style="font-size:11px;color:#6B7280">Maximum Drawdown</div>
    </div>
    <div class="card" style="text-align:center;background:linear-gradient(135deg,#F5F3FF,#EDE9FE)">
      <div style="font-size:11px;font-weight:600;color:#7C3AED;text-transform:uppercase;letter-spacing:.05em">Sources Monitored</div>
      <div id="pt-sources" style="font-size:2.4rem;font-weight:700;color:#6D28D9;line-height:1.2">72</div>
      <div style="font-size:11px;color:#6B7280">Academic, Blogs, Forums, Crypto</div>
    </div>
  </div>

  <!-- Alpha vs Benchmarks chart -->
  <div class="card mb2">
    <div class="ctitle">üìä NEXUS vs Benchmarks ‚Äî Equity Curve (2024)</div>
    <div style="font-size:12px;color:#6B7280;margin-bottom:12px">
      Real Binance data ¬∑ 1h bars ¬∑ 8,784 bars ¬∑ 10 symbols ¬∑ Full transaction costs (0.04% maker)
    </div>
    <canvas id="pt-equity" height="300"></canvas>
    <div id="pt-bench-compare" class="mt2"></div>
  </div>

  <!-- Strategy Rankings -->
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">üèÜ Strategy Leaderboard</div>
      <div id="pt-rankings"><div class="empty">Loading...</div></div>
    </div>
    <div class="card">
      <div class="ctitle">üî¨ Scientific Verification</div>
      <div id="pt-verification"><div class="empty">Loading...</div></div>
    </div>
  </div>

  <!-- How NEXUS Thinks ‚Äî Decision Flow -->
  <div class="card mb2">
    <div class="ctitle">üß† How NEXUS Makes Decisions</div>
    <div style="background:#F8FAFC;border-radius:10px;padding:20px;margin-top:8px;font-size:13px">
      <div style="display:flex;align-items:stretch;gap:0;overflow-x:auto">
        <div class="pitch-step">
          <div class="pitch-step-icon">üì°</div>
          <div class="pitch-step-num">1</div>
          <div class="pitch-step-title">RESEARCH</div>
          <div class="pitch-step-desc">Read 72+ sources daily: arXiv, Reddit r/algotrading, quant blogs, crypto news, ML papers</div>
        </div>
        <div class="pitch-arrow">‚Üí</div>
        <div class="pitch-step">
          <div class="pitch-step-icon">üí°</div>
          <div class="pitch-step-num">2</div>
          <div class="pitch-step-title">HYPOTHESIZE</div>
          <div class="pitch-step-desc">Extract actionable trading hypotheses using keyword matching + Bayesian prior beliefs</div>
        </div>
        <div class="pitch-arrow">‚Üí</div>
        <div class="pitch-step">
          <div class="pitch-step-icon">‚öóÔ∏è</div>
          <div class="pitch-step-num">3</div>
          <div class="pitch-step-title">APPLY</div>
          <div class="pitch-step-desc">Run backtests on real Binance data with full transaction costs, slippage, and funding rates</div>
        </div>
        <div class="pitch-arrow">‚Üí</div>
        <div class="pitch-step">
          <div class="pitch-step-icon">üìä</div>
          <div class="pitch-step-num">4</div>
          <div class="pitch-step-title">EVALUATE</div>
          <div class="pitch-step-desc">Compare Sharpe, CAGR, Calmar vs champion. Walk-forward out-of-sample validation</div>
        </div>
        <div class="pitch-arrow">‚Üí</div>
        <div class="pitch-step">
          <div class="pitch-step-icon">üß†</div>
          <div class="pitch-step-num">5</div>
          <div class="pitch-step-title">ADAPT</div>
          <div class="pitch-step-desc">Update Bayesian beliefs, spaced repetition deck, meta-learner. Promote champion if improved</div>
        </div>
        <div class="pitch-arrow">‚Üí</div>
        <div class="pitch-step" style="background:linear-gradient(135deg,#EFF6FF,#DBEAFE)">
          <div class="pitch-step-icon">‚ôæÔ∏è</div>
          <div class="pitch-step-num">‚àû</div>
          <div class="pitch-step-title">REPEAT</div>
          <div class="pitch-step-desc">Runs 24/7. Every cycle the system becomes smarter. Knowledge compounds over time.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Workforce Team -->
  <div class="card mb2">
    <div class="ctitle">ü§ñ AI Workforce ‚Äî Multi-Model Team</div>
    <div id="pitch-team" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:8px">
      <div style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#F5F3FF,#EDE9FE);border-radius:10px">
        <div style="font-size:24px">üü£</div>
        <div style="font-weight:700;font-size:14px;color:#6D28D9;margin-top:4px">NEXUS PRIME</div>
        <div style="font-size:10px;font-weight:600;color:#7C3AED;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">The Architect</div>
        <div style="font-size:11px;color:#6B7280;margin-top:6px">Claude Opus 4.6<br>Strategy ¬∑ Architecture ¬∑ Integration ¬∑ Final decisions</div>
      </div>
      <div style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#ECFDF5,#D1FAE5);border-radius:10px">
        <div style="font-size:24px">üß†</div>
        <div style="font-weight:700;font-size:14px;color:#059669;margin-top:4px">SAGE</div>
        <div style="font-size:10px;font-weight:600;color:#10B981;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">The Thinker</div>
        <div style="font-size:11px;color:#6B7280;margin-top:6px">GLM-5.0<br>Deep reasoning ¬∑ Brain loop ¬∑ Research synthesis</div>
      </div>
      <div style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#EFF6FF,#DBEAFE);border-radius:10px">
        <div style="font-size:24px">üîµ</div>
        <div style="font-weight:700;font-size:14px;color:#1D4ED8;margin-top:4px">SENTINEL</div>
        <div style="font-size:10px;font-weight:600;color:#3B82F6;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">The Analyst</div>
        <div style="font-size:11px;color:#6B7280;margin-top:6px">Claude Sonnet 4.6<br>QA validation ¬∑ Bias detection ¬∑ Cross-verification</div>
      </div>
      <div style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#F0FDF4,#DCFCE7);border-radius:10px">
        <div style="font-size:24px">üü¢</div>
        <div style="font-weight:700;font-size:14px;color:#16A34A;margin-top:4px">FORGE</div>
        <div style="font-size:10px;font-weight:600;color:#22C55E;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">The Builder</div>
        <div style="font-size:11px;color:#6B7280;margin-top:6px">GPT-5.2 (Codex)<br>Code implementation ¬∑ Algorithm engineering ¬∑ Execution</div>
      </div>
      <div style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#FFF7ED,#FED7AA);border-radius:10px">
        <div style="font-size:24px">üü†</div>
        <div style="font-weight:700;font-size:14px;color:#D97706;margin-top:4px">SCOUT</div>
        <div style="font-size:10px;font-weight:600;color:#F59E0B;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">The Explorer</div>
        <div style="font-size:11px;color:#6B7280;margin-top:6px">MiniMax 2.5<br>Alternative perspectives ¬∑ Contrarian analysis ¬∑ Diversity</div>
      </div>
    </div>
    <div style="margin-top:10px;font-size:11px;color:#6B7280;text-align:center">
      All 5 AI agents collaborate through debate, critique, and consensus protocols. No single point of failure.
    </div>
  </div>

  <!-- Accelerated Learning Stats -->
  <div class="card mb2">
    <div class="ctitle">‚ö° Accelerated Learning Engine Status</div>
    <div class="g3 mt2" id="pt-learning"><div class="empty">Loading...</div></div>
  </div>

  <!-- Disclaimer -->
  <div class="card" style="background:#FFFBEB;border:1px solid #FCD34D">
    <div style="font-size:12px;color:#92400E;line-height:1.6">
      <strong>‚ö†Ô∏è Scientific Disclaimer:</strong> All backtest results are in-sample on historical data (2024).
      Past performance does not guarantee future results. Walk-forward validation is performed to reduce
      look-ahead bias, but all systematic strategies carry risk of regime change. Transaction costs
      include Binance VIP-0 taker fees (0.04%), 3bps slippage, and funding rate payments.
      No personal financial advice is provided. NEXUS is a research platform, not a live trading system.
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOGS (Analysis Journal) ‚ïê‚ïê‚ïê -->
<div class="page" id="page-logs">
  <div style="display:grid;grid-template-columns:1fr 380px;gap:16px">
    <!-- Left: Log entries -->
    <div>
      <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:4px">Analysis Journal ‚Äî Research History</div>
        <div class="text-sm text-muted">Persistent record of thinking, findings, decisions, and multi-model audits. Auto-refreshes every 10s.</div>
      </div>
      <!-- Filters -->
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
        <select id="log-filter-type" onchange="loadLogs()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px">
          <option value="">All Types</option>
          <option value="analysis">Analysis</option>
          <option value="finding">Finding</option>
          <option value="decision">Decision</option>
          <option value="audit">Audit</option>
        </select>
        <select id="log-filter-source" onchange="loadLogs()" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px">
          <option value="">All Sources</option>
          <option value="claude">NEXUS PRIME (Claude)</option>
          <option value="gpt-5.2">FORGE (GPT-5.2)</option>
          <option value="glm-5">SAGE (GLM-5)</option>
          <option value="sonnet-4.6">SENTINEL (Sonnet)</option>
          <option value="multi-model">Multi-Model Debate</option>
          <option value="user">User</option>
        </select>
        <label style="font-size:11px;color:var(--fg-muted);display:flex;align-items:center;gap:4px">
          <input type="checkbox" id="log-autorefresh" checked onchange="toggleLogAutoRefresh()"> Auto-refresh
        </label>
        <button class="btn btn-s" onclick="loadLogs()" style="padding:6px 12px">Refresh</button>
        <span id="log-count" class="text-sm text-muted" style="margin-left:auto"></span>
      </div>
      <!-- Log entries -->
      <div id="logs-container" style="display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 300px);overflow-y:auto">
        <div class="empty">Loading analysis logs...</div>
      </div>
    </div>
    <!-- Right: AI Quick Chat -->
    <div>
      <div class="card" style="margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:8px">AI Research Assistant</div>
        <div class="text-sm text-muted" style="margin-bottom:10px">Ask about research findings, strategy analysis, or get quick insights from AI.</div>
        <div id="log-chat-messages" style="max-height:400px;overflow-y:auto;margin-bottom:10px;display:flex;flex-direction:column;gap:8px">
        </div>
        <div style="display:flex;gap:6px">
          <input type="text" id="log-chat-input" placeholder="Ask about research findings..." style="flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px" onkeydown="if(event.key==='Enter')sendLogChat()">
          <select id="log-chat-model" style="padding:6px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:12px;width:120px">
            <option value="glm-5">üß† SAGE</option>
            <option value="claude-sonnet-4-6">üîµ SENTINEL</option>
            <option value="codex">üü¢ FORGE</option>
          </select>
          <button class="btn btn-s" onclick="sendLogChat()" style="padding:6px 14px">Send</button>
        </div>
      </div>
      <!-- Quick Stats -->
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Research Stats</div>
        <div id="log-stats" class="text-sm" style="line-height:1.8">
          <div>Loading...</div>
        </div>
      </div>
      <!-- Quick actions -->
      <div class="card" style="margin-top:12px">
        <div style="font-weight:600;margin-bottom:8px">Quick Actions</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn btn-s" onclick="addLogNote()" style="padding:6px 12px;text-align:left">+ Add Note</button>
          <button class="btn btn-s" onclick="loadLogs();toast('Logs refreshed')" style="padding:6px 12px;text-align:left">Refresh All</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<!-- ‚ïê‚ïê‚ïê CONSOLE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-console">
  <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:16px">
    <div style="font-weight:600;margin-bottom:6px">üí° NEXUS Console ‚Äî How to use</div>
    <div class="text-sm text-muted" style="line-height:1.7">
      <b>Process Monitor</b>: Shows running NEXUS processes (Dashboard, Brain Loop, Research). Use Start/Stop buttons to control them.<br>
      <b>Log Viewer</b>: Switch between Dashboard/Brain logs to debug issues. Auto-refresh every 3s when enabled.<br>
      <b>Quick Commands</b>: Run a backtest, start brain loop, or trigger research from this panel.<br>
      <b>Phase Timeline</b>: Historical milestones of NEXUS development.
    </div>
  </div>
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">‚öôÔ∏è NEXUS Console ‚Äî Live Process Control</div>
    <div class="row">
      <button class="btn btn-s btn-sm" onclick="refreshConsole()">‚Üª Refresh</button>
    </div>
  </div>
  <div class="console-wrap">
    <!-- Left panel: processes + controls -->
    <div style="display:flex;flex-direction:column;gap:14px;overflow-y:auto">
      <!-- System Status -->
      <div class="card">
        <div class="ctitle">üñ• System Status</div>
        <div id="sys-status"><div class="empty">Loading...</div></div>
      </div>
      <!-- Running Processes -->
      <div class="card">
        <div class="ctitle">üîÑ Active Processes
          <span id="proc-count" class="bdg bg-g" style="font-size:10px">0</span>
        </div>
        <div class="proc-list" id="proc-list"><div class="empty">Loading...</div></div>
      </div>
      <!-- Quick Controls -->
      <div class="card">
        <div class="ctitle">üéÆ Control Panel</div>
        <div style="font-size:11px;color:var(--fg-muted);margin-bottom:8px">Start / stop NEXUS processes:</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <button class="ctrl-btn" onclick="ctrlAction('start','brain')">‚ñ∂ Start Brain</button>
          <button class="ctrl-btn danger" onclick="ctrlAction('stop','brain')">‚èπ Stop Brain</button>
          <button class="ctrl-btn" onclick="ctrlAction('start','research')">‚ñ∂ Start Research</button>
          <button class="ctrl-btn danger" onclick="ctrlAction('stop','research')">‚èπ Stop Research</button>
          <button class="ctrl-btn" onclick="ctrlAction('restart','brain')">‚Ü∫ Restart Brain</button>
          <button class="ctrl-btn" onclick="ctrlAction('restart','research')">‚Ü∫ Restart Research</button>
        </div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:11px;color:var(--fg-muted);margin-bottom:6px">Run backtest:</div>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="backtest-cfg" style="flex:1;font-size:11px;padding:4px 6px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--fg)">
              <option value="configs/run_synthetic_funding.json">Synthetic Funding</option>
              <option value="configs/run_binance_v1_full_2023_2025.json">V1 Full 2023-2025</option>
              <option value="configs/run_binance_nexus_alpha_v1_2025ytd.json">V1 2025 YTD</option>
              <option value="configs/run_binance_v1_2022_bear.json">V1 2022 Bear</option>
            </select>
            <button class="ctrl-btn" onclick="ctrlAction('start','backtest')">‚ñ∂ Run</button>
          </div>
        </div>
        <div id="ctrl-result" style="margin-top:8px;font-size:11px;color:var(--accent);min-height:16px"></div>
      </div>
      <!-- Phase Timeline -->
      <div class="card">
        <div class="ctitle">üìã Completed Phases</div>
        <div class="phase-timeline">
          <div class="phase-item done"><span class="phase-num">Ph 1-10</span><span>Real data, venue costs, walk-forward, risk, ML, agents</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 11</span><span>NEXUS Brain ‚Äî GLM-5 + diary + goals</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 12</span><span>RAG-lite TF-IDF + SmartRouter</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 13</span><span>Bias checker + web research tools</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 14</span><span>Kanban + team reports + live market</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 29-31</span><span>OOS validation ‚Äî avg Sharpe 1.01</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 32-36</span><span>Chat, console, brain, memory curator</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 37-41</span><span>Regime-adaptive, ML Factor V3, audit</span></div>
          <div class="phase-item done"><span class="phase-num">Ph 54</span><span>V1-Long discovery ‚Äî avg OOS Sharpe 1.125</span></div>
          <div class="phase-item curr"><span class="phase-num">Ph 55-57</span><span>Param optimization + signal engineering (120+ backtests)</span></div>
        </div>
      </div>
    </div>
    <!-- Right panel: log viewer -->
    <div class="log-viewer">
      <div class="log-tabs">
        <div class="log-tab active" id="ltab-dashboard" onclick="switchLogTab('dashboard')">Dashboard</div>
        <div class="log-tab" id="ltab-brain" onclick="switchLogTab('brain')">Brain</div>
        <div class="log-tab" id="ltab-research" onclick="switchLogTab('research')">Research</div>
        <div class="log-tab" id="ltab-backtest" onclick="switchLogTab('backtest')">Backtest</div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;padding:4px 8px">
          <label style="font-size:11px;color:var(--fg-muted);display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="log-auto" checked onchange="toggleLogAuto()"> Auto
          </label>
          <button class="btn btn-s btn-sm" onclick="refreshLog()">‚Üª</button>
        </div>
      </div>
      <div class="log-body" id="log-body"><span style="color:#888">Connecting to log stream...</span></div>
      <div style="padding:6px 12px;border-top:1px solid var(--border);font-size:11px;color:var(--fg-muted);display:flex;justify-content:space-between">
        <span id="log-info">Lines: 0</span>
        <span id="log-updated">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const $$ = s => document.querySelectorAll(s);
function jx(url,opts){return fetch(url,opts).then(r=>{if(!r.ok)throw new Error(r.status);return r.json()});}
function set(id,v){const e=$(id);if(e)e.textContent=v;}
function html(id,h){const e=$(id);if(e)e.innerHTML=h;}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function n2(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return(+v).toFixed(d);}
function pct(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return((+v)*100).toFixed(d)+'%';}
function pctd(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return(+v).toFixed(d)+'%';}
function clr(v,pos=true){if(v==null)return'';return(pos?v>=0:v<=0)?'pos':'neg';}
function now(){return new Date().toLocaleTimeString();}
function toast(m,d=3){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d*1000);}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}

// ‚îÄ‚îÄ‚îÄ Tab system ‚îÄ‚îÄ‚îÄ
const TABS=['overview','chat','benchmark','performance','risk','research','tasks','files','market','pitch','logs','console'];
const THEME_KEY='nexus_theme';
const TABLE_STATE={};
const APP_STATE={
  liveConnected:false,
  liveSeenAt:0,
  activeRun:null,
  lastRunName:null,
  tableTimer:null,
  metricsTimer:null,
};
let _tab='overview';
function go(name){
  $$('.tab').forEach((t,i)=>{t.classList[TABS[i]===name?'add':'remove']('active');});
  $$('.page').forEach(p=>p.classList.remove('active'));
  const pg=$('page-'+name);if(pg)pg.classList.add('active');
  _tab=name;
  initCardExpansion();
  LOADERS[name]&&LOADERS[name]();
}
function isInputTarget(el){
  if(!el)return false;
  const tag=(el.tagName||'').toLowerCase();
  return tag==='input'||tag==='textarea'||tag==='select'||el.isContentEditable;
}
function setLiveStatus(state,label){
  const live=$('hdr-live');
  const liveLabel=$('live-label');
  if(live){
    live.classList.remove('connected','connecting','stale','disconnected');
    live.classList.add(state||'connecting');
  }
  if(liveLabel)liveLabel.textContent=label||'Connecting‚Ä¶';
  const dot=$('chat-sse-dot');
  if(dot)dot.className='sse-dot '+(state==='connected'?'':'yellow');
}
function setHeaderChip(id,text,cls=''){
  const el=$(id);if(!el)return;
  el.textContent=text;
  el.className='hdr-chip '+cls;
}
function applyTheme(theme){
  const t=theme==='dark'?'dark':'light';
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem(THEME_KEY,t);
  const btn=$('theme-toggle');
  if(btn)btn.textContent=t==='dark'?'‚òÄÔ∏è':'üåô';
}
function toggleTheme(){
  const current=document.documentElement.getAttribute('data-theme')||'light';
  applyTheme(current==='dark'?'light':'dark');
}
function initTheme(){
  const pref=localStorage.getItem(THEME_KEY);
  if(pref){applyTheme(pref);return;}
  const auto=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
  applyTheme(auto);
}
function animateKpiText(id,next,className){
  const el=$(id);if(!el)return;
  if(el.textContent===next&&(!className||el.className===className))return;
  el.textContent=next;
  if(className)el.className=className;
  el.classList.remove('bump');
  void el.offsetWidth;
  el.classList.add('bump');
}
function setSkeleton(id,rows=5){
  html(id,'<div>'+Array.from({length:rows}).map(()=>'<div class="skel skel-row"></div>').join('')+'</div>');
}
function attachSectionStamps(){
  $$('.card .ctitle').forEach((ct)=>{
    if(ct.querySelector('.section-stamp'))return;
    const st=document.createElement('span');
    st.className='section-stamp';
    st.textContent='Updated ‚Äî';
    ct.appendChild(st);
  });
}
function touchSection(id){
  const el=typeof id==='string'?$(id):id;
  if(!el)return;
  const card=el.closest('.card');
  if(!card)return;
  const stamp=card.querySelector('.section-stamp');
  if(stamp)stamp.textContent='Updated '+now();
}
function initCardExpansion(){
  $$('.card').forEach(card=>{
    if(card.dataset.expandReady==='1')return;
    const title=card.querySelector('.ctitle');
    if(!title)return;
    card.dataset.expandReady='1';
    card.classList.add('expandable');
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='card-expand-btn';
    btn.title='Expand card';
    btn.textContent='‚§¢';
    btn.onclick=(e)=>{
      e.stopPropagation();
      const willExpand=!card.classList.contains('expanded');
      $$('.card.expanded').forEach(c=>{
        c.classList.remove('expanded');
        const b=c.querySelector('.card-expand-btn');
        if(b)b.textContent='‚§¢';
      });
      if(willExpand){
        card.classList.add('expanded');
        btn.textContent='‚Üß';
        card.scrollIntoView({behavior:'smooth',block:'start'});
      }
    };
    title.appendChild(btn);
  });
}
function parseSortValue(s){
  const raw=(s||'').replace(/,/g,'').trim();
  const n=parseFloat(raw.replace(/[^\d.+-]/g,''));
  if(!Number.isNaN(n)&&raw.match(/[-\d.]/))return n;
  return raw.toLowerCase();
}
function applyTableState(container,table,key){
  const state=TABLE_STATE[key]||{q:'',col:-1,dir:'asc'};
  TABLE_STATE[key]=state;
  const rows=Array.from(table.tBodies[0]?.rows||[]);
  let view=rows.filter(r=>!state.q||r.textContent.toLowerCase().includes(state.q));
  if(state.col>=0){
    view=view.sort((a,b)=>{
      const av=parseSortValue(a.cells[state.col]?.innerText||'');
      const bv=parseSortValue(b.cells[state.col]?.innerText||'');
      if(av===bv)return 0;
      return(av>bv?1:-1)*(state.dir==='asc'?1:-1);
    });
  }
  view.forEach(r=>table.tBodies[0].appendChild(r));
  rows.forEach(r=>{r.style.display=view.includes(r)?'':'none';});
  const meta=container.querySelector('.table-meta');
  if(meta)meta.textContent=`${view.length}/${rows.length} rows`;
}
function makeTableInteractive(containerId,key){
  const container=$(containerId);if(!container)return;
  const table=container.querySelector('table');if(!table||!table.tBodies.length)return;
  let tools=container.querySelector(':scope > .table-tools');
  if(!tools){
    tools=document.createElement('div');
    tools.className='table-tools';
    tools.innerHTML=`<input class="table-search" placeholder="Search..." /><span class="table-meta"></span>`;
    container.insertBefore(tools,table);
    const inp=tools.querySelector('.table-search');
    inp.addEventListener('input',()=>{
      TABLE_STATE[key]=TABLE_STATE[key]||{q:'',col:-1,dir:'asc'};
      TABLE_STATE[key].q=(inp.value||'').toLowerCase().trim();
      applyTableState(container,table,key);
    });
  }
  const state=TABLE_STATE[key]||{q:'',col:-1,dir:'asc'};
  TABLE_STATE[key]=state;
  const inp=tools.querySelector('.table-search');
  if(inp&&inp.value!==state.q)inp.value=state.q||'';
  Array.from(table.tHead?.rows[0]?.cells||[]).forEach((th,idx)=>{
    th.classList.add('sortable');
    th.classList.remove('sort-asc','sort-desc');
    if(state.col===idx)th.classList.add(state.dir==='asc'?'sort-asc':'sort-desc');
    th.onclick=()=>{
      const s=TABLE_STATE[key]||{q:'',col:-1,dir:'asc'};
      if(s.col===idx)s.dir=s.dir==='asc'?'desc':'asc';
      else{s.col=idx;s.dir='asc';}
      TABLE_STATE[key]=s;
      makeTableInteractive(containerId,key);
    };
  });
  applyTableState(container,table,key);
}
function initKeyboardShortcuts(){
  document.addEventListener('keydown',(e)=>{
    if(isInputTarget(e.target)||e.altKey||e.ctrlKey||e.metaKey)return;
    if(/^[1-9]$/.test(e.key)){
      const idx=+e.key-1;
      if(TABS[idx]){e.preventDefault();go(TABS[idx]);}
      return;
    }
    const k=e.key.toLowerCase();
    if(k==='r'){e.preventDefault();refresh();}
    if(k==='d'){e.preventDefault();toggleTheme();}
  });
}

// ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ
let _eq=null,_ret=null;

// ‚îÄ‚îÄ‚îÄ KPI ‚îÄ‚îÄ‚îÄ
let _sharpe=null;
function loadKPI(){
  jx('/api/metrics').then(d=>{
    // metrics.json has nested structure: d.summary.sharpe, d.meta.*, d.verdict.*
    const m=d.summary||d.metrics||d||{};
    const meta=d.meta||{};
    _sharpe=+(m.sharpe_ratio||m.sharpe||0);
    animateKpiText('k-sharpe',n2(_sharpe),'kpi-v '+(_sharpe>=1.5?'pos':_sharpe>=0.6?'neu':'neg'));
    const ca=+(m.cagr||m.annualized_return||0);
    animateKpiText('k-cagr',pct(ca),'kpi-v '+(ca>=0?'pos':'neg'));
    const md=+(m.max_drawdown||0);
    animateKpiText('k-mdd',pct(md),'kpi-v neg');
    const tot=+(m.total_return||0);
    animateKpiText('k-tot',pct(tot),'kpi-v '+(tot>=0?'pos':'neg'));
    set('k-wr',pct(m.win_rate));
    set('k-strat',meta.strategy_name||m.strategy_name||m.run_name||d.run_name||'‚Äî');
    set('kpi-updated','Updated '+now());
    // Header badge
    // verdict: check d.verdict.pass (nested), or derive from Sharpe
    const vObj=d.verdict||{};
    const vPass=vObj.pass;
    const v=m.strategy_verdict||(vPass===true?'PASS':vPass===false?'FAIL':(_sharpe>=1.5?'GOOD':_sharpe>=0.6?'OK':'WEAK'));
    const b=$('hdr-badge');b.textContent=v;
    b.className='bdg '+(v==='GOOD'||v==='PASS'?'bg-g':v==='OK'||v==='WARN'?'bg-y':'bg-r');
    setHeaderChip('hc-sharpe','Sharpe '+n2(_sharpe),_sharpe>=1.5?'pos':_sharpe>=0.6?'neu':'neg');
    setHeaderChip('hc-pnl','PnL '+pct(tot),tot>=0?'pos':'neg');
    setHeaderChip('hc-status','Status '+v,v==='GOOD'||v==='PASS'?'pos':v==='OK'||v==='WARN'?'neu':'neg');
    // Update targets
    updateTargets(_sharpe);
    touchSection('eq-chart-wrap');
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Equity chart ‚îÄ‚îÄ‚îÄ
function chartFill(canvas,start,end){
  const c=canvas.getContext('2d');
  const g=c.createLinearGradient(0,0,0,canvas.height||240);
  g.addColorStop(0,start);
  g.addColorStop(1,end);
  return g;
}
function loadEq(){
  jx('/api/equity').then(d=>{
    const eq=d.equity_curve||d.equity||[];if(!eq.length)return;
    const vals=eq.map(e=>typeof e==='object'?(e.value||e.equity||e[1]||1):+e);
    const ctx=$('eq-chart');if(!ctx)return;
    const fill=chartFill(ctx,'rgba(37,99,235,.24)','rgba(37,99,235,0)');
    if(_eq){_eq.destroy();}
    _eq=new Chart(ctx,{
      type:'line',
      data:{labels:vals.map((_,i)=>i),datasets:[{label:'Equity',data:vals,borderColor:'#2563EB',backgroundColor:fill,fill:true,pointRadius:0,tension:.34,borderWidth:2.2}]},
      options:{
        responsive:true,maintainAspectRatio:false,
        animation:{duration:700,easing:'easeOutQuart'},
        plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},
        scales:{
          x:{title:{display:true,text:'Bars'},ticks:{maxTicksLimit:8,font:{size:10}}},
          y:{grid:{color:'rgba(148,163,184,.18)'},title:{display:true,text:'Portfolio Value'},ticks:{font:{size:10}}}
        }
      }
    });
    touchSection('eq-chart-wrap');
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Learning Progress Chart ‚îÄ‚îÄ‚îÄ
let _prog=null;
function loadProgress(){
  jx('/api/progress').then(d=>{
    const days=d.daily||[];
    if(!days.length){html('progress-stats','No runs yet');return;}
    const labels=days.map(e=>e.date);
    const champ=days.map(e=>e.champion_sharpe||null);
    const daily=days.map(e=>e.max_sharpe||null);
    const ctx=$('progress-chart');if(!ctx)return;
    const fill=chartFill(ctx,'rgba(37,99,235,.2)','rgba(37,99,235,0)');
    if(_prog){_prog.destroy();}
    _prog=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'Champion Sharpe',data:champ,borderColor:'#2563EB',backgroundColor:fill,fill:true,pointRadius:2,tension:.32,borderWidth:2},
          {label:'Daily Best',data:daily,borderColor:'#10B981',backgroundColor:'transparent',pointRadius:2,tension:.3,borderWidth:1.5,borderDash:[4,2]},
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        animation:{duration:650,easing:'easeOutQuart'},
        plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},
        scales:{
          x:{ticks:{font:{size:9},maxTicksLimit:10},title:{display:true,text:'Date'}},
          y:{grid:{color:'rgba(148,163,184,.18)'},title:{display:true,text:'Sharpe'}}
        }
      }
    });
    const best=d.best_ever_sharpe;
    html('progress-stats',`Total runs: <b>${d.total_runs}</b> ¬∑ Best ever Sharpe: <b class="${best>=1.5?'pos':best>=0.6?'neu':'neg'}">${(best||0).toFixed(3)}</b> ¬∑ Days tracked: <b>${days.length}</b>`);
    touchSection('progress-stats');
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Overview ‚îÄ‚îÄ‚îÄ
function loadOvRun(){
  jx('/api/runs').then(d=>{
    const r=(d.runs||d||[])[0];
    if(!r){html('ov-run','<div class="empty">No runs</div>');return;}
    APP_STATE.lastRunName=r.run_name||r.name||APP_STATE.lastRunName;
    const m=r.metrics||{};
    html('ov-run',`
      <div class="srow"><span class="lbl">Run</span><span class="val text-sm">${esc(r.run_name||r.name||'‚Äî').slice(0,30)}</span></div>
      <div class="srow"><span class="lbl">Sharpe</span><span class="val ${clr(m.sharpe||m.sharpe_ratio)}">${n2(m.sharpe||m.sharpe_ratio)}</span></div>
      <div class="srow"><span class="lbl">CAGR</span><span class="val ${clr(m.cagr)}">${pct(m.cagr)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(m.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Calmar</span><span class="val">${n2(m.calmar)}</span></div>
    `);
    touchSection('ov-run');
  }).catch(()=>{html('ov-run','<div class="empty">No data</div>');});
}
function loadOvBrain(){
  jx('/api/brain/identity').then(d=>{
    const id=d.identity||d||{};
    html('ov-brain',`
      <div class="srow"><span class="lbl">Name</span><span class="val">${esc(id.name||'NEXUS')}</span></div>
      <div class="srow"><span class="lbl">Role</span><span class="val text-sm">${esc(id.role||'Autonomous Quant')}</span></div>
      <div class="srow"><span class="lbl">Mood</span><span class="val">${esc(id.mood||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Version</span><span class="val">${esc(id.version||'‚Äî')}</span></div>
    `);
    touchSection('ov-brain');
  }).catch(()=>{html('ov-brain','<div class="empty">Brain offline</div>');});
}
function loadOvLedger(){
  jx('/api/ledger').then(d=>{
    const evs=d.events||d.ledger||d||[];
    if(!evs.length){html('ov-ledger','<div class="empty">No events</div>');return;}
    const rows=evs.slice(0,20).map(e=>{
      const kind=(e.level||e.kind||'INFO').toUpperCase();
      const cls=kind==='ERROR'?'bg-r':kind==='WARN'?'bg-y':'bg-b';
      const message=e.event||e.message||e.msg||`${(e.kind||'event')} ${e.run_name?`¬∑ ${e.run_name}`:''}`;
      const source=e.source||e.run_name||e.run_id||'‚Äî';
      const verdict=e.verdict===true?' <span class="bdg bg-g">PASS</span>':e.verdict===false?' <span class="bdg bg-r">FAIL</span>':'';
      return `<tr>
        <td class="text-sm text-muted">${esc((e.ts||e.timestamp||'').slice(0,19).replace('T',' '))}</td>
        <td><span class="bdg ${cls}">${esc(kind)}</span></td>
        <td>${esc(message)}${verdict}</td>
        <td class="text-sm text-muted">${esc(source)}</td>
      </tr>`;
    }).join('');
    html('ov-ledger',`<table><thead><tr><th>Time</th><th>Level</th><th>Event</th><th>Source</th></tr></thead><tbody>${rows}</tbody></table>`);
    makeTableInteractive('ov-ledger','ledger');
    touchSection('ov-ledger');
  }).catch(()=>{html('ov-ledger','<div class="empty">No ledger</div>');});
}
function loadOv(){
  loadEq();loadKPI();loadProgress();
  loadOvRun();
  loadOvBrain();
  loadOvLedger();
}

// ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ
var CHAT_CTX = {};
var chatSSE = null;
var chatSseEvents = [];

function mdRender(text){
  // Code blocks
  text = text.replace(/```([\s\S]*?)```/g, function(_,c){return '<pre><code>'+c.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</code></pre>';});
  // Inline code
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Headers
  text = text.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  text = text.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  text = text.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  // Bold/italic
  text = text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g,'<em>$1</em>');
  // Tables
  text = text.replace(/\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)*)/g, function(_,hdr,body){
    var ths=hdr.split('|').filter(function(s){return s.trim();}).map(function(s){return '<th>'+s.trim()+'</th>';}).join('');
    var rows=body.trim().split('\n').filter(Boolean).map(function(r){
      var tds=r.split('|').filter(function(s){return s.trim();}).map(function(s){return '<td>'+s.trim()+'</td>';}).join('');
      return '<tr>'+tds+'</tr>';
    }).join('');
    return '<table><thead><tr>'+ths+'</tr></thead><tbody>'+rows+'</tbody></table>';
  });
  // Unordered lists
  text = text.replace(/((?:^[ \t]*[-*] .+\n?)+)/gm, function(_,block){
    var items=block.trim().split('\n').map(function(l){return '<li>'+l.replace(/^[ \t]*[-*] /,'').trim()+'</li>';}).join('');
    return '<ul>'+items+'</ul>';
  });
  // Ordered lists
  text = text.replace(/((?:^[ \t]*\d+\. .+\n?)+)/gm, function(_,block){
    var items=block.trim().split('\n').map(function(l){return '<li>'+l.replace(/^[ \t]*\d+\. /,'').trim()+'</li>';}).join('');
    return '<ol>'+items+'</ol>';
  });
  // Line breaks / paragraphs
  text = text.split('\n\n').map(function(p){
    p=p.trim();
    if(!p)return '';
    if(/^<(h[1-3]|ul|ol|pre|table)/.test(p))return p;
    return '<p>'+p.replace(/\n/g,'<br>')+'</p>';
  }).filter(Boolean).join('');
  return text;
}

function autoGrowTA(el){
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,150)+'px';
}

function chatSaveSession(){
  try{
    var msgs=[];
    document.querySelectorAll('#chat-msgs .cmsg').forEach(function(el){
      var role=el.classList.contains('u')?'u':'a';
      var bub=el.querySelector('.cbubble');
      if(bub)msgs.push({role:role,html:bub.innerHTML});
    });
    var data=JSON.stringify(msgs.slice(-50));
    sessionStorage.setItem('nexus_chat',data);
    localStorage.setItem('nexus_chat_persist',data);
  }catch(e){}
}

function chatRestoreSession(){
  try{
    var raw=sessionStorage.getItem('nexus_chat')||localStorage.getItem('nexus_chat_persist');
    if(!raw)return;
    var msgs=JSON.parse(raw);
    if(!msgs||!msgs.length)return;
    var container=$('chat-msgs');
    container.innerHTML='';
    msgs.forEach(function(m){
      var d=document.createElement('div');
      d.className='cmsg '+m.role;
      d.innerHTML='<div class="cbubble">'+m.html+'</div><div class="cmsg-footer"><span class="cts">restored</span>'+(m.role==='a'?'<button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>':'')+'</div>';
      container.appendChild(d);
    });
    container.lastChild&&container.lastChild.scrollIntoView({behavior:'smooth'});
  }catch(e){}
}

function initChatSSE(){
  var dot=$('chat-sse-dot');
  if(dot){dot.className='sse-dot '+(APP_STATE.liveConnected?'':'yellow');}
  renderSSEFeed();
}

function renderSSEFeed(){
  var feed=$('sse-feed');if(!feed)return;
  if(!chatSseEvents.length){feed.innerHTML='<div class="text-sm text-muted">No events yet</div>';return;}
  feed.innerHTML=chatSseEvents.map(function(ev){
    var cls='sse-item';
    var lvl=(ev.level||ev.type||ev.kind||'').toUpperCase();
    if(lvl==='ERROR')cls+=' err';
    else if(lvl==='WARN'||lvl==='WARNING')cls+=' warn';
    var msg=ev.event||ev.message||ev.msg||ev.kind||JSON.stringify(ev);
    var ts=(ev.ts||ev.timestamp||'').slice(11,19);
    return '<div class="'+cls+'" title="'+msg+'">'+(ts?'<span style="color:var(--fg-muted);margin-right:4px">'+ts+'</span>':'')+esc(msg).slice(0,60)+'</div>';
  }).join('');
  touchSection('bp-feed');
}

function loadChatMetrics(){
  jx('/api/metrics').then(function(m){
    var s=m.summary||m.metrics&&m.metrics.summary||{};
    var sh=s.sharpe!=null?s.sharpe:(m.sharpe!=null?m.sharpe:null);
    var cagr=s.cagr!=null?s.cagr:(m.cagr!=null?m.cagr:null);
    var mdd=s.max_drawdown!=null?s.max_drawdown:(s.mdd!=null?s.mdd:null);
    if($('lm-sharpe-is'))$('lm-sharpe-is').textContent=sh!=null?sh.toFixed(2):'‚Äî';
    // Try OOS sharpe from nested or oos key
    var oosS=m.oos_sharpe!=null?m.oos_sharpe:(m.oos&&m.oos.sharpe!=null?m.oos.sharpe:null);
    if($('lm-sharpe-oos'))$('lm-sharpe-oos').textContent=oosS!=null?oosS.toFixed(2):'1.07';
    if($('lm-cagr'))$('lm-cagr').textContent=cagr!=null?pct(cagr,1):'‚Äî';
    if($('lm-mdd'))$('lm-mdd').textContent=mdd!=null?pct(mdd,1):'‚Äî';
    if($('lm-updated'))$('lm-updated').textContent='Updated '+now();
    // Store in context
    CHAT_CTX.sharpe_is=sh;CHAT_CTX.sharpe_oos=oosS||1.07;CHAT_CTX.cagr=cagr;CHAT_CTX.mdd=mdd;
    touchSection('bp-metrics');
  }).catch(function(){});
  jx('/api/alerts').then(function(d){
    var count=(d.alerts||d||[]).length;
    if($('lm-alerts'))$('lm-alerts').textContent=count+' alert'+(count!==1?'s':'');
    CHAT_CTX.alerts=count;
  }).catch(function(){});
}

function loadChat(){
  chatRestoreSession();
  initChatSSE();
  loadChatMetrics();
  if(!window._chatMetricsTimer)window._chatMetricsTimer=setInterval(loadChatMetrics,20000);
  jx('/api/brain/identity').then(function(d){
    var id=d.identity||{};
    html('bp-identity','<h4>Identity</h4><div class="srow"><span class="lbl">Name</span><span class="val">'+esc(id.name||'NEXUS')+'</span></div><div class="srow"><span class="lbl">Role</span><span class="val text-sm">'+esc(id.role||'Autonomous Quant AI')+'</span></div><div class="srow"><span class="lbl">Mission</span><span class="val text-sm">'+esc((id.mission||'Research & Trade').slice(0,50))+'</span></div>');
  }).catch(function(){});
  jx('/api/brain/goals').then(function(d){
    var gs=d.goals||[];
    if(!gs.length){html('bp-goals','<h4>Goals</h4><div class="text-sm text-muted">No goals set</div>');return;}
    var items=gs.slice(0,4).map(function(g){var t=typeof g==='string'?g:(g.goal||g.text||'');return '<div style="padding:3px 0;border-bottom:1px solid var(--border);font-size:12px">'+esc(t.slice(0,70))+'</div>';}).join('');
    html('bp-goals','<h4>Goals</h4>'+items);
  }).catch(function(){});
  jx('/api/brain/notifications').then(function(d){
    var ns=d.notifications||[];var last=ns.slice(-1)[0];
    var mood=last&&last.mood||d.mood||'ü§î';
    html('bp-mood','<h4>Mood</h4><div style="font-size:24px;margin:6px 0">'+mood+'</div><div class="text-sm text-muted">'+esc(last&&last.message||'Operational')+'</div>');
    CHAT_CTX.mood=mood;
  }).catch(function(){});
}

function onChatKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}
  if(e.key==='Enter'&&(e.metaKey||e.ctrlKey)){e.preventDefault();sendMsg();}
}

function chip(t){$('chat-in').value=t;autoGrowTA($('chat-in'));sendMsg();}

function addMsg(role,text){
  var ts=now();var d=document.createElement('div');
  d.className='cmsg '+role;
  var bubbleContent=role==='a'?mdRender(text):('<p>'+esc(text).replace(/\n/g,'<br>')+'</p>');
  var copyBtn=role==='a'?'<button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>':'';
  var modelSpan=role==='a'?'<span class="cts" style="margin-left:4px;opacity:1;font-size:9px;color:var(--fg-light)">'+(document.getElementById('model-select')?.options[document.getElementById('model-select')?.selectedIndex]?.text||'AI')+'</span>':'';
  d.innerHTML='<div class="cbubble">'+bubbleContent+'</div><div class="cmsg-footer"><span class="cts">'+ts+'</span>'+modelSpan+copyBtn+'</div>';
  $('chat-msgs').appendChild(d);
  d.scrollIntoView({behavior:'smooth'});
  chatSaveSession();
  return d;
}

function buildCtxPrefix(){
  var parts=[];
  parts.push('[NEXUS System Context ‚Äî NOT shown to user]');
  if(CHAT_CTX.sharpe_is!=null)parts.push('Champion IS 2024 Sharpe: '+CHAT_CTX.sharpe_is.toFixed(2));
  parts.push('Honest OOS 2023 Sharpe: '+(CHAT_CTX.sharpe_oos||'1.07'));
  if(CHAT_CTX.cagr!=null)parts.push('CAGR: '+CHAT_CTX.cagr.toFixed(1)+'%');
  if(CHAT_CTX.mdd!=null)parts.push('MDD: '+CHAT_CTX.mdd.toFixed(1)+'%');
  if(CHAT_CTX.alerts!=null)parts.push('Active alerts: '+CHAT_CTX.alerts);
  if(chatSseEvents.length){
    parts.push('Last SSE events: '+chatSseEvents.slice(0,3).map(function(e){return e.event||e.message||'';}).filter(Boolean).join(' | '));
  }
  parts.push('[End context]');
  return parts.join('; ');
}

function _sendMsgNormal(txt, inp){
  if(!txt)return;
  if(inp){inp.value='';inp.style.height='40px';}
  var ty=document.createElement('div');ty.className='cmsg a';ty.id='typing';
  ty.innerHTML='<div class="cbubble"><div class="spin"></div> Thinking...</div>';
  $('chat-msgs').appendChild(ty);ty.scrollIntoView({behavior:'smooth'});
  var ctxMsg=buildCtxPrefix()+' USER: '+txt;
  jx('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:ctxMsg,raw_user:txt,model:document.getElementById('model-select').value||'glm-5'})}).then(function(d){
    var el=$('typing');if(el)el.remove();
    addMsg('a',d.response||d.reply||d.message||'(no response)');
  }).catch(function(){var el=$('typing');if(el)el.remove();addMsg('a','Error connecting to NEXUS Brain. Ensure ZAI_API_KEY is set and dashboard is running with env vars.');});
}

function copyLastAI(){
  var bubbles=document.querySelectorAll('#chat-msgs .cmsg.a .cbubble');
  if(!bubbles.length){toast('No AI message to copy');return;}
  var last=bubbles[bubbles.length-1];
  var text=last.innerText||last.textContent||'';
  navigator.clipboard&&navigator.clipboard.writeText(text).then(function(){toast('Copied!');}).catch(function(){});
}

function copyBubble(btn){
  var bub=btn.closest('.cmsg').querySelector('.cbubble');
  if(!bub)return;
  var text=bub.innerText||bub.textContent||'';
  navigator.clipboard&&navigator.clipboard.writeText(text).then(function(){toast('Copied!');}).catch(function(){});
}

function onModelChange() {
  const sel = document.getElementById('model-select');
  const badge = document.getElementById('chat-model-badge');
  const labels = {
    'glm-5': 'SAGE',
    'claude-sonnet-4-6': 'SENTINEL',
    'claude-opus-4-6': 'NEXUS PRIME',
    'codex': 'FORGE',
    'minimax-2.5': 'SCOUT',
  };
  if (badge) badge.textContent = labels[sel.value] || sel.value;
}
function clearChat(){
  $('chat-msgs').innerHTML='';
  localStorage.removeItem('nexus_chat_history');
  sessionStorage.removeItem('nexus_chat');
  addMsg('a','Chat cleared. How can I help you?');
}
function _saveChatHistory(){
  try{
    const msgs=[...$('chat-msgs').querySelectorAll('[data-role]')].map(el=>({role:el.dataset.role,text:el.querySelector('.msg-text')?.textContent||''}));
    localStorage.setItem('nexus_chat_history',JSON.stringify(msgs.slice(-50)));
  }catch(e){}
}
function _loadChatHistory(){
  try{
    const saved=JSON.parse(localStorage.getItem('nexus_chat_history')||'[]');
    if(saved.length){saved.forEach(m=>addMsg(m.role,m.text));return true;}
  }catch(e){}
  return false;
}
// ‚îÄ‚îÄ‚îÄ Benchmark ‚îÄ‚îÄ‚îÄ
const TARGETS=[0.6,1.5,2.5,5.0];
const BM_DATA=[
  {name:'S&P 500 (SPY)',sharpe:0.73,cagr:23.1,mdd:-8.5,note:'2024 actual'},
  {name:'Bitcoin B&H',sharpe:1.47,cagr:125.0,mdd:-28.0,note:'2024 actual'},
  {name:'Ethereum B&H',sharpe:0.62,cagr:50.3,mdd:-35.0,note:'2024 actual'},
  {name:'Renaissance Medallion (net)',sharpe:3.8,cagr:39.0,mdd:-4.0,note:'estimated'},
  {name:'60/40 Portfolio',sharpe:0.55,cagr:15.2,mdd:-10.0,note:'typical'},
  {name:'Simple Funding Carry',sharpe:0.90,cagr:12.0,mdd:-18.0,note:'baseline est.'},
];
function updateTargets(sh){
  if(sh==null)return;
  ['tc1','tc2','tc3','tc4'].forEach((id,i)=>{
    const tgt=TARGETS[i];
    const pct2=Math.min(100,Math.max(0,(sh/tgt)*100));
    const ok=sh>=tgt;
    const card=$(id);const bar=$('tp'+(i+1));const bdg=$('tb'+(i+1));const cur=$('tc'+(i+1)+'-v');
    if(cur)cur.textContent=n2(sh);
    if(bar){bar.style.width=pct2+'%';bar.className='pfill '+(ok?'g':pct2>50?'b':'y');}
    if(bdg){bdg.textContent=ok?'‚úì ACHIEVED':pct2>50?'IN PROGRESS':'PENDING';bdg.className='bdg '+(ok?'bg-g':pct2>50?'bg-b':'bg-gray');}
    if(card){card.className='tcard '+(ok?'achieved':pct2>30?'near':'');}
  });
  // Badges
  $$('.ach').forEach((el,i)=>{
    const ok=sh>=TARGETS[i];
    el.style.opacity=ok?'1':'0.35';el.style.borderStyle=ok?'solid':'dashed';
    el.style.borderColor=ok?'var(--green)':'var(--border)';
  });
}
function loadBM(){
  jx('/api/metrics').then(d=>{
    const s=d.summary||{};
    const sh=+(s.sharpe||0);
    const cagr=+(s.cagr||0)*100;
    const mdd=+(s.max_drawdown||0)*100;
    updateTargets(sh);
    const provider=d.meta?.data_provider||'current';
    const nexus={name:`NEXUS ‚Äî ${provider}`,sharpe:sh,cagr,mdd:mdd,note:'live OOS'};
    const all=[nexus,...BM_DATA];
    const rows=all.map((bm,i)=>{
      const isN=i===0;
      const sc=bm.sharpe;
      const vs=isN?'‚Äî':(sh>bm.sharpe?'<span class="bdg bg-g" style="font-size:11px">‚úì WINNING</span>':'<span class="bdg bg-r" style="font-size:11px">‚úó BEHIND</span>');
      const sc_cls=sc>=1.5?'pos':sc>=0.6?'':'neg';
      return `<tr>
        <td><b>${esc(bm.name)}</b>${isN?' <span class="bdg bg-b">NEXUS</span>':''}</td>
        <td class="${isN?(sh>=1.5?'pos':sh>=0.6?'':'neg'):sc_cls}"><b>${n2(bm.sharpe)}</b></td>
        <td class="${bm.cagr>=0?'pos':'neg'}">${n2(bm.cagr,1)}%</td>
        <td class="neg">${n2(Math.abs(bm.mdd),1)}%</td>
        <td>${vs}</td>
        <td class="text-sm text-muted">${esc(bm.note||'')}</td>
      </tr>`;
    }).join('');
    html('bm-table',`<table><thead><tr><th>Strategy</th><th>Sharpe</th><th>CAGR</th><th>Max DD</th><th>vs NEXUS</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`);
    makeTableInteractive('bm-table','benchmark');
    touchSection('bm-table');
  }).catch(()=>{html('bm-table','<div class="empty">Run a backtest first to see comparison</div>');});
}

// ‚îÄ‚îÄ‚îÄ Performance ‚îÄ‚îÄ‚îÄ
function loadRunsHistory(){
  setSkeleton('runs-table',6);
  jx('/api/runs_history?limit=80').then(rows=>{
    const arr=rows||[];
    if(!arr.length){html('runs-table','<div class="empty">No backtest history yet</div>');return;}
    const body=arr.map((r,i)=>{
      const verdict=r.verdict_pass?'<span class="bdg bg-g">PASS</span>':'<span class="bdg bg-r">FAIL</span>';
      const bias=r.bias_likely_overfit?'<span class="bdg bg-r">Bias</span>':'<span class="bdg bg-g">Clean</span>';
      return `<tr>
        <td>${i+1}</td>
        <td class="text-sm">${esc(r.run_name||r.run_id||'‚Äî')}</td>
        <td>${esc(r.year||'‚Äî')}</td>
        <td class="${clr(r.sharpe)}"><b>${n2(r.sharpe,3)}</b></td>
        <td>${pct(r.cagr)}</td>
        <td class="neg">${pct(r.max_drawdown)}</td>
        <td>${n2(r.calmar,2)}</td>
        <td>${pct(r.win_rate)}</td>
        <td>${verdict}</td>
        <td>${bias}</td>
      </tr>`;
    }).join('');
    html('runs-table',`<table><thead><tr><th>#</th><th>Run</th><th>Year</th><th>Sharpe</th><th>CAGR</th><th>MDD</th><th>Calmar</th><th>Win Rate</th><th>Verdict</th><th>Bias</th></tr></thead><tbody>${body}</tbody></table>`);
    makeTableInteractive('runs-table','runs');
    touchSection('runs-table');
  }).catch(()=>html('runs-table','<div class="empty">Run history unavailable</div>'));
}
function loadPerf(){
  jx('/api/metrics').then(d=>{
    const s=d.summary||{};
    const wf=d.walk_forward||{};
    const stats=[
      ['Sharpe Ratio',n2(s.sharpe,3),clr(s.sharpe)],
      ['Sortino Ratio',n2(s.sortino,3),''],
      ['Calmar Ratio',n2(s.calmar,3),''],
      ['CAGR',pct(s.cagr),clr(s.cagr)],
      ['Total Return',pct(s.total_return),clr(s.total_return)],
      ['Max Drawdown',pct(s.max_drawdown),'neg'],
      ['Win Rate',pct(s.win_rate),''],
      ['Periods',s.periods||'‚Äî',''],
      ['Avg Turnover',pct(s.turnover_avg),''],
      ['Annual Vol',pct(s.volatility),''],
    ];
    // Add walk-forward summary stats
    const wfStab=wf.stability||{};
    const wfStats=[
      ['WF Windows',wf.stability?.windows||'‚Äî',''],
      ['WF Profitable %',wfStab.fraction_profitable!=null?pct(wfStab.fraction_profitable):'‚Äî',''],
      ['WF MDD<35% %',wfStab.fraction_mdd_lt_0_35!=null?pct(wfStab.fraction_mdd_lt_0_35):'‚Äî',''],
    ];
    html('pf-stats',[...stats,...wfStats].map(([l,v,c])=>`<div class="srow"><span class="lbl">${l}</span><span class="val ${c}">${v}</span></div>`).join(''));
    touchSection('pf-stats');
  }).catch(()=>{html('pf-stats','<div class="empty">No data ‚Äî run a backtest first</div>');});
  jx('/api/walk_forward').then(d=>{
    const wf=d.windows||d.walk_forward||[];
    if(!wf.length){html('wf-body','<div class="empty">No walk-forward data</div>');return;}
    const rows=wf.map((w,i)=>`<tr>
      <td>${i+1}</td>
      <td>${esc((w.start||w.train_start||'').slice(0,10))}</td>
      <td>${esc((w.end||w.test_end||'').slice(0,10))}</td>
      <td class="${clr(w.sharpe||w.oos_sharpe)}">${n2(w.sharpe||w.oos_sharpe)}</td>
      <td>${n2(w.calmar||w.oos_calmar)}</td>
      <td class="neg">${pct(w.max_drawdown||w.oos_mdd)}</td>
      <td>${esc(w.regime||'‚Äî')}</td>
    </tr>`).join('');
    html('wf-body',`<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>OOS Sharpe</th><th>Calmar</th><th>Max DD</th><th>Regime</th></tr></thead><tbody>${rows}</tbody></table>`);
    makeTableInteractive('wf-body','walkforward');
    touchSection('wf-body');
  }).catch(()=>{html('wf-body','<div class="empty">No walk-forward</div>');});
  jx('/api/equity').then(d=>{
    const eq=d.equity_curve||d.equity||[];if(eq.length<2)return;
    const vals=eq.map(e=>typeof e==='object'?(e.value||e.equity||1):+e);
    const rets=vals.slice(1).map((v,i)=>(v/vals[i]-1)*100);
    const mn=Math.min(...rets),mx=Math.max(...rets);
    const B=20;const step=(mx-mn)/B;
    const counts=new Array(B).fill(0);
    rets.forEach(r=>{const b=Math.min(B-1,Math.floor((r-mn)/step));counts[b]++;});
    const labs=counts.map((_,i)=>(mn+i*step).toFixed(1)+'%');
    const ctx=$('ret-chart');if(!ctx)return;
    if(_ret){_ret.destroy();}
    _ret=new Chart(ctx,{
      type:'bar',
      data:{labels:labs,datasets:[{label:'Freq',data:counts,backgroundColor:labs.map(l=>+l>=0?'rgba(22,163,74,.7)':'rgba(220,38,38,.7)'),borderRadius:2}]},
      options:{
        responsive:true,maintainAspectRatio:false,
        animation:{duration:650,easing:'easeOutQuart'},
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{maxTicksLimit:8,font:{size:10}},title:{display:true,text:'Hourly Return Bucket'}},
          y:{grid:{color:'rgba(148,163,184,.18)'},title:{display:true,text:'Frequency'}}
        }
      }
    });
    touchSection('ret-chart');
  }).catch(()=>{});
  loadRunsHistory();
}
function runVal(){
  set('val-st','Running...');html('val-body','<div class="empty"><div class="spin"></div> Running 8 tests...</div>');
  jx('/api/validation/run',{method:'POST'}).then(d=>{
    set('val-st','');
    const r=d.results||d||{};
    const v=r.overall_verdict||d.verdict||'‚Äî';
    const ts=r.tests||[];
    const vc=v==='PASS'?'bg-g':v==='WARN'?'bg-y':'bg-r';
    let h=`<div class="row mb"><span class="bdg ${vc}" style="font-size:14px">${v}</span><span class="text-sm text-muted">${ts.length} tests</span></div>`;
    if(ts.length){
      const rows=ts.map(t=>`<tr><td>${esc(t.name||'')}</td><td><span class="bdg ${t.verdict==='PASS'?'bg-g':t.verdict==='WARN'?'bg-y':'bg-r'}">${t.verdict||'‚Äî'}</span></td><td>${n2(t.sharpe||t.is_sharpe)}</td><td>${n2(t.oos_sharpe)}</td><td class="text-sm text-muted">${esc(t.notes||t.note||'')}</td></tr>`).join('');
      h+=`<table><thead><tr><th>Test</th><th>Verdict</th><th>IS Sharpe</th><th>OOS Sharpe</th><th>Notes</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    html('val-body',h);toast('Validation done: '+v);
  }).catch(e=>{set('val-st','');html('val-body','<div class="empty">Error: '+esc(String(e))+'</div>');});
}

// ‚îÄ‚îÄ‚îÄ Risk ‚îÄ‚îÄ‚îÄ
function loadRisk(){
  jx('/api/risk').then(d=>{
    const r=d.risk||d||{};
    html('risk-var',`
      <div class="srow"><span class="lbl">VaR 95%</span><span class="val neg">${pct(r.var_95||r.VaR_95)}</span></div>
      <div class="srow"><span class="lbl">VaR 99%</span><span class="val neg">${pct(r.var_99||r.VaR_99)}</span></div>
      <div class="srow"><span class="lbl">CVaR 95%</span><span class="val neg">${pct(r.cvar_95||r.CVaR_95)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(r.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Gross Lev</span><span class="val">${n2(r.gross_leverage||r.current_leverage)}x</span></div>
    `);
    const reg=r.regime||r.market_regime||'‚Äî';
    const rc=reg==='trending'?'bg-g':reg==='volatile'||reg==='crash'?'bg-r':'bg-y';
    html('risk-regime',`
      <div style="text-align:center;padding:16px 0"><span class="bdg ${rc}" style="font-size:15px;padding:7px 18px">${esc(reg.toUpperCase())}</span></div>
      <div class="srow"><span class="lbl">Vol Regime</span><span class="val">${esc(r.vol_regime||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Trend Score</span><span class="val">${n2(r.trend_score)}</span></div>
    `);
    html('risk-limits',`
      <div class="srow"><span class="lbl">Max DD Limit</span><span class="val">${pct(r.max_drawdown_limit)}</span></div>
      <div class="srow"><span class="lbl">Max Gross Lev</span><span class="val">${n2(r.max_gross_leverage,1)}x</span></div>
      <div class="srow"><span class="lbl">Max/Symbol</span><span class="val">${pct(r.max_position_per_symbol)}</span></div>
      <div class="srow"><span class="lbl">Max Turnover</span><span class="val">${pct(r.max_turnover_per_rebalance)}</span></div>
    `);
    const pos=r.positions||r.position_detail||{};
    const prows=Object.entries(pos).map(([s,p])=>`<tr><td><b>${esc(s)}</b></td><td class="${clr(p.weight)}">${pctd((p.weight||0)*100)}</td><td>${n2(p.volatility,4)}</td><td class="${clr(p.pnl||p.return)}">${pct(p.pnl||p.return)}</td></tr>`).join('');
    html('risk-detail',prows?`<table><thead><tr><th>Symbol</th><th>Weight</th><th>Vol</th><th>PnL</th></tr></thead><tbody>${prows}</tbody></table>`:'<div class="empty">No position data</div>');
  }).catch(()=>{['risk-var','risk-regime','risk-limits','risk-detail'].forEach(id=>html(id,'<div class="empty">No risk data. Run a backtest.</div>'));});
}

// ‚îÄ‚îÄ‚îÄ Research ‚îÄ‚îÄ‚îÄ
function loadResearch(){
  // Load debate history as main research content
  jx('/api/debate_history').then(d=>{
    const debates=Array.isArray(d)?d:(d.debates||d.history||[]);
    if(debates.length){
      html('rc-proposals',debates.slice(0,5).map((db,i)=>{
        const contribs=db.contributions||db.rounds||[];
        const score=db.consensus_score!=null?(+(db.consensus_score)*100).toFixed(0)+'%':'‚Äî';
        const ts=(db.timestamp||db.ts||'').slice(0,16).replace('T',' ');
        return `<div class="card mb" style="margin-bottom:8px">
          <div class="rowb mb"><b class="text-sm">‚öîÔ∏è Debate: ${esc(db.topic||'Analysis')}</b><span class="bdg bg-b">Consensus: ${score}</span></div>
          <div class="text-sm text-muted" style="margin-bottom:4px">${ts} ¬∑ ${contribs.length} contributions</div>
          ${db.synthesis?`<div class="text-sm" style="border-left:3px solid var(--accent);padding-left:8px;margin-top:4px">${esc((db.synthesis||'').slice(0,200))}${db.synthesis?.length>200?'‚Ä¶':''}</div>`:''}
        </div>`;
      }).join(''));
    } else {
      html('rc-proposals','<div class="empty">No debate history yet. Use ‚öîÔ∏è Debate mode in Chat tab.</div>');
    }
  }).catch(()=>html('rc-proposals','<div class="empty">No debate data</div>'));
  // Research cycle latest
  jx('/api/research_cycle/latest').then(d=>{
    const r=d.cycle||d||{};
    const ts=(r.ts||r.timestamp||'').slice(0,16).replace('T',' ');
    html('rc-latest',`
      <div class="srow"><span class="lbl">Last Run</span><span class="val">${esc(ts||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Papers</span><span class="val">${r.papers_found||r.papers||0}</span></div>
      <div class="srow"><span class="lbl">Tasks Created</span><span class="val">${r.tasks_created||r.tasks||0}</span></div>
      <div class="srow"><span class="lbl">Proposals</span><span class="val">${(r.strategy_proposals||[]).length}</span></div>
      <div class="srow"><span class="lbl">Status</span><span class="val"><span class="bdg bg-g">${esc(r.status||'OK')}</span></span></div>
    `);
    const props=r.strategy_proposals||[];
    if(props.length){
      html('rc-proposals',props.map((p,i)=>`<div class="card mb" style="margin-bottom:8px"><div class="rowb mb"><b class="text-sm">#${i+1} ${esc(p.title||p.name||'Proposal')}</b><span class="bdg bg-b">${esc(p.strategy||'strategy')}</span></div><div class="text-sm text-muted">${esc(p.description||p.rationale||'')}</div></div>`).join(''));
    }
  }).catch(()=>{html('rc-latest','<div class="empty">No research cycle run yet. Click "Run Now" to start.</div>');});
  jx('/api/alerts').then(d=>{
    const al=d.alerts||[];
    if(!al.length){html('rc-alerts','<div class="empty">No alerts</div>');return;}
    html('rc-alerts',al.slice(0,8).map(a=>`<div class="srow"><span class="bdg ${a.level==='ERROR'?'bg-r':a.level==='WARN'?'bg-y':'bg-b'}">${esc(a.level||'INFO')}</span><span class="text-sm" style="flex:1">${esc(a.message||a.msg||'')}</span><span class="text-sm text-muted">${esc((a.ts||'').slice(11,16))}</span></div>`).join(''));
  }).catch(()=>{html('rc-alerts','<div class="empty">No alerts</div>');});
}
function runResearch(){
  set('rc-st','Running...');
  jx('/api/research_cycle/run',{method:'POST'}).then(d=>{set('rc-st','Done at '+now());loadResearch();toast('Research cycle complete!');}).catch(()=>set('rc-st','Error'));
}
function searchMem(){
  const q=$('mem-q').value.trim();if(!q)return;
  html('mem-results','<div class="spin"></div> Searching...');
  jx('/api/brain/search?q='+encodeURIComponent(q)).then(d=>{
    const rs=d.results||[];
    if(!rs.length){html('mem-results','<div class="empty">No results for "'+esc(q)+'"</div>');return;}
    html('mem-results',rs.slice(0,6).map(r=>`<div style="padding:5px 0;border-bottom:1px solid var(--border)"><div class="text-sm" style="font-weight:500">${esc(r.title||r.key||'')}</div><div class="text-sm text-muted">${esc((r.snippet||r.content||r.value||'').slice(0,120))}</div></div>`).join(''));
  }).catch(()=>html('mem-results','<div class="empty">Search error</div>'));
}
function runAgent(name){
  set('agent-res','Running '+name.toUpperCase()+'...');
  jx('/api/agents/run?agent='+name,{method:'POST'}).then(d=>{set('agent-res',(d.result||d.message||'Done').slice(0,100));toast(name.toUpperCase()+' complete');}).catch(()=>set('agent-res','Error: '+name));
}

// ‚îÄ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ‚îÄ
const _catIcon={research:'üî¨',practice:'‚öóÔ∏è',procedure:'ü§ñ'};
const _delIcon={human:'üë§',nexus:'ü§ñ',atlas:'‚ö°',cipher:'üõ°',echo:'üîä',flux:'üåä'};
function _taskCard(t,mini=false){
  const pc={high:'bg-r',medium:'bg-y',low:'bg-g'};
  const statusDot={todo:'#94A3B8',in_progress:'#3B82F6',review:'#F59E0B',done:'#10B981'};
  const dot=`<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${statusDot[t.status]||'#94A3B8'};margin-right:4px"></span>`;
  return `<div class="tsk" title="Click to mark done" onclick="doneTask('${esc(t.id)}')">
    <div class="tsk-title">${dot}${esc(t.title||'Untitled')}</div>
    <div class="tsk-meta">
      <span class="bdg ${pc[t.priority||'medium']||'bg-gray'}">${esc(t.priority||'med')}</span>
      ${t.assignee?`<span class="bdg bg-b">${esc(t.assignee)}</span>`:''}
      ${t.delegated_by?`<span class="text-sm text-muted" style="font-size:10px">${_delIcon[t.delegated_by]||''}${esc(t.delegated_by)}</span>`:''}
    </div>
    ${!mini&&t.description?`<div class="text-sm text-muted" style="margin-top:3px;font-size:11px">${esc(t.description.slice(0,80))}</div>`:''}
  </div>`;
}
function loadTasks(){
  jx('/api/tasks').then(d=>{
    const tasks=d.tasks||[];
    // Category lanes
    const cats={research:[],practice:[],procedure:[]};
    tasks.filter(t=>t.status!=='done').forEach(t=>{
      const c=t.category||'practice';
      if(cats[c])cats[c].push(t);
      else cats.practice.push(t);
    });
    ['research','practice','procedure'].forEach(cat=>{
      set('kc-'+cat,cats[cat].length);
      html('kl-'+cat,cats[cat].map(t=>_taskCard(t)).join('')||'<div class="empty" style="font-size:11px">No active tasks</div>');
    });
    // Classic status kanban
    const cols={todo:[],inprogress:[],review:[],done:[]};
    tasks.forEach(t=>{const s=(t.status||'todo').toLowerCase().replace(/[- ]/g,'');(cols[s]||cols.todo).push(t);});
    Object.entries(cols).forEach(([k,list])=>{
      set('kc-'+k,list.length);
      html('kl-'+k,list.map(t=>_taskCard(t,true)).join('')||'<div style="padding:8px;font-size:12px;color:var(--fg-light);text-align:center">Empty</div>');
    });
    const rows=tasks.map(t=>{
      const st=(t.status||'todo').replace(/_/g,' ');
      const pri=(t.priority||'medium');
      const priCls=pri==='high'?'bg-r':pri==='low'?'bg-g':'bg-y';
      return `<tr>
        <td class="text-sm">${esc(t.title||'Untitled')}</td>
        <td><span class="bdg bg-b">${esc(t.category||'practice')}</span></td>
        <td><span class="bdg ${priCls}">${esc(pri)}</span></td>
        <td>${esc(st)}</td>
        <td>${esc(t.assignee||'‚Äî')}</td>
        <td class="text-sm text-muted">${esc((t.delegated_by||'‚Äî'))}</td>
        <td>${t.status==='done'?'‚úÖ':'<button class="btn btn-s btn-sm" onclick="doneTask(\''+esc(t.id)+'\')">Done</button>'}</td>
      </tr>`;
    }).join('');
    html('tasks-table',rows?`<table><thead><tr><th>Title</th><th>Category</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Delegated</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>`:'<div class="empty">No tasks</div>');
    makeTableInteractive('tasks-table','tasks');
    touchSection('tasks-table');
  }).catch(()=>{
    html('kanban','<div class="empty">Could not load tasks</div>');
    html('tasks-table','<div class="empty">Could not load tasks</div>');
  });
}
function createTask(){
  const title=$('t-title').value.trim();if(!title){toast('Title required');return;}
  const body={
    title,
    priority:$('t-pri').value,
    assignee:$('t-who').value,
    description:$('t-desc').value.trim(),
    status:'todo',
    category:$('t-cat').value,
    delegated_by:$('t-delegated').value,
  };
  jx('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
    .then(()=>{$('t-title').value='';$('t-desc').value='';loadTasks();toast('Task created');})
    .catch(()=>toast('Error creating task'));
}
function doneTask(id){
  jx('/api/tasks/'+id+'/status',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'done'})})
    .then(()=>{loadTasks();toast('Task marked done');})
    .catch(()=>jx('/api/tasks/'+id,{method:'DELETE'}).then(()=>{loadTasks();toast('Task removed');}));
}

// ‚îÄ‚îÄ‚îÄ Files ‚îÄ‚îÄ‚îÄ
function loadFiles(){
  setSkeleton('files-body',8);
  jx('/api/files').then(d=>{
    const secs=d.sections||[];
    if(!secs.length){html('files-body','<div class="empty">No artifacts found</div>');return;}
    let h='';
    secs.forEach(sec=>{
      const icon=sec.icon||'üìÑ';
      const items=sec.items||[];
      h+=`<div class="file-section"><div class="file-section-hdr">${icon} ${esc(sec.title)} <span class="bdg bg-gray">${items.length}</span></div>`;
      if(!items.length){h+='<div class="text-sm text-muted" style="padding-left:20px">Empty</div>';h+='</div>';return;}
      if(sec.type==='runs'){
        h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';
        items.forEach(it=>{
          const sc=it.sharpe!=null?(+it.sharpe>=1.5?'pos':+it.sharpe>=0.6?'':'neg'):'';
          h+=`<div class="run-item" onclick="viewRunReport('${esc(it.path)}')">
            <div class="run-name">${esc(it.name.slice(0,50))}</div>
            <div class="row gap-4" style="flex-wrap:wrap;gap:6px">
              ${it.sharpe!=null?`<span class="bdg ${+it.sharpe>=1.5?'bg-g':+it.sharpe>=0.6?'bg-b':'bg-r'}">Sharpe: ${n2(it.sharpe)}</span>`:''}
              ${it.cagr!=null?`<span class="bdg bg-gray">CAGR: ${pct(it.cagr)}</span>`:''}
              ${it.mdd!=null?`<span class="bdg bg-r">DD: ${pct(it.mdd)}</span>`:''}
            </div>
            <div class="text-sm text-muted" style="margin-top:4px">${esc(it.mtime)} ¬∑ ${(it.files||[]).join(', ').slice(0,60)}</div>
          </div>`;
        });
        h+='</div>';
      } else {
        h+='<div class="file-grid">';
        items.forEach(it=>{
          h+=`<div class="file-item" onclick="viewFile('${esc(it.path)}','${esc(it.name)}')">
            <div class="file-name">${esc(it.name)}</div>
            <div class="file-meta">${fmtSize(it.size||0)} ¬∑ ${esc(it.mtime||'‚Äî')}</div>
          </div>`;
        });
        h+='</div>';
      }
      h+='</div>';
    });
    html('files-body',h);
    filterFiles();
    touchSection('files-body');
  }).catch(e=>html('files-body','<div class="empty">Error: '+esc(String(e))+'</div>'));
}
function filterFiles(){
  const q=($('file-search')?.value||'').trim().toLowerCase();
  const sections=[...$$('#files-body .file-section')];
  let matches=0;
  sections.forEach(sec=>{
    const cards=[...sec.querySelectorAll('.file-item,.run-item')];
    let visible=0;
    cards.forEach(card=>{
      const ok=!q||card.textContent.toLowerCase().includes(q);
      card.classList[ok?'remove':'add']('hide');
      if(ok){visible++;matches++;}
    });
    sec.classList[(visible||!q)?'remove':'add']('hide');
  });
  set('files-match',q?`${matches} match${matches===1?'':'es'}`:'');
}
function viewFile(path,name){
  $('fv-path').textContent=path;
  html('fv-content','<div class="spin"></div> Loading '+esc(name)+'...');
  $('file-viewer-panel').style.display='block';
  $('file-viewer-panel').scrollIntoView({behavior:'smooth'});
  jx('/api/files/content?path='+encodeURIComponent(path)).then(d=>{
    let content=d.content||'(empty)';
    if(path.endsWith('.json')){try{content=JSON.stringify(JSON.parse(content),null,2);}catch(e){}}
    html('fv-content',esc(content));
  }).catch(e=>html('fv-content','Error: '+esc(String(e))));
}
function viewRunReport(runPath){
  viewFile(runPath+'/report.md','report.md');
}
function closeFileViewer(){$('file-viewer-panel').style.display='none';}

// ‚îÄ‚îÄ‚îÄ Market ‚îÄ‚îÄ‚îÄ
function loadMarket(){
  set('mkt-ts','Updating...');
  jx('/api/market').then(d=>{
    const items=d.market||d.data||d||[];
    const arr=Array.isArray(items)?items:Object.values(items);
    set('mkt-ts','Updated '+now());
    if(!arr.length){html('mkt-funding','<div class="empty">No data</div>');return;}
    const frows=arr.map(it=>{
      const fr=+(it.funding_rate||it.fundingRate||0);
      const frp=(fr*100).toFixed(4)+'%';
      const ann=(fr*3*365*100).toFixed(1)+'%';
      const sig=fr<-0.005?'<span class="bdg bg-g">LONG ‚Üë</span>':fr>0.005?'<span class="bdg bg-r">SHORT ‚Üì</span>':'<span class="bdg bg-gray">NEUTRAL</span>';
      return `<tr><td><b>${esc(it.symbol||it.s||'‚Äî')}</b></td><td class="${fr<0?'pos':'neg'}">${frp}</td><td>${ann}</td><td>${sig}</td><td class="text-sm text-muted">${esc((it.funding_time||it.nextFundingTime||'').toString().slice(-8,).slice(0,5)||'‚Äî')}</td></tr>`;
    }).join('');
    html('mkt-funding',`<table><thead><tr><th>Symbol</th><th>Funding Rate</th><th>Annualized</th><th>Signal</th><th>Next</th></tr></thead><tbody>${frows}</tbody></table>`);
    makeTableInteractive('mkt-funding','market_funding');
    const prows=arr.map(it=>{
      const chg=+(it.price_change_24h||it.priceChange||0);
      const price=+(it.mark_price||it.markPrice||it.price||0);
      return `<tr><td><b>${esc(it.symbol||'‚Äî')}</b></td><td>$${price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td class="${chg>=0?'pos':'neg'}">${chg.toFixed(2)}%</td><td class="text-sm text-muted">${it.open_interest||it.openInterest||'‚Äî'}</td></tr>`;
    }).join('');
    html('mkt-price',`<table><thead><tr><th>Symbol</th><th>Mark Price</th><th>24h Change</th><th>Open Interest</th></tr></thead><tbody>${prows}</tbody></table>`);
    makeTableInteractive('mkt-price','market_price');
    touchSection('mkt-price');
  }).catch(()=>{html('mkt-funding','<div class="empty">Market data unavailable</div>');set('mkt-ts','Error');});
}

// ‚îÄ‚îÄ‚îÄ Tab loader map ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ Pitch / Investor tab ‚îÄ‚îÄ‚îÄ
let _ptChart=null;
function loadPitch(){
  // Load champion metrics
  jx('/api/alpha_loop/champion').then(d=>{
    if(d.error){html('pt-sharpe','‚Äî');return;}
    const s=d.corrected_sharpe||d.summary?.sharpe||0;
    const c=d.summary?.cagr||0;
    const m=d.summary?.max_drawdown||0;
    set('pt-sharpe',(+s).toFixed(3));
    set('pt-cagr',pct(c));
    set('pt-mdd',pct(m));
  }).catch(()=>{
    // Fallback: load from metrics API
    jx('/api/metrics').then(d=>{
      const s=d.summary?.sharpe||d.sharpe||0;
      const c=d.summary?.cagr||d.cagr||0;
      const m=d.summary?.max_drawdown||d.max_drawdown||0;
      set('pt-sharpe',(+s).toFixed(3));
      set('pt-cagr',pct(c));
      set('pt-mdd',pct(m));
    }).catch(()=>{});
  });

  // Load strategy rankings
  jx('/api/alpha_loop/rankings').then(rows=>{
    if(!rows||rows.error){html('pt-rankings','<div class="empty">No rankings yet</div>');return;}
    const tbl=rows.slice(0,8).map((r,i)=>{
      const medal=['ü•á','ü•à','ü•â'][i]||`${i+1}.`;
      const sh=n2(r.corrected_sharpe||r.sharpe,3);
      const pass=r.verdict_pass?'<span class="bdg bg-g">PASS</span>':'<span class="bdg bg-r">FAIL</span>';
      return `<tr><td>${medal} ${esc(r.run_name||r.strategy||'')}</td><td><strong class="pos">${sh}</strong></td><td>${pct(r.cagr)}</td><td>${pct(r.max_drawdown)}</td><td>${pass}</td></tr>`;
    }).join('');
    html('pt-rankings',`<table><thead><tr><th>Strategy</th><th>Sharpe</th><th>CAGR</th><th>MDD</th><th>Verdict</th></tr></thead><tbody>${tbl}</tbody></table>`);
  }).catch(()=>html('pt-rankings','<div class="empty">Run a backtest first</div>'));

  // Scientific verification
  jx('/api/metrics').then(d=>{
    const v=d.verdict||{};
    const b=d.bias_check||{};
    const wf=d.walk_forward||{};
    const checks=[
      {label:'Walk-Forward Out-of-Sample',pass:!!wf.windows,detail:wf.windows?`${wf.windows} windows`:'Not run yet'},
      {label:'Benchmark Verdict',pass:!!v.pass,detail:v.reason||'‚Äî'},
      {label:'Bias Check',pass:!(b.flags?.length>0),detail:b.flags?.length?`${b.flags.length} flags: ${(b.flags||[]).slice(0,2).join(', ')}`:'No bias flags detected'},
      {label:'Min Trades',pass:(d.summary?.num_trades||0)>30,detail:`${d.summary?.num_trades||0} trades`},
      {label:'Periods per Year',pass:!!(d.meta?.periods_per_year===8760||d.benchmark?.annualization?.periods_per_year===8760),detail:`${d.meta?.periods_per_year||d.benchmark?.annualization?.periods_per_year||'?'} (1h bars need 8760)`},
    ];
    html('pt-verification',checks.map(c=>`
      <div class="vbadge ${c.pass?'pass':'warn'}">
        <span>${c.pass?'‚úÖ':'‚ö†Ô∏è'}</span>
        <div><strong>${esc(c.label)}</strong><div style="font-size:11px;color:#6B7280">${esc(c.detail)}</div></div>
      </div>`).join(''));
  }).catch(()=>html('pt-verification','<div class="empty">Load a backtest result</div>'));

  // Equity curve vs benchmarks
  jx('/api/equity').then(d=>{
    const eq=d.equity||d.equity_curve||[];
    const bm=d.benchmarks||{};
    if(!eq.length){html('pt-bench-compare','<div class="empty">No equity data</div>');return;}
    const ctx=document.getElementById('pt-equity');
    if(!ctx)return;
    const n=eq.length;
    const labels=eq.map((_,i)=>i);
    const nexusNorm=eq.map(v=>+v/eq[0]);

    // Build datasets
    const datasets=[{label:'NEXUS Champion',data:nexusNorm,borderColor:'#2563EB',backgroundColor:'rgba(37,99,235,.07)',fill:true,tension:.4,borderWidth:2.5}];
    if(bm.btc_hold){
      const b=bm.btc_hold;datasets.push({label:'BTC B&H',data:b.map(v=>+v/b[0]),borderColor:'#F59E0B',borderWidth:1.5,fill:false,tension:.3,pointRadius:0});
    }
    if(bm.eth_hold){
      const b=bm.eth_hold;datasets.push({label:'ETH B&H',data:b.map(v=>+v/b[0]),borderColor:'#8B5CF6',borderWidth:1.5,fill:false,tension:.3,pointRadius:0});
    }
    if(_ptChart)_ptChart.destroy();
    _ptChart=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{position:'top'},tooltip:{mode:'index',intersect:false}},scales:{y:{title:{display:true,text:'Normalized Return'},ticks:{callback:v=>`${((v-1)*100).toFixed(0)}%`}},x:{ticks:{maxTicksLimit:12}}}}});

    // Summary table
    const nexusFinal=nexusNorm[n-1];
    let rows=`<tr><td><strong style="color:#2563EB">NEXUS Champion</strong></td><td class="pos"><strong>+${((nexusFinal-1)*100).toFixed(1)}%</strong></td><td colspan="2">See KPIs above</td></tr>`;
    if(bm.btc_hold){
      const f=+bm.btc_hold[n-1]/+bm.btc_hold[0];
      rows+=`<tr><td>BTC Buy & Hold</td><td class="${f>1?'pos':'neg'}">${f>1?'+':''}${((f-1)*100).toFixed(1)}%</td><td colspan="2">Pure crypto exposure</td></tr>`;
    }
    if(bm.eth_hold){
      const f=+bm.eth_hold[n-1]/+bm.eth_hold[0];
      rows+=`<tr><td>ETH Buy & Hold</td><td class="${f>1?'pos':'neg'}">${f>1?'+':''}${((f-1)*100).toFixed(1)}%</td><td colspan="2">Pure crypto exposure</td></tr>`;
    }
    html('pt-bench-compare',`<table><thead><tr><th>Strategy</th><th>Total Return</th><th>Notes</th><th></th></tr></thead><tbody>${rows}</tbody></table>`);
  }).catch(()=>{});

  // Learning stats
  jx('/api/learning/stats').then(d=>{
    if(d.error){html('pt-learning','<div class="empty">Learning engine initializing...</div>');return;}
    html('pt-learning',`
      <div class="card" style="text-align:center"><div class="ctitle">Hypotheses Tracked</div><div style="font-size:2rem;font-weight:700;color:var(--accent)">${d.total_hypotheses_tracked||0}</div></div>
      <div class="card" style="text-align:center"><div class="ctitle">Learning Velocity</div><div style="font-size:2rem;font-weight:700;color:var(--green)">${(+(d.learning_velocity||0)*100).toFixed(1)}%</div></div>
      <div class="card" style="text-align:center"><div class="ctitle">Due for Review</div><div style="font-size:2rem;font-weight:700;color:var(--yellow)">${d.hypotheses_due_today||0}</div></div>
    `);
  }).catch(()=>html('pt-learning','<div class="empty">Learning stats unavailable</div>'));
}

// ‚îÄ‚îÄ‚îÄ Analysis Logs (Research Journal) ‚îÄ‚îÄ‚îÄ
function loadLogs(){
  const t=$('log-filter-type')?.value||'';
  const s=$('log-filter-source')?.value||'';
  let url='/api/analysis_log?n=200';
  if(t)url+='&entry_type='+t;
  if(s)url+='&source='+s;
  jx(url).then(d=>{
    const entries=(d.entries||[]).reverse();
    set('log-count',entries.length+' entries');
    if(!entries.length){html('logs-container','<div class="empty">No analysis log entries yet. Logs are created during research sessions.</div>');return;}
    const typeIcon={analysis:'üîç',finding:'üí°',decision:'‚úÖ',audit:'ü§ñ'};
    const typeColor={analysis:'#3B82F6',finding:'#F59E0B',decision:'#10B981',audit:'#8B5CF6'};
    const sevColor={critical:'#EF4444',warning:'#F59E0B',info:'#6B7280'};
    let h='';
    for(const e of entries){
      const icon=typeIcon[e.type]||'üìù';
      const color=typeColor[e.type]||'#6B7280';
      const sev=e.severity?`<span style="color:${sevColor[e.severity]||'#6B7280'};font-size:11px;font-weight:600">[${e.severity.toUpperCase()}]</span>`:'';
      const ts=e.ts?new Date(e.ts).toLocaleString():'';
      const src=e.source||'';
      const tags=(e.tags||[]).map(t=>`<span style="background:var(--border);padding:1px 6px;border-radius:10px;font-size:10px">${esc(t)}</span>`).join(' ');
      // Format content: support markdown-like formatting
      let content=esc(e.content||e.details||e.rationale||e.consensus||'');
      content=content.replace(/\n/g,'<br>');
      content=content.replace(/\*\*(.+?)\*\*/g,'<b>$1</b>');
      content=content.replace(/`(.+?)`/g,'<code style="background:var(--border);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>');
      // For audit entries, show responses
      let responses='';
      if(e.type==='audit'&&e.responses){
        responses='<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">';
        for(const[model,resp]of Object.entries(e.responses)){
          const r=esc(String(resp)).replace(/\n/g,'<br>');
          responses+=`<div style="margin-bottom:8px"><b style="color:var(--accent)">${esc(model)}:</b><div style="font-size:12px;margin-top:4px;padding:6px 10px;background:rgba(0,0,0,0.03);border-radius:6px">${r}</div></div>`;
        }
        responses+='</div>';
      }
      // Alternatives for decisions
      let alts='';
      if(e.alternatives&&e.alternatives.length){
        alts='<div style="margin-top:6px;font-size:11px;color:var(--fg-muted)">Alternatives considered: '+e.alternatives.map(a=>esc(a)).join(', ')+'</div>';
      }
      h+=`<div class="card" style="border-left:3px solid ${color};padding:12px 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:16px">${icon}</span>
            <span style="font-weight:600;font-size:14px">${esc(e.title||'')}</span>
            ${sev}
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:11px;padding:2px 8px;background:${color}22;color:${color};border-radius:10px;font-weight:500">${esc(src)}</span>
            <span class="text-sm text-muted">${ts}</span>
          </div>
        </div>
        <div style="font-size:13px;line-height:1.6;color:var(--fg)">${content}</div>
        ${responses}${alts}
        ${tags?'<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap">'+tags+'</div>':''}
      </div>`;
    }
    html('logs-container',h);
    loadLogStats();
  }).catch(e=>{
    html('logs-container','<div class="empty">Error loading logs: '+esc(e.message)+'</div>');
  });
}

// ‚îÄ‚îÄ‚îÄ Log Stats ‚îÄ‚îÄ‚îÄ
function loadLogStats(){
  jx('/api/analysis_log?n=500').then(d=>{
    const entries=d.entries||[];
    if(!entries.length){html('log-stats','<div class="text-muted">No entries yet</div>');return;}
    const byType={},bySrc={};
    let latest='';
    for(const e of entries){
      byType[e.type]=(byType[e.type]||0)+1;
      if(e.source)bySrc[e.source]=(bySrc[e.source]||0)+1;
      if(e.ts&&e.ts>latest)latest=e.ts;
    }
    let h=`<div><b>${entries.length}</b> total entries</div>`;
    h+='<div style="margin-top:6px;font-weight:600;font-size:11px;color:var(--fg-muted)">BY TYPE</div>';
    const typeIcon={analysis:'üîç',finding:'üí°',decision:'‚úÖ',audit:'ü§ñ'};
    for(const[t,c] of Object.entries(byType)){
      h+=`<div>${typeIcon[t]||'üìù'} ${t}: <b>${c}</b></div>`;
    }
    h+='<div style="margin-top:6px;font-weight:600;font-size:11px;color:var(--fg-muted)">BY SOURCE</div>';
    for(const[s,c] of Object.entries(bySrc)){
      h+=`<div>${esc(s)}: <b>${c}</b></div>`;
    }
    if(latest){
      h+=`<div style="margin-top:6px;font-size:11px;color:var(--fg-muted)">Latest: ${new Date(latest).toLocaleString()}</div>`;
    }
    html('log-stats',h);
  }).catch(()=>html('log-stats','<div class="text-muted">Stats unavailable</div>'));
}

// ‚îÄ‚îÄ‚îÄ Log Auto-Refresh ‚îÄ‚îÄ‚îÄ
let _logRefreshTimer=null;
function toggleLogAutoRefresh(){
  const cb=$('log-autorefresh');
  if(cb&&cb.checked){
    if(!_logRefreshTimer)_logRefreshTimer=setInterval(()=>{if(_tab==='logs'){loadLogs();loadLogStats();}},10000);
  }else{
    if(_logRefreshTimer){clearInterval(_logRefreshTimer);_logRefreshTimer=null;}
  }
}
// Start auto-refresh by default
toggleLogAutoRefresh();

// ‚îÄ‚îÄ‚îÄ Log AI Chat ‚îÄ‚îÄ‚îÄ
function sendLogChat(){
  const inp=$('log-chat-input');
  if(!inp)return;
  const txt=inp.value.trim();
  if(!txt)return;
  inp.value='';
  const msgs=$('log-chat-messages');
  // Add user message
  msgs.innerHTML+=`<div style="text-align:right"><div style="display:inline-block;background:var(--accent);color:#fff;padding:6px 12px;border-radius:12px 12px 2px 12px;font-size:13px;max-width:85%">${esc(txt)}</div></div>`;
  // Add typing indicator
  msgs.innerHTML+=`<div id="log-typing" style="text-align:left"><div style="display:inline-block;background:var(--surface2,#F1F5F9);padding:6px 12px;border-radius:12px 12px 12px 2px;font-size:13px;color:var(--fg-muted)">Thinking...</div></div>`;
  msgs.scrollTop=msgs.scrollHeight;
  // Build context with recent log entries
  const model=$('log-chat-model')?.value||'glm-5';
  const ctxMsg='[NEXUS Research Assistant] You are analyzing the research log. Answer based on the findings below.\nUSER: '+txt;
  jx('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:ctxMsg,raw_user:txt,model:model})}).then(d=>{
    const el=$('log-typing');if(el)el.remove();
    const resp=d.response||d.reply||d.message||'(no response)';
    let formatted=esc(resp).replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<b>$1</b>').replace(/`(.+?)`/g,'<code style="background:var(--border);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>');
    msgs.innerHTML+=`<div style="text-align:left"><div style="display:inline-block;background:var(--surface2,#F1F5F9);padding:8px 12px;border-radius:12px 12px 12px 2px;font-size:13px;max-width:85%;line-height:1.5">${formatted}</div><div style="font-size:10px;color:var(--fg-light);margin-top:2px">${esc(model)} ¬∑ ${new Date().toLocaleTimeString()}</div></div>`;
    msgs.scrollTop=msgs.scrollHeight;
  }).catch(e=>{
    const el=$('log-typing');if(el)el.remove();
    msgs.innerHTML+=`<div style="text-align:left"><div style="display:inline-block;background:var(--red-light);color:var(--red);padding:6px 12px;border-radius:12px;font-size:13px">Error: ${esc(e.message)}</div></div>`;
    msgs.scrollTop=msgs.scrollHeight;
  });
}

// ‚îÄ‚îÄ‚îÄ Add Log Note ‚îÄ‚îÄ‚îÄ
function addLogNote(){
  const note=prompt('Add a research note:');
  if(!note||!note.trim())return;
  jx('/api/analysis_log',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'analysis',source:'user',title:'User Note',content:note.trim(),tags:['user-note']})}).then(()=>{
    toast('Note added');
    loadLogs();
    loadLogStats();
  }).catch(e=>toast('Error: '+e.message));
}

const LOADERS={
  overview:loadOv,chat:loadChat,benchmark:loadBM,performance:loadPerf,
  risk:loadRisk,research:loadResearch,tasks:loadTasks,files:loadFiles,market:loadMarket,pitch:loadPitch,
  logs:loadLogs,console:refreshConsole
};

// ‚îÄ‚îÄ‚îÄ Auto refresh (fallback polling if SSE fails) ‚îÄ‚îÄ‚îÄ
function refresh(){loadKPI();LOADERS[_tab]&&LOADERS[_tab]();}
setInterval(()=>{if(_tab==='market')loadMarket();},30000);
setInterval(()=>{if(LOADERS[_tab]&&_tab!=='chat'&&_tab!=='overview')LOADERS[_tab]();},90000);

// ‚îÄ‚îÄ‚îÄ SSE live stream ‚îÄ‚îÄ‚îÄ
let _sseRetry=0;
function _connectSSE(){
  setLiveStatus('connecting','Connecting\u2026');
  APP_STATE.liveConnected=false;
  const src=new EventSource('/api/stream');
  src.onopen=()=>{
    _sseRetry=0;
    APP_STATE.liveConnected=true;
    APP_STATE.liveSeenAt=Date.now();
    setLiveStatus('connected','Live');
  };
  src.onmessage=(ev)=>{
    try{
      const d=JSON.parse(ev.data);
      if(d.error)return;
      APP_STATE.liveSeenAt=Date.now();
      // Update header KPIs with animation
      if(d.sharpe!=null){
        animateKpiText('k-sharpe',n2(d.sharpe),'kpi-v '+(d.sharpe>=1.5?'pos':d.sharpe>=0.6?'neu':'neg'));
        setHeaderChip('hc-sharpe','Sharpe '+n2(d.sharpe),d.sharpe>=1.5?'pos':d.sharpe>=0.6?'neu':'neg');
      }
      if(d.mdd!=null){animateKpiText('k-mdd',pct(d.mdd),'kpi-v neg');}
      if(d.latest_equity!=null){const r=d.latest_equity-1;animateKpiText('k-tot',pct(r),'kpi-v '+(r>=0?'pos':'neg'));setHeaderChip('hc-pnl','PnL '+pct(r),r>=0?'pos':'neg');}
      // Update header badge
      if(d.verdict!=null){
        const v=d.verdict?'PASS':'FAIL';
        const b=$('hdr-badge');if(b){b.textContent=v;b.className='bdg '+(v==='PASS'?'bg-g':'bg-r');}
        setHeaderChip('hc-status','Status '+v,v==='PASS'?'pos':'neg');
      }
      // Live progress indicator
      if(d.active_run){
        APP_STATE.activeRun=d.active_run;
        const pill=$('bt-progress');
        if(pill){pill.classList.remove('idle');set('bt-progress-text',d.active_run);}
        setLiveStatus('connected',d.active_run);
      } else if(APP_STATE.activeRun){
        APP_STATE.activeRun=null;
        const pill=$('bt-progress');
        if(pill){pill.classList.add('idle');set('bt-progress-text','No active backtest');}
        setLiveStatus('connected','Live');
      }
      // Push SSE events into chat feed
      if(d.event||d.kind){
        chatSseEvents.unshift(d);
        if(chatSseEvents.length>5)chatSseEvents.length=5;
        renderSSEFeed();
      }
      // Update overview ledger if on overview tab
      if(_tab==='overview'&&d.ledger_tail&&d.ledger_tail.length){
        _updateLiveLedger(d.ledger_tail);
      }
      // Update equity tail chart
      if(_tab==='overview'&&d.equity_tail&&d.equity_tail.length&&_eq){
        _updateEquityTail(d.equity_tail);
      }
      // Learning progress update
      if(d.learning_velocity!=null){
        const lv=$('live-lv');if(lv)lv.textContent=(d.learning_velocity*100).toFixed(1)+'%';
      }
      set('kpi-updated','Live \u00b7 '+now());
    }catch(e){}
  };
  src.onerror=()=>{
    APP_STATE.liveConnected=false;
    setLiveStatus('connecting','Reconnecting\u2026');
    src.close();
    _sseRetry=Math.min(_sseRetry+1,5);
    setTimeout(_connectSSE,Math.pow(2,_sseRetry)*1000);
  };
}

function _updateLiveLedger(events){
  const el=$('ov-ledger');if(!el)return;
  const rows=events.slice(0,8).map(e=>{
    const v=e.verdict;
    const badge=v===true?'<span class="bdg bg-g">PASS</span>':v===false?'<span class="bdg bg-r">FAIL</span>':'';
    return `<tr><td class="text-sm text-muted">${esc(e.ts||'').slice(11,19)}</td><td>${esc(e.kind||'')}</td><td class="text-sm">${esc((e.run_name||'').slice(0,20))}</td><td>${badge}</td></tr>`;
  }).join('');
  el.innerHTML=`<table><thead><tr><th>Time</th><th>Kind</th><th>Run</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
}

function _updateEquityTail(tail){
  if(!_eq||!tail.length)return;
  const vals=tail.map(e=>typeof e==='number'?e:+e);
  _eq.data.datasets[0].data=vals;
  _eq.data.labels=vals.map((_,i)=>i);
  _eq.update('none');
}

// ‚îÄ‚îÄ‚îÄ Multi-Model Debate ‚îÄ‚îÄ‚îÄ
let _debateMode = false;

function toggleDebateMode(){
  _debateMode = !_debateMode;
  const btn = $('debate-toggle-btn');
  const banner = $('debate-banner');
  const ta = $('chat-in');
  if(_debateMode){
    if(btn){btn.classList.add('debate-btn-active');btn.textContent='‚öîÔ∏è Debate ON';}
    if(banner)banner.style.display='block';
    if(ta)ta.placeholder='Ask any question ‚Äî all 4 models will analyze + debate + synthesize (30-60s)...';
  } else {
    if(btn){btn.classList.remove('debate-btn-active');btn.textContent='‚öîÔ∏è Debate';}
    if(banner)banner.style.display='none';
    if(ta)ta.placeholder='Ask NEXUS anything... (Enter to send, Shift+Enter for newline)';
  }
}

function modelTag(model){
  const m=(model||'').toLowerCase();
  if(m.includes('glm'))return`<span class="debate-model-tag tag-glm">üß† SAGE (GLM-5)</span>`;
  if(m.includes('sonnet'))return`<span class="debate-model-tag tag-claude">üîµ SENTINEL (Sonnet)</span>`;
  if(m.includes('opus'))return`<span class="debate-model-tag tag-claude">üü£ NEXUS PRIME (Opus)</span>`;
  if(m.includes('claude'))return`<span class="debate-model-tag tag-claude">üîµ SENTINEL (Claude)</span>`;
  if(m.includes('codex')||m.includes('gpt'))return`<span class="debate-model-tag tag-codex">üü¢ FORGE (GPT-5.2)</span>`;
  if(m.includes('minimax'))return`<span class="debate-model-tag tag-minimax">üü† SCOUT (MiniMax)</span>`;
  return`<span class="debate-model-tag" style="background:#f1f5f9">${escHtml(model)}</span>`;
}

function renderDebate(d){
  if(!d||d.error)return`<div class="empty text-sm">Debate failed: ${escHtml(d&&d.error||'unknown error')}</div>`;
  const contribs=d.contributions||[];
  // Group by round
  const r1=contribs.filter(c=>c.round===1||c.round==='analysis');
  const r2=contribs.filter(c=>c.round===2||c.round==='critique');
  const conf=d.consensus_score!=null?Math.round(d.consensus_score*100):50;
  const confColor=conf>=70?'var(--green)':conf>=40?'var(--yellow)':'#EF4444';
  let html=`<div class="debate-wrap">
    <div class="debate-header">‚öîÔ∏è Multi-Model Debate &nbsp;¬∑&nbsp; ${escHtml(d.topic||'')}
      <span class="debate-confidence" style="background:${confColor};color:#fff;float:right">Consensus: ${conf}%</span>
    </div>`;
  if(r1.length){
    html+=`<div class="debate-round"><div class="debate-round-title">Round 1 ‚Äî Independent Analysis</div>`;
    r1.forEach(c=>{html+=`<div class="debate-contrib">${modelTag(c.model_name||c.model)}<div style="color:var(--fg);line-height:1.5;white-space:pre-wrap">${escHtml(c.content||'')}</div></div>`;});
    html+=`</div>`;
  }
  if(r2.length){
    html+=`<div class="debate-round"><div class="debate-round-title">Round 2 ‚Äî Cross-Critique</div>`;
    r2.forEach(c=>{html+=`<div class="debate-contrib">${modelTag(c.model_name||c.model)}<div style="color:var(--fg);line-height:1.5;white-space:pre-wrap">${escHtml(c.content||'')}</div></div>`;});
    html+=`</div>`;
  }
  if(d.synthesis){
    html+=`<div class="debate-synthesis"><span class="debate-model-tag tag-synthesis" style="margin-bottom:6px;display:inline-block">üß© Synthesis</span><div style="white-space:pre-wrap">${escHtml(d.synthesis)}</div></div>`;
  }
  if(d.action_items&&d.action_items.length){
    html+=`<div class="debate-actions"><strong style="font-size:11px;color:var(--fg-muted);text-transform:uppercase">Action Items</strong>`;
    d.action_items.forEach((a,i)=>{html+=`<div class="debate-action-item">‚Üí ${escHtml(a)}</div>`;});
    html+=`</div>`;
  }
  html+=`</div>`;
  return html;
}

function startDebate(topic){
  const ta=$('chat-in');if(ta)ta.value=topic;
  _debateMode=true;
  const btn=$('debate-toggle-btn');const banner=$('debate-banner');
  if(btn){btn.classList.add('debate-btn-active');btn.textContent='‚öîÔ∏è Debate ON';}
  if(banner)banner.style.display='block';
  sendMsg();
}

function loadDebateHistory(){
  jx('/api/debate_history?n=10').then(items=>{
    if(!items||!items.length){addMsg('a','No debate history yet. Ask a question with Debate Mode ON.');return;}
    let html='<strong>Recent Debates:</strong><br>';
    items.slice(0,5).forEach((r,i)=>{
      const conf=r.consensus_score!=null?Math.round(r.consensus_score*100)+'%':'?';
      html+=`<div style="margin:6px 0;padding:6px 10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
        <div style="font-weight:600;font-size:12px">${escHtml(r.topic||'?')}</div>
        <div style="font-size:11px;color:var(--fg-muted)">Consensus: ${conf} ¬∑ ${r.created_at||''}</div>
        <div style="font-size:11px;margin-top:3px">${escHtml((r.synthesis||'').slice(0,120))}...</div>
      </div>`;
    });
    addMsg('a',html,true);
  }).catch(()=>addMsg('a','Debate history unavailable.'));
}

// sendMsg ‚Äî supports both normal chat and debate mode
function sendMsg(){
  const ta=$('chat-in');
  const msg=(ta?ta.value.trim():'');
  if(!msg)return;
  if(_debateMode){
    // Debate mode: call /api/debate
    addMsg('u',msg);
    if(ta){ta.value='';autoGrowTA(ta);}
    const thinkId='debate-thinking-'+Date.now();
    addMsg('a',`<div id="${thinkId}" style="display:flex;align-items:center;gap:8px;color:var(--fg-muted);font-size:13px">
      <div class="loading-dot"></div>
      ‚öîÔ∏è Calling 4 agents in 3 rounds... (SAGE ‚Üí SENTINEL ‚Üí FORGE ‚Üí SCOUT ‚Üí Synthesis)
      <span style="font-size:11px">~30-60s</span>
    </div>`,true);
    fetch('/api/debate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic:msg,context:'NexusAlpha V1-Long OOS Sharpe=1.125 (avg 5yr). Alpha=carry+mom(336h)+MR(72h). 2021-2025 all OOS.'})})
    .then(r=>r.json()).then(d=>{
      const el=document.getElementById(thinkId);
      const debHtml=renderDebate(d);
      if(el){el.parentElement.innerHTML=`<div>${debHtml}</div><div class="cmsg-footer"><span class="cts">Debate ¬∑ ${new Date().toLocaleTimeString()}</span><button class="copy-btn" onclick="copyBubble(this)">üìã</button></div>`;}
      else{addMsg('a',debHtml,true);}
    }).catch(e=>{
      const el=document.getElementById(thinkId);
      const errMsg=`Debate failed: ${escHtml(String(e))}`;
      if(el)el.parentElement.querySelector('.cbubble').innerHTML=errMsg;
      else addMsg('a',errMsg,true);
    });
    return;
  }
  // Normal mode: original sendMsg logic
  _sendMsgNormal(msg,ta);
}

// ‚îÄ‚îÄ‚îÄ Year Bar Chart (Overview) ‚îÄ‚îÄ‚îÄ
function renderYearBars(){
  const data=[
    {year:'2021',sharpe:1.052,type:'pos',tip:'Bull market ¬∑ OOS'},
    {year:'2022',sharpe:1.042,type:'pos',tip:'Bear (BTC -65%) ¬∑ OOS'},
    {year:'2023',sharpe:1.524,type:'pos',tip:'Recovery ¬∑ OOS'},
    {year:'2024',sharpe:1.058,type:'pos',tip:'Bull ATH ¬∑ OOS'},
    {year:'2025',sharpe:0.948,type:'pos',tip:'YTD ¬∑ OOS'},
  ];
  const maxS=3.0;
  const el=$('year-bar-chart');
  if(!el)return;
  el.innerHTML=data.map(d=>{
    const pct=Math.max(4,(d.sharpe/maxS)*100);
    const cls=d.type==='is'?'year-bar is':'year-bar pos';
    const valColor=d.type==='is'?'var(--yellow)':'var(--green)';
    return `<div class="year-bar-col" title="${d.tip}">
      <div class="year-bar-val" style="color:${valColor}">${d.sharpe.toFixed(2)}</div>
      <div class="${cls}" style="height:${pct}%;"></div>
      <div class="year-bar-lbl">${d.year}${d.type==='is'?' (IS)':''}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Console ‚îÄ‚îÄ‚îÄ
let _logTarget='dashboard';
let _logAutoRefresh=true;
let _logTimer=null;

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function colorLine(line){
  if(/ERROR|CRITICAL|Exception|Traceback/.test(line)) return `<span class="lg-err">${escHtml(line)}</span>`;
  if(/WARNING|WARN/.test(line)) return `<span class="lg-warn">${escHtml(line)}</span>`;
  if(/INFO|started|loaded|done|success/i.test(line)) return `<span class="lg-info">${escHtml(line)}</span>`;
  if(/Sharpe|OOS|‚úì|‚úÖ/.test(line)) return `<span class="lg-ok">${escHtml(line)}</span>`;
  return `<span>${escHtml(line)}</span>`;
}

function refreshLog(){
  const logMap={dashboard:'/tmp/nexus_dash.log',brain:null,research:null,backtest:'/tmp/nexus_alpha_v1_run.log'};
  jx(`/api/log_tail?n=200&target=${_logTarget}`).then(d=>{
    const lines=(d.lines||[]);
    const el=$('log-body');
    if(!el)return;
    el.innerHTML=lines.map(colorLine).join('<br>');
    el.scrollTop=el.scrollHeight;
    set('log-info',`Lines: ${lines.length}`);
    set('log-updated','Updated: '+now());
  }).catch(e=>{
    const el=$('log-body');
    if(el)el.innerHTML=`<span class="lg-warn">Log unavailable: ${escHtml(String(e))}</span>`;
  });
}

function switchLogTab(name){
  _logTarget=name;
  ['dashboard','brain','research','backtest'].forEach(t=>{
    const el=$('ltab-'+t);
    if(el)el.classList[t===name?'add':'remove']('active');
  });
  refreshLog();
}

function toggleLogAuto(){
  const cb=document.getElementById('log-auto');
  _logAutoRefresh=cb?cb.checked:true;
  if(_logAutoRefresh){_logTimer=setInterval(refreshLog,3000);}
  else{clearInterval(_logTimer);}
}

function refreshConsole(){
  // Processes
  jx('/api/processes').then(d=>{
    const procs=d.processes||[];
    set('proc-count',procs.length);
    if(!procs.length){html('proc-list','<div class="empty text-sm">No NEXUS processes running</div>');return;}
    html('proc-list',procs.map(p=>`
      <div class="proc-item ${p.status}">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="proc-status ${p.status}"></div>
          <div>
            <div style="font-weight:600">${escHtml(p.name)}</div>
            <div style="font-size:10px;color:var(--fg-muted)">PID ${p.pid||'‚Äî'}</div>
          </div>
        </div>
        <div style="text-align:right;font-size:10px;color:var(--fg-muted)">
          <div>${escHtml(p.cpu_pct!=null?p.cpu_pct.toFixed(1)+'% CPU':'')}</div>
          <div>${escHtml(p.mem_mb!=null?p.mem_mb.toFixed(0)+' MB':'')}</div>
        </div>
      </div>`).join(''));
  }).catch(()=>html('proc-list','<div class="empty text-sm">Process monitor unavailable</div>'));
  // System status
  jx('/api/system_status').then(d=>{
    const cpu=d.cpu_pct||0,mem=d.mem_pct||0,disk=d.disk_pct||0;
    html('sys-status',`
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">CPU</span>
        <div class="sys-bar"><div class="sys-fill ${cpu>80?'crit':cpu>60?'warn':'ok'}" style="width:${cpu}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${cpu.toFixed(1)}%</span>
      </div>
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">RAM</span>
        <div class="sys-bar"><div class="sys-fill ${mem>80?'crit':mem>60?'warn':'ok'}" style="width:${mem}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${mem.toFixed(1)}%</span>
      </div>
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">Disk</span>
        <div class="sys-bar"><div class="sys-fill ${disk>90?'crit':disk>70?'warn':'ok'}" style="width:${disk}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${disk.toFixed(1)}%</span>
      </div>
      <div style="font-size:11px;color:var(--fg-muted);margin-top:4px">Cache: ${escHtml(d.cache_size||'‚Äî')} ¬∑ Artifacts: ${escHtml(d.artifacts_size||'‚Äî')}</div>
    `);
  }).catch(()=>html('sys-status','<div class="text-sm text-muted">System stats unavailable</div>'));
  // Start log auto-refresh
  clearInterval(_logTimer);
  refreshLog();
  if(_logAutoRefresh)_logTimer=setInterval(refreshLog,3000);
}

function ctrlAction(action,target){
  const cfg=target==='backtest'?(document.getElementById('backtest-cfg')||{}).value:'';
  set('ctrl-result','‚è≥ Sending...');
  fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action,target,config:cfg||''})})
  .then(r=>r.json()).then(d=>{
    const msg=d.status==='ok'?`‚úÖ ${action} ${target}: ${d.message||'done'}`:
      `‚ùå ${d.message||'Error'}`;
    set('ctrl-result',msg);
    toast(msg,3);
    setTimeout(refreshConsole,800);
  }).catch(e=>{set('ctrl-result','‚ùå Request failed');});
}

// ‚îÄ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ
setInterval(()=>set('hdr-clock',new Date().toLocaleTimeString()),1000);

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
initTheme();
initKeyboardShortcuts();
_connectSSE();
loadKPI();
loadOv();
renderYearBars();
attachSectionStamps();
initCardExpansion();
// Stale check ‚Äî mark disconnected if no event in 30s
setInterval(()=>{
  if(APP_STATE.liveConnected&&Date.now()-APP_STATE.liveSeenAt>30000){
    setLiveStatus('stale','Stale');
  }
},10000);
</script>
</body>
</html>
