<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NEXUS ‚Äî Autonomous Quant Workforce</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#F8FAFC;--surface:#FFFFFF;--surface2:#F1F5F9;--border:#E2E8F0;
  --accent:#2563EB;--accent-hover:#1D4ED8;--accent-light:#EFF6FF;
  --green:#16A34A;--green-light:#F0FDF4;--red:#DC2626;--red-light:#FEF2F2;
  --yellow:#D97706;--yellow-light:#FFFBEB;--purple:#7C3AED;--purple-light:#F5F3FF;
  --fg:#0F172A;--fg-muted:#64748B;--fg-light:#94A3B8;
  --shadow:0 1px 3px rgba(0,0,0,.07);--shadow-md:0 4px 12px rgba(0,0,0,.08);
  --r:8px;--r-sm:4px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--fg);font-size:14px;line-height:1.5;min-height:100vh}

/* Header */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:16px;height:54px;position:sticky;top:0;z-index:200;box-shadow:var(--shadow)}
.logo{font-size:17px;font-weight:700;background:linear-gradient(135deg,#2563EB,#7C3AED);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.5px}
.logo-sub{font-size:11px;color:var(--fg-muted);font-weight:400;margin-left:4px;-webkit-text-fill-color:var(--fg-muted)}

/* Tab bar */
.tabs{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;display:flex;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{padding:10px 14px;cursor:pointer;font-size:13px;font-weight:500;color:var(--fg-muted);border-bottom:2px solid transparent;white-space:nowrap;display:flex;align-items:center;gap:5px;transition:color .15s;flex-shrink:0}
.tab:hover{color:var(--fg)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* KPI strip */
.kpi-strip{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 24px;display:flex;gap:28px;overflow-x:auto;align-items:center}
.kpi{display:flex;flex-direction:column;min-width:70px}
.kpi-l{font-size:10px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.06em}
.kpi-v{font-size:17px;font-weight:700}
.kpi-v.pos{color:var(--green)}.kpi-v.neg{color:var(--red)}.kpi-v.neu{color:var(--yellow)}.kpi-v.acc{color:var(--accent)}

/* Pages */
.page{display:none;padding:22px 24px;max-width:1440px;margin:0 auto}
.page.active{display:block}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
.ctitle{font-size:12px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px}

/* Grid */
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:1100px){.g3{grid-template-columns:repeat(2,1fr)}.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.g3,.g2,.g4{grid-template-columns:1fr}}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:1px solid transparent;font-family:inherit;transition:all .15s}
.btn-p{background:var(--accent);color:#fff;border-color:var(--accent)}.btn-p:hover{background:var(--accent-hover)}
.btn-s{background:var(--surface);color:var(--fg);border-color:var(--border)}.btn-s:hover{background:var(--surface2)}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-danger{background:var(--red);color:#fff;border-color:var(--red)}

/* Badges */
.bdg{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600}
.bg-g{background:var(--green-light);color:var(--green)}
.bg-r{background:var(--red-light);color:var(--red)}
.bg-y{background:var(--yellow-light);color:var(--yellow)}
.bg-b{background:var(--accent-light);color:var(--accent)}
.bg-p{background:var(--purple-light);color:var(--purple)}
.bg-gray{background:var(--surface2);color:var(--fg-muted)}

/* Table */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em;padding:7px 12px;border-bottom:2px solid var(--border)}
td{padding:9px 12px;border-bottom:1px solid var(--border);font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--surface2)}

/* Stat rows */
.srow{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:13px}
.srow:last-child{border-bottom:none}
.srow .lbl{color:var(--fg-muted)}.srow .val{font-weight:500}

/* Chat */
.chat-wrap{display:grid;grid-template-columns:1fr 260px;gap:14px;height:calc(100vh-240px);min-height:500px}
@media(max-width:900px){.chat-wrap{grid-template-columns:1fr}}
.chat-box{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:var(--r);background:var(--surface);overflow:hidden;min-height:500px}
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.cmsg{max-width:85%}.cmsg.u{align-self:flex-end}.cmsg.a{align-self:flex-start}
.cbubble{padding:9px 13px;border-radius:12px;font-size:13.5px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
.cmsg.u .cbubble{background:var(--accent);color:#fff;border-bottom-right-radius:3px}
.cmsg.a .cbubble{background:var(--surface2);color:var(--fg);border-bottom-left-radius:3px}
.cts{font-size:10px;color:var(--fg-light);margin-top:2px}
.chat-in-bar{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--surface)}
.chat-ta{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;font-family:inherit;resize:none;outline:none;height:40px;max-height:100px;transition:border-color .15s}
.chat-ta:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.chips{display:flex;flex-wrap:wrap;gap:5px;padding:6px 10px 0}
.chip{padding:4px 11px;border:1px solid var(--border);border-radius:20px;font-size:12px;cursor:pointer;background:var(--surface);color:var(--fg);transition:all .15s}
.chip:hover{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}
.brain-panel{display:flex;flex-direction:column;gap:10px}
.brain-card{border:1px solid var(--border);border-radius:var(--r);padding:14px;background:var(--surface)}
.brain-card h4{font-size:12px;font-weight:600;color:var(--fg-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.05em}

/* Benchmark targets */
.tgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:18px}
@media(max-width:700px){.tgrid{grid-template-columns:1fr}}
.tcard{border:1px solid var(--border);border-radius:var(--r);padding:14px;background:var(--surface);transition:all .3s}
.tcard.achieved{border-color:var(--green);background:var(--green-light)}
.tcard.near{border-color:var(--accent);background:var(--accent-light)}
.ttitle{font-size:11px;font-weight:600;color:var(--fg-muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em}
.tval{font-size:20px;font-weight:700;margin-bottom:5px}
.tdesc{font-size:12px;color:var(--fg-muted);margin-bottom:8px}
.pbar{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden}
.pfill{height:100%;border-radius:3px;transition:width .6s}
.pfill.g{background:var(--green)}.pfill.b{background:var(--accent)}.pfill.y{background:var(--yellow)}

/* Kanban */
.kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:1000px){.kanban{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.kanban{grid-template-columns:1fr}}
.kcol{background:var(--surface2);border-radius:var(--r);padding:10px}
.kh{font-size:11px;font-weight:600;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.kcount{background:var(--border);border-radius:20px;padding:1px 7px;font-size:11px}
.tsk{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:9px 11px;margin-bottom:6px;cursor:pointer}
.tsk:hover{box-shadow:var(--shadow-md)}
.tsk-title{font-size:13px;font-weight:500;margin-bottom:5px}
.tsk-meta{display:flex;gap:5px;flex-wrap:wrap}

/* File explorer */
.file-section{margin-bottom:18px}
.file-section-hdr{font-size:13px;font-weight:600;color:var(--fg);margin-bottom:8px;display:flex;align-items:center;gap:6px;cursor:pointer}
.file-section-hdr:hover{color:var(--accent)}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.file-item{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 12px;cursor:pointer;transition:all .15s}
.file-item:hover{border-color:var(--accent);box-shadow:var(--shadow-md)}
.file-name{font-size:13px;font-weight:500;color:var(--fg);margin-bottom:2px;word-break:break-all}
.file-meta{font-size:11px;color:var(--fg-muted)}
.run-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:all .15s}
.run-item:hover{border-color:var(--accent);box-shadow:var(--shadow-md)}
.run-name{font-size:12px;font-weight:600;color:var(--fg);margin-bottom:6px;word-break:break-all}
.file-viewer{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:14px;font-family:monospace;font-size:12px;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;margin-top:10px}

/* Misc */
.mb{margin-bottom:14px}.mb2{margin-bottom:20px}
.row{display:flex;align-items:center;gap:8px}
.rowb{display:flex;align-items:center;justify-content:space-between;gap:8px}
.empty{text-align:center;padding:36px;color:var(--fg-muted);font-size:14px}
.spin{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
input,select,textarea{font-family:inherit;font-size:14px;color:var(--fg);background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:7px 11px;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
label{font-size:12px;font-weight:500;color:var(--fg-muted);margin-bottom:3px;display:block}
.fr{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--fg);color:#fff;padding:9px 16px;border-radius:8px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
.section-title{font-size:15px;font-weight:600;color:var(--fg);margin-bottom:14px}
.text-sm{font-size:12px}.text-muted{color:var(--fg-muted)}.text-green{color:var(--green)}.text-red{color:var(--red)}
#eq-chart-wrap{position:relative;height:240px}
.pos{color:var(--green)}.neg{color:var(--red)}
</style>
</head>
<body>

<!-- Header -->
<header class="hdr">
  <div class="row gap-4">
    <span class="logo">NEXUS</span>
    <span class="logo-sub">Autonomous Quant Workforce</span>
  </div>
  <div style="flex:1"></div>
  <span id="hdr-badge" class="bdg bg-gray" style="font-size:12px">Connecting...</span>
  <span id="hdr-clock" class="text-sm text-muted"></span>
</header>

<!-- Tabs -->
<nav class="tabs">
  <div class="tab active" onclick="go('overview')">üìä Overview</div>
  <div class="tab" onclick="go('chat')">üí¨ Chat</div>
  <div class="tab" onclick="go('benchmark')">üèÜ Benchmark</div>
  <div class="tab" onclick="go('performance')">üìà Performance</div>
  <div class="tab" onclick="go('risk')">‚ö†Ô∏è Risk</div>
  <div class="tab" onclick="go('research')">üî¨ Research</div>
  <div class="tab" onclick="go('tasks')">‚úÖ Tasks</div>
  <div class="tab" onclick="go('files')">üìÅ Files</div>
  <div class="tab" onclick="go('market')">üì° Market</div>
</nav>

<!-- KPI Strip -->
<div class="kpi-strip">
  <div class="kpi"><span class="kpi-l">Sharpe</span><span id="k-sharpe" class="kpi-v acc">‚Äî</span></div>
  <div class="kpi"><span class="kpi-l">CAGR</span><span id="k-cagr" class="kpi-v">‚Äî</span></div>
  <div class="kpi"><span class="kpi-l">Max DD</span><span id="k-mdd" class="kpi-v">‚Äî</span></div>
  <div class="kpi"><span class="kpi-l">Total Ret</span><span id="k-tot" class="kpi-v">‚Äî</span></div>
  <div class="kpi"><span class="kpi-l">Win Rate</span><span id="k-wr" class="kpi-v">‚Äî</span></div>
  <div class="kpi"><span class="kpi-l">Strategy</span><span id="k-strat" class="kpi-v acc" style="font-size:12px">‚Äî</span></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
    <span class="text-sm text-muted" id="kpi-updated"></span>
    <button class="btn btn-s btn-sm" onclick="refresh()">‚Üª</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê -->
<div class="page active" id="page-overview">
  <div class="mb2">
    <div class="card">
      <div class="ctitle">Equity Curve</div>
      <div id="eq-chart-wrap"><canvas id="eq-chart"></canvas></div>
    </div>
  </div>
  <div class="g3 mb2">
    <div class="card">
      <div class="ctitle">Latest Run</div>
      <div id="ov-run"><div class="empty">Run a backtest first</div></div>
    </div>
    <div class="card">
      <div class="ctitle">NEXUS Brain</div>
      <div id="ov-brain"><div class="empty">Brain loading...</div></div>
    </div>
    <div class="card">
      <div class="ctitle">Agent Dispatch</div>
      <div id="ov-agents" style="display:flex;flex-direction:column;gap:7px">
        <button class="btn btn-s btn-sm" onclick="runAgent('atlas')">‚ö° ATLAS ‚Äî Strategy Research</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('cipher')">üõ° CIPHER ‚Äî Risk Assessment</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('echo')">üîä ECHO ‚Äî Data Quality</button>
        <button class="btn btn-s btn-sm" onclick="runAgent('flux')">üåä FLUX ‚Äî Experiment Queue</button>
        <div id="agent-res" class="text-sm text-muted" style="margin-top:4px"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ctitle">
      Recent Events
      <button class="btn btn-s btn-sm" onclick="loadOv()">‚Üª</button>
    </div>
    <div id="ov-ledger"><div class="empty">Loading...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê -->
<div class="page" id="page-chat">
  <div class="chat-wrap">
    <div class="chat-box">
      <div class="chips">
        <span class="chip" onclick="chip('Show current performance metrics')">üìä Performance</span>
        <span class="chip" onclick="chip('What is the BTC funding rate right now?')">üì° BTC Funding</span>
        <span class="chip" onclick="chip('What is the current risk status and regime?')">‚ö†Ô∏è Risk Status</span>
        <span class="chip" onclick="chip('Show active goals and progress')">üéØ Goals</span>
        <span class="chip" onclick="chip('Summarize latest research and proposals')">üî¨ Research</span>
        <span class="chip" onclick="chip('Propose a new strategy improvement for higher Sharpe')">üí° Propose Strategy</span>
        <span class="chip" onclick="chip('What is NEXUS and how does it work?')">ü§ñ About NEXUS</span>
        <span class="chip" onclick="chip('Give me a trading signal for today based on funding rates')">üö¶ Signal</span>
      </div>
      <div class="chat-msgs" id="chat-msgs">
        <div class="cmsg a">
          <div class="cbubble">üëã Hello! I'm <b>NEXUS Brain</b> ‚Äî the world's first autonomous quantitative research workforce.<br><br>I run 24/7: researching papers, testing strategies, managing risk, and improving performance. Ask me anything about trading strategy, risk, market conditions, or request an improvement proposal.</div>
          <div class="cts">Ready ¬∑ GLM-5 powered</div>
        </div>
      </div>
      <div class="chat-in-bar">
        <textarea class="chat-ta" id="chat-in" placeholder="Ask NEXUS anything..." onkeydown="onChatKey(event)"></textarea>
        <button class="btn btn-p" onclick="sendMsg()">Send</button>
      </div>
    </div>
    <div class="brain-panel">
      <div class="brain-card" id="bp-identity">
        <h4>üß† Identity</h4>
        <div class="text-sm text-muted">Loading...</div>
      </div>
      <div class="brain-card" id="bp-goals">
        <h4>üéØ Goals</h4>
        <div class="text-sm text-muted">Loading...</div>
      </div>
      <div class="brain-card" id="bp-mood">
        <h4>üå° Mood</h4>
        <div class="text-sm text-muted" style="font-size:22px">ü§î</div>
      </div>
      <div class="brain-card">
        <h4>‚ö° Actions</h4>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn btn-s btn-sm" onclick="runResearch()">üî¨ Run Research</button>
          <button class="btn btn-s btn-sm" onclick="go('benchmark')">üèÜ Benchmarks</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BENCHMARK ‚ïê‚ïê‚ïê -->
<div class="page" id="page-benchmark">
  <div class="section-title mb">üèÜ NEXUS Achievement Targets</div>
  <div class="tgrid" id="target-cards">
    <div class="tcard" id="tc1">
      <div class="ttitle">Target 1 ‚Äî Beat S&P 500</div>
      <div class="tval" id="tv1">Sharpe &gt; 0.6</div>
      <div class="tdesc">Minimum viable: outperform passive US equity (SPY 2024 Sharpe ‚âà 0.73)</div>
      <div class="pbar"><div class="pfill b" id="tp1" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc1-v">‚Äî</b></span><span id="tb1" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc2">
      <div class="ttitle">Target 2 ‚Äî Beat BTC Buy &amp; Hold</div>
      <div class="tval" id="tv2">Sharpe &gt; 1.5</div>
      <div class="tdesc">Short-term goal: risk-adjusted better than simply holding Bitcoin (BTC 2024 ‚âà 1.47)</div>
      <div class="pbar"><div class="pfill b" id="tp2" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc2-v">‚Äî</b></span><span id="tb2" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc3">
      <div class="ttitle">Target 3 ‚Äî Beat Renaissance (net)</div>
      <div class="tval" id="tv3">Sharpe &gt; 2.5</div>
      <div class="tdesc">Medium-term: surpass best human hedge fund net-of-fees (Renaissance ‚âà 3.8 gross)</div>
      <div class="pbar"><div class="pfill b" id="tp3" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc3-v">‚Äî</b></span><span id="tb3" class="bdg bg-gray">PENDING</span></div>
    </div>
    <div class="tcard" id="tc4">
      <div class="ttitle">Target 4 ‚Äî World-Class (NEXUS Goal)</div>
      <div class="tval" id="tv4">Sharpe &gt; 5.0</div>
      <div class="tdesc">Long-term: top-tier autonomous quant ‚Äî beyond any human team</div>
      <div class="pbar"><div class="pfill b" id="tp4" style="width:0%"></div></div>
      <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b id="tc4-v">‚Äî</b></span><span id="tb4" class="bdg bg-gray">PENDING</span></div>
    </div>
  </div>

  <!-- Achievement badges -->
  <div class="card mb2">
    <div class="ctitle">Achievement Badges</div>
    <div style="display:flex;gap:16px;flex-wrap:wrap" id="ach-badges">
      <div class="ach" data-level="0" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•â</div><div style="font-size:12px;font-weight:600;margin-top:4px">Bronze</div><div class="text-sm text-muted">Sharpe &gt; 0.6</div></div>
      <div class="ach" data-level="1" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•à</div><div style="font-size:12px;font-weight:600;margin-top:4px">Silver</div><div class="text-sm text-muted">Sharpe &gt; 1.5</div></div>
      <div class="ach" data-level="2" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">ü•á</div><div style="font-size:12px;font-weight:600;margin-top:4px">Gold</div><div class="text-sm text-muted">Sharpe &gt; 2.5</div></div>
      <div class="ach" data-level="3" style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
        <div style="font-size:30px">üíé</div><div style="font-size:12px;font-weight:600;margin-top:4px">Platinum</div><div class="text-sm text-muted">Sharpe &gt; 5.0</div></div>
    </div>
  </div>

  <!-- Benchmark table -->
  <div class="card">
    <div class="ctitle">
      Live Benchmark Comparison
      <button class="btn btn-s btn-sm" onclick="loadBM()">‚Üª Refresh</button>
    </div>
    <div id="bm-table"><div class="empty">Loading...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PERFORMANCE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-performance">
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">Returns Distribution</div>
      <div style="position:relative;height:220px"><canvas id="ret-chart"></canvas></div>
    </div>
    <div class="card">
      <div class="ctitle">Key Metrics</div>
      <div id="pf-stats"><div class="empty">Loading...</div></div>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Walk-Forward Windows</div>
    <div id="wf-body"><div class="empty">Loading...</div></div>
  </div>
  <div class="card">
    <div class="ctitle">
      Validation Suite (8 Tests)
      <div class="row">
        <button class="btn btn-p btn-sm" onclick="runVal()">‚ñ∂ Run Validation</button>
        <span id="val-st" class="text-sm text-muted"></span>
      </div>
    </div>
    <div id="val-body"><div class="empty">No validation results. Click Run to execute all 8 tests.</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RISK ‚ïê‚ïê‚ïê -->
<div class="page" id="page-risk">
  <div class="g3 mb2">
    <div class="card"><div class="ctitle">Value at Risk</div><div id="risk-var"><div class="empty">‚Äî</div></div></div>
    <div class="card"><div class="ctitle">Market Regime</div><div id="risk-regime"><div class="empty">‚Äî</div></div></div>
    <div class="card"><div class="ctitle">Position Limits</div><div id="risk-limits"><div class="empty">‚Äî</div></div></div>
  </div>
  <div class="card">
    <div class="ctitle">Position Detail</div>
    <div id="risk-detail"><div class="empty">Run a backtest to see positions</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RESEARCH ‚ïê‚ïê‚ïê -->
<div class="page" id="page-research">
  <div class="rowb mb2">
    <div class="row">
      <button class="btn btn-p btn-sm" onclick="runResearch()">üî¨ Run Research Cycle</button>
      <span id="rc-st" class="text-sm text-muted"></span>
    </div>
    <button class="btn btn-s btn-sm" onclick="loadResearch()">‚Üª Refresh</button>
  </div>
  <div class="g2 mb2">
    <div class="card">
      <div class="ctitle">Latest Research Cycle</div>
      <div id="rc-latest"><div class="empty">No cycle data yet</div></div>
    </div>
    <div class="card">
      <div class="ctitle">Memory Search</div>
      <div class="row mb" style="gap:6px">
        <input type="text" id="mem-q" placeholder="Search NEXUS knowledge..." style="flex:1">
        <button class="btn btn-s btn-sm" onclick="searchMem()">Search</button>
      </div>
      <div id="mem-results" class="text-sm text-muted">Enter query above...</div>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Strategy Proposals</div>
    <div id="rc-proposals"><div class="empty">No proposals yet</div></div>
  </div>
  <div class="card">
    <div class="ctitle">Recent Alerts</div>
    <div id="rc-alerts"><div class="empty">No alerts</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TASKS ‚ïê‚ïê‚ïê -->
<div class="page" id="page-tasks">
  <div class="card mb2">
    <div class="ctitle">Create Task</div>
    <div class="fr">
      <div><label>Title</label><input type="text" id="t-title" placeholder="Task title..."></div>
      <div><label>Priority</label><select id="t-pri"><option value="high">üî¥ High</option><option value="medium" selected>üü° Medium</option><option value="low">üü¢ Low</option></select></div>
    </div>
    <div class="fr">
      <div><label>Assignee</label><select id="t-who"><option>ATLAS</option><option>CIPHER</option><option>ECHO</option><option>FLUX</option><option value="Human">Human</option></select></div>
      <div><label>Description</label><input type="text" id="t-desc" placeholder="Optional..."></div>
    </div>
    <button class="btn btn-p btn-sm" onclick="createTask()">+ Create Task</button>
  </div>
  <div class="kanban" id="kanban">
    <div class="kcol"><div class="kh">TODO <span class="kcount" id="kc-todo">0</span></div><div id="kl-todo"></div></div>
    <div class="kcol"><div class="kh">IN PROGRESS <span class="kcount" id="kc-inprogress">0</span></div><div id="kl-inprogress"></div></div>
    <div class="kcol"><div class="kh">REVIEW <span class="kcount" id="kc-review">0</span></div><div id="kl-review"></div></div>
    <div class="kcol"><div class="kh">DONE <span class="kcount" id="kc-done">0</span></div><div id="kl-done"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê FILES & REPORTS ‚ïê‚ïê‚ïê -->
<div class="page" id="page-files">
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">üìÅ Files, Reports &amp; Artifacts</div>
    <button class="btn btn-s btn-sm" onclick="loadFiles()">‚Üª Refresh</button>
  </div>
  <div id="file-viewer-panel" style="display:none" class="card mb2">
    <div class="ctitle rowb">
      <span id="fv-path">File Viewer</span>
      <button class="btn btn-s btn-sm" onclick="closeFileViewer()">‚úï Close</button>
    </div>
    <div id="fv-content" class="file-viewer">Select a file to view its content</div>
  </div>
  <div id="files-body"><div class="empty"><div class="spin"></div> Loading artifacts...</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê MARKET ‚ïê‚ïê‚ïê -->
<div class="page" id="page-market">
  <div class="rowb mb2">
    <div class="section-title" style="margin-bottom:0">üì° Live Market Data</div>
    <div class="row">
      <span class="text-sm text-muted" id="mkt-ts">‚Äî</span>
      <button class="btn btn-s btn-sm" onclick="loadMarket()">‚Üª Refresh</button>
    </div>
  </div>
  <div class="card mb2">
    <div class="ctitle">Funding Rates &amp; Carry Signals</div>
    <div id="mkt-funding"><div class="empty">Loading...</div></div>
  </div>
  <div class="card">
    <div class="ctitle">Price &amp; Volume</div>
    <div id="mkt-price"><div class="empty">Loading...</div></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const $$ = s => document.querySelectorAll(s);
function jx(url,opts){return fetch(url,opts).then(r=>{if(!r.ok)throw new Error(r.status);return r.json()});}
function set(id,v){const e=$(id);if(e)e.textContent=v;}
function html(id,h){const e=$(id);if(e)e.innerHTML=h;}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function n2(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return(+v).toFixed(d);}
function pct(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return((+v)*100).toFixed(d)+'%';}
function pctd(v,d=2){if(v==null||isNaN(+v))return'‚Äî';return(+v).toFixed(d)+'%';}
function clr(v,pos=true){if(v==null)return'';return(pos?v>=0:v<=0)?'pos':'neg';}
function now(){return new Date().toLocaleTimeString();}
function toast(m,d=3){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d*1000);}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}

// ‚îÄ‚îÄ‚îÄ Tab system ‚îÄ‚îÄ‚îÄ
const TABS=['overview','chat','benchmark','performance','risk','research','tasks','files','market'];
let _tab='overview';
function go(name){
  $$('.tab').forEach((t,i)=>{t.classList[TABS[i]===name?'add':'remove']('active');});
  $$('.page').forEach(p=>p.classList.remove('active'));
  const pg=$('page-'+name);if(pg)pg.classList.add('active');
  _tab=name;
  LOADERS[name]&&LOADERS[name]();
}

// ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ
let _eq=null,_ret=null;

// ‚îÄ‚îÄ‚îÄ KPI ‚îÄ‚îÄ‚îÄ
let _sharpe=null;
function loadKPI(){
  jx('/api/metrics').then(d=>{
    const m=d.metrics||d||{};
    _sharpe=+(m.sharpe_ratio||m.sharpe||0);
    const se=$('k-sharpe');
    se.textContent=n2(_sharpe);
    se.className='kpi-v '+(_sharpe>=1.5?'pos':_sharpe>=0.6?'neu':'neg');
    const ca=+(m.cagr||m.annualized_return||0);
    const ce=$('k-cagr');ce.textContent=pct(ca);ce.className='kpi-v '+(ca>=0?'pos':'neg');
    const md=+(m.max_drawdown||0);
    const me=$('k-mdd');me.textContent=pct(md);me.className='kpi-v neg';
    const tot=+(m.total_return||0);
    const te=$('k-tot');te.textContent=pct(tot);te.className='kpi-v '+(tot>=0?'pos':'neg');
    set('k-wr',pct(m.win_rate));
    set('k-strat',m.strategy_name||m.run_name||'‚Äî');
    set('kpi-updated','Updated '+now());
    // Header badge
    const v=m.strategy_verdict||(m.sharpe_ratio>=1.5?'GOOD':m.sharpe_ratio>=0.6?'OK':'WEAK');
    const b=$('hdr-badge');b.textContent=v;
    b.className='bdg '+(v==='GOOD'||v==='PASS'?'bg-g':v==='OK'||v==='WARN'?'bg-y':'bg-r');
    // Update targets
    updateTargets(_sharpe);
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Equity chart ‚îÄ‚îÄ‚îÄ
function loadEq(){
  jx('/api/equity').then(d=>{
    const eq=d.equity||[];if(!eq.length)return;
    const vals=eq.map(e=>typeof e==='object'?(e.value||e.equity||e[1]||1):+e);
    const ctx=$('eq-chart');if(!ctx)return;
    if(_eq){_eq.destroy();}
    _eq=new Chart(ctx,{
      type:'line',
      data:{labels:vals.map((_,i)=>i),datasets:[{label:'Portfolio',data:vals,borderColor:'#2563EB',backgroundColor:'rgba(37,99,235,.07)',fill:true,pointRadius:0,tension:.35,borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:'rgba(0,0,0,.05)'},ticks:{font:{size:10}}}}}
    });
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Overview ‚îÄ‚îÄ‚îÄ
function loadOv(){
  loadEq();loadKPI();
  jx('/api/runs').then(d=>{
    const r=(d.runs||d||[])[0];if(!r){html('ov-run','<div class="empty">No runs</div>');return;}
    const m=r.metrics||{};
    html('ov-run',`
      <div class="srow"><span class="lbl">Run</span><span class="val text-sm">${esc(r.run_name||r.name||'‚Äî').slice(0,30)}</span></div>
      <div class="srow"><span class="lbl">Sharpe</span><span class="val ${clr(m.sharpe||m.sharpe_ratio)}">${n2(m.sharpe||m.sharpe_ratio)}</span></div>
      <div class="srow"><span class="lbl">CAGR</span><span class="val ${clr(m.cagr)}">${pct(m.cagr)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(m.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Calmar</span><span class="val">${n2(m.calmar)}</span></div>
    `);
  }).catch(()=>{html('ov-run','<div class="empty">No data</div>');});
  jx('/api/brain/identity').then(d=>{
    const id=d.identity||{};
    html('ov-brain',`
      <div class="srow"><span class="lbl">Name</span><span class="val">${esc(id.name||'NEXUS')}</span></div>
      <div class="srow"><span class="lbl">Role</span><span class="val text-sm">${esc(id.role||'Autonomous Quant')}</span></div>
      <div class="srow"><span class="lbl">Mood</span><span class="val">${esc(id.mood||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Version</span><span class="val">${esc(id.version||'‚Äî')}</span></div>
    `);
  }).catch(()=>{html('ov-brain','<div class="empty">Brain offline</div>');});
  jx('/api/ledger').then(d=>{
    const evs=d.events||d.ledger||[];
    if(!evs.length){html('ov-ledger','<div class="empty">No events</div>');return;}
    const rows=evs.slice(0,12).map(e=>`<tr>
      <td class="text-sm text-muted">${esc((e.ts||e.timestamp||'').slice(0,16).replace('T',' '))}</td>
      <td><span class="bdg ${e.level==='ERROR'?'bg-r':e.level==='WARN'?'bg-y':'bg-b'}">${esc(e.level||'INFO')}</span></td>
      <td>${esc(e.event||e.message||e.msg||'')}</td>
      <td class="text-sm text-muted">${esc(e.source||'‚Äî')}</td>
    </tr>`).join('');
    html('ov-ledger',`<table><thead><tr><th>Time</th><th>Level</th><th>Event</th><th>Source</th></tr></thead><tbody>${rows}</tbody></table>`);
  }).catch(()=>{html('ov-ledger','<div class="empty">No ledger</div>');});
}

// ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ
function loadChat(){
  jx('/api/brain/identity').then(d=>{
    const id=d.identity||{};
    html('bp-identity',`<h4>üß† Identity</h4>
      <div class="srow"><span class="lbl">Name</span><span class="val">${esc(id.name||'NEXUS')}</span></div>
      <div class="srow"><span class="lbl">Role</span><span class="val text-sm">${esc(id.role||'Autonomous Quant AI')}</span></div>
      <div class="srow"><span class="lbl">Mission</span><span class="val text-sm">${esc((id.mission||'Research & Trade').slice(0,40))}</span></div>
    `);
  }).catch(()=>{});
  jx('/api/brain/goals').then(d=>{
    const gs=d.goals||[];
    if(!gs.length){html('bp-goals','<h4>üéØ Goals</h4><div class="text-sm text-muted">No goals</div>');return;}
    const items=gs.slice(0,4).map(g=>{const t=typeof g==='string'?g:(g.goal||g.text||'');return `<div style="padding:3px 0;border-bottom:1px solid var(--border);font-size:12px">${esc(t.slice(0,60))}</div>`;}).join('');
    html('bp-goals','<h4>üéØ Goals</h4>'+items);
  }).catch(()=>{});
  jx('/api/brain/notifications').then(d=>{
    const ns=d.notifications||[];const last=ns.slice(-1)[0];
    const mood=last?.mood||d.mood||'ü§î';
    html('bp-mood',`<h4>üå° Mood</h4><div style="font-size:24px;margin:6px 0">${mood}</div><div class="text-sm text-muted">${esc(last?.message||'Operational')}</div>`);
  }).catch(()=>{});
}
function onChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function chip(t){$('chat-in').value=t;sendMsg();}
function addMsg(role,text){
  const ts=now();const d=document.createElement('div');
  d.className='cmsg '+role;
  d.innerHTML=`<div class="cbubble">${esc(text)}</div><div class="cts">${ts}</div>`;
  $('chat-msgs').appendChild(d);d.scrollIntoView({behavior:'smooth'});
}
function sendMsg(){
  const inp=$('chat-in'),txt=inp.value.trim();if(!txt)return;
  inp.value='';addMsg('u',txt);
  const ty=document.createElement('div');ty.className='cmsg a';ty.id='typing';
  ty.innerHTML='<div class="cbubble"><div class="spin"></div></div>';
  $('chat-msgs').appendChild(ty);ty.scrollIntoView({behavior:'smooth'});
  jx('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt})}).then(d=>{
    const el=$('typing');if(el)el.remove();
    addMsg('a',d.response||d.reply||d.message||'(no response)');
  }).catch(()=>{const el=$('typing');if(el)el.remove();addMsg('a','Error connecting to NEXUS Brain. Ensure ZAI_API_KEY is set.');});
}

// ‚îÄ‚îÄ‚îÄ Benchmark ‚îÄ‚îÄ‚îÄ
const TARGETS=[0.6,1.5,2.5,5.0];
const BM_DATA=[
  {name:'S&P 500 (SPY)',sharpe:0.73,cagr:23.1,mdd:-8.5,note:'2024 actual'},
  {name:'Bitcoin B&H',sharpe:1.47,cagr:125.0,mdd:-28.0,note:'2024 actual'},
  {name:'Ethereum B&H',sharpe:0.62,cagr:50.3,mdd:-35.0,note:'2024 actual'},
  {name:'Renaissance Medallion (net)',sharpe:3.8,cagr:39.0,mdd:-4.0,note:'estimated'},
  {name:'60/40 Portfolio',sharpe:0.55,cagr:15.2,mdd:-10.0,note:'typical'},
  {name:'Simple Funding Carry',sharpe:0.90,cagr:12.0,mdd:-18.0,note:'baseline est.'},
];
function updateTargets(sh){
  if(sh==null)return;
  ['tc1','tc2','tc3','tc4'].forEach((id,i)=>{
    const tgt=TARGETS[i];
    const pct2=Math.min(100,Math.max(0,(sh/tgt)*100));
    const ok=sh>=tgt;
    const card=$(id);const bar=$('tp'+(i+1));const bdg=$('tb'+(i+1));const cur=$('tc'+(i+1)+'-v');
    if(cur)cur.textContent=n2(sh);
    if(bar){bar.style.width=pct2+'%';bar.className='pfill '+(ok?'g':pct2>50?'b':'y');}
    if(bdg){bdg.textContent=ok?'‚úì ACHIEVED':pct2>50?'IN PROGRESS':'PENDING';bdg.className='bdg '+(ok?'bg-g':pct2>50?'bg-b':'bg-gray');}
    if(card){card.className='tcard '+(ok?'achieved':pct2>30?'near':'');}
  });
  // Badges
  $$('.ach').forEach((el,i)=>{
    const ok=sh>=TARGETS[i];
    el.style.opacity=ok?'1':'0.35';el.style.borderStyle=ok?'solid':'dashed';
    el.style.borderColor=ok?'var(--green)':'var(--border)';
  });
}
function loadBM(){
  jx('/api/metrics').then(d=>{
    const m=d.metrics||d||{};
    const sh=+(m.sharpe_ratio||m.sharpe||0);
    const cagr=+(m.cagr||m.annualized_return||0)*100;
    const mdd=+(m.max_drawdown||0)*100;
    updateTargets(sh);
    const nexus={name:`NEXUS ‚Äî ${m.strategy_name||m.run_name||'current'}`,sharpe:sh,cagr,mdd:mdd,note:'live'};
    const all=[nexus,...BM_DATA];
    const rows=all.map((bm,i)=>{
      const isN=i===0;
      const sc=bm.sharpe;
      const vs=isN?'‚Äî':(sh>bm.sharpe?'<span class="bdg bg-g" style="font-size:11px">‚úì WINNING</span>':'<span class="bdg bg-r" style="font-size:11px">‚úó BEHIND</span>');
      const sc_cls=sc>=1.5?'pos':sc>=0.6?'':'neg';
      return `<tr>
        <td><b>${esc(bm.name)}</b>${isN?' <span class="bdg bg-b">NEXUS</span>':''}</td>
        <td class="${isN?(sh>=1.5?'pos':sh>=0.6?'':'neg'):sc_cls}"><b>${n2(bm.sharpe)}</b></td>
        <td class="${bm.cagr>=0?'pos':'neg'}">${n2(bm.cagr,1)}%</td>
        <td class="neg">${n2(Math.abs(bm.mdd),1)}%</td>
        <td>${vs}</td>
        <td class="text-sm text-muted">${esc(bm.note||'')}</td>
      </tr>`;
    }).join('');
    html('bm-table',`<table><thead><tr><th>Strategy</th><th>Sharpe</th><th>CAGR</th><th>Max DD</th><th>vs NEXUS</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`);
  }).catch(()=>{html('bm-table','<div class="empty">Run a backtest first to see comparison</div>');});
}

// ‚îÄ‚îÄ‚îÄ Performance ‚îÄ‚îÄ‚îÄ
function loadPerf(){
  jx('/api/metrics').then(d=>{
    const m=d.metrics||d||{};
    const stats=[
      ['Sharpe Ratio',n2(m.sharpe_ratio||m.sharpe,3),clr(m.sharpe_ratio||m.sharpe)],
      ['Sortino Ratio',n2(m.sortino_ratio||m.sortino,3),''],
      ['Calmar Ratio',n2(m.calmar_ratio||m.calmar,3),''],
      ['CAGR',pct(m.cagr||m.annualized_return),clr(m.cagr)],
      ['Total Return',pct(m.total_return),clr(m.total_return)],
      ['Max Drawdown',pct(m.max_drawdown),'neg'],
      ['Win Rate',pct(m.win_rate),''],
      ['Num Trades',m.num_trades||m.trade_count||'‚Äî',''],
      ['Avg Trade',pct(m.avg_trade_return),''],
      ['Annual Vol',pct(m.annual_volatility||m.volatility),''],
    ];
    html('pf-stats',stats.map(([l,v,c])=>`<div class="srow"><span class="lbl">${l}</span><span class="val ${c}">${v}</span></div>`).join(''));
  }).catch(()=>{html('pf-stats','<div class="empty">No data</div>');});
  jx('/api/walk_forward').then(d=>{
    const wf=d.windows||d.walk_forward||[];
    if(!wf.length){html('wf-body','<div class="empty">No walk-forward data</div>');return;}
    const rows=wf.map((w,i)=>`<tr>
      <td>${i+1}</td>
      <td>${esc((w.start||w.train_start||'').slice(0,10))}</td>
      <td>${esc((w.end||w.test_end||'').slice(0,10))}</td>
      <td class="${clr(w.sharpe||w.oos_sharpe)}">${n2(w.sharpe||w.oos_sharpe)}</td>
      <td>${n2(w.calmar||w.oos_calmar)}</td>
      <td class="neg">${pct(w.max_drawdown||w.oos_mdd)}</td>
      <td>${esc(w.regime||'‚Äî')}</td>
    </tr>`).join('');
    html('wf-body',`<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>OOS Sharpe</th><th>Calmar</th><th>Max DD</th><th>Regime</th></tr></thead><tbody>${rows}</tbody></table>`);
  }).catch(()=>{html('wf-body','<div class="empty">No walk-forward</div>');});
  jx('/api/equity').then(d=>{
    const eq=d.equity||[];if(eq.length<2)return;
    const vals=eq.map(e=>typeof e==='object'?(e.value||e.equity||1):+e);
    const rets=vals.slice(1).map((v,i)=>(v/vals[i]-1)*100);
    const mn=Math.min(...rets),mx=Math.max(...rets);
    const B=20;const step=(mx-mn)/B;
    const counts=new Array(B).fill(0);
    rets.forEach(r=>{const b=Math.min(B-1,Math.floor((r-mn)/step));counts[b]++;});
    const labs=counts.map((_,i)=>(mn+i*step).toFixed(1)+'%');
    const ctx=$('ret-chart');if(!ctx)return;
    if(_ret){_ret.destroy();}
    _ret=new Chart(ctx,{
      type:'bar',
      data:{labels:labs,datasets:[{label:'Freq',data:counts,backgroundColor:labs.map(l=>+l>=0?'rgba(22,163,74,.7)':'rgba(220,38,38,.7)'),borderRadius:2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxTicksLimit:8,font:{size:10}}},y:{grid:{color:'rgba(0,0,0,.05)'}}}}
    });
  }).catch(()=>{});
}
function runVal(){
  set('val-st','Running...');html('val-body','<div class="empty"><div class="spin"></div> Running 8 tests...</div>');
  jx('/api/validation/run',{method:'POST'}).then(d=>{
    set('val-st','');
    const r=d.results||d||{};
    const v=r.overall_verdict||d.verdict||'‚Äî';
    const ts=r.tests||[];
    const vc=v==='PASS'?'bg-g':v==='WARN'?'bg-y':'bg-r';
    let h=`<div class="row mb"><span class="bdg ${vc}" style="font-size:14px">${v}</span><span class="text-sm text-muted">${ts.length} tests</span></div>`;
    if(ts.length){
      const rows=ts.map(t=>`<tr><td>${esc(t.name||'')}</td><td><span class="bdg ${t.verdict==='PASS'?'bg-g':t.verdict==='WARN'?'bg-y':'bg-r'}">${t.verdict||'‚Äî'}</span></td><td>${n2(t.sharpe||t.is_sharpe)}</td><td>${n2(t.oos_sharpe)}</td><td class="text-sm text-muted">${esc(t.notes||t.note||'')}</td></tr>`).join('');
      h+=`<table><thead><tr><th>Test</th><th>Verdict</th><th>IS Sharpe</th><th>OOS Sharpe</th><th>Notes</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    html('val-body',h);toast('Validation done: '+v);
  }).catch(e=>{set('val-st','');html('val-body','<div class="empty">Error: '+esc(String(e))+'</div>');});
}

// ‚îÄ‚îÄ‚îÄ Risk ‚îÄ‚îÄ‚îÄ
function loadRisk(){
  jx('/api/risk').then(d=>{
    const r=d.risk||d||{};
    html('risk-var',`
      <div class="srow"><span class="lbl">VaR 95%</span><span class="val neg">${pct(r.var_95||r.VaR_95)}</span></div>
      <div class="srow"><span class="lbl">VaR 99%</span><span class="val neg">${pct(r.var_99||r.VaR_99)}</span></div>
      <div class="srow"><span class="lbl">CVaR 95%</span><span class="val neg">${pct(r.cvar_95||r.CVaR_95)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(r.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Gross Lev</span><span class="val">${n2(r.gross_leverage||r.current_leverage)}x</span></div>
    `);
    const reg=r.regime||r.market_regime||'‚Äî';
    const rc=reg==='trending'?'bg-g':reg==='volatile'||reg==='crash'?'bg-r':'bg-y';
    html('risk-regime',`
      <div style="text-align:center;padding:16px 0"><span class="bdg ${rc}" style="font-size:15px;padding:7px 18px">${esc(reg.toUpperCase())}</span></div>
      <div class="srow"><span class="lbl">Vol Regime</span><span class="val">${esc(r.vol_regime||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Trend Score</span><span class="val">${n2(r.trend_score)}</span></div>
    `);
    html('risk-limits',`
      <div class="srow"><span class="lbl">Max DD Limit</span><span class="val">${pct(r.max_drawdown_limit)}</span></div>
      <div class="srow"><span class="lbl">Max Gross Lev</span><span class="val">${n2(r.max_gross_leverage,1)}x</span></div>
      <div class="srow"><span class="lbl">Max/Symbol</span><span class="val">${pct(r.max_position_per_symbol)}</span></div>
      <div class="srow"><span class="lbl">Max Turnover</span><span class="val">${pct(r.max_turnover_per_rebalance)}</span></div>
    `);
    const pos=r.positions||r.position_detail||{};
    const prows=Object.entries(pos).map(([s,p])=>`<tr><td><b>${esc(s)}</b></td><td class="${clr(p.weight)}">${pctd((p.weight||0)*100)}</td><td>${n2(p.volatility,4)}</td><td class="${clr(p.pnl||p.return)}">${pct(p.pnl||p.return)}</td></tr>`).join('');
    html('risk-detail',prows?`<table><thead><tr><th>Symbol</th><th>Weight</th><th>Vol</th><th>PnL</th></tr></thead><tbody>${prows}</tbody></table>`:'<div class="empty">No position data</div>');
  }).catch(()=>{['risk-var','risk-regime','risk-limits','risk-detail'].forEach(id=>html(id,'<div class="empty">No risk data. Run a backtest.</div>'));});
}

// ‚îÄ‚îÄ‚îÄ Research ‚îÄ‚îÄ‚îÄ
function loadResearch(){
  jx('/api/research_cycle/latest').then(d=>{
    const r=d.cycle||d||{};
    const ts=(r.ts||r.timestamp||'').slice(0,16).replace('T',' ');
    html('rc-latest',`
      <div class="srow"><span class="lbl">Last Run</span><span class="val">${esc(ts||'‚Äî')}</span></div>
      <div class="srow"><span class="lbl">Papers</span><span class="val">${r.papers_found||r.papers||0}</span></div>
      <div class="srow"><span class="lbl">Tasks Created</span><span class="val">${r.tasks_created||r.tasks||0}</span></div>
      <div class="srow"><span class="lbl">Proposals</span><span class="val">${(r.strategy_proposals||[]).length}</span></div>
      <div class="srow"><span class="lbl">Status</span><span class="val"><span class="bdg bg-g">${esc(r.status||'OK')}</span></span></div>
    `);
    const props=r.strategy_proposals||[];
    if(props.length){
      html('rc-proposals',props.map((p,i)=>`<div class="card mb" style="margin-bottom:8px"><div class="rowb mb"><b class="text-sm">#${i+1} ${esc(p.title||p.name||'Proposal')}</b><span class="bdg bg-b">${esc(p.strategy||'strategy')}</span></div><div class="text-sm text-muted">${esc(p.description||p.rationale||'')}</div></div>`).join(''));
    }
  }).catch(()=>{html('rc-latest','<div class="empty">No research data</div>');});
  jx('/api/alerts').then(d=>{
    const al=d.alerts||[];
    if(!al.length){html('rc-alerts','<div class="empty">No alerts</div>');return;}
    html('rc-alerts',al.slice(0,8).map(a=>`<div class="srow"><span class="bdg ${a.level==='ERROR'?'bg-r':a.level==='WARN'?'bg-y':'bg-b'}">${esc(a.level||'INFO')}</span><span class="text-sm" style="flex:1">${esc(a.message||a.msg||'')}</span><span class="text-sm text-muted">${esc((a.ts||'').slice(11,16))}</span></div>`).join(''));
  }).catch(()=>{html('rc-alerts','<div class="empty">No alerts</div>');});
}
function runResearch(){
  set('rc-st','Running...');
  jx('/api/research_cycle/run',{method:'POST'}).then(d=>{set('rc-st','Done at '+now());loadResearch();toast('Research cycle complete!');}).catch(()=>set('rc-st','Error'));
}
function searchMem(){
  const q=$('mem-q').value.trim();if(!q)return;
  html('mem-results','<div class="spin"></div> Searching...');
  jx('/api/brain/search?q='+encodeURIComponent(q)).then(d=>{
    const rs=d.results||[];
    if(!rs.length){html('mem-results','<div class="empty">No results for "'+esc(q)+'"</div>');return;}
    html('mem-results',rs.slice(0,6).map(r=>`<div style="padding:5px 0;border-bottom:1px solid var(--border)"><div class="text-sm" style="font-weight:500">${esc(r.title||r.key||'')}</div><div class="text-sm text-muted">${esc((r.snippet||r.content||r.value||'').slice(0,120))}</div></div>`).join(''));
  }).catch(()=>html('mem-results','<div class="empty">Search error</div>'));
}
function runAgent(name){
  set('agent-res','Running '+name.toUpperCase()+'...');
  jx('/api/agents/run?agent='+name,{method:'POST'}).then(d=>{set('agent-res',(d.result||d.message||'Done').slice(0,100));toast(name.toUpperCase()+' complete');}).catch(()=>set('agent-res','Error: '+name));
}

// ‚îÄ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ‚îÄ
function loadTasks(){
  jx('/api/tasks').then(d=>{
    const tasks=d.tasks||[];
    const cols={todo:[],inprogress:[],review:[],done:[]};
    tasks.forEach(t=>{const s=(t.status||'todo').toLowerCase().replace(/[- ]/g,'');(cols[s]||cols.todo).push(t);});
    const pc={high:'bg-r',medium:'bg-y',low:'bg-g'};
    const card=t=>`<div class="tsk" title="Click to mark done" onclick="doneTask('${esc(t.id)}')">
      <div class="tsk-title">${esc(t.title||t.name||'Untitled')}</div>
      <div class="tsk-meta">
        <span class="bdg ${pc[t.priority||'medium']||'bg-gray'}">${esc(t.priority||'med')}</span>
        ${t.assignee?`<span class="bdg bg-b">${esc(t.assignee)}</span>`:''}
      </div>
      ${t.description?`<div class="text-sm text-muted" style="margin-top:3px">${esc(t.description.slice(0,70))}</div>`:''}
    </div>`;
    Object.entries(cols).forEach(([k,list])=>{
      set('kc-'+k,list.length);
      html('kl-'+k,list.map(card).join('')||'<div style="padding:8px;font-size:12px;color:var(--fg-light);text-align:center">Empty</div>');
    });
  }).catch(()=>html('kanban','<div class="empty">Could not load tasks</div>'));
}
function createTask(){
  const title=$('t-title').value.trim();if(!title){toast('Title required');return;}
  jx('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,priority:$('t-pri').value,assignee:$('t-who').value,description:$('t-desc').value.trim(),status:'todo'})}).then(()=>{$('t-title').value='';$('t-desc').value='';loadTasks();toast('Task created');}).catch(()=>toast('Error'));
}
function doneTask(id){
  jx('/api/tasks/'+id,{method:'DELETE'}).then(()=>{loadTasks();toast('Task removed');}).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ Files ‚îÄ‚îÄ‚îÄ
function loadFiles(){
  html('files-body','<div class="empty"><div class="spin"></div> Loading...</div>');
  jx('/api/files').then(d=>{
    const secs=d.sections||[];
    if(!secs.length){html('files-body','<div class="empty">No artifacts found</div>');return;}
    let h='';
    secs.forEach(sec=>{
      const icon=sec.icon||'üìÑ';
      const items=sec.items||[];
      h+=`<div class="file-section"><div class="file-section-hdr">${icon} ${esc(sec.title)} <span class="bdg bg-gray">${items.length}</span></div>`;
      if(!items.length){h+='<div class="text-sm text-muted" style="padding-left:20px">Empty</div>';h+='</div>';return;}
      if(sec.type==='runs'){
        h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';
        items.forEach(it=>{
          const sc=it.sharpe!=null?(+it.sharpe>=1.5?'pos':+it.sharpe>=0.6?'':'neg'):'';
          h+=`<div class="run-item" onclick="viewRunReport('${esc(it.path)}')">
            <div class="run-name">${esc(it.name.slice(0,50))}</div>
            <div class="row gap-4" style="flex-wrap:wrap;gap:6px">
              ${it.sharpe!=null?`<span class="bdg ${+it.sharpe>=1.5?'bg-g':+it.sharpe>=0.6?'bg-b':'bg-r'}">Sharpe: ${n2(it.sharpe)}</span>`:''}
              ${it.cagr!=null?`<span class="bdg bg-gray">CAGR: ${pct(it.cagr)}</span>`:''}
              ${it.mdd!=null?`<span class="bdg bg-r">DD: ${pct(it.mdd)}</span>`:''}
            </div>
            <div class="text-sm text-muted" style="margin-top:4px">${esc(it.mtime)} ¬∑ ${(it.files||[]).join(', ').slice(0,60)}</div>
          </div>`;
        });
        h+='</div>';
      } else {
        h+='<div class="file-grid">';
        items.forEach(it=>{
          h+=`<div class="file-item" onclick="viewFile('${esc(it.path)}','${esc(it.name)}')">
            <div class="file-name">${esc(it.name)}</div>
            <div class="file-meta">${fmtSize(it.size||0)} ¬∑ ${esc(it.mtime||'‚Äî')}</div>
          </div>`;
        });
        h+='</div>';
      }
      h+='</div>';
    });
    html('files-body',h);
  }).catch(e=>html('files-body','<div class="empty">Error: '+esc(String(e))+'</div>'));
}
function viewFile(path,name){
  $('fv-path').textContent=path;
  html('fv-content','<div class="spin"></div> Loading '+esc(name)+'...');
  $('file-viewer-panel').style.display='block';
  $('file-viewer-panel').scrollIntoView({behavior:'smooth'});
  jx('/api/files/content?path='+encodeURIComponent(path)).then(d=>{
    let content=d.content||'(empty)';
    if(path.endsWith('.json')){try{content=JSON.stringify(JSON.parse(content),null,2);}catch(e){}}
    html('fv-content',esc(content));
  }).catch(e=>html('fv-content','Error: '+esc(String(e))));
}
function viewRunReport(runPath){
  viewFile(runPath+'/report.md','report.md');
}
function closeFileViewer(){$('file-viewer-panel').style.display='none';}

// ‚îÄ‚îÄ‚îÄ Market ‚îÄ‚îÄ‚îÄ
function loadMarket(){
  set('mkt-ts','Updating...');
  jx('/api/market').then(d=>{
    const items=d.market||d.data||d||[];
    const arr=Array.isArray(items)?items:Object.values(items);
    set('mkt-ts','Updated '+now());
    if(!arr.length){html('mkt-funding','<div class="empty">No data</div>');return;}
    const frows=arr.map(it=>{
      const fr=+(it.funding_rate||it.fundingRate||0);
      const frp=(fr*100).toFixed(4)+'%';
      const ann=(fr*3*365*100).toFixed(1)+'%';
      const sig=fr<-0.005?'<span class="bdg bg-g">LONG ‚Üë</span>':fr>0.005?'<span class="bdg bg-r">SHORT ‚Üì</span>':'<span class="bdg bg-gray">NEUTRAL</span>';
      return `<tr><td><b>${esc(it.symbol||it.s||'‚Äî')}</b></td><td class="${fr<0?'pos':'neg'}">${frp}</td><td>${ann}</td><td>${sig}</td><td class="text-sm text-muted">${esc((it.funding_time||it.nextFundingTime||'').toString().slice(-8,).slice(0,5)||'‚Äî')}</td></tr>`;
    }).join('');
    html('mkt-funding',`<table><thead><tr><th>Symbol</th><th>Funding Rate</th><th>Annualized</th><th>Signal</th><th>Next</th></tr></thead><tbody>${frows}</tbody></table>`);
    const prows=arr.map(it=>{
      const chg=+(it.price_change_24h||it.priceChange||0);
      const price=+(it.mark_price||it.markPrice||it.price||0);
      return `<tr><td><b>${esc(it.symbol||'‚Äî')}</b></td><td>$${price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td class="${chg>=0?'pos':'neg'}">${chg.toFixed(2)}%</td><td class="text-sm text-muted">${it.open_interest||it.openInterest||'‚Äî'}</td></tr>`;
    }).join('');
    html('mkt-price',`<table><thead><tr><th>Symbol</th><th>Mark Price</th><th>24h Change</th><th>Open Interest</th></tr></thead><tbody>${prows}</tbody></table>`);
  }).catch(()=>{html('mkt-funding','<div class="empty">Market data unavailable</div>');set('mkt-ts','Error');});
}

// ‚îÄ‚îÄ‚îÄ Tab loader map ‚îÄ‚îÄ‚îÄ
const LOADERS={
  overview:loadOv,chat:loadChat,benchmark:loadBM,performance:loadPerf,
  risk:loadRisk,research:loadResearch,tasks:loadTasks,files:loadFiles,market:loadMarket
};

// ‚îÄ‚îÄ‚îÄ Auto refresh ‚îÄ‚îÄ‚îÄ
function refresh(){loadKPI();LOADERS[_tab]&&LOADERS[_tab]();}
setInterval(()=>{loadKPI();if(_tab==='market')loadMarket();},30000);
setInterval(()=>{if(LOADERS[_tab]&&_tab!=='chat')LOADERS[_tab]();},90000);

// ‚îÄ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ
setInterval(()=>set('hdr-clock',new Date().toLocaleTimeString()),1000);

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
loadKPI();
loadOv();
</script>
</body>
</html>
