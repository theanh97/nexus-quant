<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>NEXUS — Autonomous Quant Workforce</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Manrope:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --font-ui: 'Inter', 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
      --bg: #FAFAFA;
      --surface: #FFFFFF;
      --surface2: #F5F5F5;
      --border: rgba(0, 0, 0, 0.06);
      --border-strong: rgba(0, 0, 0, 0.12);
      --accent: #000000;
      --accent-hover: #333333;
      --accent-light: rgba(0, 0, 0, 0.04);
      --green: #22C55E;
      --green-light: #F0FDF4;
      --red: #EF4444;
      --red-light: #FEF2F2;
      --yellow: #F59E0B;
      --yellow-light: #FFFBEB;
      --purple: #8B5CF6;
      --purple-light: #F5F3FF;
      --fg: #111111;
      --fg-muted: #666666;
      --fg-light: #999999;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
      --r: 8px;
      --r-sm: 4px;
      --s1: 4px;
      --s2: 8px;
      --s3: 12px;
      --s4: 16px;
      --s5: 20px;
    }

    :root[data-theme="dark"] {
      --bg: #000000;
      --surface: #0A0A0A;
      --surface2: #141414;
      --border: rgba(255, 255, 255, 0.08);
      --border-strong: rgba(255, 255, 255, 0.15);
      --accent: #FFFFFF;
      --accent-hover: #E5E5E5;
      --accent-light: rgba(255, 255, 255, 0.06);
      --green: #4ADE80;
      --green-light: rgba(74, 222, 128, 0.1);
      --red: #F87171;
      --red-light: rgba(248, 113, 113, 0.1);
      --yellow: #FBBF24;
      --yellow-light: rgba(251, 191, 36, 0.1);
      --purple: #A78BFA;
      --purple-light: rgba(167, 139, 250, 0.1);
      --fg: #EAEAEA;
      --fg-muted: #888888;
      --fg-light: #555555;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: var(--font-ui);
      background: radial-gradient(1200px 700px at 85% -10%, color-mix(in srgb, var(--accent) 5%, transparent), transparent 60%),
        radial-gradient(900px 500px at -10% 0%, color-mix(in srgb, var(--green) 3%, transparent), transparent 55%),
        var(--bg);
      color: var(--fg);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    .hdr {
      background: color-mix(in srgb, var(--surface) 60%, transparent);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 200;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.02)
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      color: var(--fg);
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--fg-muted);
      font-weight: 400;
      margin-left: 4px;
      -webkit-text-fill-color: var(--fg-muted)
    }

    .hdr-mini {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto
    }

    .hdr-chip {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 9px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface2);
      white-space: nowrap;
      transition: all .2s
    }

    .hdr-chip.pos {
      color: var(--green);
      border-color: var(--green)
    }

    .hdr-chip.neg {
      color: var(--red);
      border-color: var(--red)
    }

    .hdr-chip.neu {
      color: var(--yellow);
      border-color: var(--yellow)
    }

    .hdr-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto
    }

    .hdr-live {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--fg-muted)
    }

    .live-heart {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--yellow);
      box-shadow: 0 0 0 rgba(37, 99, 235, .2)
    }

    .hdr-live.connected .live-heart {
      background: var(--green);
      animation: heartbeat 1.7s infinite
    }

    .hdr-live.connecting .live-heart,
    .hdr-live.stale .live-heart {
      background: var(--yellow)
    }

    .hdr-live.disconnected .live-heart {
      background: var(--red)
    }

    @keyframes heartbeat {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(22, 163, 74, .4)
      }

      70% {
        transform: scale(1.1);
        box-shadow: 0 0 0 8px rgba(22, 163, 74, 0)
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(22, 163, 74, 0)
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: .95
      }

      50% {
        transform: scale(1.08);
        opacity: .65
      }

      100% {
        transform: scale(1);
        opacity: .95
      }
    }

    .global-loader {
      position: sticky;
      top: 54px;
      z-index: 190;
      height: 2px;
      background: transparent;
      overflow: hidden
    }

    .global-loader .bar {
      height: 100%;
      width: 28%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      transform: translateX(-120%);
      opacity: 0
    }

    .global-loader.active .bar {
      opacity: 1;
      animation: global-load 1.1s linear infinite
    }

    @keyframes global-load {
      0% {
        transform: translateX(-120%)
      }

      100% {
        transform: translateX(430%)
      }
    }

    /* Tab bar */
    .tabs {
      background: color-mix(in srgb, var(--surface) 90%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      gap: 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: sticky;
      top: 56px;
      z-index: 180;
      backdrop-filter: blur(8px)
    }

    .tab {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--fg-muted);
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      flex-shrink: 0;
      border-radius: 8px 8px 0 0;
    }

    .tab:hover {
      color: var(--fg);
    }

    .tab.active {
      color: var(--fg);
      font-weight: 600;
      border-bottom-color: var(--fg);
    }

    .tab.live::after,
    .tab.loading::after,
    .tab.stale::after {
      content: "";
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-left: 2px
    }

    .tab.live::after {
      background: var(--green);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--green) 18%, transparent)
    }

    .tab.loading::after {
      background: var(--yellow);
      animation: pulse 1.2s infinite
    }

    .tab.stale::after {
      background: var(--red)
    }

    /* KPI strip */
    .kpi-strip {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 24px;
      display: flex;
      gap: 28px;
      overflow-x: auto;
      align-items: center
    }

    .kpi {
      display: flex;
      flex-direction: column;
      min-width: 70px
    }

    .kpi-l {
      font-size: 10px;
      font-weight: 600;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .06em
    }

    .kpi-v {
      font-size: 17px;
      font-weight: 700;
      transition: all .25s ease
    }

    .kpi-v.bump {
      animation: kpi-bump .35s ease
    }

    .kpi-v.pos {
      color: var(--green)
    }

    .kpi-v.neg {
      color: var(--red)
    }

    .kpi-v.neu {
      color: var(--yellow)
    }

    .kpi-v.acc {
      color: var(--accent)
    }

    @keyframes kpi-bump {
      0% {
        transform: translateY(2px);
        opacity: .7
      }

      100% {
        transform: translateY(0);
        opacity: 1
      }
    }

    .progress-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface2);
      font-size: 11px;
      color: var(--fg-muted)
    }

    .progress-pill .progress-track {
      width: 76px;
      height: 4px;
      border-radius: 999px;
      background: var(--border);
      overflow: hidden
    }

    .progress-pill .progress-fill {
      width: 38%;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--green));
      animation: prog 1.2s linear infinite
    }

    .progress-pill.idle .progress-fill {
      display: none
    }

    @keyframes prog {
      0% {
        transform: translateX(-55%)
      }

      100% {
        transform: translateX(210%)
      }
    }

    #auto-sync-badge {
      max-width: min(42vw, 460px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    /* Pages */
    .page {
      display: none;
      padding: 32px 32px;
      max-width: 1280px;
      margin: 0 auto;
      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      opacity: 0;
      transform: translateY(10px);
    }

    .page.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* Cards */
    .card {
      position: relative;
      background: color-mix(in srgb, var(--surface) 95%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 12px;
      padding: 24px;
      box-shadow: inset 0 0 0 1px var(--border), var(--shadow);
      transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .card:hover {
      box-shadow: inset 0 0 0 1px var(--border-strong), var(--shadow-md);
      transform: translateY(-2px);
    }

    .ctitle {
      font-size: 11px;
      font-weight: 700;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .section-stamp {
      margin-left: auto;
      font-size: 10px;
      font-weight: 500;
      color: var(--fg-light);
      text-transform: none;
      letter-spacing: 0
    }

    .mvp-hero {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 12px;
      padding: 16px;
      border: 1px solid color-mix(in srgb, var(--accent) 32%, var(--border));
      border-radius: 12px;
      background:
        radial-gradient(120% 120% at 0% 0%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 45%),
        radial-gradient(100% 100% at 100% 100%, color-mix(in srgb, var(--green) 10%, transparent), transparent 55%),
        color-mix(in srgb, var(--surface) 94%, transparent)
    }

    .mvp-kicker {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--accent);
      font-weight: 700
    }

    .mvp-title {
      font-size: 21px;
      font-weight: 800;
      letter-spacing: -.02em;
      line-height: 1.2;
      margin: 5px 0 8px
    }

    .mvp-sub {
      font-size: 12px;
      color: var(--fg-muted);
      max-width: 80ch
    }

    .mvp-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px
    }

    .mvp-points {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px
    }

    .mvp-point {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--surface2) 70%, transparent)
    }

    .mvp-point .lbl {
      font-size: 10px;
      font-weight: 700;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .mvp-point .val {
      font-size: 13px;
      font-weight: 700;
      margin-top: 2px;
      line-height: 1.35
    }

    @media(max-width:960px) {
      .mvp-hero {
        grid-template-columns: 1fr
      }

      .mvp-title {
        font-size: 18px
      }

      .mvp-sub {
        max-width: none
      }
    }

    .story-strip {
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 10px;
      padding: 10px 24px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 94%, transparent)
    }

    .story-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in srgb, var(--surface) 50%, transparent);
      backdrop-filter: blur(8px);
      padding: 12px 14px;
      text-align: left;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: var(--font-ui);
      appearance: none;
      color: inherit;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
    }

    .story-card:hover {
      border-color: var(--border-strong);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .story-kicker {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--fg-muted)
    }

    .story-head {
      font-size: 14px;
      font-weight: 700;
      margin-top: 2px
    }

    .story-desc {
      font-size: 11px;
      color: var(--fg-muted);
      margin-top: 2px;
      line-height: 1.35
    }

    .story-signal {
      margin-top: 7px;
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    @media(max-width:1000px) {
      .story-strip {
        grid-template-columns: repeat(2, minmax(160px, 1fr));
        padding: 10px 12px
      }
    }

    @media(max-width:640px) {
      .story-strip {
        grid-template-columns: 1fr
      }
    }

    .tab-focus-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:
        linear-gradient(135deg, color-mix(in srgb, var(--accent) 8%, transparent), transparent 44%),
        color-mix(in srgb, var(--surface) 96%, transparent);
      margin-bottom: 12px
    }

    .tab-focus-kicker {
      font-size: 10px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--fg-muted);
      font-weight: 700
    }

    .tab-focus-title {
      font-size: 16px;
      font-weight: 800;
      letter-spacing: -.01em;
      margin-top: 1px
    }

    .tab-focus-sub {
      font-size: 12px;
      color: var(--fg-muted);
      margin-top: 2px
    }

    .tab-focus-watch {
      font-size: 11px;
      color: var(--accent);
      margin-top: 6px;
      font-weight: 700
    }

    .tab-focus-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end
    }

    .tab-focus-meta {
      display: flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap
    }

    @media(max-width:860px) {
      .tab-focus-meta {
        width: 100%
      }
    }

    @media(max-width:860px) {
      .tab-focus-hero {
        flex-direction: column;
        align-items: flex-start
      }

      .tab-focus-right {
        justify-content: flex-start
      }
    }

    .cmdk-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, .45);
      backdrop-filter: blur(3px);
      z-index: 880;
      display: none
    }

    .cmdk {
      position: fixed;
      top: 12vh;
      left: 50%;
      transform: translateX(-50%);
      width: min(760px, 92vw);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow-md);
      z-index: 890;
      display: none;
      overflow: hidden
    }

    .cmdk-head {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border)
    }

    .cmdk-input {
      flex: 1;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 10px
    }

    .cmdk-list {
      max-height: 48vh;
      overflow: auto;
      padding: 8px
    }

    .cmdk-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid transparent;
      border-radius: 10px;
      background: transparent;
      color: var(--fg);
      cursor: pointer;
      font-family: var(--font-ui)
    }

    .cmdk-item:hover,
    .cmdk-item.active {
      background: var(--surface2);
      border-color: var(--border)
    }

    .cmdk-tag {
      font-size: 10px;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .cmdk-empty {
      padding: 16px;
      text-align: center;
      color: var(--fg-muted);
      font-size: 13px
    }

    .card.expandable {
      position: relative
    }

    .card-expand-btn {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--fg-muted);
      border-radius: 6px;
      padding: 2px 7px;
      font-size: 11px;
      cursor: pointer
    }

    .card-expand-btn:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .card.expanded {
      grid-column: 1 / -1 !important;
      border-color: var(--accent)
    }

    /* Table tools */
    .table-tools {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap
    }

    .table-search {
      min-width: 180px;
      max-width: 300px;
      font-size: 12px;
      padding: 6px 9px
    }

    .table-meta {
      font-size: 11px;
      color: var(--fg-muted)
    }

    th.sortable {
      cursor: pointer;
      user-select: none
    }

    th.sortable::after {
      content: " ↕";
      font-size: 10px;
      color: var(--fg-light)
    }

    th.sort-asc::after {
      content: " ↑";
      color: var(--accent)
    }

    th.sort-desc::after {
      content: " ↓";
      color: var(--accent)
    }

    /* Skeleton */
    .skel {
      position: relative;
      overflow: hidden;
      background: var(--surface2);
      border-radius: 6px
    }

    .skel::after {
      content: "";
      position: absolute;
      top: 0;
      left: -120px;
      width: 90px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .28), transparent);
      animation: shimmer 1.35s infinite
    }

    .skel-row {
      height: 14px;
      margin-bottom: 8px
    }

    .skel-row:last-child {
      margin-bottom: 0
    }

    @keyframes shimmer {
      to {
        left: calc(100% + 120px)
      }
    }

    /* Grid */
    .g3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px
    }

    .g2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px
    }

    .g4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px
    }

    @media(max-width:1100px) {
      .g3 {
        grid-template-columns: repeat(2, 1fr)
      }

      .g4 {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media(max-width:700px) {

      .g3,
      .g2,
      .g4 {
        grid-template-columns: 1fr
      }
    }

    #aw-kpis {
      grid-template-columns: repeat(4, 1fr)
    }

    #aw-bullets {
      grid-template-columns: 1fr 1fr
    }

    @media(max-width:900px) {
      #aw-kpis {
        grid-template-columns: repeat(2, 1fr)
      }

      #aw-bullets {
        grid-template-columns: 1fr
      }
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      font-family: inherit;
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      user-select: none;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-p {
      background: var(--fg);
      color: var(--bg);
      border: 1px solid transparent;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .btn-p:hover {
      background: var(--fg-muted);
      color: var(--bg);
    }

    .btn-s {
      background: var(--surface);
      color: var(--fg);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 1px 2px rgba(0, 0, 0, 0.02);
    }

    .btn-s:hover {
      background: var(--surface2);
      border-color: var(--border-strong);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    .btn-danger {
      background: var(--red);
      color: #fff;
      border: 1px solid transparent;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    /* Badges */
    .bdg {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      border: 1px solid transparent;
    }

    .bg-g {
      background: var(--green-light);
      color: var(--green);
      border-color: color-mix(in srgb, var(--green) 20%, transparent);
    }

    .bg-r {
      background: var(--red-light);
      color: var(--red);
      border-color: color-mix(in srgb, var(--red) 20%, transparent);
    }

    .bg-y {
      background: var(--yellow-light);
      color: var(--yellow);
      border-color: color-mix(in srgb, var(--yellow) 20%, transparent);
    }

    .bg-b {
      background: var(--accent-light);
      color: var(--accent);
      border-color: color-mix(in srgb, var(--accent) 20%, transparent);
    }

    .bg-p {
      background: var(--purple-light);
      color: var(--purple);
      border-color: color-mix(in srgb, var(--purple) 20%, transparent);
    }

    .bg-gray {
      background: var(--surface2);
      color: var(--fg-muted);
      border-color: var(--border);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      text-align: left;
      font-size: 11px;
      font-weight: 500;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 10;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--fg);
      font-variant-numeric: tabular-nums;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: var(--surface2);
    }

    /* Pitch step flow */
    .pitch-step {
      min-width: 130px;
      max-width: 160px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 12px;
      text-align: center;
      flex-shrink: 0
    }

    .pitch-step-icon {
      font-size: 1.6rem;
      margin-bottom: 4px
    }

    .pitch-step-num {
      font-size: 10px;
      font-weight: 700;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .pitch-step-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--fg);
      margin: 4px 0
    }

    .pitch-step-desc {
      font-size: 11px;
      color: var(--fg-muted);
      line-height: 1.4
    }

    .pitch-arrow {
      display: flex;
      align-items: center;
      font-size: 20px;
      color: var(--accent);
      padding: 0 6px;
      flex-shrink: 0
    }

    /* Verification badges */
    .vbadge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px
    }

    .vbadge.pass {
      background: #F0FDF4;
      border: 1px solid #86EFAC
    }

    .vbadge.fail {
      background: #FFF5F5;
      border: 1px solid #FCA5A5
    }

    .vbadge.warn {
      background: #FFFBEB;
      border: 1px solid #FCD34D
    }

    /* Stat rows */
    .srow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px
    }

    .srow:last-child {
      border-bottom: none
    }

    .srow .lbl {
      color: var(--fg-muted)
    }

    .srow .val {
      font-weight: 500
    }

    /* Console */
    .console-wrap {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
      height: calc(100vh - 200px);
      min-height: 500px
    }

    @media(max-width:900px) {
      .console-wrap {
        grid-template-columns: 1fr
      }
    }

    .proc-list {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .proc-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      font-size: 13px;
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .proc-item:hover {
      background: var(--surface2);
      border-color: var(--border-strong);
    }

    .proc-item.running {
      border-color: color-mix(in srgb, var(--green) 30%, var(--border));
    }

    .proc-item.stopped {
      border-color: var(--border);
      opacity: 0.6;
    }

    .proc-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0
    }

    .proc-status.running {
      background: var(--green);
      animation: pulse 2s infinite
    }

    .proc-status.stopped {
      background: var(--border)
    }

    .ctrl-btn-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px
    }

    .ctrl-btn {
      padding: 5px 11px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      font-size: 12px;
      cursor: pointer;
      transition: all .2s
    }

    .ctrl-btn:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent)
    }

    .ctrl-btn.danger:hover {
      background: #EF4444;
      border-color: #EF4444;
      color: #fff
    }

    .log-viewer {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .log-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .log-tab {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--fg-muted);
      transition: all 0.2s;
    }

    .log-tab:hover {
      color: var(--fg);
    }

    .log-tab.active {
      border-bottom-color: var(--fg);
      color: var(--fg);
      font-weight: 600;
      background: var(--surface);
    }

    .log-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      font-size: 12px;
      font-family: var(--font-mono);
      line-height: 1.6;
      background: color-mix(in srgb, var(--surface2) 40%, transparent);
      color: var(--fg);
    }

    .log-body .lg-info {
      color: #7EC8E3
    }

    .log-body .lg-warn {
      color: #F9C74F
    }

    .log-body .lg-err {
      color: #FF6B6B
    }

    .log-body .lg-ok {
      color: #90EE90
    }

    .log-toolbar {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      flex-wrap: wrap
    }

    .log-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 11px;
      color: var(--fg-muted);
      background: var(--surface2)
    }

    .log-pill .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--yellow)
    }

    .log-pill.connected .dot {
      background: var(--green)
    }

    .log-pill.disconnected .dot {
      background: var(--red)
    }

    .log-pill.paused .dot {
      background: var(--yellow)
    }

    .log-search {
      width: 180px;
      min-width: 120px;
      padding: 5px 9px;
      border-radius: 6px;
      font-size: 11px
    }

    .log-line {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 10px;
      align-items: start
    }

    .log-ln {
      color: #64748b;
      user-select: none;
      text-align: right
    }

    .log-text {
      white-space: pre-wrap;
      word-break: break-word
    }

    :root[data-theme="dark"] .log-line .log-ln {
      color: #475569
    }

    .phase-timeline {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .phase-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid transparent;
    }

    .phase-item.done {
      background: var(--surface2);
      border-color: var(--border);
    }

    .phase-item.curr {
      background: var(--accent-light)
    }

    .phase-num {
      font-weight: 700;
      font-size: 11px;
      min-width: 36px;
      color: var(--accent)
    }

    .year-bar-wrap {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 120px;
      padding: 8px 0
    }

    .year-bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      gap: 4px
    }

    .year-bar {
      width: 100%;
      border-radius: 4px 4px 0 0;
      transition: height .4s ease;
      min-height: 4px;
      cursor: pointer
    }

    .year-bar.pos {
      background: linear-gradient(180deg, var(--green), #86efac)
    }

    .year-bar.neg {
      background: linear-gradient(180deg, #FF6B6B, #fca5a5)
    }

    .year-bar.is {
      background: linear-gradient(180deg, var(--yellow), #fde68a);
      opacity: .6
    }

    .year-bar-lbl {
      font-size: 10px;
      color: var(--fg-muted);
      text-align: center
    }

    .year-bar-val {
      font-size: 11px;
      font-weight: 700;
      text-align: center
    }

    .bias-card {
      border-left: 4px solid #EF4444
    }

    .bias-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px
    }

    .bias-row:last-child {
      border-bottom: none
    }

    .bias-type {
      color: var(--fg-muted)
    }

    .bias-verdict.pass {
      color: var(--green);
      font-weight: 600
    }

    .bias-verdict.warn {
      color: var(--yellow);
      font-weight: 600
    }

    .bias-verdict.fail {
      color: #EF4444;
      font-weight: 600
    }

    .sys-meter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 12px
    }

    .sys-bar {
      flex: 1;
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden
    }

    .sys-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .5s
    }

    .sys-fill.ok {
      background: var(--green)
    }

    .sys-fill.warn {
      background: var(--yellow)
    }

    .sys-fill.crit {
      background: #EF4444
    }

    /* Debate */
    .debate-wrap {
      border: 2px solid #6366f1;
      border-radius: 10px;
      overflow: hidden;
      margin: 4px 0
    }

    .debate-header {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      color: #fff;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600
    }

    .debate-round {
      padding: 0 12px;
      border-bottom: 1px solid var(--border)
    }

    .debate-round-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: 6px 0 2px
    }

    .debate-contrib {
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px
    }

    .debate-contrib:last-child {
      border-bottom: none
    }

    .debate-model-tag {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      margin-bottom: 3px
    }

    .tag-glm {
      background: #e0f2fe;
      color: #0369a1
    }

    .tag-claude {
      background: #f3e8ff;
      color: #7c3aed
    }

    .tag-codex {
      background: #dcfce7;
      color: #166534
    }

    .tag-minimax {
      background: #fff7ed;
      color: #c2410c
    }

    .tag-gemini {
      background: #e8f5e9;
      color: #1b5e20
    }

    .tag-synthesis {
      background: #1e1b4b;
      color: #e0e7ff
    }

    .debate-synthesis {
      padding: 10px 12px;
      background: linear-gradient(135deg, #1e1b4b, #312e81);
      color: #e0e7ff;
      font-size: 12px;
      line-height: 1.6
    }

    .debate-actions {
      padding: 8px 12px;
      background: #f8fafc;
      font-size: 12px
    }

    .debate-action-item {
      padding: 3px 0;
      color: var(--accent);
      font-weight: 500
    }

    .debate-confidence {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 6px
    }

    .debate-btn-active {
      background: linear-gradient(90deg, #6366f1, #8b5cf6) !important;
      color: #fff !important;
      border-color: #6366f1 !important
    }

    /* Chat */
    .chat-wrap {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 14px;
      height: calc(100vh - 200px);
      min-height: 560px
    }

    @media(max-width:900px) {
      .chat-wrap {
        grid-template-columns: 1fr
      }
    }

    .chat-box {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: var(--surface);
      overflow: hidden
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px
    }

    .chat-header-right {
      display: flex;
      align-items: center;
      gap: 6px
    }

    .model-badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 10px;
      background: var(--accent-light);
      color: var(--accent);
      font-weight: 600;
      letter-spacing: .03em
    }

    .sse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
      flex-shrink: 0
    }

    .sse-dot.yellow {
      background: var(--yellow)
    }

    .chat-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0
    }

    .cmsg {
      display: flex;
      flex-direction: column
    }

    .cmsg.u {
      align-self: flex-end;
      max-width: 75%
    }

    .cmsg.a {
      align-self: flex-start;
      max-width: 90%
    }

    .cbubble {
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13.5px;
      line-height: 1.6;
      word-break: break-word;
      position: relative
    }

    .cmsg.u .cbubble {
      background: var(--accent);
      color: #fff;
      border-bottom-right-radius: 3px
    }

    .cmsg.a .cbubble {
      background: var(--surface);
      color: var(--fg);
      border-bottom-left-radius: 3px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent)
    }

    .cbubble p {
      margin: 0 0 6px
    }

    .cbubble p:last-child {
      margin-bottom: 0
    }

    .cbubble h1,
    .cbubble h2,
    .cbubble h3 {
      font-size: 14px;
      font-weight: 700;
      margin: 8px 0 4px;
      color: var(--fg)
    }

    .cbubble ul,
    .cbubble ol {
      margin: 4px 0 4px 18px;
      padding: 0
    }

    .cbubble li {
      margin: 2px 0
    }

    .cbubble code {
      background: rgba(0, 0, 0, .07);
      border-radius: 4px;
      padding: 1px 5px;
      font-family: monospace;
      font-size: 12.5px
    }

    .cbubble pre {
      background: #1e1e2e;
      color: #cdd6f4;
      border-radius: 8px;
      padding: 10px 12px;
      margin: 6px 0;
      overflow-x: auto
    }

    .cbubble pre code {
      background: none;
      padding: 0;
      font-size: 12px;
      color: inherit
    }

    .cbubble table {
      border-collapse: collapse;
      font-size: 12px;
      margin: 6px 0;
      width: 100%
    }

    .cbubble th {
      background: var(--surface2);
      padding: 4px 8px;
      text-align: left;
      border: 1px solid var(--border)
    }

    .cbubble td {
      padding: 3px 8px;
      border: 1px solid var(--border)
    }

    .cbubble strong {
      font-weight: 700
    }

    .cbubble em {
      font-style: italic
    }

    .cmsg-footer {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 3px
    }

    .cts {
      font-size: 10px;
      color: var(--fg-light);
      opacity: 0
    }

    .cmsg:hover .cts {
      opacity: 1
    }

    .copy-btn {
      font-size: 10px;
      color: var(--fg-light);
      cursor: pointer;
      padding: 1px 5px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: none;
      opacity: 0;
      transition: all .15s
    }

    .cmsg:hover .copy-btn {
      opacity: 1
    }

    .copy-btn:hover {
      border-color: var(--border);
      background: var(--surface2)
    }

    .chat-in-bar {
      padding: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      background: var(--surface);
      flex-shrink: 0;
      align-items: flex-end
    }

    .chat-ta {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      min-height: 40px;
      max-height: 150px;
      overflow-y: auto;
      line-height: 1.5;
      transition: border-color .15s
    }

    .chat-ta:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .1)
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      flex-shrink: 0
    }

    .chip {
      padding: 4px 11px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 11.5px;
      cursor: pointer;
      background: var(--surface);
      color: var(--fg);
      transition: all .15s;
      white-space: nowrap
    }

    .chip:hover {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent)
    }

    .brain-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      max-height: calc(100vh - 200px)
    }

    .brain-card {
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px 14px;
      background: var(--surface);
      flex-shrink: 0
    }

    .brain-card h4 {
      font-size: 11px;
      font-weight: 600;
      color: var(--fg-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: .05em;
      display: flex;
      align-items: center;
      gap: 5px
    }

    .live-metrics-card {
      border: 1px solid var(--accent);
      border-radius: var(--r);
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--surface), var(--accent-light));
      flex-shrink: 0
    }

    .live-metrics-card h4 {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: .05em
    }

    .lm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px
    }

    .lm-cell {
      text-align: center;
      padding: 6px;
      background: rgba(255, 255, 255, .5);
      border-radius: 6px
    }

    .lm-val {
      font-size: 16px;
      font-weight: 700;
      color: var(--fg)
    }

    .lm-lbl {
      font-size: 9px;
      color: var(--fg-muted);
      text-transform: uppercase;
      margin-top: 1px
    }

    .is-badge {
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 3px
    }

    .is-badge.is {
      background: #DBEAFE;
      color: #1D4ED8
    }

    .is-badge.oos {
      background: #D1FAE5;
      color: #065F46
    }

    .sse-feed {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .sse-item {
      font-size: 11px;
      padding: 4px 7px;
      background: var(--surface2);
      border-radius: 5px;
      border-left: 2px solid var(--accent);
      color: var(--fg);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .sse-item.err {
      border-left-color: var(--red)
    }

    .sse-item.warn {
      border-left-color: var(--yellow)
    }

    /* Benchmark targets */
    .tgrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 18px
    }

    @media(max-width:700px) {
      .tgrid {
        grid-template-columns: 1fr
      }
    }

    .tcard {
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      background: var(--surface);
      transition: all .3s
    }

    .tcard.achieved {
      border-color: var(--green);
      background: var(--green-light)
    }

    .tcard.near {
      border-color: var(--accent);
      background: var(--accent-light)
    }

    .ttitle {
      font-size: 11px;
      font-weight: 600;
      color: var(--fg-muted);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: .05em
    }

    .tval {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px
    }

    .tdesc {
      font-size: 12px;
      color: var(--fg-muted);
      margin-bottom: 8px
    }

    .pbar {
      height: 5px;
      background: var(--surface2);
      border-radius: 3px;
      overflow: hidden
    }

    .pfill {
      height: 100%;
      border-radius: 3px;
      transition: width .6s
    }

    .pfill.g {
      background: var(--green)
    }

    .pfill.b {
      background: var(--accent)
    }

    .pfill.y {
      background: var(--yellow)
    }

    /* Kanban */
    .kanban {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px
    }

    @media(max-width:1000px) {
      .kanban {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media(max-width:600px) {
      .kanban {
        grid-template-columns: 1fr
      }
    }

    .kcol {
      background: var(--surface2);
      border-radius: var(--r);
      padding: 10px
    }

    .kh {
      font-size: 11px;
      font-weight: 600;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .kcount {
      background: var(--border);
      border-radius: 20px;
      padding: 1px 7px;
      font-size: 11px
    }

    .tsk {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 9px 11px;
      margin-bottom: 6px;
      cursor: pointer
    }

    .tsk:hover {
      box-shadow: var(--shadow-md)
    }

    .tsk-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px
    }

    .tsk-meta {
      display: flex;
      gap: 5px;
      flex-wrap: wrap
    }

    /* File explorer */
    .file-section {
      margin-bottom: 18px
    }

    .file-section-hdr {
      font-size: 13px;
      font-weight: 600;
      color: var(--fg);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer
    }

    .file-section-hdr:hover {
      color: var(--accent)
    }

    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px
    }

    .file-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all .15s
    }

    .file-item:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md)
    }

    .file-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--fg);
      margin-bottom: 2px;
      word-break: break-all
    }

    .file-meta {
      font-size: 11px;
      color: var(--fg-muted)
    }

    .run-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px;
      cursor: pointer;
      transition: all .15s
    }

    .run-item:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md)
    }

    .run-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--fg);
      margin-bottom: 6px;
      word-break: break-all
    }

    .file-viewer {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      font-family: var(--font-mono);
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-top: 10px
    }

    .hide {
      display: none !important
    }

    /* Misc */
    .mb {
      margin-bottom: 14px
    }

    .mb2 {
      margin-bottom: 20px
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .rowb {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px
    }

    .empty {
      text-align: center;
      padding: 36px;
      color: var(--fg-muted);
      font-size: 14px
    }

    .spin {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    input,
    select,
    textarea {
      font-family: inherit;
      font-size: 14px;
      color: var(--fg);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 11px;
      outline: none
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .1)
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: var(--fg-muted);
      margin-bottom: 3px;
      display: block
    }

    .fr {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--fg);
      color: #fff;
      padding: 9px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      transition: opacity .3s;
      pointer-events: none
    }

    .toast.show {
      opacity: 1
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--fg);
      margin-bottom: 14px
    }

    .text-sm {
      font-size: 12px
    }

    .text-muted {
      color: var(--fg-muted)
    }

    .text-green {
      color: var(--green)
    }

    .text-red {
      color: var(--red)
    }

    #eq-chart-wrap {
      position: relative;
      height: 240px
    }

    .pos {
      color: var(--green)
    }

    .neg {
      color: var(--red)
    }

    /* Responsive polish */
    @media(max-width:980px) {
      .hdr {
        height: auto;
        min-height: 56px;
        padding: 8px 12px;
        flex-wrap: wrap;
        gap: 8px
      }

      .logo-sub {
        display: none
      }

      .hdr-mini {
        order: 3;
        width: 100%
      }

      .hdr-actions {
        width: 100%;
        justify-content: space-between
      }

      .global-loader {
        top: 56px
      }

      .tabs {
        top: 58px
      }

      .kpi-strip {
        padding: 8px 12px;
        gap: 14px
      }

      .page {
        padding: 16px 12px
      }

      #tasks-lanes {
        grid-template-columns: 1fr !important
      }

      #pitch-team {
        grid-template-columns: repeat(2, 1fr) !important
      }

      .table-tools {
        flex-direction: column;
        align-items: stretch
      }

      .table-search {
        max-width: none;
        width: 100%
      }

      .log-toolbar {
        margin-left: 0;
        width: 100%;
        justify-content: flex-start
      }

      .log-search {
        width: 100%
      }
    }

    :root[data-theme="dark"] .log-body {
      background: #0b1325;
      color: #dbe4f3
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="hdr">
    <div class="row gap-4">
      <span class="logo">NEXUS</span>
      <span class="logo-sub" data-i18n="brand.sub">Nền tảng Quant tự động</span>
    </div>
    <div class="hdr-mini" id="hdr-mini">
      <span class="hdr-chip" id="hc-sharpe" data-i18n="hdr.sharpe">Sharpe —</span>
      <span class="hdr-chip" id="hc-pnl" data-i18n="hdr.pnl">PnL —</span>
      <span class="hdr-chip" id="hc-status" data-i18n="hdr.status_connecting">Trạng thái Đang kết nối</span>
    </div>
    <div class="hdr-actions">
      <span id="hdr-live" class="hdr-live connecting">
        <span id="live-heart" class="live-heart"></span>
        <span id="live-label" data-i18n="status.connecting">Đang kết nối…</span>
      </span>
      <span id="hdr-badge" class="bdg bg-gray" style="font-size:12px" data-i18n="status.connecting_short">Đang kết
        nối...</span>
      <button id="demo-btn" class="btn btn-p btn-sm" onclick="startDemoTour()" data-i18n="btn.demo">🚀 Demo
        Tour</button>
      <button id="cmdk-btn" class="btn btn-s btn-sm" onclick="openCommandPalette()" data-i18n="cmd.open">⌘K Lệnh
        nhanh</button>
      <select id="lang-select" class="btn btn-s btn-sm" style="padding:4px 8px" onchange="setLanguage(this.value)">
        <option value="vi">VI</option>
        <option value="en">EN</option>
      </select>
      <select id="mode-toggle" class="btn btn-p btn-sm" style="padding:4px 8px; font-weight: bold;"
        onchange="setDashboardMode(this.value)">
        <option value="showcase">🌟 Showcase Mode</option>
        <option value="ops">⚙️ Operations Mode</option>
      </select>
      <button id="theme-toggle" class="btn btn-s btn-sm" onclick="toggleTheme()"
        title="Toggle dark mode (D)">🌙</button>
      <span id="hdr-clock" class="text-sm text-muted"></span>
    </div>
  </header>
  <div id="global-loader" class="global-loader">
    <div class="bar"></div>
  </div>

  <!-- Tabs -->
  <nav class="tabs" id="main-tabs">
    <!-- Showcase Tabs -->
    <div class="tab active" data-mode="showcase" onclick="go('home')">🏠 Home</div>
    <div class="tab" data-mode="showcase" onclick="go('performance-sc')">📈 Performance</div>
    <div class="tab" data-mode="showcase" onclick="go('how-it-works')">⚙️ How It Works</div>
    <div class="tab" data-mode="showcase" onclick="go('live-demo')">🔴 Live Demo</div>
    <div class="tab" data-mode="showcase" onclick="go('about')">ℹ️ About</div>

    <!-- Operations Tabs -->
    <div class="tab" data-mode="ops" onclick="go('chat')">💬 <span data-i18n="tab.chat">Chat</span></div>
    <div class="tab" data-mode="ops" onclick="go('research')">🔬 <span data-i18n="tab.research">Nghiên cứu</span></div>
    <div class="tab" data-mode="ops" onclick="go('tasks')">✅ <span data-i18n="tab.tasks">Nhiệm vụ</span></div>
    <div class="tab" data-mode="ops" onclick="go('files')">📁 <span data-i18n="tab.files">Tệp</span></div>
    <div class="tab" data-mode="ops" onclick="go('logs')">📝 <span data-i18n="tab.logs">Nhật ký</span></div>
    <div class="tab" data-mode="ops" onclick="go('signals')">📡 <span data-i18n="tab.signals">Tín hiệu</span></div>
    <div class="tab live" data-mode="ops" onclick="go('live-engine')">🔴 <span data-i18n="tab.live_engine">Live Trading</span></div>
    <div class="tab" data-mode="ops" onclick="go('track-record')">🏆 Track Record</div>
    <div class="tab" data-mode="ops" onclick="go('console')">⚙️ <span data-i18n="tab.console">Console</span></div>

    <!-- Hidden Internal Tabs (Kept for compatibility, but hidden from UI) -->
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('overview')">📊 Tổng quan</div>
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('benchmark')">🏆 Benchmark</div>
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('performance')">📈 Hiệu suất Internal</div>
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('risk')">⚠️ Rủi ro</div>
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('market')">📡 Thị trường</div>
    <div class="tab" data-mode="hidden" style="display:none" onclick="go('pitch')">🎯 Pitch</div>
  </nav>

  <!-- KPI Strip -->
  <div class="kpi-strip">
    <div class="kpi" title="Sharpe Ratio: Risk-adjusted return per unit volatility. >1 = good, >2 = excellent.">
      <span class="kpi-l" data-i18n="kpi.sharpe">Sharpe</span><span id="k-sharpe" class="kpi-v acc">1.931</span>
    </div>
    <div class="kpi" title="Compound Annual Growth Rate: Annualized return.">
      <span class="kpi-l" data-i18n="kpi.cagr">CAGR</span><span id="k-cagr" class="kpi-v">18.4%</span>
    </div>
    <div class="kpi" title="Maximum Drawdown: Largest peak-to-trough loss."><span class="kpi-l" data-i18n="kpi.mdd">Max
        DD</span><span id="k-mdd" class="kpi-v">-7.1%</span></div>
    <div class="kpi" title="Total Return since backtest start."><span class="kpi-l" data-i18n="kpi.total_return">Tổng
        lợi nhuận</span><span id="k-tot" class="kpi-v">142.6%</span></div>
    <div class="kpi" title="% of periods with positive P&L."><span class="kpi-l" data-i18n="kpi.win_rate">Tỷ lệ
        thắng</span><span id="k-wr" class="kpi-v">51.3%</span></div>
    <div class="kpi" title="Strategy name and signal mix"><span class="kpi-l" data-i18n="kpi.strategy">Chiến
        lược</span><span id="k-strat" class="kpi-v acc" style="font-size:12px">P91b Champion</span></div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="bt-progress" class="progress-pill idle"><span id="bt-progress-text"
          data-i18n="status.no_active_backtest">Không có backtest đang chạy</span><span class="progress-track"><span
            class="progress-fill"></span></span></span>
      <span id="auto-sync-badge" class="bdg bg-gray" data-i18n="status.waiting_first_sync_kpi">Đang chờ đồng bộ dữ
        liệu</span>
      <span class="text-sm text-muted" id="kpi-updated"></span>
      <button class="btn btn-s btn-sm" onclick="refresh()" data-i18n="btn.refresh">↻ Làm mới</button>
    </div>
  </div>

  <div class="story-strip">
    <button class="story-card" onclick="openStoryStep('overview')">
      <div class="story-kicker">01</div>
      <div class="story-head" data-i18n="story.value">Value</div>
      <div class="story-desc" data-i18n="story.value_desc">Alpha quality at a glance.</div>
      <div class="story-signal" id="story-signal-value">Sharpe — · CAGR —</div>
    </button>
    <button class="story-card" onclick="openStoryStep('performance')">
      <div class="story-kicker">02</div>
      <div class="story-head" data-i18n="story.proof">Proof</div>
      <div class="story-desc" data-i18n="story.proof_desc">Validation and consistency.</div>
      <div class="story-signal" id="story-signal-proof">Max DD — · Win Rate —</div>
    </button>
    <button class="story-card" onclick="openStoryStep('console')">
      <div class="story-kicker">03</div>
      <div class="story-head" data-i18n="story.live">Live Ops</div>
      <div class="story-desc" data-i18n="story.live_desc">Realtime process and logs.</div>
      <div class="story-signal" id="story-signal-live">System connecting…</div>
    </button>
    <button class="story-card" onclick="openStoryStep('pitch')">
      <div class="story-kicker">04</div>
      <div class="story-head" data-i18n="story.roi">ROI</div>
      <div class="story-desc" data-i18n="story.roi_desc">Business case and roadmap.</div>
      <div class="story-signal" id="story-signal-roi">Total Return —</div>
    </button>
  </div>

  <!-- ═══ SHOWCASE PAGES ═══ -->
  <div class="page" id="page-home"></div>
  <div class="page" id="page-performance-sc"></div>
  <div class="page" id="page-how-it-works"></div>
  <div class="page" id="page-live-demo"></div>
  <div class="page" id="page-about">
    <div class="card mb2">
      <div class="ctitle">🌟 Competitive Positioning</div>
      <div style="font-size:13px; color:var(--fg); line-height:1.6">
        NEXUS is an autonomous quant workforce utilizing a 5-agent multi-model architecture.
        Unlike traditional hedge funds limited by human speed, NEXUS compressed months of R&D into a single day (107
        phases),
        generating the verified <strong>P91b Champion</strong> ensemble with an average Sharpe of 1.931.
      </div>
    </div>
    <div class="card mb2">
      <div class="ctitle">🔗 Links & Contact</div>
      <div style="font-size:13px; line-height:1.6">
        <div style="margin-bottom:6px"><a href="#" style="color:var(--accent); text-decoration:none">📄 Investor Deck
            (PDF)</a></div>
        <div style="margin-bottom:6px"><a href="#" style="color:var(--accent); text-decoration:none">🔬 Full
            Architectural Whitepaper</a></div>
        <div><a href="#" style="color:var(--accent); text-decoration:none">✉️ investors@nexusquant.ai</a></div>
      </div>
    </div>
  </div>

  <!-- ═══ OVERVIEW ═══ -->
  <div class="page active" id="page-overview">
    <div class="mvp-hero mb2">
      <div>
        <div class="mvp-kicker" data-i18n="mvp.kicker">MVP Snapshot</div>
        <div class="mvp-title" data-i18n="mvp.title">NEXUS tạo alpha trung tính thị trường với giám sát realtime.</div>
        <div class="mvp-sub" data-i18n="mvp.subtitle">Bản demo tập trung vào 3 thứ: hiệu suất có thể kiểm chứng, rủi ro
          có kiểm soát, và vận hành AI realtime để sẵn sàng ra mắt thị trường.</div>
        <div class="mvp-tags">
          <span class="bdg bg-g" data-i18n="mvp.tag_oos">Chứng minh OOS nhiều năm</span>
          <span class="bdg bg-b" data-i18n="mvp.tag_live">Realtime dashboard + logs</span>
          <span class="bdg bg-p" data-i18n="mvp.tag_multi">Đội AI đa mô hình</span>
        </div>
      </div>
      <div class="mvp-points">
        <div class="mvp-point">
          <div class="lbl" data-i18n="mvp.value">Giá trị</div>
          <div class="val" id="mvp-value">Sharpe — · CAGR —</div>
        </div>
        <div class="mvp-point">
          <div class="lbl" data-i18n="mvp.proof">Bằng chứng</div>
          <div class="val" id="mvp-proof">Max DD — · Win Rate —</div>
        </div>
        <div class="mvp-point">
          <div class="lbl" data-i18n="mvp.realtime">Realtime</div>
          <div class="val" id="mvp-realtime">System connecting…</div>
        </div>
      </div>
    </div>

    <!-- ═══ AGENTIC WORKFORCE HIGHLIGHTS ═══ -->
    <div class="card mb2" id="aw-highlights"
      style="border:2px solid var(--accent);border-radius:14px;background:linear-gradient(135deg,color-mix(in srgb,var(--accent) 6%,var(--surface)),color-mix(in srgb,var(--green) 4%,var(--surface)))">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div>
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--accent)">
            Agentic Workforce Highlights</div>
          <div style="font-size:18px;font-weight:800;letter-spacing:-.02em;margin-top:2px" data-i18n="aw.title">3 AIs. 5
            Agents. 107 Phases. 1 Day.</div>
        </div>
        <span class="bdg bg-b" style="font-size:10px;white-space:nowrap">FIRST-TO-MARKET</span>
      </div>

      <!-- Top 4 KPI cards -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px" id="aw-kpis">
        <div
          style="text-align:center;padding:12px 8px;border-radius:10px;background:color-mix(in srgb,var(--accent) 10%,var(--surface));border:1px solid color-mix(in srgb,var(--accent) 25%,var(--border))">
          <div style="font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.06em">
            AVG Sharpe</div>
          <div style="font-size:1.8rem;font-weight:800;color:var(--accent);line-height:1.1">1.931</div>
          <div style="font-size:10px;color:var(--fg-muted)">6/6 years positive</div>
        </div>
        <div
          style="text-align:center;padding:12px 8px;border-radius:10px;background:color-mix(in srgb,var(--green) 10%,var(--surface));border:1px solid color-mix(in srgb,var(--green) 25%,var(--border))">
          <div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.06em">
            Bear 2022</div>
          <div style="font-size:1.8rem;font-weight:800;color:var(--green);line-height:1.1">+12.8%</div>
          <div style="font-size:10px;color:var(--fg-muted)">BTC: -64.6%</div>
        </div>
        <div
          style="text-align:center;padding:12px 8px;border-radius:10px;background:color-mix(in srgb,var(--green) 10%,var(--surface));border:1px solid color-mix(in srgb,var(--green) 25%,var(--border))">
          <div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.06em">
            Crash 2026</div>
          <div style="font-size:1.8rem;font-weight:800;color:var(--green);line-height:1.1">+3.6%</div>
          <div style="font-size:10px;color:var(--fg-muted)">BTC: -86.1%</div>
        </div>
        <div
          style="text-align:center;padding:12px 8px;border-radius:10px;background:color-mix(in srgb,var(--purple) 10%,var(--surface));border:1px solid color-mix(in srgb,var(--purple) 25%,var(--border))">
          <div style="font-size:10px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.06em">
            Experiments</div>
          <div style="font-size:1.8rem;font-weight:800;color:var(--purple);line-height:1.1">1,006</div>
          <div style="font-size:10px;color:var(--fg-muted)">Full audit trail</div>
        </div>
      </div>

      <!-- Bullet points grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="aw-bullets">
        <!-- FIRST-TO-MARKET -->
        <div
          style="padding:12px;border-radius:10px;background:color-mix(in srgb,var(--surface2) 80%,transparent);border:1px solid var(--border)">
          <div
            style="font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
            First-to-Market</div>
          <div style="font-size:12px;line-height:1.7;color:var(--fg)">
            <div style="display:flex;gap:6px;align-items:start;margin-bottom:4px"><span
                style="color:var(--accent);flex-shrink:0;font-weight:700">1.</span><span><strong>3 AI models
                  collaborate</strong> (Claude + GPT-5 + GLM-5) — not swap, real teamwork</span></div>
            <div style="display:flex;gap:6px;align-items:start;margin-bottom:4px"><span
                style="color:var(--accent);flex-shrink:0;font-weight:700">2.</span><span><strong>107 R&D phases in ~1
                  day</strong> — months of quant team work compressed</span></div>
            <div style="display:flex;gap:6px;align-items:start;margin-bottom:4px"><span
                style="color:var(--accent);flex-shrink:0;font-weight:700">3.</span><span><strong>24/7 autonomous crypto
                  R&D</strong> — no human prompt needed</span></div>
            <div style="display:flex;gap:6px;align-items:start;margin-bottom:4px"><span
                style="color:var(--accent);flex-shrink:0;font-weight:700">4.</span><span><strong>Self-learning with
                  human feedback</strong> — holdout + stress test + memory DB</span></div>
            <div style="display:flex;gap:6px;align-items:start"><span
                style="color:var(--accent);flex-shrink:0;font-weight:700">5.</span><span><strong>5-check anti-bias
                  pipeline</strong> — no competitor has this</span></div>
          </div>
        </div>
        <!-- VERIFIED PERFORMANCE -->
        <div
          style="padding:12px;border-radius:10px;background:color-mix(in srgb,var(--surface2) 80%,transparent);border:1px solid var(--border)">
          <div
            style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
            Verified Performance (P91b)</div>
          <table style="font-size:11px;width:100%">
            <thead>
              <tr style="border-bottom:2px solid var(--border)">
                <th style="padding:3px 6px;font-size:10px">Year</th>
                <th style="padding:3px 6px;font-size:10px">Type</th>
                <th style="padding:3px 6px;font-size:10px">Sharpe</th>
                <th style="padding:3px 6px;font-size:10px">CAGR</th>
                <th style="padding:3px 6px;font-size:10px">MDD</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:2px 6px">2021</td>
                <td style="padding:2px 6px">Bull</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">3.358</td>
                <td style="padding:2px 6px;color:var(--green)">+56.7%</td>
                <td style="padding:2px 6px">7.4%</td>
              </tr>
              <tr>
                <td style="padding:2px 6px">2022</td>
                <td style="padding:2px 6px">Bear</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">1.782</td>
                <td style="padding:2px 6px;color:var(--green)">+12.8%</td>
                <td style="padding:2px 6px">3.6%</td>
              </tr>
              <tr>
                <td style="padding:2px 6px">2023</td>
                <td style="padding:2px 6px">OOS</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">1.480</td>
                <td style="padding:2px 6px;color:var(--green)">+10.1%</td>
                <td style="padding:2px 6px">5.3%</td>
              </tr>
              <tr>
                <td style="padding:2px 6px">2024</td>
                <td style="padding:2px 6px">Bull</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">2.355</td>
                <td style="padding:2px 6px;color:var(--green)">+19.6%</td>
                <td style="padding:2px 6px">4.3%</td>
              </tr>
              <tr>
                <td style="padding:2px 6px">2025</td>
                <td style="padding:2px 6px">OOS</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">1.782</td>
                <td style="padding:2px 6px;color:var(--green)">+11.8%</td>
                <td style="padding:2px 6px">3.1%</td>
              </tr>
              <tr style="border-top:2px solid var(--border)">
                <td style="padding:2px 6px">2026</td>
                <td style="padding:2px 6px;color:var(--yellow);font-weight:600">True OOS</td>
                <td style="padding:2px 6px;color:var(--green);font-weight:700">0.828</td>
                <td style="padding:2px 6px;color:var(--green)">+3.6%</td>
                <td style="padding:2px 6px">1.5%</td>
              </tr>
              <tr style="background:color-mix(in srgb,var(--accent) 8%,transparent)">
                <td style="padding:3px 6px;font-weight:800" colspan="2">AVG</td>
                <td style="padding:3px 6px;font-weight:800;color:var(--accent)">1.931</td>
                <td style="padding:3px 6px;font-weight:800;color:var(--green)">+19.1%</td>
                <td style="padding:3px 6px;font-weight:700">4.2%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bottom strip: System stats -->
      <div
        style="display:flex;flex-wrap:wrap;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
        <span class="bdg bg-b">5 AI Models</span>
        <span class="bdg bg-p">5 Agents</span>
        <span class="bdg bg-g">34,442 Lines Python</span>
        <span class="bdg bg-gray">51 Strategies</span>
        <span class="bdg bg-gray">30+ Signals Tested</span>
        <span class="bdg bg-gray">200+ Params Optimized</span>
        <span class="bdg bg-gray">56 Research Sources</span>
        <span class="bdg bg-g">12-Tab Dashboard</span>
        <span class="bdg bg-g">Beta -0.003 (Neutral)</span>
        <span class="bdg bg-y">10 Crypto Assets</span>
      </div>
    </div>
    <!-- ═══ END AGENTIC WORKFORCE HIGHLIGHTS ═══ -->
    <div class="mb2">
      <div class="card">
        <div class="ctitle">Equity Curve</div>
        <div id="eq-chart-wrap"><canvas id="eq-chart"></canvas></div>
      </div>
    </div>
    <div class="g3 mb2">
      <div class="card">
        <div class="ctitle">Latest Run</div>
        <div id="ov-run">
          <div class="empty">Run a backtest first</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">NEXUS Brain</div>
        <div id="ov-brain">
          <div class="empty">Brain loading...</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">Agent Dispatch</div>
        <div id="ov-agents" style="display:flex;flex-direction:column;gap:7px">
          <button class="btn btn-s btn-sm" onclick="runAgent('atlas')">⚡ ATLAS — Strategy Research</button>
          <button class="btn btn-s btn-sm" onclick="runAgent('cipher')">🛡 CIPHER — Risk Assessment</button>
          <button class="btn btn-s btn-sm" onclick="runAgent('echo')">🔊 ECHO — Data Quality</button>
          <button class="btn btn-s btn-sm" onclick="runAgent('flux')">🌊 FLUX — Experiment Queue</button>
          <div id="agent-res" class="text-sm text-muted" style="margin-top:4px"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">
        Recent Events
        <button class="btn btn-s btn-sm" onclick="loadOv()">↻</button>
      </div>
      <div id="ov-ledger">
        <div class="empty">Loading...</div>
      </div>
    </div>
    <div class="card mb2" style="margin-top:14px">
      <div class="ctitle">🔄 P91b Champion — Full Crypto Cycle (2021–2026)
        <span class="bdg bg-g" style="font-size:10px">VERIFIED</span>
      </div>
      <div style="margin-bottom:10px;font-size:12px;color:var(--fg-muted);line-height:1.6">
        4-signal static-weight ensemble: V1 (27.5%) + IdioMom i460 (19.7%) + IdioMom i415 (32.5%) + FundingMom f144
        (20.4%) · 10 symbols · 0.35x leverage · Full costs
      </div>
      <table style="font-size:12px">
        <thead>
          <tr>
            <th>Year</th>
            <th>Market Regime</th>
            <th>Sharpe</th>
            <th>CAGR</th>
            <th>MDD</th>
            <th>Beta</th>
            <th>BTC Sharpe</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>2021</td>
            <td>🐂 Bull (BTC +60%)</td>
            <td class="pos"><strong>3.358</strong></td>
            <td class="pos">+56.7%</td>
            <td>7.4%</td>
            <td>-0.003</td>
            <td class="pos">+0.97</td>
            <td><span class="bdg bg-g">VERIFIED</span></td>
          </tr>
          <tr>
            <td>2022</td>
            <td>🐻 Bear (BTC -65%)</td>
            <td class="pos"><strong>1.782</strong></td>
            <td class="pos">+12.8%</td>
            <td>3.6%</td>
            <td>-0.003</td>
            <td class="neg">-1.31</td>
            <td><span class="bdg bg-g">VERIFIED</span></td>
          </tr>
          <tr>
            <td>2023</td>
            <td>📈 Recovery</td>
            <td class="pos"><strong>1.480</strong></td>
            <td class="pos">+10.1%</td>
            <td>5.3%</td>
            <td>~0</td>
            <td class="pos">+2.41</td>
            <td><span class="bdg bg-g">VERIFIED</span></td>
          </tr>
          <tr>
            <td>2024</td>
            <td>🐂 Bull (ATH)</td>
            <td class="pos"><strong>2.355</strong></td>
            <td class="pos">+19.6%</td>
            <td>4.3%</td>
            <td>~0</td>
            <td class="pos">+1.76</td>
            <td><span class="bdg bg-g">VERIFIED</span></td>
          </tr>
          <tr>
            <td>2025</td>
            <td>📊 Choppy</td>
            <td class="pos"><strong>1.782</strong></td>
            <td class="pos">+11.8%</td>
            <td>3.1%</td>
            <td>~0</td>
            <td class="pos">+0.06</td>
            <td><span class="bdg bg-g">VERIFIED</span></td>
          </tr>
          <tr style="background:color-mix(in srgb,var(--yellow) 8%,transparent)">
            <td>2026 YTD</td>
            <td>💥 Crash (BTC -86%)</td>
            <td class="pos"><strong>0.828</strong></td>
            <td class="pos">+3.6%</td>
            <td>1.5%</td>
            <td>~0</td>
            <td class="neg">-3.56</td>
            <td><span class="bdg bg-y">TRUE OOS</span></td>
          </tr>
          <tr style="background:color-mix(in srgb,var(--accent) 8%,transparent);font-weight:700">
            <td colspan="2" style="font-weight:800">AVERAGE</td>
            <td class="pos"><strong>1.931</strong></td>
            <td class="pos">+19.1%</td>
            <td>4.2%</td>
            <td>-0.003</td>
            <td></td>
            <td><span class="bdg bg-g">6/6 POSITIVE</span></td>
          </tr>
        </tbody>
      </table>
      <div style="margin-top:10px;font-size:11px;color:var(--fg-muted)">
        P91b champion: 4-signal ensemble discovered through 107 autonomous R&D phases. AVG Sharpe <strong
          style="color:var(--green)">1.931</strong> · MIN Sharpe <strong style="color:var(--yellow)">0.828</strong>
        (2026 crash) · Max DD range: 1.5%–7.4% vs BTC ~77%
      </div>
    </div>
    <div class="g2 mb2">
      <div class="card">
        <div class="ctitle">📖 How to Read This Dashboard</div>
        <div style="font-size:12px;line-height:1.7;color:var(--fg-muted)">
          <p><strong style="color:var(--fg)">Sharpe Ratio</strong>: Risk-adjusted return. 1.0 = good. We target 1.0+
            OOS.</p>
          <p><strong style="color:var(--fg)">Calmar Ratio</strong>: CAGR ÷ Max Drawdown. Higher is better capital
            efficiency.</p>
          <p><strong style="color:var(--fg)">Beta ≈ 0</strong>: Market-neutral. Strategy profits regardless of BTC
            direction.</p>
          <p><strong style="color:var(--fg)">OOS vs IS</strong>: Out-of-sample (OOS) is true performance. In-sample (IS)
            is biased upward.</p>
          <p><strong style="color:var(--fg)">Walk-Forward</strong>: Rolling IS/OOS windows. &gt;60% profitable = robust
            signal.</p>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">🧠 P91b Champion: 4-Signal Ensemble</div>
        <div style="font-size:12px;line-height:1.7;color:var(--fg-muted)">
          <p><strong style="color:var(--accent)">Signal 1 — NexusAlpha V1 (27.5%)</strong>: Carry + 336h momentum + 72h
            MR, k=2 per side</p>
          <p><strong style="color:var(--accent)">Signal 2 — IdioMom i460 (19.7%)</strong>: Beta-hedged momentum (lb=460,
            bw=168), k=4</p>
          <p><strong style="color:var(--accent)">Signal 3 — IdioMom i415 (32.5%)</strong>: Beta-hedged momentum (lb=415,
            bw=216), k=4</p>
          <p><strong style="color:var(--accent)">Signal 4 — FundingMom f144 (20.4%)</strong>: Contrarian cumulative
            funding (lb=144), k=2</p>
          <p style="margin-top:5px;color:var(--green);font-weight:500">Static weights proven optimal across 9 weighting
            methods. V1 = regime insurance (critical for 2026 OOS)</p>
        </div>
      </div>
    </div>
    <div class="card mb2" style="border-left:4px solid var(--purple)">
      <div class="ctitle">🧠 Critical Thinking — Process Challenges
        <span class="bdg bg-p" style="font-size:10px">SELF-REVIEW</span>
      </div>
      <div class="g2" style="font-size:12px;line-height:1.7">
        <div>
          <p style="font-weight:600;color:var(--fg);margin-bottom:6px">❓ Key Open Questions</p>
          <ul style="color:var(--fg-muted);padding-left:16px;margin:0">
            <li>Is the 72h MR lookback genuinely robust? (Validated: OOS 2021=1.052, 2026=0.921)</li>
            <li>P91b 2022 bear Sharpe=1.782 — will this hold with 10+ years of data?</li>
            <li>Are we missing signals in order flow, OI change, or on-chain data?</li>
            <li>Is 0.35x leverage optimal or leaving alpha on the table?</li>
          </ul>
        </div>
        <div>
          <p style="font-weight:600;color:var(--fg);margin-bottom:6px">🔬 Research Gaps Identified</p>
          <ul style="color:var(--fg-muted);padding-left:16px;margin:0">
            <li>No live trading validation yet (all backtested)</li>
            <li>Slippage model assumes uniform cost — real fill may vary</li>
            <li>Cross-exchange funding rate arbitrage unexplored</li>
            <li>2020 pandemic crash data not yet tested</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Sharpe by Year bar chart -->
    <div class="card mb2">
      <div class="ctitle">📊 Sharpe by Year — Full Cycle OOS Summary
        <span class="bdg bg-g" style="font-size:10px">ALL OOS (P91b)</span>
      </div>
      <div class="year-bar-wrap" id="year-bar-chart"></div>
      <div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:var(--fg-muted)">
        <span><span
            style="display:inline-block;width:10px;height:10px;background:var(--green);border-radius:2px;margin-right:3px"></span>All
          OOS (P91b)</span>
        <span style="font-size:11px;color:var(--fg-muted)">Avg=1.931 · MIN=0.828 · All positive</span>
      </div>
    </div>
    <!-- Bias Monitor -->
    <div class="card mb2 bias-card">
      <div class="ctitle">⚠️ Bias & Overfitting Monitor
        <span class="bdg bg-g" style="font-size:10px">IMPROVED</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">In-Sample Bias (2024)</span>
        <span class="bias-verdict pass">RESOLVED — P91b uses extended lookbacks, all 6 years are OOS.
          Avg=1.931</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Look-Ahead Bias</span>
        <span class="bias-verdict pass">PASS — OOS predictions use t-1 data only, no future leakage</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Selection Bias (k, rebal window)</span>
        <span class="bias-verdict warn">PARTIAL — 336h/72h tested 120+ variants in Phase 55; DSR adjusted</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Survivorship Bias</span>
        <span class="bias-verdict warn">PARTIAL — 10 majors only; MATICUSDT rename handled</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Multiple Testing (DSR)</span>
        <span class="bias-verdict warn">DSR=0.46 — 30+ experiments; discount applies to IS results</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Regime Bias (regime lock-in)</span>
        <span class="bias-verdict pass">PASS — Tested bull/bear/recovery/sideways across 5 years</span>
      </div>
      <div class="bias-row">
        <span class="bias-type">Walk-Forward Stability</span>
        <span class="bias-verdict pass">PASS — 67% of 2023 WF windows profitable; 85% Monte Carlo paths</span>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--fg-muted)">
        💡 P91b honest OOS Sharpe = <strong>1.931</strong> (avg 2021-2026, all OOS). MIN year Sharpe = 0.828 (2026).
      </div>
    </div>
    <div class="card mt2">
      <div class="ctitle">📈 Learning Progress — Champion Sharpe Over Time
        <span id="live-lv" style="font-size:11px;color:var(--accent);margin-left:8px">—</span>
      </div>
      <div style="height:180px"><canvas id="progress-chart"></canvas></div>
      <div id="progress-stats" class="text-sm text-muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- ═══ CHAT ═══ -->
  <div class="page" id="page-chat">
    <div class="chat-wrap">
      <div class="chat-box">
        <!-- Header bar -->
        <div class="chat-header">
          <div class="chat-header-left">
            <span id="chat-sse-dot" class="sse-dot yellow" title="SSE disconnected"></span>
            <span>NEXUS Brain</span>
            <span id="chat-model-badge" class="model-badge">SAGE</span>
          </div>
          <div class="chat-header-right" style="display:flex;align-items:center;gap:6px">
            <select id="model-select" onchange="onModelChange()"
              style="font-size:11px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--fg);cursor:pointer;height:28px">
              <option value="glm-5" selected>🧠 SAGE — The Thinker (GLM-5)</option>
              <option value="claude-sonnet-4-6">🔵 SENTINEL — The Analyst (Sonnet 4.6)</option>
              <option value="claude-opus-4-6">🟣 NEXUS PRIME — The Architect (Opus 4.6)</option>
              <option value="codex">🟢 FORGE — The Builder (GPT-5.2)</option>
              <option value="minimax-2.5">🟠 SCOUT — The Explorer (MiniMax 2.5)</option>
            </select>
            <button class="btn btn-s btn-sm" id="debate-toggle-btn" onclick="toggleDebateMode()"
              title="Debate mode: all models discuss + critique each other"
              style="background:var(--surface);border:1px solid var(--border)">⚔️ Debate</button>
            <button class="btn btn-s btn-sm" onclick="copyLastAI()" title="Copy last AI response">Copy</button>
            <button class="btn btn-s btn-sm" onclick="clearChat()" title="Clear chat">Clear</button>
          </div>
        </div>
        <!-- Debate mode banner -->
        <div id="debate-banner"
          style="display:none;padding:6px 12px;background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff;font-size:11px;text-align:center">
          ⚔️ <strong>Debate Mode ON</strong> — 4 agents (SAGE + SENTINEL + FORGE + ORACLE) will analyze, critique each
          other, then synthesize a verdict. Takes ~30-60s.
          <button onclick="toggleDebateMode()"
            style="margin-left:8px;background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px">✕
            Off</button>
        </div>
        <!-- Quick chips -->
        <div class="chips">
          <span class="chip"
            onclick="chip('Show full cycle validation results: 2021 bull, 2022 bear, 2023 recovery, 2025 YTD, 2026 Crash. Explain what honest OOS Sharpe of 1.931 means for P91b.')">📊
            Full Cycle OOS</span>
          <span class="chip"
            onclick="chip('What is the alpha source? Explain the 4-signal static ensemble and why V1 acts as regime insurance for 2026.')">🧠
            Alpha Source</span>
          <span class="chip"
            onclick="chip('How did P91b achieve Sharpe=1.782 in 2022 bear market (BTC -65%, FTX collapse)?')">🐻
            2022 Bear Survival</span>
          <span class="chip"
            onclick="chip('Analyze current risk status: drawdown, leverage, regime, and what could cause next drawdown period')">⚠️
            Risk Check</span>
          <span class="chip"
            onclick="chip('What should Phase 108 focus on? What new signals would genuinely improve P91b?')">🔬
            Phase 108 Plan</span>
          <span class="chip"
            onclick="chip('Compare recent P91b experiments with V1-Long. Why did static weight ensemble perform best?')">📉
            Latest Findings</span>
          <span class="chip"
            onclick="chip('Based on current BTC funding rates and 48h price action, what is the cross-sectional signal ranking right now? Who is long candidate, who is short?')">🚦
            Live Signal</span>
          <span class="chip"
            onclick="chip('Propose a new signal that does not require parameter optimization: open interest change, funding momentum, or basis convergence')">💡
            New Signal Idea</span>
          <span class="chip" onclick="loadDebateHistory()"
            style="background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff">⚔️ Debate History</span>
          <span class="chip"
            onclick="startDebate('Should we add open interest change as a signal? Pros, cons, overfitting risk, OOS expectation. Current alpha: P91b Sharpe=1.931 OOS.')">🆚
            Debate: OI Signal</span>
          <span class="chip"
            onclick="startDebate('Is NexusAlpha P91b Sharpe=1.931 OOS genuinely good for a crypto long-short strategy? Compare to industry benchmarks. What are the main risks?')">🆚
            Debate: Alpha Quality</span>
        </div>
        <!-- Messages -->
        <div class="chat-msgs" id="chat-msgs">
          <div class="cmsg a">
            <div class="cbubble"><strong>NEXUS Brain</strong> — autonomous quant research workforce.<br><br>I run 24/7:
              researching papers, testing strategies, managing risk. P91b champion results:<br><strong>2021</strong>
              Sharpe=3.358 · <strong>2022 Bear</strong> Sharpe=1.782 · <strong>2023</strong> Sharpe=1.480 ·
              <strong>2024</strong> Sharpe=2.355 · <strong>2025</strong> Sharpe=1.782 · <strong>2026</strong>
              Sharpe=0.828<br><strong>Avg OOS Sharpe:
                1.931</strong> across all market regimes. MIN=0.828. All years OOS.<br><br>Ask me anything about
              strategy, signals, risk, or next research direction.
            </div>
            <div class="cmsg-footer">
              <span class="cts">Ready · GLM-5 powered</span>
              <button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>
            </div>
          </div>
        </div>
        <!-- Input bar -->
        <div class="chat-in-bar">
          <textarea class="chat-ta" id="chat-in"
            placeholder="Ask NEXUS anything... (Enter to send, Shift+Enter for newline)" onkeydown="onChatKey(event)"
            oninput="autoGrowTA(this)"></textarea>
          <button class="btn btn-p" onclick="sendMsg()" style="flex-shrink:0;align-self:flex-end">Send</button>
        </div>
      </div>
      <!-- Right sidebar -->
      <div class="brain-panel" id="brain-panel">
        <!-- Live Metrics -->
        <div class="live-metrics-card" id="bp-metrics">
          <h4>Live Metrics</h4>
          <div class="lm-grid">
            <div class="lm-cell">
              <div class="lm-val" id="lm-sharpe-is">—</div>
              <div class="lm-lbl">Sharpe <span class="is-badge is">IS</span></div>
            </div>
            <div class="lm-cell">
              <div class="lm-val" id="lm-sharpe-oos">—</div>
              <div class="lm-lbl">Sharpe <span class="is-badge oos">OOS</span></div>
            </div>
            <div class="lm-cell">
              <div class="lm-val" id="lm-cagr">—</div>
              <div class="lm-lbl">CAGR</div>
            </div>
            <div class="lm-cell">
              <div class="lm-val" id="lm-mdd">—</div>
              <div class="lm-lbl">MDD</div>
            </div>
          </div>
          <div
            style="margin-top:8px;font-size:10px;color:var(--fg-muted);display:flex;justify-content:space-between;align-items:center">
            <span id="lm-updated">—</span>
            <span id="lm-alerts" style="color:var(--accent)">0 alerts</span>
          </div>
        </div>
        <!-- Live Events -->
        <div class="brain-card" id="bp-feed">
          <h4>Live Events</h4>
          <div class="sse-feed" id="sse-feed">
            <div class="text-sm text-muted">Connecting...</div>
          </div>
        </div>
        <!-- Identity -->
        <div class="brain-card" id="bp-identity">
          <h4>Identity</h4>
          <div class="text-sm text-muted">Loading...</div>
        </div>
        <!-- Goals -->
        <div class="brain-card" id="bp-goals">
          <h4>Goals</h4>
          <div class="text-sm text-muted">Loading...</div>
        </div>
        <!-- Mood -->
        <div class="brain-card" id="bp-mood">
          <h4>Mood</h4>
          <div class="text-sm text-muted" style="font-size:22px">🤔</div>
        </div>
        <!-- Quick Actions -->
        <div class="brain-card">
          <h4>Quick Actions</h4>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn btn-s btn-sm" onclick="runResearch()">🔬 Run Research</button>
            <button class="btn btn-s btn-sm" onclick="go('benchmark')">🏆 Benchmarks</button>
            <button class="btn btn-s btn-sm" onclick="openValidationView()">✅ Validation</button>
            <button class="btn btn-s btn-sm" onclick="copyLastAI()">📋 Copy Last Result</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ═══ BENCHMARK ═══ -->
  <div class="page" id="page-benchmark">
    <div class="section-title mb">🏆 NEXUS Achievement Targets</div>
    <div class="tgrid" id="target-cards">
      <div class="tcard" id="tc1">
        <div class="ttitle">Target 1 — Beat S&P 500</div>
        <div class="tval" id="tv1">Sharpe &gt; 0.6</div>
        <div class="tdesc">Minimum viable: outperform passive US equity (SPY 2024 Sharpe ≈ 0.73)</div>
        <div class="pbar">
          <div class="pfill b" id="tp1" style="width:0%"></div>
        </div>
        <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b
              id="tc1-v">—</b></span><span id="tb1" class="bdg bg-gray">PENDING</span></div>
      </div>
      <div class="tcard" id="tc2">
        <div class="ttitle">Target 2 — Beat BTC Buy &amp; Hold</div>
        <div class="tval" id="tv2">Sharpe &gt; 1.5</div>
        <div class="tdesc">Short-term goal: risk-adjusted better than simply holding Bitcoin (BTC 2024 ≈ 1.47)</div>
        <div class="pbar">
          <div class="pfill b" id="tp2" style="width:0%"></div>
        </div>
        <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b
              id="tc2-v">—</b></span><span id="tb2" class="bdg bg-gray">PENDING</span></div>
      </div>
      <div class="tcard" id="tc3">
        <div class="ttitle">Target 3 — Beat Renaissance (net)</div>
        <div class="tval" id="tv3">Sharpe &gt; 2.5</div>
        <div class="tdesc">Medium-term: surpass best human hedge fund net-of-fees (Renaissance ≈ 3.8 gross)</div>
        <div class="pbar">
          <div class="pfill b" id="tp3" style="width:0%"></div>
        </div>
        <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b
              id="tc3-v">—</b></span><span id="tb3" class="bdg bg-gray">PENDING</span></div>
      </div>
      <div class="tcard" id="tc4">
        <div class="ttitle">Target 4 — World-Class (NEXUS Goal)</div>
        <div class="tval" id="tv4">Sharpe &gt; 5.0</div>
        <div class="tdesc">Long-term: top-tier autonomous quant — beyond any human team</div>
        <div class="pbar">
          <div class="pfill b" id="tp4" style="width:0%"></div>
        </div>
        <div class="rowb" style="margin-top:6px"><span class="text-sm text-muted">Current: <b
              id="tc4-v">—</b></span><span id="tb4" class="bdg bg-gray">PENDING</span></div>
      </div>
    </div>

    <!-- Achievement badges -->
    <div class="card mb2">
      <div class="ctitle">Achievement Badges</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap" id="ach-badges">
        <div class="ach" data-level="0"
          style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
          <div style="font-size:30px">🥉</div>
          <div style="font-size:12px;font-weight:600;margin-top:4px">Bronze</div>
          <div class="text-sm text-muted">Sharpe &gt; 0.6</div>
        </div>
        <div class="ach" data-level="1"
          style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
          <div style="font-size:30px">🥈</div>
          <div style="font-size:12px;font-weight:600;margin-top:4px">Silver</div>
          <div class="text-sm text-muted">Sharpe &gt; 1.5</div>
        </div>
        <div class="ach" data-level="2"
          style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
          <div style="font-size:30px">🥇</div>
          <div style="font-size:12px;font-weight:600;margin-top:4px">Gold</div>
          <div class="text-sm text-muted">Sharpe &gt; 2.5</div>
        </div>
        <div class="ach" data-level="3"
          style="text-align:center;padding:14px 20px;border:2px dashed var(--border);border-radius:8px;opacity:.4;transition:all .3s">
          <div style="font-size:30px">💎</div>
          <div style="font-size:12px;font-weight:600;margin-top:4px">Platinum</div>
          <div class="text-sm text-muted">Sharpe &gt; 5.0</div>
        </div>
      </div>
    </div>

    <!-- Benchmark table -->
    <div class="card">
      <div class="ctitle">
        Live Benchmark Comparison
        <button class="btn btn-s btn-sm" onclick="loadBM()">↻ Refresh</button>
      </div>
      <div id="bm-table">
        <div class="empty">Loading...</div>
      </div>
    </div>
  </div>

  <!-- ═══ PERFORMANCE ═══ -->
  <div class="page" id="page-performance">
    <div class="g2 mb2">
      <div class="card">
        <div class="ctitle">Returns Distribution</div>
        <div style="position:relative;height:220px"><canvas id="ret-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="ctitle">Key Metrics</div>
        <div id="pf-stats">
          <div class="empty">Loading...</div>
        </div>
      </div>
    </div>
    <div class="card mb2">
      <div class="ctitle">Walk-Forward Windows</div>
      <div id="wf-body">
        <div class="empty">Loading...</div>
      </div>
    </div>
    <div class="card mb2">
      <div class="ctitle">Recent Backtest Runs</div>
      <div id="runs-table">
        <div class="empty">Loading run history...</div>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">
        Validation Suite (8 Tests)
        <div class="row">
          <button class="btn btn-p btn-sm" onclick="runVal()">▶ Run Validation</button>
          <span id="val-st" class="text-sm text-muted"></span>
        </div>
      </div>
      <div id="val-body">
        <div class="empty">No validation results. Click Run to execute all 8 tests.</div>
      </div>
    </div>
  </div>

  <!-- ═══ RISK ═══ -->
  <div class="page" id="page-risk">
    <div class="g3 mb2">
      <div class="card">
        <div class="ctitle">Value at Risk</div>
        <div id="risk-var">
          <div class="empty">—</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">Market Regime</div>
        <div id="risk-regime">
          <div class="empty">—</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">Position Limits</div>
        <div id="risk-limits">
          <div class="empty">—</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">Position Detail</div>
      <div id="risk-detail">
        <div class="empty">Run a backtest to see positions</div>
      </div>
    </div>
  </div>

  <!-- ═══ RESEARCH ═══ -->
  <div class="page" id="page-research">
    <div class="rowb mb2">
      <div class="row">
        <button class="btn btn-p btn-sm" onclick="runResearch()">🔬 Run Research Cycle</button>
        <span id="rc-st" class="text-sm text-muted"></span>
      </div>
      <button class="btn btn-s btn-sm" onclick="loadResearch()">↻ Refresh</button>
    </div>
    <div class="g2 mb2">
      <div class="card">
        <div class="ctitle">Latest Research Cycle</div>
        <div id="rc-latest">
          <div class="empty">No cycle data yet</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">Memory Search</div>
        <div class="row mb" style="gap:6px">
          <input type="text" id="mem-q" placeholder="Search NEXUS knowledge..." style="flex:1">
          <button class="btn btn-s btn-sm" onclick="searchMem()">Search</button>
        </div>
        <div id="mem-results" class="text-sm text-muted">Enter query above...</div>
      </div>
    </div>
    <div class="card mb2">
      <div class="ctitle">Strategy Proposals</div>
      <div id="rc-proposals">
        <div class="empty">No proposals yet</div>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">Recent Alerts</div>
      <div id="rc-alerts">
        <div class="empty">No alerts</div>
      </div>
    </div>
  </div>

  <!-- ═══ TASKS ═══ -->
  <div class="page" id="page-tasks">
    <div class="card" style="background:#FFFBEB;border:1px solid #FDE68A;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:4px">📋 Task Board — NEXUS Kanban</div>
      <div class="text-sm text-muted">Tasks are auto-generated by ATLAS/CIPHER/ECHO agents and brain loop. <b>Click a
          task card to mark it done.</b> Create new tasks with the form below.</div>
    </div>
    <div class="card mb2">
      <div class="ctitle">Create Task</div>
      <div class="fr">
        <div><label>Title</label><input type="text" id="t-title" placeholder="Task title..."></div>
        <div><label>Category</label><select id="t-cat">
            <option value="research">🔬 Research</option>
            <option value="practice" selected>⚗️ Practice</option>
            <option value="procedure">🤖 Procedure</option>
          </select></div>
        <div><label>Priority</label><select id="t-pri">
            <option value="high">🔴 High</option>
            <option value="medium" selected>🟡 Medium</option>
            <option value="low">🟢 Low</option>
          </select></div>
      </div>
      <div class="fr">
        <div><label>Assignee</label><select id="t-who">
            <option>ATLAS</option>
            <option>CIPHER</option>
            <option>ECHO</option>
            <option>FLUX</option>
            <option value="Human">Human</option>
          </select></div>
        <div><label>Delegated by</label><select id="t-delegated">
            <option value="human">👤 Human</option>
            <option value="nexus">🤖 NEXUS</option>
            <option value="atlas">⚡ ATLAS</option>
            <option value="cipher">🛡 CIPHER</option>
          </select></div>
        <div><label>Description</label><input type="text" id="t-desc" placeholder="Optional..."></div>
      </div>
      <button class="btn btn-p btn-sm" onclick="createTask()">+ Create Task</button>
    </div>
    <!-- 3-lane category view -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px" id="tasks-lanes">
      <div class="card" style="border-top:3px solid #6366F1">
        <div class="ctitle">🔬 Research <span class="kcount" id="kc-research">0</span></div>
        <div class="text-sm text-muted mb1" style="font-size:11px">Literature · Hypotheses · Analysis</div>
        <div id="kl-research">
          <div class="empty">No tasks</div>
        </div>
      </div>
      <div class="card" style="border-top:3px solid #10B981">
        <div class="ctitle">⚗️ Practice <span class="kcount" id="kc-practice">0</span></div>
        <div class="text-sm text-muted mb1" style="font-size:11px">Backtests · Experiments · Implementation</div>
        <div id="kl-practice">
          <div class="empty">No tasks</div>
        </div>
      </div>
      <div class="card" style="border-top:3px solid #F59E0B">
        <div class="ctitle">🤖 Procedures <span class="kcount" id="kc-procedure">0</span></div>
        <div class="text-sm text-muted mb1" style="font-size:11px">Automated AI workflows · Loops</div>
        <div id="kl-procedure">
          <div class="empty">No tasks</div>
        </div>
      </div>
    </div>
    <!-- Classic Kanban (by status) below -->
    <div class="ctitle mt2"
      style="margin-bottom:8px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.5px">All Tasks
      by Status</div>
    <div class="kanban" id="kanban">
      <div class="kcol">
        <div class="kh">TODO <span class="kcount" id="kc-todo">0</span></div>
        <div id="kl-todo"></div>
      </div>
      <div class="kcol">
        <div class="kh">IN PROGRESS <span class="kcount" id="kc-inprogress">0</span></div>
        <div id="kl-inprogress"></div>
      </div>
      <div class="kcol">
        <div class="kh">REVIEW <span class="kcount" id="kc-review">0</span></div>
        <div id="kl-review"></div>
      </div>
      <div class="kcol">
        <div class="kh">DONE <span class="kcount" id="kc-done">0</span></div>
        <div id="kl-done"></div>
      </div>
    </div>
    <div class="card" style="margin-top:14px">
      <div class="ctitle">Task Table</div>
      <div id="tasks-table">
        <div class="empty">Loading tasks...</div>
      </div>
    </div>
  </div>

  <!-- ═══ FILES & REPORTS ═══ -->
  <div class="page" id="page-files">
    <div class="rowb mb2">
      <div class="section-title" style="margin-bottom:0">📁 Files, Reports &amp; Artifacts</div>
      <div class="row">
        <input type="text" id="file-search" placeholder="Search files and runs..." style="min-width:240px"
          oninput="filterFiles()">
        <span class="text-sm text-muted" id="files-match"></span>
        <button class="btn btn-s btn-sm" onclick="loadFiles()">↻ Refresh</button>
      </div>
    </div>
    <div id="file-viewer-panel" style="display:none" class="card mb2">
      <div class="ctitle rowb">
        <span id="fv-path">File Viewer</span>
        <button class="btn btn-s btn-sm" onclick="closeFileViewer()">✕ Close</button>
      </div>
      <div id="fv-content" class="file-viewer">Select a file to view its content</div>
    </div>
    <div id="files-body">
      <div class="empty">
        <div class="spin"></div> Loading artifacts...
      </div>
    </div>
  </div>

  <!-- ═══ MARKET ═══ -->
  <div class="page" id="page-market">
    <div class="card" style="background:#F0FDF4;border:1px solid #BBF7D0;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:6px">📡 Live Binance Perp Futures — What this tab shows</div>
      <div class="text-sm text-muted" style="line-height:1.7">
        <b>Funding Rates</b>: When funding is very negative → longs earn from shorts → BUY signal. Very positive →
        shorts earn → SELL signal. NEXUS Carry strategy exploits this.<br>
        <b>Signal column</b>: LONG ↑ means funding &lt; -0.05% (bullish carry), SHORT ↓ means funding &gt; +0.05%
        (bearish carry), NEUTRAL otherwise.<br>
        <b>Annualized</b>: Funding rate × 3 payments/day × 365 days. E.g. -0.01%/8h = -10.95% annual yield to longs.<br>
        <b>Mark Price / 24h Change</b>: Current price and momentum signals used by the NEXUS momentum layer.
      </div>
    </div>
    <div class="rowb mb2">
      <div class="section-title" style="margin-bottom:0">📡 Live Market Data</div>
      <div class="row">
        <span class="text-sm text-muted" id="mkt-ts">—</span>
        <button class="btn btn-s btn-sm" onclick="loadMarket()">↻ Refresh</button>
      </div>
    </div>
    <div class="card mb2">
      <div class="ctitle">Funding Rates &amp; Carry Signals</div>
      <div id="mkt-funding">
        <div class="empty">Loading...</div>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">Price &amp; Volume</div>
      <div id="mkt-price">
        <div class="empty">Loading...</div>
      </div>
    </div>
  </div>

  <!-- ═══ INVESTOR PITCH ═══ -->
  <div class="page" id="page-pitch">
    <div class="rowb mb2">
      <div class="section-title" style="margin-bottom:0">🎯 NEXUS Investor Pitch — Alpha Verification</div>
      <div class="row">
        <button class="btn btn-s btn-sm" onclick="loadPitch()">↻ Refresh</button>
        <button class="btn btn-p btn-sm" onclick="window.open('/api/pitch/report','_blank')">⬇ Export PDF</button>
      </div>
    </div>

    <!-- Hero KPIs -->
    <div class="g4 mb2" id="pitch-kpis">
      <div class="card" style="text-align:center;background:linear-gradient(135deg,#EFF6FF,#DBEAFE)">
        <div style="font-size:11px;font-weight:600;color:#1D4ED8;text-transform:uppercase;letter-spacing:.05em">Champion
          Sharpe</div>
        <div id="pt-sharpe" style="font-size:2.4rem;font-weight:700;color:#1E40AF;line-height:1.2">—</div>
        <div style="font-size:11px;color:#6B7280">Annualized (1h bars, 8760 ppy)</div>
      </div>
      <div class="card" style="text-align:center;background:linear-gradient(135deg,#F0FDF4,#DCFCE7)">
        <div style="font-size:11px;font-weight:600;color:#16A34A;text-transform:uppercase;letter-spacing:.05em">CAGR
        </div>
        <div id="pt-cagr" style="font-size:2.4rem;font-weight:700;color:#15803D;line-height:1.2">—</div>
        <div style="font-size:11px;color:#6B7280">Compound Annual Growth Rate</div>
      </div>
      <div class="card" style="text-align:center;background:linear-gradient(135deg,#FFF7ED,#FED7AA)">
        <div style="font-size:11px;font-weight:600;color:#D97706;text-transform:uppercase;letter-spacing:.05em">Max
          Drawdown</div>
        <div id="pt-mdd" style="font-size:2.4rem;font-weight:700;color:#B45309;line-height:1.2">—</div>
        <div style="font-size:11px;color:#6B7280">Maximum Drawdown</div>
      </div>
      <div class="card" style="text-align:center;background:linear-gradient(135deg,#F5F3FF,#EDE9FE)">
        <div style="font-size:11px;font-weight:600;color:#7C3AED;text-transform:uppercase;letter-spacing:.05em">Sources
          Monitored</div>
        <div id="pt-sources" style="font-size:2.4rem;font-weight:700;color:#6D28D9;line-height:1.2">56</div>
        <div style="font-size:11px;color:#6B7280">Academic, Blogs, Forums, Crypto</div>
      </div>
    </div>

    <!-- Alpha vs Benchmarks chart -->
    <div class="card mb2">
      <div class="ctitle">📊 NEXUS vs Benchmarks — Equity Curve (2024)</div>
      <div style="font-size:12px;color:#6B7280;margin-bottom:12px">
        Real Binance data · 1h bars · 8,784 bars · 10 symbols · Full transaction costs (0.04% maker)
      </div>
      <canvas id="pt-equity" height="300"></canvas>
      <div id="pt-bench-compare" class="mt2"></div>
    </div>

    <!-- Strategy Rankings -->
    <div class="g2 mb2">
      <div class="card">
        <div class="ctitle">🏆 Strategy Leaderboard</div>
        <div id="pt-rankings">
          <div class="empty">Loading...</div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">🔬 Scientific Verification</div>
        <div id="pt-verification">
          <div class="empty">Loading...</div>
        </div>
      </div>
    </div>

    <!-- How NEXUS Thinks — Decision Flow -->
    <div class="card mb2">
      <div class="ctitle">🧠 How NEXUS Makes Decisions</div>
      <div style="background:#F8FAFC;border-radius:10px;padding:20px;margin-top:8px;font-size:13px">
        <div style="display:flex;align-items:stretch;gap:0;overflow-x:auto">
          <div class="pitch-step">
            <div class="pitch-step-icon">📡</div>
            <div class="pitch-step-num">1</div>
            <div class="pitch-step-title">RESEARCH</div>
            <div class="pitch-step-desc">Read 56 sources daily: arXiv, Reddit r/algotrading, quant blogs, crypto news,
              ML papers</div>
          </div>
          <div class="pitch-arrow">→</div>
          <div class="pitch-step">
            <div class="pitch-step-icon">💡</div>
            <div class="pitch-step-num">2</div>
            <div class="pitch-step-title">HYPOTHESIZE</div>
            <div class="pitch-step-desc">Extract actionable trading hypotheses using keyword matching + Bayesian prior
              beliefs</div>
          </div>
          <div class="pitch-arrow">→</div>
          <div class="pitch-step">
            <div class="pitch-step-icon">⚗️</div>
            <div class="pitch-step-num">3</div>
            <div class="pitch-step-title">APPLY</div>
            <div class="pitch-step-desc">Run backtests on real Binance data with full transaction costs, slippage, and
              funding rates</div>
          </div>
          <div class="pitch-arrow">→</div>
          <div class="pitch-step">
            <div class="pitch-step-icon">📊</div>
            <div class="pitch-step-num">4</div>
            <div class="pitch-step-title">EVALUATE</div>
            <div class="pitch-step-desc">Compare Sharpe, CAGR, Calmar vs champion. Walk-forward out-of-sample validation
            </div>
          </div>
          <div class="pitch-arrow">→</div>
          <div class="pitch-step">
            <div class="pitch-step-icon">🧠</div>
            <div class="pitch-step-num">5</div>
            <div class="pitch-step-title">ADAPT</div>
            <div class="pitch-step-desc">Update Bayesian beliefs, spaced repetition deck, meta-learner. Promote champion
              if improved</div>
          </div>
          <div class="pitch-arrow">→</div>
          <div class="pitch-step" style="background:linear-gradient(135deg,#EFF6FF,#DBEAFE)">
            <div class="pitch-step-icon">♾️</div>
            <div class="pitch-step-num">∞</div>
            <div class="pitch-step-title">REPEAT</div>
            <div class="pitch-step-desc">Runs 24/7. Every cycle the system becomes smarter. Knowledge compounds over
              time.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Workforce Team -->
    <div class="card mb2">
      <div class="ctitle">🤖 AI Workforce — Multi-Model Team</div>
      <div id="pitch-team" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:8px">
        <div
          style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#F5F3FF,#EDE9FE);border-radius:10px">
          <div style="font-size:24px">🟣</div>
          <div style="font-weight:700;font-size:14px;color:#6D28D9;margin-top:4px">NEXUS PRIME</div>
          <div
            style="font-size:10px;font-weight:600;color:#7C3AED;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">
            The Architect</div>
          <div style="font-size:11px;color:#6B7280;margin-top:6px">Claude Opus 4.6<br>Strategy · Architecture ·
            Integration · Final decisions</div>
        </div>
        <div
          style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#ECFDF5,#D1FAE5);border-radius:10px">
          <div style="font-size:24px">🧠</div>
          <div style="font-weight:700;font-size:14px;color:#059669;margin-top:4px">SAGE</div>
          <div
            style="font-size:10px;font-weight:600;color:#10B981;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">
            The Thinker</div>
          <div style="font-size:11px;color:#6B7280;margin-top:6px">GLM-5.0<br>Deep reasoning · Brain loop · Research
            synthesis</div>
        </div>
        <div
          style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#EFF6FF,#DBEAFE);border-radius:10px">
          <div style="font-size:24px">🔵</div>
          <div style="font-weight:700;font-size:14px;color:#1D4ED8;margin-top:4px">SENTINEL</div>
          <div
            style="font-size:10px;font-weight:600;color:#3B82F6;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">
            The Analyst</div>
          <div style="font-size:11px;color:#6B7280;margin-top:6px">Claude Sonnet 4.6<br>QA validation · Bias detection ·
            Cross-verification</div>
        </div>
        <div
          style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#F0FDF4,#DCFCE7);border-radius:10px">
          <div style="font-size:24px">🟢</div>
          <div style="font-weight:700;font-size:14px;color:#16A34A;margin-top:4px">FORGE</div>
          <div
            style="font-size:10px;font-weight:600;color:#22C55E;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">
            The Builder</div>
          <div style="font-size:11px;color:#6B7280;margin-top:6px">GPT-5.2 (Codex)<br>Code implementation · Algorithm
            engineering · Execution</div>
        </div>
        <div
          style="text-align:center;padding:14px 10px;background:linear-gradient(135deg,#FFF7ED,#FED7AA);border-radius:10px">
          <div style="font-size:24px">🟠</div>
          <div style="font-weight:700;font-size:14px;color:#D97706;margin-top:4px">SCOUT</div>
          <div
            style="font-size:10px;font-weight:600;color:#F59E0B;text-transform:uppercase;letter-spacing:.05em;margin-top:2px">
            The Explorer</div>
          <div style="font-size:11px;color:#6B7280;margin-top:6px">MiniMax 2.5<br>Alternative perspectives · Contrarian
            analysis · Diversity</div>
        </div>
      </div>
      <div style="margin-top:10px;font-size:11px;color:#6B7280;text-align:center">
        All 5 AI agents collaborate through debate, critique, and consensus protocols. No single point of failure.
      </div>
    </div>

    <!-- Accelerated Learning Stats -->
    <div class="card mb2">
      <div class="ctitle">⚡ Accelerated Learning Engine Status</div>
      <div class="g3 mt2" id="pt-learning">
        <div class="empty">Loading...</div>
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="card" style="background:#FFFBEB;border:1px solid #FCD34D">
      <div style="font-size:12px;color:#92400E;line-height:1.6">
        <strong>⚠️ Scientific Disclaimer:</strong> All backtest results are in-sample on historical data (2024).
        Past performance does not guarantee future results. Walk-forward validation is performed to reduce
        look-ahead bias, but all systematic strategies carry risk of regime change. Transaction costs
        include Binance VIP-0 taker fees (0.04%), 3bps slippage, and funding rate payments.
        No personal financial advice is provided. NEXUS is a research platform, not a live trading system.
      </div>
    </div>
  </div>

  <!-- ═══ LIVE SIGNALS (Paper Trading) ═══ -->
  <div class="page" id="page-signals">
    <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">📡 Live Signals — P91b Champion (Paper Trading)</div>
          <div class="text-sm text-muted">Real-time signals from the champion strategy. Vol tilt overlay applied. Dollar-neutral.</div>
        </div>
        <button class="btn btn-p btn-sm" onclick="generateNewSignal()" id="btn-gen-signal">Generate Signal</button>
      </div>
    </div>

    <!-- Paper Trading Summary -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:16px">
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Paper Equity</div>
        <div style="font-size:1.4em;font-weight:700" id="sig-equity">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Paper P&L</div>
        <div style="font-size:1.4em;font-weight:700" id="sig-pnl">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Vol Tilt</div>
        <div style="font-size:1.4em;font-weight:700" id="sig-voltilt">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Gross Leverage</div>
        <div style="font-size:1.4em;font-weight:700" id="sig-leverage">—</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Left: Target Weights -->
      <div class="card">
        <h3 style="margin:0 0 12px">Target Weights</h3>
        <div id="sig-weights" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
      <!-- Right: Trades Needed -->
      <div class="card">
        <h3 style="margin:0 0 12px">Trades Needed</h3>
        <div id="sig-trades" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
      <!-- Sub-Strategy Breakdown -->
      <div class="card">
        <h3 style="margin:0 0 12px">Sub-Strategy Breakdown</h3>
        <div id="sig-subs" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
      <!-- Execution Status -->
      <div class="card">
        <h3 style="margin:0 0 12px">Execution Status</h3>
        <div id="sig-exec-status" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
    </div>

    <!-- Paper P&L History -->
    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 12px">Paper P&L History (<span id="sig-count">0</span> signals)</h3>
      <div id="sig-history" class="text-sm" style="max-height:300px;overflow-y:auto;font-family:monospace">No signals yet.</div>
    </div>

    <!-- Signal Health Monitor -->
    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 12px">Signal Health Monitor (Phase 123)</h3>
      <div id="sig-health" class="text-sm" style="font-family:monospace">Loading health report...</div>
    </div>

    <!-- Quick Start Guide -->
    <div class="card" style="margin-top:16px;background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE">
      <h3 style="margin:0 0 8px">Quick Start</h3>
      <div class="text-sm" style="font-family:monospace">
        <div><strong>Paper trading:</strong> <code>python3 -m nexus_quant trade --mode paper --loop</code></div>
        <div><strong>One-shot signal:</strong> <code>python3 -m nexus_quant signal</code></div>
        <div><strong>Testnet (needs API key):</strong> <code>python3 -m nexus_quant trade --mode testnet --loop</code></div>
        <div><strong>Dashboard signal:</strong> Click "Generate Signal" above</div>
      </div>
    </div>
  </div>

  <!-- ═══ LIVE TRADING ENGINE ═══ -->
  <div class="page" id="page-live-engine">
    <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">🔴 Live Trading Engine — P91b Champion</div>
          <div class="text-sm text-muted">Real-time execution on Binance USDM Futures. Risk circuit breakers active.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm" onclick="resetRiskHalt()" style="background:#dc2626;color:#fff">Reset Halt</button>
          <button class="btn btn-p btn-sm" onclick="refreshLiveStatus()">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Status Cards -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:16px">
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Engine Status</div>
        <div style="font-size:1.4em;font-weight:700" id="le-status">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Balance</div>
        <div style="font-size:1.4em;font-weight:700" id="le-balance">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Risk Gate</div>
        <div style="font-size:1.4em;font-weight:700" id="le-risk">—</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="text-sm text-muted">Total Cycles</div>
        <div style="font-size:1.4em;font-weight:700" id="le-cycles">—</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Left: Risk State -->
      <div class="card">
        <h3 style="margin:0 0 12px">Risk State</h3>
        <div id="le-risk-detail" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
      <!-- Right: Last Cycle -->
      <div class="card">
        <h3 style="margin:0 0 12px">Last Cycle</h3>
        <div id="le-last-cycle" class="text-sm" style="font-family:monospace">Loading...</div>
      </div>
    </div>

    <!-- Recent Cycles -->
    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 12px">Recent Cycles (<span id="le-cycle-count">0</span>)</h3>
      <div id="le-cycle-history" class="text-sm" style="max-height:400px;overflow-y:auto;font-family:monospace">No cycles yet.</div>
    </div>

    <!-- Quick Start -->
    <div class="card" style="margin-top:16px;background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE">
      <h3 style="margin:0 0 8px">Quick Start</h3>
      <div class="text-sm" style="font-family:monospace">
        <div><strong>Dry run:</strong> <code>python3 -m nexus_quant live --dry-run</code></div>
        <div><strong>Testnet:</strong> <code>python3 -m nexus_quant live --testnet</code></div>
        <div><strong>Single cycle:</strong> <code>python3 -m nexus_quant live --dry-run --once</code></div>
        <div><strong>Live (real $):</strong> <code>BINANCE_API_KEY=... BINANCE_API_SECRET=... python3 -m nexus_quant live</code></div>
      </div>
    </div>
  </div>

  <!-- ═══ LOGS (Analysis Journal) ═══ -->
  <div class="page" id="page-logs">
    <div style="display:grid;grid-template-columns:1fr 380px;gap:16px">
      <!-- Left: Log entries -->
      <div>
        <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:12px">
          <div style="font-weight:600;margin-bottom:4px" data-i18n="logs.hero_title">Analysis Journal — Research History
          </div>
          <div class="text-sm text-muted" data-i18n="logs.hero_subtitle">Persistent record of thinking, findings,
            decisions, and multi-model audits. Live stream via SSE with smart fallback.</div>
        </div>
        <!-- Filters -->
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <select id="log-filter-type" onchange="onAnalysisFilterChange()"
            style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px">
            <option value="" data-i18n="logs.filter_all_types">All Types</option>
            <option value="analysis" data-i18n="logs.filter_analysis">Analysis</option>
            <option value="finding" data-i18n="logs.filter_finding">Finding</option>
            <option value="decision" data-i18n="logs.filter_decision">Decision</option>
            <option value="audit" data-i18n="logs.filter_audit">Audit</option>
          </select>
          <select id="log-filter-source" onchange="onAnalysisFilterChange()"
            style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px">
            <option value="" data-i18n="logs.filter_all_sources">All Sources</option>
            <option value="claude">NEXUS PRIME (Claude)</option>
            <option value="gpt-5.2">FORGE (GPT-5.2)</option>
            <option value="glm-5">SAGE (GLM-5)</option>
            <option value="sonnet-4.6">SENTINEL (Sonnet)</option>
            <option value="multi-model">Multi-Model Debate</option>
            <option value="user">User</option>
          </select>
          <label style="font-size:11px;color:var(--fg-muted);display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="log-autorefresh" checked onchange="toggleLogAutoRefresh()"> <span
              data-i18n="logs.auto_refresh">Auto-refresh</span>
          </label>
          <span id="analysis-stream-state" class="bdg bg-gray" data-i18n="logs.stream_connecting">Kết nối
            stream...</span>
          <button class="btn btn-s" onclick="runTabPrimaryAction('logs')" style="padding:6px 12px"
            data-i18n="logs.refresh_btn">Refresh</button>
          <span id="log-count" class="text-sm text-muted" style="margin-left:auto"></span>
        </div>
        <div id="log-kpis"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:12px">
        </div>
        <!-- Log entries -->
        <div id="logs-container"
          style="display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 300px);overflow-y:auto">
          <div class="empty" data-i18n="logs.loading">Loading analysis logs...</div>
        </div>
      </div>
      <!-- Right: AI Quick Chat -->
      <div>
        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:600;margin-bottom:8px" data-i18n="logs.assistant_title">AI Research Assistant</div>
          <div class="text-sm text-muted" style="margin-bottom:10px" data-i18n="logs.assistant_subtitle">Ask about
            research findings, strategy analysis, or get quick insights from AI.</div>
          <div id="log-chat-messages"
            style="max-height:400px;overflow-y:auto;margin-bottom:10px;display:flex;flex-direction:column;gap:8px">
          </div>
          <div style="display:flex;gap:6px">
            <input type="text" id="log-chat-input" placeholder="Ask about research findings..."
              data-i18n-placeholder="logs.assistant_placeholder"
              style="flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:13px"
              onkeydown="if(event.key==='Enter')sendLogChat()">
            <select id="log-chat-model"
              style="padding:6px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--fg);font-size:12px;width:120px">
              <option value="glm-5">🧠 SAGE</option>
              <option value="claude-sonnet-4-6">🔵 SENTINEL</option>
              <option value="codex">🟢 FORGE</option>
            </select>
            <button class="btn btn-s" onclick="sendLogChat()" style="padding:6px 14px"
              data-i18n="logs.send">Send</button>
          </div>
        </div>
        <!-- Quick Stats -->
        <div class="card">
          <div style="font-weight:600;margin-bottom:8px" data-i18n="logs.stats_title">Research Stats</div>
          <div id="log-stats" class="text-sm" style="line-height:1.8">
            <div>Loading...</div>
          </div>
        </div>
        <!-- Quick actions -->
        <div class="card" style="margin-top:12px">
          <div style="font-weight:600;margin-bottom:8px" data-i18n="logs.quick_actions">Thao tác nhanh</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn btn-s" onclick="addLogNote()" style="padding:6px 12px;text-align:left"
              data-i18n="logs.add_note">+ Thêm ghi chú</button>
            <button class="btn btn-s" onclick="loadLogs();toast(t('logs.refreshed'))"
              style="padding:6px 12px;text-align:left" data-i18n="logs.refresh_all">Làm mới tất cả</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <!-- ═══ CONSOLE ═══ -->
  <div class="page" id="page-console">
    <div class="card" style="background:var(--info-bg,#EFF6FF);border:1px solid #BFDBFE;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:6px" data-i18n="console.howto_title">💡 NEXUS Console — Cách sử dụng
      </div>
      <div class="text-sm text-muted" style="line-height:1.7">
        <b data-i18n="console.howto_monitor">Process Monitor</b><span data-i18n="console.howto_monitor_desc">: Hiển thị
          các tiến trình NEXUS đang chạy (Dashboard, Brain Loop, Research). Dùng nút Start/Stop để điều
          khiển.</span><br>
        <b data-i18n="console.howto_logs">Log Viewer</b><span data-i18n="console.howto_logs_desc">: Chuyển giữa log
          Dashboard/Brain để debug. Hỗ trợ live stream SSE và fallback polling.</span><br>
        <b data-i18n="console.howto_cmd">Quick Commands</b><span data-i18n="console.howto_cmd_desc">: Chạy backtest,
          start brain loop, hoặc trigger research ngay tại đây.</span><br>
        <b data-i18n="console.howto_timeline">Phase Timeline</b><span data-i18n="console.howto_timeline_desc">: Các mốc
          phát triển lịch sử của NEXUS.</span>
      </div>
    </div>
    <div class="rowb mb2">
      <div class="section-title" style="margin-bottom:0" data-i18n="console.live_control">⚙️ NEXUS Console — Điều khiển
        tiến trình realtime</div>
      <div class="row">
        <button class="btn btn-s btn-sm"
          onclick="refreshConsole({includeLogs:true,forceLogRefresh:true,forceStream:true})" data-i18n="btn.refresh">↻
          Làm mới</button>
      </div>
    </div>
    <div class="console-wrap">
      <!-- Left panel: processes + controls -->
      <div style="display:flex;flex-direction:column;gap:14px;overflow-y:auto">
        <!-- System Status -->
        <div class="card">
          <div class="ctitle" data-i18n="console.system_status">🖥 Trạng thái hệ thống</div>
          <div id="sys-status">
            <div class="empty">Loading...</div>
          </div>
        </div>
        <!-- Running Processes -->
        <div class="card">
          <div class="ctitle"><span data-i18n="console.active_processes">🔄 Tiến trình hoạt động</span>
            <span id="proc-count" class="bdg bg-g" style="font-size:10px">0</span>
          </div>
          <div class="proc-list" id="proc-list">
            <div class="empty">Loading...</div>
          </div>
        </div>
        <!-- Quick Controls -->
        <div class="card">
          <div class="ctitle" data-i18n="console.control_panel">🎮 Bảng điều khiển</div>
          <div style="font-size:11px;color:var(--fg-muted);margin-bottom:8px" data-i18n="console.start_stop">Start /
            stop NEXUS processes:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <button class="ctrl-btn" onclick="ctrlAction('start','brain')" data-i18n="console.start_brain">▶ Start
              Brain</button>
            <button class="ctrl-btn danger" onclick="ctrlAction('stop','brain')" data-i18n="console.stop_brain">⏹ Stop
              Brain</button>
            <button class="ctrl-btn" onclick="ctrlAction('start','research')" data-i18n="console.start_research">▶ Start
              Research</button>
            <button class="ctrl-btn danger" onclick="ctrlAction('stop','research')" data-i18n="console.stop_research">⏹
              Stop Research</button>
            <button class="ctrl-btn" onclick="ctrlAction('restart','brain')" data-i18n="console.restart_brain">↺ Restart
              Brain</button>
            <button class="ctrl-btn" onclick="ctrlAction('restart','research')" data-i18n="console.restart_research">↺
              Restart Research</button>
          </div>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
            <div style="font-size:11px;color:var(--fg-muted);margin-bottom:6px" data-i18n="console.run_backtest">Run
              backtest:</div>
            <div style="display:flex;gap:6px;align-items:center">
              <select id="backtest-cfg"
                style="flex:1;font-size:11px;padding:4px 6px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--fg)">
                <option value="configs/production_p91b_champion.json">Production P91b Champion</option>
                <option value="configs/run_binance_v1_full_2023_2025.json">V1 Full 2023-2025</option>
                <option value="configs/run_binance_nexus_alpha_v1_2025ytd.json">V1 2025 YTD</option>
                <option value="configs/run_binance_v1_2022_bear.json">V1 2022 Bear</option>
                <option value="configs/run_synthetic_funding.json">Synthetic Funding (Demo only)</option>
              </select>
              <button class="ctrl-btn" onclick="ctrlAction('start','backtest')" data-i18n="console.run">▶ Run</button>
            </div>
          </div>
          <div id="ctrl-result" style="margin-top:8px;font-size:11px;color:var(--accent);min-height:16px"></div>
        </div>
        <!-- Phase Timeline -->
        <div class="card">
          <div class="ctitle">📋 Completed Phases</div>
          <div class="phase-timeline">
            <div class="phase-item done"><span class="phase-num">Ph 1-10</span><span>Real data, venue costs,
                walk-forward, risk, ML, agents</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 11</span><span>NEXUS Brain — GLM-5 + diary +
                goals</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 12</span><span>RAG-lite TF-IDF + SmartRouter</span>
            </div>
            <div class="phase-item done"><span class="phase-num">Ph 13</span><span>Bias checker + web research
                tools</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 14</span><span>Kanban + team reports + live
                market</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 29-31</span><span>OOS validation — avg Sharpe
                1.01</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 32-36</span><span>Chat, console, brain, memory
                curator</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 37-41</span><span>Regime-adaptive, ML Factor V3,
                audit</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 54</span><span>V1-Long discovery</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 55-90</span><span>Param optimization & new
                signals</span></div>
            <div class="phase-item done"><span class="phase-num">Ph 91</span><span>P91b Champion discovery</span></div>
            <div class="phase-item curr"><span class="phase-num">Ph 92-107</span><span>Verification, Bias Checks & Live
                Deploy Prep</span></div>
          </div>
        </div>
      </div>
      <!-- Right panel: log viewer -->
      <div class="log-viewer">
        <div class="log-tabs">
          <div class="log-tab active" id="ltab-dashboard" onclick="switchLogTab('dashboard')"><span
              data-i18n="log.tab_dashboard">Dashboard</span></div>
          <div class="log-tab" id="ltab-brain" onclick="switchLogTab('brain')"><span
              data-i18n="log.tab_brain">Brain</span></div>
          <div class="log-tab" id="ltab-research" onclick="switchLogTab('research')"><span
              data-i18n="log.tab_research">Research</span></div>
          <div class="log-tab" id="ltab-backtest" onclick="switchLogTab('backtest')"><span
              data-i18n="log.tab_backtest">Backtest</span></div>
          <div class="log-toolbar">
            <span id="log-stream-state" class="log-pill disconnected"><span class="dot"></span><span
                id="log-stream-label" data-i18n="log.disconnected">Mất kết nối</span></span>
            <input id="log-search" class="log-search" type="text" placeholder="Lọc dòng log..."
              data-i18n-placeholder="log.filter_placeholder" oninput="renderLogBody()">
            <label style="font-size:11px;color:var(--fg-muted);display:flex;align-items:center;gap:4px">
              <input type="checkbox" id="log-auto" checked onchange="toggleLogAuto()"> <span data-i18n="log.auto">Tự
                động</span>
            </label>
            <button class="btn btn-s btn-sm" id="log-pause-btn" onclick="toggleLogPause()" data-i18n="log.pause">Tạm
              dừng</button>
            <button class="btn btn-s btn-sm" onclick="copyVisibleLogs()" data-i18n="log.copy">Sao chép</button>
            <button class="btn btn-s btn-sm" onclick="refreshLog()" data-i18n="btn.refresh">↻ Làm mới</button>
          </div>
        </div>
        <div class="log-body" id="log-body"><span style="color:#888" data-i18n="log.connecting">Đang kết nối log
            stream...</span></div>
        <div
          style="padding:6px 12px;border-top:1px solid var(--border);font-size:11px;color:var(--fg-muted);display:flex;justify-content:space-between">
          <span id="log-info">Dòng: 0</span>
          <span id="log-updated">—</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ── TRACK RECORD PAGE ──────────────────────────────────────────── -->
  <div class="page" id="page-track-record">
    <div class="section-wrap">
      <div class="section-header">
        <span class="section-title">🏆 NEXUS Platform Track Record</span>
        <span class="section-sub">Cross-project performance vs benchmarks · All Sharpe ratios annualised</span>
        <button onclick="loadTrackRecord()" style="float:right;padding:4px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:12px">↻ Refresh</button>
      </div>
      <div id="tr-badges" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px"></div>
      <div class="card" style="margin-bottom:14px">
        <div class="ctitle" style="margin-bottom:10px">NEXUS Projects (OOS Backtest Sharpe)</div>
        <div id="tr-projects-table"><div class="text-muted text-sm">Loading…</div></div>
      </div>
      <div class="card" style="margin-bottom:14px">
        <div class="ctitle" style="margin-bottom:10px">Benchmarks (Estimated Annual Sharpe)</div>
        <div id="tr-benchmarks-table"><div class="text-muted text-sm">Loading…</div></div>
      </div>
      <!-- ── Portfolio Optimizer Card ─────────────────────────────────── -->
      <div class="card" style="margin-bottom:14px">
        <div class="ctitle" style="margin-bottom:10px">
          📐 Multi-Strategy Portfolio Optimizer
          <button onclick="loadPortfolioOptimizer()" style="float:right;padding:2px 8px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:11px">Run</button>
        </div>
        <div id="portfolio-summary" style="margin-bottom:10px;font-size:13px;color:var(--fg-muted)">
          Click Run to compute optimal allocation…
        </div>
        <div id="portfolio-frontier-table"></div>
        <div id="portfolio-grid-chart" style="margin-top:10px"></div>
      </div>

      <!-- ── Key Insights Card ─────────────────────────────────────────── -->
      <div class="card">
        <div class="ctitle" style="margin-bottom:8px">Key Insights</div>
        <div id="tr-insights" style="font-size:13px;line-height:1.7;color:var(--fg-muted)">
          <ul style="margin:0;padding-left:18px">
            <li><strong style="color:var(--fg)">crypto_perps</strong>: OOS validated 2021-2026. AVG=2.005, MIN=1.427. 2022 bear: Sharpe 1.427 (BTC was -64%).</li>
            <li><strong style="color:var(--fg)">crypto_options (VRP)</strong>: Phase 2 validated 2021-2025. AVG=1.520, MIN=1.273. Best 2023 (1.944, low vol = max premium collect). Proper gamma/theta model.</li>
            <li><strong style="color:var(--fg)">commodity_cta</strong>: Infrastructure Phase 135 complete. Pending real data validation. Target Sharpe &gt; 0.8.</li>
            <li><strong style="color:var(--fg)">Portfolio optimizer (Phase 138)</strong>: 35% perps + 65% options → avg Sharpe <strong style="color:var(--green)">2.265</strong>, min <strong style="color:var(--green)">1.790</strong>, vol 4.6%. Diversification benefit <strong style="color:var(--green)">+0.575</strong>.</li>
            <li><strong style="color:var(--fg)">SG CTA 2022</strong>: +25.2% (best CTA year in decades). NEXUS crypto_perps (1.427) + crypto_options (1.446) both strong in bear market. Macro stress resistant.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- ── END TRACK RECORD ──────────────────────────────────────────── -->

  <div id="cmdk-backdrop" class="cmdk-backdrop" onclick="closeCommandPalette()"></div>
  <div id="cmdk" class="cmdk" role="dialog" aria-modal="true" aria-label="Quick command">
    <div class="cmdk-head">
      <input id="cmdk-input" class="cmdk-input" type="text" placeholder="Tìm tab hoặc hành động..."
        oninput="renderCommandPalette()" onkeydown="onCommandPaletteKey(event)">
      <button class="btn btn-s btn-sm" onclick="closeCommandPalette()">Esc</button>
    </div>
    <div id="cmdk-list" class="cmdk-list"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ─── Utils ───
    const $ = id => document.getElementById(id);
    const $$ = s => document.querySelectorAll(s);
    let _activeTabHint = 'overview';
    const _loaderCtx = [];
    const TAB_RT_STATE = {};
    let _globalPending = 0;
    function _tabState(tab) {
      const key = String(tab || 'overview');
      if (!TAB_RT_STATE[key]) {
        TAB_RT_STATE[key] = {
          pending: 0, running: false, lastStartAt: 0, lastEndAt: 0, lastSuccessAt: 0, lastErrorAt: 0,
          lastReason: '', queuedLoader: null, queuedReason: ''
        };
      }
      return TAB_RT_STATE[key];
    }
    function _withLoaderCtx(tab, fn) {
      _loaderCtx.push(String(tab || 'overview'));
      try { return fn(); }
      finally { _loaderCtx.pop(); }
    }
    function _currentLoaderTab() {
      return _loaderCtx.length ? _loaderCtx[_loaderCtx.length - 1] : _activeTabHint;
    }
    function jx(url, opts) {
      const tab = _currentLoaderTab();
      const st = _tabState(tab);
      st.pending += 1;
      _globalPending += 1;
      if (typeof _updateGlobalLoader === 'function') _updateGlobalLoader();
      return fetch(url, opts).then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(d => { st.lastSuccessAt = Date.now(); return d; })
        .catch(e => { st.lastErrorAt = Date.now(); throw e; })
        .finally(() => {
          st.pending = Math.max(0, st.pending - 1);
          _globalPending = Math.max(0, _globalPending - 1);
          if (typeof _updateGlobalLoader === 'function') _updateGlobalLoader();
          if (st.pending === 0 && st.running) {
            st.running = false;
            st.lastEndAt = Date.now();
            if ((!st.lastSuccessAt || st.lastSuccessAt < st.lastStartAt) && (!st.lastErrorAt || st.lastErrorAt < st.lastStartAt)) {
              st.lastSuccessAt = st.lastEndAt;
            }
          }
          if (typeof _drainTabQueue === 'function') _drainTabQueue(tab);
          if (typeof _updateTabIndicators === 'function') _updateTabIndicators();
          if (typeof _updateAutoSyncBadge === 'function') _updateAutoSyncBadge();
        });
    }
    function set(id, v) { const e = $(id); if (e) e.textContent = v; }
    function html(id, h) { const e = $(id); if (e) e.innerHTML = h; }
    function esc(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function n2(v, d = 2) { if (v == null || isNaN(+v)) return '—'; return (+v).toFixed(d); }
    function pct(v, d = 2) { if (v == null || isNaN(+v)) return '—'; return ((+v) * 100).toFixed(d) + '%'; }
    function pctd(v, d = 2) { if (v == null || isNaN(+v)) return '—'; return (+v).toFixed(d) + '%'; }
    function clr(v, pos = true) { if (v == null) return ''; return (pos ? v >= 0 : v <= 0) ? 'pos' : 'neg'; }
    function now() { return new Date().toLocaleTimeString(); }
    function toast(m, d = 3) { const t = $('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), d * 1000); }
    function fmtSize(b) { if (b < 1024) return b + 'B'; if (b < 1048576) return (b / 1024).toFixed(1) + 'KB'; return (b / 1048576).toFixed(1) + 'MB'; }
    const LANG_KEY = 'nexus_lang';
    const I18N = {
      vi: {
        'brand.sub': 'Nền tảng Quant tự động',
        'hdr.sharpe': 'Sharpe —',
        'hdr.pnl': 'PnL —',
        'hdr.status_connecting': 'Trạng thái Đang kết nối',
        'chip.sharpe': 'Sharpe',
        'chip.pnl': 'PnL',
        'chip.status': 'Trạng thái',
        'tab.overview': 'Tổng quan',
        'tab.chat': 'Chat',
        'tab.benchmark': 'Benchmark',
        'tab.performance': 'Hiệu suất',
        'tab.risk': 'Rủi ro',
        'tab.research': 'Nghiên cứu',
        'tab.tasks': 'Nhiệm vụ',
        'tab.files': 'Tệp',
        'tab.market': 'Thị trường',
        'tab.pitch': 'Pitch',
        'tab.logs': 'Nhật ký',
        'tab.console': 'Console',
        'kpi.sharpe': 'Sharpe',
        'kpi.cagr': 'CAGR',
        'kpi.mdd': 'Max DD',
        'kpi.total_return': 'Tổng lợi nhuận',
        'kpi.win_rate': 'Tỷ lệ thắng',
        'kpi.strategy': 'Chiến lược',
        'btn.refresh': '↻ Làm mới',
        'btn.demo': '🚀 Demo Tour',
        'status.connecting': 'Đang kết nối…',
        'status.connecting_short': 'Đang kết nối...',
        'status.live': 'Trực tiếp',
        'status.reconnecting': 'Đang kết nối lại…',
        'status.stale': 'Trễ dữ liệu',
        'status.updated': 'Cập nhật {time}',
        'status.live_dot': 'Trực tiếp · {time}',
        'status.no_active_backtest': 'Không có backtest đang chạy',
        'status.pass': 'ĐẠT',
        'status.fail': 'KHÔNG ĐẠT',
        'status.good': 'TỐT',
        'status.ok': 'ỔN',
        'status.weak': 'YẾU',
        'status.waiting_first_sync_kpi': 'Đang chờ đồng bộ dữ liệu',
        'status.syncing_tab': 'Đang cập nhật {tab}',
        'status.synced_tab': '{tab} · cập nhật {age}s trước',
        'status.next_in': 'lần tới {n}s',
        'status.waiting_first_sync': '{tab} · chờ đồng bộ lần đầu',
        'status.auto_paused': 'Tự động tạm dừng',
        'status.hidden_mode': 'chế độ nền',
        'status.retrying': 'đang thử lại',
        'mvp.kicker': 'MVP Snapshot',
        'mvp.title': 'NEXUS tạo alpha trung tính thị trường với giám sát realtime.',
        'mvp.subtitle': 'Bản demo tập trung vào 3 thứ: hiệu suất có thể kiểm chứng, rủi ro có kiểm soát, và vận hành AI realtime để sẵn sàng ra mắt thị trường.',
        'mvp.tag_oos': 'Chứng minh OOS nhiều năm',
        'mvp.tag_live': 'Realtime dashboard + logs',
        'mvp.tag_multi': 'Đội AI đa mô hình',
        'mvp.value': 'Giá trị',
        'mvp.proof': 'Bằng chứng',
        'mvp.realtime': 'Realtime',
        'story.value': 'Giá trị',
        'story.value_desc': 'Chất lượng alpha nhìn trong 1 nhịp.',
        'story.proof': 'Bằng chứng',
        'story.proof_desc': 'Xác thực và độ ổn định.',
        'story.live': 'Vận hành Live',
        'story.live_desc': 'Tiến trình và log realtime.',
        'story.roi': 'ROI',
        'story.roi_desc': 'Luận điểm kinh doanh và roadmap.',
        'story.proc': '{n} tiến trình',
        'story.open_tab': 'Mở tab {tab}',
        'focus.live': 'Live',
        'focus.loading': 'Đang tải',
        'focus.stale': 'Cần làm mới',
        'focus.waiting': 'Chờ dữ liệu',
        'focus.updated': 'Cập nhật {s}s trước',
        'focus.never': 'Chưa có đồng bộ',
        'table.search_placeholder': 'Tìm trong bảng...',
        'cmd.open': '⌘K Lệnh nhanh',
        'cmd.placeholder': 'Tìm tab hoặc hành động...',
        'cmd.no_result': 'Không tìm thấy lệnh phù hợp.',
        'cmd.refresh_current': 'Làm mới tab hiện tại',
        'cmd.run_primary': 'Chạy hành động trọng tâm',
        'cmd.focus_input': 'Tới ô nhập chính',
        'cmd.demo_tour': 'Chạy Demo Tour',
        'cmd.toggle_theme': 'Đổi sáng/tối',
        'cmd.toggle_lang': 'Chuyển VI/EN',
        'cmd.tab': 'Tab',
        'cmd.action': 'Hành động',
        'log.auto': 'Tự động',
        'log.auto_off': 'Tự động tắt',
        'log.pause': 'Tạm dừng',
        'log.resume': 'Tiếp tục',
        'log.copy': 'Sao chép',
        'log.filter_placeholder': 'Lọc dòng log...',
        'log.tab_dashboard': 'Dashboard',
        'log.tab_brain': 'Brain',
        'log.tab_research': 'Research',
        'log.tab_backtest': 'Backtest',
        'log.connecting': 'Đang kết nối log stream...',
        'log.disconnected': 'Mất kết nối',
        'log.streaming': 'Đang stream',
        'log.polling': 'Đang polling',
        'log.paused': 'Đã tạm dừng',
        'log.unavailable': 'Không khả dụng',
        'log.no_lines': 'Chưa có dòng log cho mục này.',
        'log.no_lines_filtered': 'Không có dòng log phù hợp bộ lọc.',
        'log.lines': 'Dòng',
        'log.filtered': 'Đã lọc',
        'log.copied': 'Đã sao chép log',
        'log.no_copy_data': 'Không có log để sao chép',
        'log.copy_failed': 'Sao chép thất bại',
        'logs.quick_actions': 'Thao tác nhanh',
        'logs.add_note': '+ Thêm ghi chú',
        'logs.refresh_all': 'Làm mới tất cả',
        'logs.refreshed': 'Đã làm mới logs',
        'logs.hero_title': 'Nhật ký Phân tích — Lịch sử Nghiên cứu',
        'logs.hero_subtitle': 'Lưu vết bền vững các phân tích, phát hiện, quyết định và audit đa mô hình. Stream live qua SSE, tự fallback thông minh.',
        'logs.filter_all_types': 'Tất cả loại',
        'logs.filter_analysis': 'Phân tích',
        'logs.filter_finding': 'Phát hiện',
        'logs.filter_decision': 'Quyết định',
        'logs.filter_audit': 'Audit',
        'logs.filter_all_sources': 'Tất cả nguồn',
        'logs.auto_refresh': 'Tự động làm mới',
        'logs.refresh_btn': 'Làm mới',
        'logs.loading': 'Đang tải nhật ký phân tích...',
        'logs.assistant_title': 'Trợ lý Nghiên cứu AI',
        'logs.assistant_subtitle': 'Hỏi nhanh về phát hiện nghiên cứu, phân tích chiến lược và insight AI.',
        'logs.assistant_placeholder': 'Hỏi về các phát hiện nghiên cứu...',
        'logs.send': 'Gửi',
        'logs.stats_title': 'Thống kê Nghiên cứu',
        'logs.kpi_total': 'Tổng mục',
        'logs.kpi_critical': 'Critical',
        'logs.kpi_decision': 'Quyết định',
        'logs.kpi_audit': 'Audit',
        'logs.entries': 'mục',
        'logs.no_entries': 'Chưa có bản ghi nghiên cứu. Nhật ký sẽ xuất hiện khi research chạy.',
        'logs.load_error': 'Lỗi tải nhật ký',
        'logs.stream_connecting': 'Kết nối stream...',
        'logs.stream_live': 'Live SSE',
        'logs.stream_polling': 'Fallback polling',
        'logs.stream_paused': 'Tạm dừng',
        'logs.stream_disconnected': 'Mất kết nối',
        'logs.by_type': 'THEO LOẠI',
        'logs.by_source': 'THEO NGUỒN',
        'logs.latest': 'Mới nhất',
        'logs.alternatives': 'Phương án đã cân nhắc',
        'console.howto_title': '💡 NEXUS Console — Cách sử dụng',
        'console.howto_monitor': 'Process Monitor',
        'console.howto_monitor_desc': ': Hiển thị tiến trình NEXUS đang chạy (Dashboard, Brain Loop, Research). Dùng Start/Stop để điều khiển.',
        'console.howto_logs': 'Log Viewer',
        'console.howto_logs_desc': ': Chuyển giữa log Dashboard/Brain để debug. Hỗ trợ SSE realtime và fallback polling.',
        'console.howto_cmd': 'Quick Commands',
        'console.howto_cmd_desc': ': Chạy backtest, start brain loop, hoặc trigger research ngay tại đây.',
        'console.howto_timeline': 'Phase Timeline',
        'console.howto_timeline_desc': ': Các mốc phát triển lịch sử của NEXUS.',
        'console.live_control': '⚙️ NEXUS Console — Điều khiển tiến trình realtime',
        'console.system_status': '🖥 Trạng thái hệ thống',
        'console.active_processes': '🔄 Tiến trình hoạt động',
        'console.control_panel': '🎮 Bảng điều khiển',
        'console.start_stop': 'Start / stop NEXUS processes:',
        'console.start_brain': '▶ Start Brain',
        'console.stop_brain': '⏹ Stop Brain',
        'console.start_research': '▶ Start Research',
        'console.stop_research': '⏹ Stop Research',
        'console.restart_brain': '↺ Restart Brain',
        'console.restart_research': '↺ Restart Research',
        'console.run_backtest': 'Run backtest:',
        'console.run': '▶ Run',
        'console.action_start': 'Bật',
        'console.action_stop': 'Dừng',
        'console.action_restart': 'Khởi động lại',
        'console.target_brain': 'Brain',
        'console.target_research': 'Research',
        'console.target_backtest': 'Backtest',
        'demo.step_overview': 'Overview: kể câu chuyện KPI và equity curve.',
        'demo.step_chat': 'Chat: hỏi NEXUS về chiến lược, rủi ro và logic tín hiệu.',
        'demo.step_performance': 'Performance: cho thấy consistency qua lịch sử runs.',
        'demo.step_risk': 'Risk: trình bày VaR, drawdown và cơ chế guardrails.',
        'demo.step_console': 'Console: chứng minh process + logs realtime đang sống.',
        'demo.step_pitch': 'Pitch: chốt business value, roadmap và khả năng scale.',
        'demo.done': 'Demo tour hoàn tất.',
        'console.no_processes': 'Không có tiến trình NEXUS đang chạy',
        'console.proc_unavailable': 'Không thể tải process monitor',
        'console.sys_unavailable': 'Không thể tải thống kê hệ thống',
        'console.request_failed': 'Yêu cầu thất bại',
      },
      en: {
        'brand.sub': 'Autonomous Quant Platform',
        'hdr.sharpe': 'Sharpe —',
        'hdr.pnl': 'PnL —',
        'hdr.status_connecting': 'Status Connecting',
        'chip.sharpe': 'Sharpe',
        'chip.pnl': 'PnL',
        'chip.status': 'Status',
        'tab.overview': 'Overview',
        'tab.chat': 'Chat',
        'tab.benchmark': 'Benchmark',
        'tab.performance': 'Performance',
        'tab.risk': 'Risk',
        'tab.research': 'Research',
        'tab.tasks': 'Tasks',
        'tab.files': 'Files',
        'tab.market': 'Market',
        'tab.pitch': 'Pitch',
        'tab.logs': 'Logs',
        'tab.console': 'Console',
        'kpi.sharpe': 'Sharpe',
        'kpi.cagr': 'CAGR',
        'kpi.mdd': 'Max DD',
        'kpi.total_return': 'Total Return',
        'kpi.win_rate': 'Win Rate',
        'kpi.strategy': 'Strategy',
        'btn.refresh': '↻ Refresh',
        'btn.demo': '🚀 Demo Tour',
        'status.connecting': 'Connecting…',
        'status.connecting_short': 'Connecting...',
        'status.live': 'Live',
        'status.reconnecting': 'Reconnecting…',
        'status.stale': 'Stale',
        'status.updated': 'Updated {time}',
        'status.live_dot': 'Live · {time}',
        'status.no_active_backtest': 'No active backtest',
        'status.pass': 'PASS',
        'status.fail': 'FAIL',
        'status.good': 'GOOD',
        'status.ok': 'OK',
        'status.weak': 'WEAK',
        'status.waiting_first_sync_kpi': 'Waiting for first data sync',
        'status.syncing_tab': 'Syncing {tab}',
        'status.synced_tab': '{tab} · updated {age}s ago',
        'status.next_in': 'next {n}s',
        'status.waiting_first_sync': '{tab} · waiting first sync',
        'status.auto_paused': 'Auto paused',
        'status.hidden_mode': 'background',
        'status.retrying': 'retrying',
        'mvp.kicker': 'MVP Snapshot',
        'mvp.title': 'NEXUS delivers market-neutral alpha with realtime AI supervision.',
        'mvp.subtitle': 'This demo focuses on 3 things: provable performance, controlled risk, and realtime AI operations ready for fast market launch.',
        'mvp.tag_oos': 'Multi-year OOS proof',
        'mvp.tag_live': 'Realtime dashboard + logs',
        'mvp.tag_multi': 'Multi-model AI team',
        'mvp.value': 'Value',
        'mvp.proof': 'Proof',
        'mvp.realtime': 'Realtime',
        'story.value': 'Value',
        'story.value_desc': 'Alpha quality at a glance.',
        'story.proof': 'Proof',
        'story.proof_desc': 'Validation and consistency.',
        'story.live': 'Live Ops',
        'story.live_desc': 'Realtime processes and logs.',
        'story.roi': 'ROI',
        'story.roi_desc': 'Business case and roadmap.',
        'story.proc': '{n} processes',
        'story.open_tab': 'Opened {tab} tab',
        'focus.live': 'Live',
        'focus.loading': 'Loading',
        'focus.stale': 'Needs refresh',
        'focus.waiting': 'Waiting data',
        'focus.updated': 'Updated {s}s ago',
        'focus.never': 'No sync yet',
        'table.search_placeholder': 'Search table...',
        'cmd.open': '⌘K Quick Cmd',
        'cmd.placeholder': 'Search tabs or actions...',
        'cmd.no_result': 'No matching command.',
        'cmd.refresh_current': 'Refresh current tab',
        'cmd.run_primary': 'Run primary action',
        'cmd.focus_input': 'Focus primary input',
        'cmd.demo_tour': 'Run Demo Tour',
        'cmd.toggle_theme': 'Toggle light/dark',
        'cmd.toggle_lang': 'Switch VI/EN',
        'cmd.tab': 'Tab',
        'cmd.action': 'Action',
        'log.auto': 'Auto',
        'log.auto_off': 'Auto Off',
        'log.pause': 'Pause',
        'log.resume': 'Resume',
        'log.copy': 'Copy',
        'log.filter_placeholder': 'Filter log lines...',
        'log.tab_dashboard': 'Dashboard',
        'log.tab_brain': 'Brain',
        'log.tab_research': 'Research',
        'log.tab_backtest': 'Backtest',
        'log.connecting': 'Connecting to log stream...',
        'log.disconnected': 'Disconnected',
        'log.streaming': 'Streaming',
        'log.polling': 'Polling',
        'log.paused': 'Paused',
        'log.unavailable': 'Unavailable',
        'log.no_lines': 'No log lines yet for this target.',
        'log.no_lines_filtered': 'No lines match this filter.',
        'log.lines': 'Lines',
        'log.filtered': 'Filtered',
        'log.copied': 'Logs copied',
        'log.no_copy_data': 'No log lines to copy',
        'log.copy_failed': 'Copy failed',
        'logs.quick_actions': 'Quick Actions',
        'logs.add_note': '+ Add Note',
        'logs.refresh_all': 'Refresh All',
        'logs.refreshed': 'Logs refreshed',
        'logs.hero_title': 'Analysis Journal — Research History',
        'logs.hero_subtitle': 'Persistent record of analysis, findings, decisions, and multi-model audits. Live stream via SSE with smart fallback.',
        'logs.filter_all_types': 'All Types',
        'logs.filter_analysis': 'Analysis',
        'logs.filter_finding': 'Finding',
        'logs.filter_decision': 'Decision',
        'logs.filter_audit': 'Audit',
        'logs.filter_all_sources': 'All Sources',
        'logs.auto_refresh': 'Auto-refresh',
        'logs.refresh_btn': 'Refresh',
        'logs.loading': 'Loading analysis logs...',
        'logs.assistant_title': 'AI Research Assistant',
        'logs.assistant_subtitle': 'Ask about research findings, strategy analysis, or get quick insights from AI.',
        'logs.assistant_placeholder': 'Ask about research findings...',
        'logs.send': 'Send',
        'logs.stats_title': 'Research Stats',
        'logs.kpi_total': 'Total Entries',
        'logs.kpi_critical': 'Critical',
        'logs.kpi_decision': 'Decisions',
        'logs.kpi_audit': 'Audits',
        'logs.entries': 'entries',
        'logs.no_entries': 'No research journal entries yet. Logs will appear as research runs.',
        'logs.load_error': 'Failed to load logs',
        'logs.stream_connecting': 'Connecting stream...',
        'logs.stream_live': 'Live SSE',
        'logs.stream_polling': 'Polling fallback',
        'logs.stream_paused': 'Paused',
        'logs.stream_disconnected': 'Disconnected',
        'logs.by_type': 'BY TYPE',
        'logs.by_source': 'BY SOURCE',
        'logs.latest': 'Latest',
        'logs.alternatives': 'Alternatives considered',
        'console.howto_title': '💡 NEXUS Console — How to use',
        'console.howto_monitor': 'Process Monitor',
        'console.howto_monitor_desc': ': Shows running NEXUS processes (Dashboard, Brain Loop, Research). Use Start/Stop buttons to control them.',
        'console.howto_logs': 'Log Viewer',
        'console.howto_logs_desc': ': Switch between Dashboard/Brain logs to debug issues. Live stream via SSE with polling fallback.',
        'console.howto_cmd': 'Quick Commands',
        'console.howto_cmd_desc': ': Run a backtest, start brain loop, or trigger research from this panel.',
        'console.howto_timeline': 'Phase Timeline',
        'console.howto_timeline_desc': ': Historical milestones of NEXUS development.',
        'console.live_control': '⚙️ NEXUS Console — Live Process Control',
        'console.system_status': '🖥 System Status',
        'console.active_processes': '🔄 Active Processes',
        'console.control_panel': '🎮 Control Panel',
        'console.start_stop': 'Start / stop NEXUS processes:',
        'console.start_brain': '▶ Start Brain',
        'console.stop_brain': '⏹ Stop Brain',
        'console.start_research': '▶ Start Research',
        'console.stop_research': '⏹ Stop Research',
        'console.restart_brain': '↺ Restart Brain',
        'console.restart_research': '↺ Restart Research',
        'console.run_backtest': 'Run backtest:',
        'console.run': '▶ Run',
        'console.action_start': 'Start',
        'console.action_stop': 'Stop',
        'console.action_restart': 'Restart',
        'console.target_brain': 'Brain',
        'console.target_research': 'Research',
        'console.target_backtest': 'Backtest',
        'demo.step_overview': 'Overview: present KPI story and equity curve.',
        'demo.step_chat': 'Chat: ask NEXUS about strategy, risk, and signal logic.',
        'demo.step_performance': 'Performance: show consistency across run history.',
        'demo.step_risk': 'Risk: present VaR, drawdown, and guardrails.',
        'demo.step_console': 'Console: prove realtime processes and logs are live.',
        'demo.step_pitch': 'Pitch: close with business value and scale roadmap.',
        'demo.done': 'Demo tour completed.',
        'console.no_processes': 'No NEXUS processes running',
        'console.proc_unavailable': 'Process monitor unavailable',
        'console.sys_unavailable': 'System stats unavailable',
        'console.request_failed': 'Request failed',
      }
    };
    let _lang = 'vi';
    function t(key, vars) {
      const dict = I18N[_lang] || I18N.vi;
      let out = dict[key] ?? I18N.vi[key] ?? key;
      if (vars && typeof out === 'string') {
        Object.keys(vars).forEach(k => { out = out.replace(new RegExp(`\\{${k}\\}`, 'g'), String(vars[k])); });
      }
      return out;
    }
    function localizeVerdict(v) {
      const u = String(v || '').toUpperCase();
      if (u === 'PASS') return t('status.pass');
      if (u === 'FAIL') return t('status.fail');
      if (u === 'GOOD') return t('status.good');
      if (u === 'OK') return t('status.ok');
      if (u === 'WEAK') return t('status.weak');
      return String(v || '—');
    }
    function applyI18n() {
      document.documentElement.setAttribute('lang', _lang);
      $$('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if (k) el.textContent = t(k);
      });
      $$('[data-i18n-placeholder]').forEach(el => {
        const k = el.getAttribute('data-i18n-placeholder');
        if (k) el.setAttribute('placeholder', t(k));
      });
      const sel = $('lang-select');
      if (sel) sel.value = _lang;
      const pb = $('log-pause-btn');
      if (pb) pb.textContent = (typeof _logPaused !== 'undefined' && _logPaused) ? t('log.resume') : t('log.pause');
      const ci = $('cmdk-input');
      if (ci) ci.setAttribute('placeholder', t('cmd.placeholder'));
      if (typeof renderTabFocusHero === 'function') renderTabFocusHero();
      if (typeof renderCommandPalette === 'function' && _cmdOpen) renderCommandPalette();
    }
    function setLanguage(lang) {
      _lang = lang === 'en' ? 'en' : 'vi';
      localStorage.setItem(LANG_KEY, _lang);
      applyI18n();
      setLiveStatus(APP_STATE.liveConnected ? 'live' : 'connecting', APP_STATE.liveConnected ? t('status.live') : t('status.connecting'));
      updateMvpSummary();
      if (typeof _updateAutoSyncBadge === 'function') _updateAutoSyncBadge();
      if (!_logLastPath) {
        const info = $('log-info');
        if (info && /^(Lines|Dòng):/.test(info.textContent || '')) info.textContent = `${t('log.lines')}: 0`;
      }
      if (typeof setAnalysisStreamState === 'function' && $('analysis-stream-state')) setAnalysisStreamState(_analysisStreamState || 'connecting');
      if (typeof _analysisRenderEntries === 'function' && _analysisEntries && _analysisEntries.length && _tab === 'logs') _analysisRenderEntries();
      if (typeof _analysisRenderStats === 'function' && _analysisEntries && _analysisEntries.length && _tab === 'logs') _analysisRenderStats(_analysisEntries);
    }
    function initLanguage() {
      const saved = localStorage.getItem(LANG_KEY);
      _lang = saved === 'en' ? 'en' : 'vi';
      applyI18n();
      updateMvpSummary();
    }

    // ─── Tab system ───
    const TABS = ['home', 'performance-sc', 'how-it-works', 'live-demo', 'about', 'chat', 'research', 'tasks', 'files', 'signals', 'live-engine', 'logs', 'console', 'overview', 'benchmark', 'performance', 'risk', 'market', 'pitch'];

    function buildShowcasePages() {
      if (window.showcaseBuilt) return;
      window.showcaseBuilt = true;

      const move = (el, destId) => {
        const dest = document.getElementById(destId);
        if (el && dest) dest.appendChild(el);
      };

      // Home
      move(document.querySelector('.mvp-hero'), 'page-home');
      move(document.getElementById('aw-highlights'), 'page-home');
      const eqWrap = document.getElementById('eq-chart-wrap');
      if (eqWrap) move(eqWrap.closest('.card'), 'page-home');

      // Performance-SC
      const titles = Array.from(document.querySelectorAll('.ctitle'));
      const p91bTable = titles.find(el => el.textContent.includes('P91b Champion — Full Crypto Cycle'));
      if (p91bTable) move(p91bTable.closest('.card'), 'page-performance-sc');
      const yearChart = document.getElementById('year-bar-chart');
      if (yearChart) move(yearChart.closest('.card'), 'page-performance-sc');
      const benchGrid = document.querySelector('.tgrid');
      if (benchGrid) {
        const bc = benchGrid.closest('.card');
        if (bc) move(bc, 'page-performance-sc');
        else move(benchGrid.parentElement, 'page-performance-sc');
      }

      // How-It-Works
      const decisionFlow = titles.find(el => el.textContent.includes('How NEXUS Makes Decisions'));
      if (decisionFlow) move(decisionFlow.closest('.card'), 'page-how-it-works');
      const agentTeam = titles.find(el => el.textContent.includes('AI Workforce'));
      if (agentTeam) move(agentTeam.closest('.card'), 'page-how-it-works');

      // Live-Demo
      const marketTab = document.getElementById('page-market');
      if (marketTab) Array.from(marketTab.querySelectorAll('.card')).forEach(c => move(c, 'page-live-demo'));
      const brainStatus = document.getElementById('ov-brain');
      if (brainStatus) {
        const bg3 = brainStatus.closest('.g3');
        if (bg3) move(bg3, 'page-live-demo');
      }
      const ovLedger = document.getElementById('ov-ledger');
      if (ovLedger) move(ovLedger.closest('.card'), 'page-live-demo');

      // About
      const pitchTab = document.getElementById('page-pitch');
      if (pitchTab) {
        const cards = Array.from(pitchTab.querySelectorAll('.card'));
        const disclaimer = cards.find(c => c.textContent.includes('Scientific Disclaimer'));
        if (disclaimer) move(disclaimer, 'page-about');
      }
    }

    function setDashboardMode(mode) {
      buildShowcasePages();

      // Move log-viewer to Showcase Live Demo or Internal Console based on mode
      const logViewer = document.querySelector('.log-viewer');
      if (logViewer) {
        if (mode === 'showcase') {
          const liveDemo = document.getElementById('page-live-demo');
          if (liveDemo) {
            liveDemo.appendChild(logViewer);
            logViewer.style.height = '600px';
            logViewer.style.marginTop = '24px';
            logViewer.style.boxShadow = 'var(--shadow-md)';
          }
        } else if (mode === 'ops') {
          const consoleWrap = document.querySelector('.console-wrap');
          if (consoleWrap) {
            consoleWrap.appendChild(logViewer);
            logViewer.style.height = '';
            logViewer.style.marginTop = '';
            logViewer.style.boxShadow = '';
          }
        }
      }

      // Hide all tabs that don't match the mode
      document.querySelectorAll('#main-tabs .tab').forEach(t => {
        if (t.dataset.mode === mode) {
          t.style.display = 'flex';
        } else {
          t.style.display = 'none';
        }
      });

      // Go to default tab for the mode
      if (mode === 'showcase') {
        go('home');
      } else if (mode === 'ops') {
        go('chat');
      }
    }
    const THEME_KEY = 'nexus_theme';
    const TABLE_STATE = {};
    const APP_STATE = {
      liveConnected: false,
      liveSeenAt: 0,
      activeRun: null,
      lastRunName: null,
      latestMetrics: {},
      tableTimer: null,
      metricsTimer: null,
      tabHeartbeatTimer: null,
    };
    let _tab = 'overview';
    let _demoTimer = null;
    function go(name) {
      const prev = _tab;
      if (prev === 'logs' && name !== 'logs' && typeof stopAnalysisLogRealtime === 'function') stopAnalysisLogRealtime();
      if (_cmdOpen) closeCommandPalette();
      $$('.tab').forEach((t, i) => { t.classList[TABS[i] === name ? 'add' : 'remove']('active'); });
      $$('.page').forEach(p => p.classList.remove('active'));
      const pg = $('page-' + name); if (pg) pg.classList.add('active');
      _tab = name;
      _activeTabHint = name;
      initCardExpansion();
      if (LOADERS[name]) _runTabLoader(name, LOADERS[name], 'switch', true);
      _tickTabRealtime(false);
    }
    function openStoryStep(tab) {
      go(tab);
      toast(t('story.open_tab', { tab: _tabLabel(tab) }), 2);
    }
    function startDemoTour() {
      const steps = [
        { tab: 'overview', key: 'demo.step_overview' },
        { tab: 'chat', key: 'demo.step_chat' },
        { tab: 'performance', key: 'demo.step_performance' },
        { tab: 'risk', key: 'demo.step_risk' },
        { tab: 'console', key: 'demo.step_console' },
        { tab: 'pitch', key: 'demo.step_pitch' },
      ];
      if (_demoTimer) {
        clearInterval(_demoTimer);
        _demoTimer = null;
      }
      let i = 0;
      const runStep = () => {
        if (i >= steps.length) {
          clearInterval(_demoTimer);
          _demoTimer = null;
          toast(t('demo.done'), 4);
          return;
        }
        const st = steps[i];
        go(st.tab);
        toast(`${i + 1}/${steps.length} · ${t(st.key)}`, 7);
        i += 1;
      };
      runStep();
      _demoTimer = setInterval(runStep, 9000);
    }
    const TAB_UX_GUIDE = {
      overview: {
        headline: { vi: 'Toàn cảnh giá trị chiến lược', en: 'Strategy Value Snapshot' },
        desc: { vi: 'Bắt đầu bằng KPI cốt lõi và đường equity để chốt giá trị trong 10 giây.', en: 'Start with core KPIs and the equity curve to establish value in 10 seconds.' },
        watch: { vi: 'Trọng tâm: Sharpe, CAGR, Max DD, Total Return.', en: 'Focus: Sharpe, CAGR, Max DD, Total Return.' },
        cta: { vi: 'Làm mới tổng quan', en: 'Refresh overview' },
      },
      chat: {
        headline: { vi: 'Tương tác với NEXUS Brain', en: 'Interact with NEXUS Brain' },
        desc: { vi: 'Hỏi trực tiếp chiến lược, rủi ro, và logic tín hiệu để tăng niềm tin.', en: 'Ask about strategy, risk, and signal logic to build trust quickly.' },
        watch: { vi: 'Trọng tâm: câu hỏi sắc nét + phản hồi có lập luận.', en: 'Focus: sharp prompts + reasoned responses.' },
        cta: { vi: 'Tập trung ô chat', en: 'Focus chat input' },
      },
      benchmark: {
        headline: { vi: 'So sánh cạnh tranh', en: 'Competitive Comparison' },
        desc: { vi: 'Đặt NEXUS cạnh benchmark để thể hiện vị thế rõ ràng.', en: 'Position NEXUS against benchmarks to show clear differentiation.' },
        watch: { vi: 'Trọng tâm: Sharpe vượt benchmark và độ ổn định.', en: 'Focus: benchmark outperformance and stability.' },
        cta: { vi: 'Cập nhật benchmark', en: 'Refresh benchmark' },
      },
      performance: {
        headline: { vi: 'Bằng chứng hiệu suất', en: 'Performance Evidence' },
        desc: { vi: 'Trình bày lịch sử run và walk-forward để chứng minh tính lặp lại.', en: 'Present run history and walk-forward to prove repeatability.' },
        watch: { vi: 'Trọng tâm: run history, walk-forward, phân phối lợi nhuận.', en: 'Focus: run history, walk-forward, return distribution.' },
        cta: { vi: 'Cập nhật hiệu suất', en: 'Refresh performance' },
      },
      risk: {
        headline: { vi: 'Rào chắn rủi ro', en: 'Risk Guardrails' },
        desc: { vi: 'Đảm bảo người xem thấy kiểm soát drawdown và chế độ thị trường.', en: 'Make drawdown control and regime awareness explicit.' },
        watch: { vi: 'Trọng tâm: VaR, CVaR, leverage, position detail.', en: 'Focus: VaR, CVaR, leverage, positions.' },
        cta: { vi: 'Cập nhật rủi ro', en: 'Refresh risk' },
      },
      research: {
        headline: { vi: 'Động cơ nghiên cứu', en: 'Research Engine' },
        desc: { vi: 'Thể hiện pipeline nghiên cứu và alert để chứng minh năng lực học.', en: 'Show research pipeline and alerts to prove learning capability.' },
        watch: { vi: 'Trọng tâm: debate history, cycle latest, alerts.', en: 'Focus: debate history, latest cycle, alerts.' },
        cta: { vi: 'Cập nhật nghiên cứu', en: 'Refresh research' },
      },
      tasks: {
        headline: { vi: 'Vận hành công việc AI', en: 'AI Task Operations' },
        desc: { vi: 'Quản trị backlog rõ ràng giúp demo tính thực thi ngoài backtest.', en: 'A clear backlog demonstrates execution beyond backtests.' },
        watch: { vi: 'Trọng tâm: ưu tiên, trạng thái, người phụ trách.', en: 'Focus: priority, status, assignee.' },
        cta: { vi: 'Tạo task nhanh', en: 'Create quick task' },
      },
      files: {
        headline: { vi: 'Kho bằng chứng dữ liệu', en: 'Artifact Evidence Vault' },
        desc: { vi: 'Cho người xem thấy dữ liệu và báo cáo thật, không phải slide.', en: 'Show real artifacts and reports, not just slides.' },
        watch: { vi: 'Trọng tâm: run outputs, report, file preview.', en: 'Focus: run outputs, reports, file previews.' },
        cta: { vi: 'Tìm file nhanh', en: 'Find files quickly' },
      },
      market: {
        headline: { vi: 'Tín hiệu thị trường realtime', en: 'Realtime Market Signals' },
        desc: { vi: 'Funding, giá và OI giúp chứng minh cảm biến thị trường đang sống.', en: 'Funding, price, and OI prove live market sensing.' },
        watch: { vi: 'Trọng tâm: funding signal, mark price, 24h change.', en: 'Focus: funding signal, mark price, 24h change.' },
        cta: { vi: 'Cập nhật thị trường', en: 'Refresh market' },
      },
      pitch: {
        headline: { vi: 'Câu chuyện thương mại', en: 'Commercial Narrative' },
        desc: { vi: 'Chốt thông điệp nhà đầu tư: khoa học, lợi thế, khả năng scale.', en: 'Close with investor messaging: rigor, edge, and scalability.' },
        watch: { vi: 'Trọng tâm: champion, verification, benchmark compare.', en: 'Focus: champion, verification, benchmark comparison.' },
        cta: { vi: 'Cập nhật pitch', en: 'Refresh pitch' },
      },
      logs: {
        headline: { vi: 'Nhật ký quyết định', en: 'Decision Journal' },
        desc: { vi: 'Cho thấy hệ thống suy nghĩ và ra quyết định có truy vết.', en: 'Show traceable reasoning and decision history.' },
        watch: { vi: 'Trọng tâm: entries mới, nguồn, severity, audit.', en: 'Focus: latest entries, source, severity, audit.' },
        cta: { vi: 'Cập nhật nhật ký', en: 'Refresh journal' },
      },
      console: {
        headline: { vi: 'Bảng điều khiển vận hành realtime', en: 'Realtime Operations Console' },
        desc: { vi: 'Tab chứng minh hệ thống đang chạy live: process, tài nguyên, logs.', en: 'The tab that proves live operations: process, resources, logs.' },
        watch: { vi: 'Trọng tâm: tiến trình running, CPU/RAM, log stream.', en: 'Focus: running processes, CPU/RAM, log stream.' },
        cta: { vi: 'Đồng bộ console', en: 'Sync console' },
      },
    };
    let _cmdOpen = false;
    let _cmdActions = [];
    let _cmdSelected = 0;
    function _langText(v, fallback = '') {
      if (v == null) return fallback;
      if (typeof v === 'string') return v;
      if (typeof v === 'object') return v[_lang] ?? v.vi ?? v.en ?? fallback;
      return fallback;
    }
    function renderTabFocusHero() {
      TABS.forEach(tab => {
        const page = $('page-' + tab);
        if (!page) return;
        let hero = page.querySelector(':scope > .tab-focus-hero');
        if (!hero) {
          hero = document.createElement('div');
          hero.className = 'tab-focus-hero';
          page.insertBefore(hero, page.firstChild);
        }
        const meta = TAB_UX_GUIDE[tab] || {};
        hero.innerHTML = `
      <div class="tab-focus-left">
        <div class="tab-focus-kicker">${esc(_tabLabel(tab))}</div>
        <div class="tab-focus-title">${esc(_langText(meta.headline, _tabLabel(tab)))}</div>
        <div class="tab-focus-sub">${esc(_langText(meta.desc, ''))}</div>
        <div class="tab-focus-watch">${esc(_langText(meta.watch, ''))}</div>
      </div>
      <div class="tab-focus-right">
        <div class="tab-focus-meta">
          <span class="bdg bg-gray" id="focus-state-${tab}">${esc(t('focus.waiting'))}</span>
          <span class="text-sm text-muted" id="focus-updated-${tab}">${esc(t('focus.never'))}</span>
        </div>
        <button class="btn btn-p btn-sm" onclick="runTabPrimaryAction('${tab}')">${esc(_langText(meta.cta, t('btn.refresh')))}</button>
        <button class="btn btn-s btn-sm" onclick="openCommandPalette('${tab}')">${esc(t('cmd.open'))}</button>
      </div>`;
      });
      updateTabFocusStatus();
    }
    function updateTabFocusStatus() {
      TABS.forEach(tab => {
        const st = _tabState(tab);
        const state = _tabIndicatorState(tab);
        const stateEl = $('focus-state-' + tab);
        const upEl = $('focus-updated-' + tab);
        if (stateEl) {
          let cls = 'bg-gray';
          let text = t('focus.waiting');
          if (state === 'loading') { cls = 'bg-b'; text = t('focus.loading'); }
          else if (state === 'live') { cls = 'bg-g'; text = t('focus.live'); }
          else if (state === 'stale') { cls = 'bg-y'; text = t('focus.stale'); }
          if (!_isTabAutoEnabled(tab)) { cls = 'bg-gray'; text = t('status.auto_paused'); }
          stateEl.className = 'bdg ' + cls;
          stateEl.textContent = text;
        }
        if (upEl) {
          if (st.lastSuccessAt) {
            const age = Math.max(0, Math.round((Date.now() - st.lastSuccessAt) / 1000));
            upEl.textContent = t('focus.updated', { s: age });
          } else {
            upEl.textContent = t('focus.never');
          }
        }
      });
    }
    function focusPrimaryInput(tab) {
      const tname = tab || _tab;
      const map = {
        chat: ['chat-in'],
        tasks: ['t-title', '#tasks-table .table-search'],
        files: ['file-search'],
        logs: ['log-chat-input', 'log-search'],
        research: ['mem-q'],
        market: ['#mkt-funding .table-search', '#mkt-price .table-search'],
        performance: ['#runs-table .table-search', '#wf-body .table-search'],
        benchmark: ['#bm-table .table-search'],
        risk: ['#risk-detail .table-search'],
        console: ['backtest-cfg'],
      };
      const sels = map[tname] || [];
      for (const sel of sels) {
        const el = sel.startsWith('#') || sel.includes(' ') ? document.querySelector(sel) : $(sel);
        if (el && typeof el.focus === 'function') {
          el.focus();
          if (el.select && typeof el.select === 'function') el.select();
          return true;
        }
      }
      return false;
    }
    function openValidationView() {
      go('performance');
      setTimeout(() => {
        const wf = $('wf-body');
        if (wf && typeof wf.scrollIntoView === 'function') wf.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 120);
    }
    function runTabPrimaryAction(tab) {
      const target = tab || _tab;
      if (_tab !== target) go(target);
      switch (target) {
        case 'overview': refresh(); break;
        case 'chat': focusPrimaryInput('chat'); break;
        case 'benchmark': loadBM(); break;
        case 'performance': loadPerf(); break;
        case 'risk': loadRisk(); break;
        case 'research': loadResearch(); break;
        case 'tasks':
          loadTasks();
          setTimeout(() => focusPrimaryInput('tasks'), 50);
          break;
        case 'files':
          loadFiles();
          setTimeout(() => focusPrimaryInput('files'), 50);
          break;
        case 'market': loadMarket(); break;
        case 'pitch': loadPitch(); break;
        case 'logs':
          loadLogs({ replace: true, skipStats: false });
          startAnalysisLogRealtime(true);
          break;
        case 'console':
          refreshConsole({ includeLogs: true, forceLogRefresh: true, forceStream: true });
          break;
        default:
          refresh();
          break;
      }
    }
    function _buildCommandActions() {
      const acts = TABS.map(tab => ({
        id: `tab:${tab}`,
        label: _tabLabel(tab),
        type: t('cmd.tab'),
        run: () => go(tab),
      }));
      acts.push(
        { id: 'action:refresh', label: t('cmd.refresh_current'), type: t('cmd.action'), run: () => refresh() },
        { id: 'action:primary', label: t('cmd.run_primary'), type: t('cmd.action'), run: () => runTabPrimaryAction(_tab) },
        { id: 'action:focus', label: t('cmd.focus_input'), type: t('cmd.action'), run: () => focusPrimaryInput(_tab) },
        { id: 'action:demo', label: t('cmd.demo_tour'), type: t('cmd.action'), run: () => startDemoTour() },
        { id: 'action:theme', label: t('cmd.toggle_theme'), type: t('cmd.action'), run: () => toggleTheme() },
        { id: 'action:lang', label: t('cmd.toggle_lang'), type: t('cmd.action'), run: () => setLanguage(_lang === 'vi' ? 'en' : 'vi') },
      );
      return acts;
    }
    function openCommandPalette(seedTab) {
      const panel = $('cmdk');
      const back = $('cmdk-backdrop');
      const inp = $('cmdk-input');
      if (!panel || !back || !inp) return;
      _cmdOpen = true;
      back.style.display = 'block';
      panel.style.display = 'block';
      document.body.style.overflow = 'hidden';
      inp.value = seedTab ? _tabLabel(seedTab) : '';
      _cmdSelected = 0;
      renderCommandPalette();
      setTimeout(() => inp.focus(), 0);
    }
    function closeCommandPalette() {
      const panel = $('cmdk');
      const back = $('cmdk-backdrop');
      if (back) back.style.display = 'none';
      if (panel) panel.style.display = 'none';
      _cmdOpen = false;
      document.body.style.overflow = '';
    }
    function executeCommandPalette(i) {
      const act = _cmdActions[i];
      if (!act) return;
      closeCommandPalette();
      act.run();
    }
    function renderCommandPalette() {
      const list = $('cmdk-list');
      const inp = $('cmdk-input');
      if (!list || !inp) return;
      const q = (inp.value || '').trim().toLowerCase();
      const actions = _buildCommandActions();
      _cmdActions = actions.filter(a => {
        if (!q) return true;
        return (a.label + ' ' + a.type).toLowerCase().includes(q);
      });
      if (!_cmdActions.length) {
        list.innerHTML = `<div class="cmdk-empty">${esc(t('cmd.no_result'))}</div>`;
        return;
      }
      if (_cmdSelected >= _cmdActions.length) _cmdSelected = 0;
      list.innerHTML = _cmdActions.map((a, i) => `<button class="cmdk-item ${i === _cmdSelected ? 'active' : ''}" onclick="executeCommandPalette(${i})"><span>${esc(a.label)}</span><span class="cmdk-tag">${esc(a.type)}</span></button>`).join('');
    }
    function onCommandPaletteKey(e) {
      if (e.key === 'Escape') { e.preventDefault(); closeCommandPalette(); return; }
      if (e.key === 'ArrowDown') { e.preventDefault(); if (_cmdActions.length) { _cmdSelected = Math.min(_cmdActions.length - 1, _cmdSelected + 1); renderCommandPalette(); } return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); if (_cmdActions.length) { _cmdSelected = Math.max(0, _cmdSelected - 1); renderCommandPalette(); } return; }
      if (e.key === 'Enter') { e.preventDefault(); executeCommandPalette(_cmdSelected); return; }
    }
    function isInputTarget(el) {
      if (!el) return false;
      const tag = (el.tagName || '').toLowerCase();
      return tag === 'input' || tag === 'textarea' || tag === 'select' || el.isContentEditable;
    }
    function setLiveStatus(state, label) {
      const live = $('hdr-live');
      const liveLabel = $('live-label');
      if (live) {
        live.classList.remove('connected', 'connecting', 'stale', 'disconnected');
        live.classList.add(state || 'connecting');
      }
      if (liveLabel) liveLabel.textContent = label || t('status.connecting');
      const dot = $('chat-sse-dot');
      if (dot) dot.className = 'sse-dot ' + (state === 'connected' ? '' : 'yellow');
      if (typeof updateMvpSummary === 'function') updateMvpSummary();
    }
    function setHeaderChip(id, text, cls = '') {
      const el = $(id); if (!el) return;
      el.textContent = text;
      el.className = 'hdr-chip ' + cls;
    }
    function applyTheme(theme) {
      const t = theme === 'dark' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem(THEME_KEY, t);
      const btn = $('theme-toggle');
      if (btn) btn.textContent = t === 'dark' ? '☀️' : '🌙';
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    }
    function initTheme() {
      // Force default to light based on user explicit request
      applyTheme('light');
    }
    function animateKpiText(id, next, className) {
      const el = $(id); if (!el) return;
      if (el.textContent === next && (!className || el.className === className)) return;
      el.textContent = next;
      if (className) el.className = className;
      el.classList.remove('bump');
      void el.offsetWidth;
      el.classList.add('bump');
    }
    function setSkeleton(id, rows = 5) {
      html(id, '<div>' + Array.from({ length: rows }).map(() => '<div class="skel skel-row"></div>').join('') + '</div>');
    }
    function attachSectionStamps() {
      $$('.card .ctitle').forEach((ct) => {
        if (ct.querySelector('.section-stamp')) return;
        const st = document.createElement('span');
        st.className = 'section-stamp';
        st.textContent = t('status.updated', { time: '—' });
        ct.appendChild(st);
      });
    }
    function touchSection(id) {
      const el = typeof id === 'string' ? $(id) : id;
      if (!el) return;
      const card = el.closest('.card');
      if (!card) return;
      const stamp = card.querySelector('.section-stamp');
      if (stamp) stamp.textContent = t('status.updated', { time: now() });
    }
    function initCardExpansion() {
      $$('.card').forEach(card => {
        if (card.dataset.expandReady === '1') return;
        const title = card.querySelector('.ctitle');
        if (!title) return;
        card.dataset.expandReady = '1';
        card.classList.add('expandable');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'card-expand-btn';
        btn.title = 'Expand card';
        btn.textContent = '⤢';
        btn.onclick = (e) => {
          e.stopPropagation();
          const willExpand = !card.classList.contains('expanded');
          $$('.card.expanded').forEach(c => {
            c.classList.remove('expanded');
            const b = c.querySelector('.card-expand-btn');
            if (b) b.textContent = '⤢';
          });
          if (willExpand) {
            card.classList.add('expanded');
            btn.textContent = '↧';
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        };
        title.appendChild(btn);
      });
    }
    function parseSortValue(s) {
      const raw = (s || '').replace(/,/g, '').trim();
      const n = parseFloat(raw.replace(/[^\d.+-]/g, ''));
      if (!Number.isNaN(n) && raw.match(/[-\d.]/)) return n;
      return raw.toLowerCase();
    }
    function applyTableState(container, table, key) {
      const state = TABLE_STATE[key] || { q: '', col: -1, dir: 'asc' };
      TABLE_STATE[key] = state;
      const rows = Array.from(table.tBodies[0]?.rows || []);
      let view = rows.filter(r => !state.q || r.textContent.toLowerCase().includes(state.q));
      if (state.col >= 0) {
        view = view.sort((a, b) => {
          const av = parseSortValue(a.cells[state.col]?.innerText || '');
          const bv = parseSortValue(b.cells[state.col]?.innerText || '');
          if (av === bv) return 0;
          return (av > bv ? 1 : -1) * (state.dir === 'asc' ? 1 : -1);
        });
      }
      view.forEach(r => table.tBodies[0].appendChild(r));
      rows.forEach(r => { r.style.display = view.includes(r) ? '' : 'none'; });
      const meta = container.querySelector('.table-meta');
      if (meta) meta.textContent = `${view.length}/${rows.length} rows`;
    }
    function makeTableInteractive(containerId, key) {
      const container = $(containerId); if (!container) return;
      const table = container.querySelector('table'); if (!table || !table.tBodies.length) return;
      let tools = container.querySelector(':scope > .table-tools');
      if (!tools) {
        tools = document.createElement('div');
        tools.className = 'table-tools';
        tools.innerHTML = `<input class="table-search" placeholder="${esc(t('table.search_placeholder'))}" /><span class="table-meta"></span>`;
        container.insertBefore(tools, table);
        const inp = tools.querySelector('.table-search');
        inp.addEventListener('input', () => {
          TABLE_STATE[key] = TABLE_STATE[key] || { q: '', col: -1, dir: 'asc' };
          TABLE_STATE[key].q = (inp.value || '').toLowerCase().trim();
          applyTableState(container, table, key);
        });
      }
      const state = TABLE_STATE[key] || { q: '', col: -1, dir: 'asc' };
      TABLE_STATE[key] = state;
      const inp = tools.querySelector('.table-search');
      if (inp) inp.setAttribute('placeholder', t('table.search_placeholder'));
      if (inp && inp.value !== state.q) inp.value = state.q || '';
      Array.from(table.tHead?.rows[0]?.cells || []).forEach((th, idx) => {
        th.classList.add('sortable');
        th.classList.remove('sort-asc', 'sort-desc');
        if (state.col === idx) th.classList.add(state.dir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.onclick = () => {
          const s = TABLE_STATE[key] || { q: '', col: -1, dir: 'asc' };
          if (s.col === idx) s.dir = s.dir === 'asc' ? 'desc' : 'asc';
          else { s.col = idx; s.dir = 'asc'; }
          TABLE_STATE[key] = s;
          makeTableInteractive(containerId, key);
        };
      });
      applyTableState(container, table, key);
    }
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        const kLower = (e.key || '').toLowerCase();
        if ((kLower === 'k') && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          if (_cmdOpen) closeCommandPalette();
          else openCommandPalette();
          return;
        }
        if (e.key === 'Escape' && _cmdOpen) {
          e.preventDefault();
          closeCommandPalette();
          return;
        }
        if (isInputTarget(e.target)) return;
        if (e.key === '/' && !e.altKey && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          if (!focusPrimaryInput(_tab)) openCommandPalette();
          return;
        }
        if (e.altKey || e.ctrlKey || e.metaKey) return;
        if (/^[1-9]$/.test(e.key)) {
          const idx = +e.key - 1;
          if (TABS[idx]) { e.preventDefault(); go(TABS[idx]); }
          return;
        }
        const k = e.key.toLowerCase();
        if (k === 'r') { e.preventDefault(); refresh(); }
        if (k === 'd') { e.preventDefault(); toggleTheme(); }
        if (k === 'x') { e.preventDefault(); runTabPrimaryAction(_tab); }
      });
    }

    // ─── Charts ───
    let _eq = null, _ret = null;

    // ─── KPI ───
    let _sharpe = null;
    function updateStoryStrip() {
      const m = APP_STATE.latestMetrics || {};
      const sh = m.sharpe;
      const cagr = m.cagr;
      const mdd = m.mdd;
      const wr = m.win_rate;
      const tot = m.total_return;
      const verdict = m.verdict_label || '';
      if ($('story-signal-value')) set('story-signal-value', `${t('kpi.sharpe')} ${n2(sh)} · ${t('kpi.cagr')} ${pct(cagr)}`);
      if ($('story-signal-proof')) set('story-signal-proof', `${t('kpi.mdd')} ${pct(mdd)} · ${t('kpi.win_rate')} ${pct(wr)}`);
      if ($('story-signal-live')) {
        const live = APP_STATE.liveConnected ? t('status.live') : t('status.connecting_short');
        const run = APP_STATE.activeRun ? ` · ${APP_STATE.activeRun}` : '';
        const pc = (m.running_processes != null && m.running_processes !== '') ? ` · ${t('story.proc', { n: m.running_processes })}` : '';
        set('story-signal-live', `${live}${run}${pc}`);
      }
      if ($('story-signal-roi')) {
        const v = verdict ? ` · ${verdict}` : '';
        set('story-signal-roi', `${t('kpi.total_return')} ${pct(tot)}${v}`);
      }
    }
    function updateMvpSummary(partial) {
      if (partial && typeof partial === 'object') {
        APP_STATE.latestMetrics = Object.assign({}, APP_STATE.latestMetrics || {}, partial);
      }
      const m = APP_STATE.latestMetrics || {};
      const sh = m.sharpe;
      const cagr = m.cagr;
      const mdd = m.mdd;
      const wr = m.win_rate;
      if ($('mvp-value')) set('mvp-value', `${t('kpi.sharpe')} ${n2(sh)} · ${t('kpi.cagr')} ${pct(cagr)}`);
      if ($('mvp-proof')) set('mvp-proof', `${t('kpi.mdd')} ${pct(mdd)} · ${t('kpi.win_rate')} ${pct(wr)}`);
      if ($('mvp-realtime')) {
        const live = APP_STATE.liveConnected ? t('status.live') : t('status.connecting_short');
        const run = APP_STATE.activeRun ? ` · ${APP_STATE.activeRun}` : '';
        set('mvp-realtime', `${live}${run}`);
      }
      updateStoryStrip();
    }
    function loadKPI() {
      jx('/api/metrics').then(d => {
        // metrics.json has nested structure: d.summary.sharpe, d.meta.*, d.verdict.*
        const m = d.summary || d.metrics || d || {};
        const meta = d.meta || {};
        _sharpe = +(m.sharpe_ratio || m.sharpe || 0);
        animateKpiText('k-sharpe', n2(_sharpe), 'kpi-v ' + (_sharpe >= 1.5 ? 'pos' : _sharpe >= 0.6 ? 'neu' : 'neg'));
        const ca = +(m.cagr || m.annualized_return || 0);
        animateKpiText('k-cagr', pct(ca), 'kpi-v ' + (ca >= 0 ? 'pos' : 'neg'));
        const md = +(m.max_drawdown || 0);
        animateKpiText('k-mdd', pct(md), 'kpi-v neg');
        const tot = +(m.total_return || 0);
        animateKpiText('k-tot', pct(tot), 'kpi-v ' + (tot >= 0 ? 'pos' : 'neg'));
        set('k-wr', pct(m.win_rate));
        set('k-strat', meta.strategy_name || m.strategy_name || m.run_name || d.run_name || '—');
        set('kpi-updated', t('status.updated', { time: now() }));
        // Header badge
        // verdict: check d.verdict.pass (nested), or derive from Sharpe
        const vObj = d.verdict || {};
        const vPass = vObj.pass;
        const v = m.strategy_verdict || (vPass === true ? 'PASS' : vPass === false ? 'FAIL' : (_sharpe >= 1.5 ? 'GOOD' : _sharpe >= 0.6 ? 'OK' : 'WEAK'));
        const vLabel = localizeVerdict(v);
        const b = $('hdr-badge'); b.textContent = vLabel;
        b.className = 'bdg ' + (v === 'GOOD' || v === 'PASS' ? 'bg-g' : v === 'OK' || v === 'WARN' ? 'bg-y' : 'bg-r');
        setHeaderChip('hc-sharpe', `${t('chip.sharpe')} ${n2(_sharpe)}`, _sharpe >= 1.5 ? 'pos' : _sharpe >= 0.6 ? 'neu' : 'neg');
        setHeaderChip('hc-pnl', `${t('chip.pnl')} ${pct(tot)}`, tot >= 0 ? 'pos' : 'neg');
        setHeaderChip('hc-status', `${t('chip.status')} ${vLabel}`, v === 'GOOD' || v === 'PASS' ? 'pos' : v === 'OK' || v === 'WARN' ? 'neu' : 'neg');
        updateMvpSummary({
          sharpe: _sharpe, cagr: ca, mdd: md, win_rate: m.win_rate, total_return: tot,
          verdict_label: vLabel,
        });
        // Update targets
        updateTargets(_sharpe);
        touchSection('eq-chart-wrap');
      }).catch(() => { });
    }

    // ─── Equity chart ───
    function chartFill(canvas, start, end) {
      const c = canvas.getContext('2d');
      const g = c.createLinearGradient(0, 0, 0, canvas.height || 240);
      g.addColorStop(0, start);
      g.addColorStop(1, end);
      return g;
    }
    function loadEq() {
      jx('/api/equity').then(d => {
        const eq = d.equity_curve || d.equity || []; if (!eq.length) return;
        const vals = eq.map(e => typeof e === 'object' ? (e.value || e.equity || e[1] || 1) : +e);
        const ctx = $('eq-chart'); if (!ctx) return;
        const fill = chartFill(ctx, 'rgba(37,99,235,.24)', 'rgba(37,99,235,0)');
        if (_eq) { _eq.destroy(); }
        _eq = new Chart(ctx, {
          type: 'line',
          data: { labels: vals.map((_, i) => i), datasets: [{ label: 'Equity', data: vals, borderColor: '#2563EB', backgroundColor: fill, fill: true, pointRadius: 0, tension: .34, borderWidth: 2.2 }] },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 700, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
            scales: {
              x: { title: { display: true, text: 'Bars' }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
              y: { grid: { color: 'rgba(148,163,184,.18)' }, title: { display: true, text: 'Portfolio Value' }, ticks: { font: { size: 10 } } }
            }
          }
        });
        touchSection('eq-chart-wrap');
      }).catch(() => { });
    }

    // ─── Learning Progress Chart ───
    let _prog = null;
    function loadProgress() {
      jx('/api/progress').then(d => {
        const days = d.daily || [];
        if (!days.length) { html('progress-stats', 'No runs yet'); return; }
        const labels = days.map(e => e.date);
        const champ = days.map(e => e.champion_sharpe || null);
        const daily = days.map(e => e.max_sharpe || null);
        const ctx = $('progress-chart'); if (!ctx) return;
        const fill = chartFill(ctx, 'rgba(37,99,235,.2)', 'rgba(37,99,235,0)');
        if (_prog) { _prog.destroy(); }
        _prog = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Champion Sharpe', data: champ, borderColor: '#2563EB', backgroundColor: fill, fill: true, pointRadius: 2, tension: .32, borderWidth: 2 },
              { label: 'Daily Best', data: daily, borderColor: '#10B981', backgroundColor: 'transparent', pointRadius: 2, tension: .3, borderWidth: 1.5, borderDash: [4, 2] },
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 650, easing: 'easeOutQuart' },
            plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } },
            scales: {
              x: { ticks: { font: { size: 9 }, maxTicksLimit: 10 }, title: { display: true, text: 'Date' } },
              y: { grid: { color: 'rgba(148,163,184,.18)' }, title: { display: true, text: 'Sharpe' } }
            }
          }
        });
        const best = d.best_ever_sharpe;
        html('progress-stats', `Total runs: <b>${d.total_runs}</b> · Best ever Sharpe: <b class="${best >= 1.5 ? 'pos' : best >= 0.6 ? 'neu' : 'neg'}">${(best || 0).toFixed(3)}</b> · Days tracked: <b>${days.length}</b>`);
        touchSection('progress-stats');
      }).catch(() => { });
    }

    // ─── Overview ───
    function loadOvRun() {
      jx('/api/runs').then(d => {
        const r = (d.runs || d || [])[0];
        if (!r) { html('ov-run', '<div class="empty">No runs</div>'); return; }
        APP_STATE.lastRunName = r.run_name || r.name || APP_STATE.lastRunName;
        const m = r.metrics || {};
        html('ov-run', `
      <div class="srow"><span class="lbl">Run</span><span class="val text-sm">${esc(r.run_name || r.name || '—').slice(0, 30)}</span></div>
      <div class="srow"><span class="lbl">Sharpe</span><span class="val ${clr(m.sharpe || m.sharpe_ratio)}">${n2(m.sharpe || m.sharpe_ratio)}</span></div>
      <div class="srow"><span class="lbl">CAGR</span><span class="val ${clr(m.cagr)}">${pct(m.cagr)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(m.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Calmar</span><span class="val">${n2(m.calmar)}</span></div>
    `);
        touchSection('ov-run');
      }).catch(() => { html('ov-run', '<div class="empty">No data</div>'); });
    }
    function loadOvBrain() {
      jx('/api/brain/identity').then(d => {
        const id = d.identity || d || {};
        html('ov-brain', `
      <div class="srow"><span class="lbl">Name</span><span class="val">${esc(id.name || 'NEXUS')}</span></div>
      <div class="srow"><span class="lbl">Role</span><span class="val text-sm">${esc(id.role || 'Autonomous Quant')}</span></div>
      <div class="srow"><span class="lbl">Mood</span><span class="val">${esc(id.mood || '—')}</span></div>
      <div class="srow"><span class="lbl">Version</span><span class="val">${esc(id.version || '—')}</span></div>
    `);
        touchSection('ov-brain');
      }).catch(() => { html('ov-brain', '<div class="empty">Brain offline</div>'); });
    }
    function loadOvLedger() {
      jx('/api/ledger').then(d => {
        const evs = d.events || d.ledger || d || [];
        if (!evs.length) { html('ov-ledger', '<div class="empty">No events</div>'); return; }
        const rows = evs.slice(0, 20).map(e => {
          const kind = (e.level || e.kind || 'INFO').toUpperCase();
          const cls = kind === 'ERROR' ? 'bg-r' : kind === 'WARN' ? 'bg-y' : 'bg-b';
          const message = e.event || e.message || e.msg || `${(e.kind || 'event')} ${e.run_name ? `· ${e.run_name}` : ''}`;
          const source = e.source || e.run_name || e.run_id || '—';
          const verdict = e.verdict === true ? ' <span class="bdg bg-g">PASS</span>' : e.verdict === false ? ' <span class="bdg bg-r">FAIL</span>' : '';
          return `<tr>
        <td class="text-sm text-muted">${esc((e.ts || e.timestamp || '').slice(0, 19).replace('T', ' '))}</td>
        <td><span class="bdg ${cls}">${esc(kind)}</span></td>
        <td>${esc(message)}${verdict}</td>
        <td class="text-sm text-muted">${esc(source)}</td>
      </tr>`;
        }).join('');
        html('ov-ledger', `<table><thead><tr><th>Time</th><th>Level</th><th>Event</th><th>Source</th></tr></thead><tbody>${rows}</tbody></table>`);
        makeTableInteractive('ov-ledger', 'ledger');
        touchSection('ov-ledger');
      }).catch(() => { html('ov-ledger', '<div class="empty">No ledger</div>'); });
    }
    function loadOv() {
      loadEq(); loadKPI(); loadProgress();
      loadOvRun();
      loadOvBrain();
      loadOvLedger();
    }

    // ─── Chat ───
    var CHAT_CTX = {};
    var chatSSE = null;
    var chatSseEvents = [];

    function mdRender(text) {
      // Code blocks
      text = text.replace(/```([\s\S]*?)```/g, function (_, c) { return '<pre><code>' + c.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>'; });
      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Headers
      text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      // Bold/italic
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Tables
      text = text.replace(/\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)*)/g, function (_, hdr, body) {
        var ths = hdr.split('|').filter(function (s) { return s.trim(); }).map(function (s) { return '<th>' + s.trim() + '</th>'; }).join('');
        var rows = body.trim().split('\n').filter(Boolean).map(function (r) {
          var tds = r.split('|').filter(function (s) { return s.trim(); }).map(function (s) { return '<td>' + s.trim() + '</td>'; }).join('');
          return '<tr>' + tds + '</tr>';
        }).join('');
        return '<table><thead><tr>' + ths + '</tr></thead><tbody>' + rows + '</tbody></table>';
      });
      // Unordered lists
      text = text.replace(/((?:^[ \t]*[-*] .+\n?)+)/gm, function (_, block) {
        var items = block.trim().split('\n').map(function (l) { return '<li>' + l.replace(/^[ \t]*[-*] /, '').trim() + '</li>'; }).join('');
        return '<ul>' + items + '</ul>';
      });
      // Ordered lists
      text = text.replace(/((?:^[ \t]*\d+\. .+\n?)+)/gm, function (_, block) {
        var items = block.trim().split('\n').map(function (l) { return '<li>' + l.replace(/^[ \t]*\d+\. /, '').trim() + '</li>'; }).join('');
        return '<ol>' + items + '</ol>';
      });
      // Line breaks / paragraphs
      text = text.split('\n\n').map(function (p) {
        p = p.trim();
        if (!p) return '';
        if (/^<(h[1-3]|ul|ol|pre|table)/.test(p)) return p;
        return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
      }).filter(Boolean).join('');
      return text;
    }

    function autoGrowTA(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 150) + 'px';
    }

    function chatSaveSession() {
      try {
        var msgs = [];
        document.querySelectorAll('#chat-msgs .cmsg').forEach(function (el) {
          var role = el.classList.contains('u') ? 'u' : 'a';
          var bub = el.querySelector('.cbubble');
          if (bub) msgs.push({ role: role, html: bub.innerHTML });
        });
        var data = JSON.stringify(msgs.slice(-50));
        sessionStorage.setItem('nexus_chat', data);
        localStorage.setItem('nexus_chat_persist', data);
      } catch (e) { }
    }

    function chatRestoreSession() {
      try {
        var raw = sessionStorage.getItem('nexus_chat') || localStorage.getItem('nexus_chat_persist');
        if (!raw) return;
        var msgs = JSON.parse(raw);
        if (!msgs || !msgs.length) return;
        var container = $('chat-msgs');
        container.innerHTML = '';
        msgs.forEach(function (m) {
          var d = document.createElement('div');
          d.className = 'cmsg ' + m.role;
          d.innerHTML = '<div class="cbubble">' + m.html + '</div><div class="cmsg-footer"><span class="cts">restored</span>' + (m.role === 'a' ? '<button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>' : '') + '</div>';
          container.appendChild(d);
        });
        container.lastChild && container.lastChild.scrollIntoView({ behavior: 'smooth' });
      } catch (e) { }
    }

    function initChatSSE() {
      var dot = $('chat-sse-dot');
      if (dot) { dot.className = 'sse-dot ' + (APP_STATE.liveConnected ? '' : 'yellow'); }
      renderSSEFeed();
    }

    function renderSSEFeed() {
      var feed = $('sse-feed'); if (!feed) return;
      if (!chatSseEvents.length) { feed.innerHTML = '<div class="text-sm text-muted">No events yet</div>'; return; }
      feed.innerHTML = chatSseEvents.map(function (ev) {
        var cls = 'sse-item';
        var lvl = (ev.level || ev.type || ev.kind || '').toUpperCase();
        if (lvl === 'ERROR') cls += ' err';
        else if (lvl === 'WARN' || lvl === 'WARNING') cls += ' warn';
        var msg = ev.event || ev.message || ev.msg || ev.kind || JSON.stringify(ev);
        var ts = (ev.ts || ev.timestamp || '').slice(11, 19);
        return '<div class="' + cls + '" title="' + msg + '">' + (ts ? '<span style="color:var(--fg-muted);margin-right:4px">' + ts + '</span>' : '') + esc(msg).slice(0, 60) + '</div>';
      }).join('');
      touchSection('bp-feed');
    }

    function loadChatMetrics() {
      jx('/api/metrics').then(function (m) {
        var s = m.summary || m.metrics && m.metrics.summary || {};
        var sh = s.sharpe != null ? s.sharpe : (m.sharpe != null ? m.sharpe : null);
        var cagr = s.cagr != null ? s.cagr : (m.cagr != null ? m.cagr : null);
        var mdd = s.max_drawdown != null ? s.max_drawdown : (s.mdd != null ? s.mdd : null);
        if ($('lm-sharpe-is')) $('lm-sharpe-is').textContent = sh != null ? sh.toFixed(2) : '—';
        // Try OOS sharpe from nested or oos key
        var oosS = m.oos_sharpe != null ? m.oos_sharpe : (m.oos && m.oos.sharpe != null ? m.oos.sharpe : null);
        if ($('lm-sharpe-oos')) $('lm-sharpe-oos').textContent = oosS != null ? oosS.toFixed(2) : '1.07';
        if ($('lm-cagr')) $('lm-cagr').textContent = cagr != null ? pct(cagr, 1) : '—';
        if ($('lm-mdd')) $('lm-mdd').textContent = mdd != null ? pct(mdd, 1) : '—';
        if ($('lm-updated')) $('lm-updated').textContent = t('status.updated', { time: now() });
        // Store in context
        CHAT_CTX.sharpe_is = sh; CHAT_CTX.sharpe_oos = oosS || 1.07; CHAT_CTX.cagr = cagr; CHAT_CTX.mdd = mdd;
        touchSection('bp-metrics');
      }).catch(function () { });
      jx('/api/alerts').then(function (d) {
        var count = (d.alerts || d || []).length;
        if ($('lm-alerts')) $('lm-alerts').textContent = count + ' alert' + (count !== 1 ? 's' : '');
        CHAT_CTX.alerts = count;
      }).catch(function () { });
    }

    function loadChat() {
      chatRestoreSession();
      initChatSSE();
      loadChatMetrics();
      jx('/api/brain/identity').then(function (d) {
        var id = d.identity || {};
        html('bp-identity', '<h4>Identity</h4><div class="srow"><span class="lbl">Name</span><span class="val">' + esc(id.name || 'NEXUS') + '</span></div><div class="srow"><span class="lbl">Role</span><span class="val text-sm">' + esc(id.role || 'Autonomous Quant AI') + '</span></div><div class="srow"><span class="lbl">Mission</span><span class="val text-sm">' + esc((id.mission || 'Research & Trade').slice(0, 50)) + '</span></div>');
      }).catch(function () { });
      jx('/api/brain/goals').then(function (d) {
        var gs = d.goals || [];
        if (!gs.length) { html('bp-goals', '<h4>Goals</h4><div class="text-sm text-muted">No goals set</div>'); return; }
        var items = gs.slice(0, 4).map(function (g) { var t = typeof g === 'string' ? g : (g.goal || g.text || ''); return '<div style="padding:3px 0;border-bottom:1px solid var(--border);font-size:12px">' + esc(t.slice(0, 70)) + '</div>'; }).join('');
        html('bp-goals', '<h4>Goals</h4>' + items);
      }).catch(function () { });
      jx('/api/brain/notifications').then(function (d) {
        var ns = d.notifications || []; var last = ns.slice(-1)[0];
        var mood = last && last.mood || d.mood || '🤔';
        html('bp-mood', '<h4>Mood</h4><div style="font-size:24px;margin:6px 0">' + mood + '</div><div class="text-sm text-muted">' + esc(last && last.message || 'Operational') + '</div>');
        CHAT_CTX.mood = mood;
      }).catch(function () { });
    }

    function onChatKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) { e.preventDefault(); sendMsg(); }
    }

    function chip(t) { $('chat-in').value = t; autoGrowTA($('chat-in')); sendMsg(); }

    function addMsg(role, text) {
      var ts = now(); var d = document.createElement('div');
      d.className = 'cmsg ' + role;
      var bubbleContent = role === 'a' ? mdRender(text) : ('<p>' + esc(text).replace(/\n/g, '<br>') + '</p>');
      var copyBtn = role === 'a' ? '<button class="copy-btn" onclick="copyBubble(this)" title="Copy">&#128203;</button>' : '';
      var modelSpan = role === 'a' ? '<span class="cts" style="margin-left:4px;opacity:1;font-size:9px;color:var(--fg-light)">' + (document.getElementById('model-select')?.options[document.getElementById('model-select')?.selectedIndex]?.text || 'AI') + '</span>' : '';
      d.innerHTML = '<div class="cbubble">' + bubbleContent + '</div><div class="cmsg-footer"><span class="cts">' + ts + '</span>' + modelSpan + copyBtn + '</div>';
      $('chat-msgs').appendChild(d);
      d.scrollIntoView({ behavior: 'smooth' });
      chatSaveSession();
      return d;
    }

    function buildCtxPrefix() {
      var parts = [];
      parts.push('[NEXUS System Context — NOT shown to user]');
      if (CHAT_CTX.sharpe_is != null) parts.push('Champion IS 2024 Sharpe: ' + CHAT_CTX.sharpe_is.toFixed(2));
      parts.push('Honest OOS 2023 Sharpe: ' + (CHAT_CTX.sharpe_oos || '1.07'));
      if (CHAT_CTX.cagr != null) parts.push('CAGR: ' + CHAT_CTX.cagr.toFixed(1) + '%');
      if (CHAT_CTX.mdd != null) parts.push('MDD: ' + CHAT_CTX.mdd.toFixed(1) + '%');
      if (CHAT_CTX.alerts != null) parts.push('Active alerts: ' + CHAT_CTX.alerts);
      if (chatSseEvents.length) {
        parts.push('Last SSE events: ' + chatSseEvents.slice(0, 3).map(function (e) { return e.event || e.message || ''; }).filter(Boolean).join(' | '));
      }
      parts.push('[End context]');
      return parts.join('; ');
    }

    function _sendMsgNormal(txt, inp) {
      if (!txt) return;
      if (inp) { inp.value = ''; inp.style.height = '40px'; }
      var ty = document.createElement('div'); ty.className = 'cmsg a'; ty.id = 'typing';
      ty.innerHTML = '<div class="cbubble"><div class="spin"></div> Thinking...</div>';
      $('chat-msgs').appendChild(ty); ty.scrollIntoView({ behavior: 'smooth' });
      var ctxMsg = buildCtxPrefix() + ' USER: ' + txt;
      jx('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: ctxMsg, raw_user: txt, model: document.getElementById('model-select').value || 'glm-5' }) }).then(function (d) {
        var el = $('typing'); if (el) el.remove();
        addMsg('a', d.response || d.reply || d.message || '(no response)');
      }).catch(function () { var el = $('typing'); if (el) el.remove(); addMsg('a', 'Error connecting to NEXUS Brain. Ensure ZAI_API_KEY is set and dashboard is running with env vars.'); });
    }

    function copyLastAI() {
      var bubbles = document.querySelectorAll('#chat-msgs .cmsg.a .cbubble');
      if (!bubbles.length) { toast('No AI message to copy'); return; }
      var last = bubbles[bubbles.length - 1];
      var text = last.innerText || last.textContent || '';
      navigator.clipboard && navigator.clipboard.writeText(text).then(function () { toast('Copied!'); }).catch(function () { });
    }

    function copyBubble(btn) {
      var bub = btn.closest('.cmsg').querySelector('.cbubble');
      if (!bub) return;
      var text = bub.innerText || bub.textContent || '';
      navigator.clipboard && navigator.clipboard.writeText(text).then(function () { toast('Copied!'); }).catch(function () { });
    }

    function onModelChange() {
      const sel = document.getElementById('model-select');
      const badge = document.getElementById('chat-model-badge');
      const labels = {
        'glm-5': 'SAGE',
        'claude-sonnet-4-6': 'SENTINEL',
        'claude-opus-4-6': 'NEXUS PRIME',
        'codex': 'FORGE',
        'minimax-2.5': 'SCOUT',
      };
      if (badge) badge.textContent = labels[sel.value] || sel.value;
    }
    function clearChat() {
      $('chat-msgs').innerHTML = '';
      localStorage.removeItem('nexus_chat_history');
      sessionStorage.removeItem('nexus_chat');
      addMsg('a', 'Chat cleared. How can I help you?');
    }
    function _saveChatHistory() {
      try {
        const msgs = [...$('chat-msgs').querySelectorAll('[data-role]')].map(el => ({ role: el.dataset.role, text: el.querySelector('.msg-text')?.textContent || '' }));
        localStorage.setItem('nexus_chat_history', JSON.stringify(msgs.slice(-50)));
      } catch (e) { }
    }
    function _loadChatHistory() {
      try {
        const saved = JSON.parse(localStorage.getItem('nexus_chat_history') || '[]');
        if (saved.length) { saved.forEach(m => addMsg(m.role, m.text)); return true; }
      } catch (e) { }
      return false;
    }
    // ─── Benchmark ───
    const TARGETS = [0.6, 1.5, 2.5, 5.0];
    const BM_DATA = [
      { name: 'S&P 500 (SPY)', sharpe: 0.73, cagr: 23.1, mdd: -8.5, note: '2024 actual' },
      { name: 'Bitcoin B&H', sharpe: 1.47, cagr: 125.0, mdd: -28.0, note: '2024 actual' },
      { name: 'Ethereum B&H', sharpe: 0.62, cagr: 50.3, mdd: -35.0, note: '2024 actual' },
      { name: 'Renaissance Medallion (net)', sharpe: 3.8, cagr: 39.0, mdd: -4.0, note: 'estimated' },
      { name: '60/40 Portfolio', sharpe: 0.55, cagr: 15.2, mdd: -10.0, note: 'typical' },
      { name: 'Simple Funding Carry', sharpe: 0.90, cagr: 12.0, mdd: -18.0, note: 'baseline est.' },
    ];
    function updateTargets(sh) {
      if (sh == null) return;
      ['tc1', 'tc2', 'tc3', 'tc4'].forEach((id, i) => {
        const tgt = TARGETS[i];
        const pct2 = Math.min(100, Math.max(0, (sh / tgt) * 100));
        const ok = sh >= tgt;
        const card = $(id); const bar = $('tp' + (i + 1)); const bdg = $('tb' + (i + 1)); const cur = $('tc' + (i + 1) + '-v');
        if (cur) cur.textContent = n2(sh);
        if (bar) { bar.style.width = pct2 + '%'; bar.className = 'pfill ' + (ok ? 'g' : pct2 > 50 ? 'b' : 'y'); }
        if (bdg) { bdg.textContent = ok ? '✓ ACHIEVED' : pct2 > 50 ? 'IN PROGRESS' : 'PENDING'; bdg.className = 'bdg ' + (ok ? 'bg-g' : pct2 > 50 ? 'bg-b' : 'bg-gray'); }
        if (card) { card.className = 'tcard ' + (ok ? 'achieved' : pct2 > 30 ? 'near' : ''); }
      });
      // Badges
      $$('.ach').forEach((el, i) => {
        const ok = sh >= TARGETS[i];
        el.style.opacity = ok ? '1' : '0.35'; el.style.borderStyle = ok ? 'solid' : 'dashed';
        el.style.borderColor = ok ? 'var(--green)' : 'var(--border)';
      });
    }
    function loadBM() {
      jx('/api/metrics').then(d => {
        const s = d.summary || {};
        const sh = +(s.sharpe || 0);
        const cagr = +(s.cagr || 0) * 100;
        const mdd = +(s.max_drawdown || 0) * 100;
        updateTargets(sh);
        const provider = d.meta?.data_provider || 'current';
        const nexus = { name: `NEXUS — ${provider}`, sharpe: sh, cagr, mdd: mdd, note: 'live OOS' };
        const all = [nexus, ...BM_DATA];
        const rows = all.map((bm, i) => {
          const isN = i === 0;
          const sc = bm.sharpe;
          const vs = isN ? '—' : (sh > bm.sharpe ? '<span class="bdg bg-g" style="font-size:11px">✓ WINNING</span>' : '<span class="bdg bg-r" style="font-size:11px">✗ BEHIND</span>');
          const sc_cls = sc >= 1.5 ? 'pos' : sc >= 0.6 ? '' : 'neg';
          return `<tr>
        <td><b>${esc(bm.name)}</b>${isN ? ' <span class="bdg bg-b">NEXUS</span>' : ''}</td>
        <td class="${isN ? (sh >= 1.5 ? 'pos' : sh >= 0.6 ? '' : 'neg') : sc_cls}"><b>${n2(bm.sharpe)}</b></td>
        <td class="${bm.cagr >= 0 ? 'pos' : 'neg'}">${n2(bm.cagr, 1)}%</td>
        <td class="neg">${n2(Math.abs(bm.mdd), 1)}%</td>
        <td>${vs}</td>
        <td class="text-sm text-muted">${esc(bm.note || '')}</td>
      </tr>`;
        }).join('');
        html('bm-table', `<table><thead><tr><th>Strategy</th><th>Sharpe</th><th>CAGR</th><th>Max DD</th><th>vs NEXUS</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`);
        makeTableInteractive('bm-table', 'benchmark');
        touchSection('bm-table');
      }).catch(() => { html('bm-table', '<div class="empty">Run a backtest first to see comparison</div>'); });
    }

    // ─── Performance ───
    function loadRunsHistory() {
      setSkeleton('runs-table', 6);
      jx('/api/runs_history?limit=80').then(rows => {
        const arr = rows || [];
        if (!arr.length) { html('runs-table', '<div class="empty">No backtest history yet</div>'); return; }
        const body = arr.map((r, i) => {
          const verdict = r.verdict_pass ? '<span class="bdg bg-g">PASS</span>' : '<span class="bdg bg-r">FAIL</span>';
          const bias = r.bias_likely_overfit ? '<span class="bdg bg-r">Bias</span>' : '<span class="bdg bg-g">Clean</span>';
          return `<tr>
        <td>${i + 1}</td>
        <td class="text-sm">${esc(r.run_name || r.run_id || '—')}</td>
        <td>${esc(r.year || '—')}</td>
        <td class="${clr(r.sharpe)}"><b>${n2(r.sharpe, 3)}</b></td>
        <td>${pct(r.cagr)}</td>
        <td class="neg">${pct(r.max_drawdown)}</td>
        <td>${n2(r.calmar, 2)}</td>
        <td>${pct(r.win_rate)}</td>
        <td>${verdict}</td>
        <td>${bias}</td>
      </tr>`;
        }).join('');
        html('runs-table', `<table><thead><tr><th>#</th><th>Run</th><th>Year</th><th>Sharpe</th><th>CAGR</th><th>MDD</th><th>Calmar</th><th>Win Rate</th><th>Verdict</th><th>Bias</th></tr></thead><tbody>${body}</tbody></table>`);
        makeTableInteractive('runs-table', 'runs');
        touchSection('runs-table');
      }).catch(() => html('runs-table', '<div class="empty">Run history unavailable</div>'));
    }
    function loadPerf() {
      jx('/api/metrics').then(d => {
        const s = d.summary || {};
        const wf = d.walk_forward || {};
        const stats = [
          ['Sharpe Ratio', n2(s.sharpe, 3), clr(s.sharpe)],
          ['Sortino Ratio', n2(s.sortino, 3), ''],
          ['Calmar Ratio', n2(s.calmar, 3), ''],
          ['CAGR', pct(s.cagr), clr(s.cagr)],
          ['Total Return', pct(s.total_return), clr(s.total_return)],
          ['Max Drawdown', pct(s.max_drawdown), 'neg'],
          ['Win Rate', pct(s.win_rate), ''],
          ['Periods', s.periods || '—', ''],
          ['Avg Turnover', pct(s.turnover_avg), ''],
          ['Annual Vol', pct(s.volatility), ''],
        ];
        // Add walk-forward summary stats
        const wfStab = wf.stability || {};
        const wfStats = [
          ['WF Windows', wf.stability?.windows || '—', ''],
          ['WF Profitable %', wfStab.fraction_profitable != null ? pct(wfStab.fraction_profitable) : '—', ''],
          ['WF MDD<35% %', wfStab.fraction_mdd_lt_0_35 != null ? pct(wfStab.fraction_mdd_lt_0_35) : '—', ''],
        ];
        html('pf-stats', [...stats, ...wfStats].map(([l, v, c]) => `<div class="srow"><span class="lbl">${l}</span><span class="val ${c}">${v}</span></div>`).join(''));
        touchSection('pf-stats');
      }).catch(() => { html('pf-stats', '<div class="empty">No data — run a backtest first</div>'); });
      jx('/api/walk_forward').then(d => {
        const wf = d.windows || d.walk_forward || [];
        if (!wf.length) { html('wf-body', '<div class="empty">No walk-forward data</div>'); return; }
        const rows = wf.map((w, i) => `<tr>
      <td>${i + 1}</td>
      <td>${esc((w.start || w.train_start || '').slice(0, 10))}</td>
      <td>${esc((w.end || w.test_end || '').slice(0, 10))}</td>
      <td class="${clr(w.sharpe || w.oos_sharpe)}">${n2(w.sharpe || w.oos_sharpe)}</td>
      <td>${n2(w.calmar || w.oos_calmar)}</td>
      <td class="neg">${pct(w.max_drawdown || w.oos_mdd)}</td>
      <td>${esc(w.regime || '—')}</td>
    </tr>`).join('');
        html('wf-body', `<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>OOS Sharpe</th><th>Calmar</th><th>Max DD</th><th>Regime</th></tr></thead><tbody>${rows}</tbody></table>`);
        makeTableInteractive('wf-body', 'walkforward');
        touchSection('wf-body');
      }).catch(() => { html('wf-body', '<div class="empty">No walk-forward</div>'); });
      jx('/api/equity').then(d => {
        const eq = d.equity_curve || d.equity || []; if (eq.length < 2) return;
        const vals = eq.map(e => typeof e === 'object' ? (e.value || e.equity || 1) : +e);
        const rets = vals.slice(1).map((v, i) => (v / vals[i] - 1) * 100);
        const mn = Math.min(...rets), mx = Math.max(...rets);
        const B = 20; const step = (mx - mn) / B;
        const counts = new Array(B).fill(0);
        rets.forEach(r => { const b = Math.min(B - 1, Math.floor((r - mn) / step)); counts[b]++; });
        const labs = counts.map((_, i) => (mn + i * step).toFixed(1) + '%');
        const ctx = $('ret-chart'); if (!ctx) return;
        if (_ret) { _ret.destroy(); }
        _ret = new Chart(ctx, {
          type: 'bar',
          data: { labels: labs, datasets: [{ label: 'Freq', data: counts, backgroundColor: labs.map(l => +l >= 0 ? 'rgba(22,163,74,.7)' : 'rgba(220,38,38,.7)'), borderRadius: 2 }] },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 650, easing: 'easeOutQuart' },
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { maxTicksLimit: 8, font: { size: 10 } }, title: { display: true, text: 'Hourly Return Bucket' } },
              y: { grid: { color: 'rgba(148,163,184,.18)' }, title: { display: true, text: 'Frequency' } }
            }
          }
        });
        touchSection('ret-chart');
      }).catch(() => { });
      loadRunsHistory();
    }
    function runVal() {
      set('val-st', 'Running...'); html('val-body', '<div class="empty"><div class="spin"></div> Running 8 tests...</div>');
      jx('/api/validation/run', { method: 'POST' }).then(d => {
        set('val-st', '');
        const r = d.results || d || {};
        const v = r.overall_verdict || d.verdict || '—';
        const ts = r.tests || [];
        const vc = v === 'PASS' ? 'bg-g' : v === 'WARN' ? 'bg-y' : 'bg-r';
        let h = `<div class="row mb"><span class="bdg ${vc}" style="font-size:14px">${v}</span><span class="text-sm text-muted">${ts.length} tests</span></div>`;
        if (ts.length) {
          const rows = ts.map(t => `<tr><td>${esc(t.name || '')}</td><td><span class="bdg ${t.verdict === 'PASS' ? 'bg-g' : t.verdict === 'WARN' ? 'bg-y' : 'bg-r'}">${t.verdict || '—'}</span></td><td>${n2(t.sharpe || t.is_sharpe)}</td><td>${n2(t.oos_sharpe)}</td><td class="text-sm text-muted">${esc(t.notes || t.note || '')}</td></tr>`).join('');
          h += `<table><thead><tr><th>Test</th><th>Verdict</th><th>IS Sharpe</th><th>OOS Sharpe</th><th>Notes</th></tr></thead><tbody>${rows}</tbody></table>`;
        }
        html('val-body', h); toast('Validation done: ' + v);
      }).catch(e => { set('val-st', ''); html('val-body', '<div class="empty">Error: ' + esc(String(e)) + '</div>'); });
    }

    // ─── Risk ───
    function loadRisk() {
      jx('/api/risk').then(d => {
        const r = d.risk || d || {};
        html('risk-var', `
      <div class="srow"><span class="lbl">VaR 95%</span><span class="val neg">${pct(r.var_95 || r.VaR_95)}</span></div>
      <div class="srow"><span class="lbl">VaR 99%</span><span class="val neg">${pct(r.var_99 || r.VaR_99)}</span></div>
      <div class="srow"><span class="lbl">CVaR 95%</span><span class="val neg">${pct(r.cvar_95 || r.CVaR_95)}</span></div>
      <div class="srow"><span class="lbl">Max DD</span><span class="val neg">${pct(r.max_drawdown)}</span></div>
      <div class="srow"><span class="lbl">Gross Lev</span><span class="val">${n2(r.gross_leverage || r.current_leverage)}x</span></div>
    `);
        const reg = r.regime || r.market_regime || '—';
        const rc = reg === 'trending' ? 'bg-g' : reg === 'volatile' || reg === 'crash' ? 'bg-r' : 'bg-y';
        html('risk-regime', `
      <div style="text-align:center;padding:16px 0"><span class="bdg ${rc}" style="font-size:15px;padding:7px 18px">${esc(reg.toUpperCase())}</span></div>
      <div class="srow"><span class="lbl">Vol Regime</span><span class="val">${esc(r.vol_regime || '—')}</span></div>
      <div class="srow"><span class="lbl">Trend Score</span><span class="val">${n2(r.trend_score)}</span></div>
    `);
        html('risk-limits', `
      <div class="srow"><span class="lbl">Max DD Limit</span><span class="val">${pct(r.max_drawdown_limit)}</span></div>
      <div class="srow"><span class="lbl">Max Gross Lev</span><span class="val">${n2(r.max_gross_leverage, 1)}x</span></div>
      <div class="srow"><span class="lbl">Max/Symbol</span><span class="val">${pct(r.max_position_per_symbol)}</span></div>
      <div class="srow"><span class="lbl">Max Turnover</span><span class="val">${pct(r.max_turnover_per_rebalance)}</span></div>
    `);
        const pos = r.positions || r.position_detail || {};
        const prows = Object.entries(pos).map(([s, p]) => `<tr><td><b>${esc(s)}</b></td><td class="${clr(p.weight)}">${pctd((p.weight || 0) * 100)}</td><td>${n2(p.volatility, 4)}</td><td class="${clr(p.pnl || p.return)}">${pct(p.pnl || p.return)}</td></tr>`).join('');
        html('risk-detail', prows ? `<table><thead><tr><th>Symbol</th><th>Weight</th><th>Vol</th><th>PnL</th></tr></thead><tbody>${prows}</tbody></table>` : '<div class="empty">No position data</div>');
      }).catch(() => { ['risk-var', 'risk-regime', 'risk-limits', 'risk-detail'].forEach(id => html(id, '<div class="empty">No risk data. Run a backtest.</div>')); });
    }

    // ─── Research ───
    function loadResearch() {
      // Load debate history as main research content
      jx('/api/debate_history').then(d => {
        const debates = Array.isArray(d) ? d : (d.debates || d.history || []);
        if (debates.length) {
          html('rc-proposals', debates.slice(0, 5).map((db, i) => {
            const contribs = db.contributions || db.rounds || [];
            const score = db.consensus_score != null ? (+(db.consensus_score) * 100).toFixed(0) + '%' : '—';
            const ts = (db.timestamp || db.ts || '').slice(0, 16).replace('T', ' ');
            return `<div class="card mb" style="margin-bottom:8px">
          <div class="rowb mb"><b class="text-sm">⚔️ Debate: ${esc(db.topic || 'Analysis')}</b><span class="bdg bg-b">Consensus: ${score}</span></div>
          <div class="text-sm text-muted" style="margin-bottom:4px">${ts} · ${contribs.length} contributions</div>
          ${db.synthesis ? `<div class="text-sm" style="border-left:3px solid var(--accent);padding-left:8px;margin-top:4px">${esc((db.synthesis || '').slice(0, 200))}${db.synthesis?.length > 200 ? '…' : ''}</div>` : ''}
        </div>`;
          }).join(''));
        } else {
          html('rc-proposals', '<div class="empty">No debate history yet. Use ⚔️ Debate mode in Chat tab.</div>');
        }
      }).catch(() => html('rc-proposals', '<div class="empty">No debate data</div>'));
      // Research cycle latest
      jx('/api/research_cycle/latest').then(d => {
        const r = d.cycle || d || {};
        const ts = (r.ts || r.timestamp || '').slice(0, 16).replace('T', ' ');
        html('rc-latest', `
      <div class="srow"><span class="lbl">Last Run</span><span class="val">${esc(ts || '—')}</span></div>
      <div class="srow"><span class="lbl">Papers</span><span class="val">${r.papers_found || r.papers || 0}</span></div>
      <div class="srow"><span class="lbl">Tasks Created</span><span class="val">${r.tasks_created || r.tasks || 0}</span></div>
      <div class="srow"><span class="lbl">Proposals</span><span class="val">${(r.strategy_proposals || []).length}</span></div>
      <div class="srow"><span class="lbl">Status</span><span class="val"><span class="bdg bg-g">${esc(r.status || 'OK')}</span></span></div>
    `);
        const props = r.strategy_proposals || [];
        if (props.length) {
          html('rc-proposals', props.map((p, i) => `<div class="card mb" style="margin-bottom:8px"><div class="rowb mb"><b class="text-sm">#${i + 1} ${esc(p.title || p.name || 'Proposal')}</b><span class="bdg bg-b">${esc(p.strategy || 'strategy')}</span></div><div class="text-sm text-muted">${esc(p.description || p.rationale || '')}</div></div>`).join(''));
        }
      }).catch(() => { html('rc-latest', '<div class="empty">No research cycle run yet. Click "Run Now" to start.</div>'); });
      jx('/api/alerts').then(d => {
        const al = d.alerts || [];
        if (!al.length) { html('rc-alerts', '<div class="empty">No alerts</div>'); return; }
        html('rc-alerts', al.slice(0, 8).map(a => `<div class="srow"><span class="bdg ${a.level === 'ERROR' ? 'bg-r' : a.level === 'WARN' ? 'bg-y' : 'bg-b'}">${esc(a.level || 'INFO')}</span><span class="text-sm" style="flex:1">${esc(a.message || a.msg || '')}</span><span class="text-sm text-muted">${esc((a.ts || '').slice(11, 16))}</span></div>`).join(''));
      }).catch(() => { html('rc-alerts', '<div class="empty">No alerts</div>'); });
    }
    function runResearch() {
      set('rc-st', 'Running...');
      jx('/api/research_cycle/run', { method: 'POST' }).then(d => { set('rc-st', 'Done at ' + now()); loadResearch(); toast('Research cycle complete!'); }).catch(() => set('rc-st', 'Error'));
    }
    function searchMem() {
      const q = $('mem-q').value.trim(); if (!q) return;
      html('mem-results', '<div class="spin"></div> Searching...');
      jx('/api/brain/search?q=' + encodeURIComponent(q)).then(d => {
        const rs = d.results || [];
        if (!rs.length) { html('mem-results', '<div class="empty">No results for "' + esc(q) + '"</div>'); return; }
        html('mem-results', rs.slice(0, 6).map(r => `<div style="padding:5px 0;border-bottom:1px solid var(--border)"><div class="text-sm" style="font-weight:500">${esc(r.title || r.key || '')}</div><div class="text-sm text-muted">${esc((r.snippet || r.content || r.value || '').slice(0, 120))}</div></div>`).join(''));
      }).catch(() => html('mem-results', '<div class="empty">Search error</div>'));
    }
    function runAgent(name) {
      set('agent-res', 'Running ' + name.toUpperCase() + '...');
      jx('/api/agents/run?agent=' + name, { method: 'POST' }).then(d => { set('agent-res', (d.result || d.message || 'Done').slice(0, 100)); toast(name.toUpperCase() + ' complete'); }).catch(() => set('agent-res', 'Error: ' + name));
    }

    // ─── Tasks ───
    const _catIcon = { research: '🔬', practice: '⚗️', procedure: '🤖' };
    const _delIcon = { human: '👤', nexus: '🤖', atlas: '⚡', cipher: '🛡', echo: '🔊', flux: '🌊' };
    function _taskCard(t, mini = false) {
      const pc = { high: 'bg-r', medium: 'bg-y', low: 'bg-g' };
      const statusDot = { todo: '#94A3B8', in_progress: '#3B82F6', review: '#F59E0B', done: '#10B981' };
      const dot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${statusDot[t.status] || '#94A3B8'};margin-right:4px"></span>`;
      return `<div class="tsk" title="Click to mark done" onclick="doneTask('${esc(t.id)}')">
    <div class="tsk-title">${dot}${esc(t.title || 'Untitled')}</div>
    <div class="tsk-meta">
      <span class="bdg ${pc[t.priority || 'medium'] || 'bg-gray'}">${esc(t.priority || 'med')}</span>
      ${t.assignee ? `<span class="bdg bg-b">${esc(t.assignee)}</span>` : ''}
      ${t.delegated_by ? `<span class="text-sm text-muted" style="font-size:10px">${_delIcon[t.delegated_by] || ''}${esc(t.delegated_by)}</span>` : ''}
    </div>
    ${!mini && t.description ? `<div class="text-sm text-muted" style="margin-top:3px;font-size:11px">${esc(t.description.slice(0, 80))}</div>` : ''}
  </div>`;
    }
    function loadTasks() {
      jx('/api/tasks').then(d => {
        const tasks = d.tasks || [];
        // Category lanes
        const cats = { research: [], practice: [], procedure: [] };
        tasks.filter(t => t.status !== 'done').forEach(t => {
          const c = t.category || 'practice';
          if (cats[c]) cats[c].push(t);
          else cats.practice.push(t);
        });
        ['research', 'practice', 'procedure'].forEach(cat => {
          set('kc-' + cat, cats[cat].length);
          html('kl-' + cat, cats[cat].map(t => _taskCard(t)).join('') || '<div class="empty" style="font-size:11px">No active tasks</div>');
        });
        // Classic status kanban
        const cols = { todo: [], inprogress: [], review: [], done: [] };
        tasks.forEach(t => { const s = (t.status || 'todo').toLowerCase().replace(/[- ]/g, ''); (cols[s] || cols.todo).push(t); });
        Object.entries(cols).forEach(([k, list]) => {
          set('kc-' + k, list.length);
          html('kl-' + k, list.map(t => _taskCard(t, true)).join('') || '<div style="padding:8px;font-size:12px;color:var(--fg-light);text-align:center">Empty</div>');
        });
        const rows = tasks.map(t => {
          const st = (t.status || 'todo').replace(/_/g, ' ');
          const pri = (t.priority || 'medium');
          const priCls = pri === 'high' ? 'bg-r' : pri === 'low' ? 'bg-g' : 'bg-y';
          return `<tr>
        <td class="text-sm">${esc(t.title || 'Untitled')}</td>
        <td><span class="bdg bg-b">${esc(t.category || 'practice')}</span></td>
        <td><span class="bdg ${priCls}">${esc(pri)}</span></td>
        <td>${esc(st)}</td>
        <td>${esc(t.assignee || '—')}</td>
        <td class="text-sm text-muted">${esc((t.delegated_by || '—'))}</td>
        <td>${t.status === 'done' ? '✅' : '<button class="btn btn-s btn-sm" onclick="doneTask(\'' + esc(t.id) + '\')">Done</button>'}</td>
      </tr>`;
        }).join('');
        html('tasks-table', rows ? `<table><thead><tr><th>Title</th><th>Category</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Delegated</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>` : '<div class="empty">No tasks</div>');
        makeTableInteractive('tasks-table', 'tasks');
        touchSection('tasks-table');
      }).catch(() => {
        html('kanban', '<div class="empty">Could not load tasks</div>');
        html('tasks-table', '<div class="empty">Could not load tasks</div>');
      });
    }
    function createTask() {
      const title = $('t-title').value.trim(); if (!title) { toast('Title required'); return; }
      const body = {
        title,
        priority: $('t-pri').value,
        assignee: $('t-who').value,
        description: $('t-desc').value.trim(),
        status: 'todo',
        category: $('t-cat').value,
        delegated_by: $('t-delegated').value,
      };
      jx('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
        .then(() => { $('t-title').value = ''; $('t-desc').value = ''; loadTasks(); toast('Task created'); })
        .catch(() => toast('Error creating task'));
    }
    function doneTask(id) {
      jx('/api/tasks/' + id + '/status', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'done' }) })
        .then(() => { loadTasks(); toast('Task marked done'); })
        .catch(() => jx('/api/tasks/' + id, { method: 'DELETE' }).then(() => { loadTasks(); toast('Task removed'); }));
    }

    // ─── Files ───
    function loadFiles() {
      setSkeleton('files-body', 8);
      jx('/api/files').then(d => {
        const secs = d.sections || [];
        if (!secs.length) { html('files-body', '<div class="empty">No artifacts found</div>'); return; }
        let h = '';
        secs.forEach(sec => {
          const icon = sec.icon || '📄';
          const items = sec.items || [];
          h += `<div class="file-section"><div class="file-section-hdr">${icon} ${esc(sec.title)} <span class="bdg bg-gray">${items.length}</span></div>`;
          if (!items.length) { h += '<div class="text-sm text-muted" style="padding-left:20px">Empty</div>'; h += '</div>'; return; }
          if (sec.type === 'runs') {
            h += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';
            items.forEach(it => {
              const sc = it.sharpe != null ? (+it.sharpe >= 1.5 ? 'pos' : +it.sharpe >= 0.6 ? '' : 'neg') : '';
              h += `<div class="run-item" onclick="viewRunReport('${esc(it.path)}')">
            <div class="run-name">${esc(it.name.slice(0, 50))}</div>
            <div class="row gap-4" style="flex-wrap:wrap;gap:6px">
              ${it.sharpe != null ? `<span class="bdg ${+it.sharpe >= 1.5 ? 'bg-g' : +it.sharpe >= 0.6 ? 'bg-b' : 'bg-r'}">Sharpe: ${n2(it.sharpe)}</span>` : ''}
              ${it.cagr != null ? `<span class="bdg bg-gray">CAGR: ${pct(it.cagr)}</span>` : ''}
              ${it.mdd != null ? `<span class="bdg bg-r">DD: ${pct(it.mdd)}</span>` : ''}
            </div>
            <div class="text-sm text-muted" style="margin-top:4px">${esc(it.mtime)} · ${(it.files || []).join(', ').slice(0, 60)}</div>
          </div>`;
            });
            h += '</div>';
          } else {
            h += '<div class="file-grid">';
            items.forEach(it => {
              h += `<div class="file-item" onclick="viewFile('${esc(it.path)}','${esc(it.name)}')">
            <div class="file-name">${esc(it.name)}</div>
            <div class="file-meta">${fmtSize(it.size || 0)} · ${esc(it.mtime || '—')}</div>
          </div>`;
            });
            h += '</div>';
          }
          h += '</div>';
        });
        html('files-body', h);
        filterFiles();
        touchSection('files-body');
      }).catch(e => html('files-body', '<div class="empty">Error: ' + esc(String(e)) + '</div>'));
    }
    function filterFiles() {
      const q = ($('file-search')?.value || '').trim().toLowerCase();
      const sections = [...$$('#files-body .file-section')];
      let matches = 0;
      sections.forEach(sec => {
        const cards = [...sec.querySelectorAll('.file-item,.run-item')];
        let visible = 0;
        cards.forEach(card => {
          const ok = !q || card.textContent.toLowerCase().includes(q);
          card.classList[ok ? 'remove' : 'add']('hide');
          if (ok) { visible++; matches++; }
        });
        sec.classList[(visible || !q) ? 'remove' : 'add']('hide');
      });
      set('files-match', q ? `${matches} match${matches === 1 ? '' : 'es'}` : '');
    }
    function viewFile(path, name) {
      $('fv-path').textContent = path;
      html('fv-content', '<div class="spin"></div> Loading ' + esc(name) + '...');
      $('file-viewer-panel').style.display = 'block';
      $('file-viewer-panel').scrollIntoView({ behavior: 'smooth' });
      jx('/api/files/content?path=' + encodeURIComponent(path)).then(d => {
        let content = d.content || '(empty)';
        if (path.endsWith('.json')) { try { content = JSON.stringify(JSON.parse(content), null, 2); } catch (e) { } }
        html('fv-content', esc(content));
      }).catch(e => html('fv-content', 'Error: ' + esc(String(e))));
    }
    function viewRunReport(runPath) {
      viewFile(runPath + '/report.md', 'report.md');
    }
    function closeFileViewer() { $('file-viewer-panel').style.display = 'none'; }

    // ─── Market ───
    function loadMarket() {
      set('mkt-ts', 'Updating...');
      jx('/api/market').then(d => {
        const items = d.market || d.data || d || [];
        const arr = Array.isArray(items) ? items : Object.values(items);
        set('mkt-ts', t('status.updated', { time: now() }));
        if (!arr.length) { html('mkt-funding', '<div class="empty">No data</div>'); return; }
        const frows = arr.map(it => {
          const fr = +(it.funding_rate || it.fundingRate || 0);
          const frp = (fr * 100).toFixed(4) + '%';
          const ann = (fr * 3 * 365 * 100).toFixed(1) + '%';
          const sig = fr < -0.005 ? '<span class="bdg bg-g">LONG ↑</span>' : fr > 0.005 ? '<span class="bdg bg-r">SHORT ↓</span>' : '<span class="bdg bg-gray">NEUTRAL</span>';
          return `<tr><td><b>${esc(it.symbol || it.s || '—')}</b></td><td class="${fr < 0 ? 'pos' : 'neg'}">${frp}</td><td>${ann}</td><td>${sig}</td><td class="text-sm text-muted">${esc((it.funding_time || it.nextFundingTime || '').toString().slice(-8,).slice(0, 5) || '—')}</td></tr>`;
        }).join('');
        html('mkt-funding', `<table><thead><tr><th>Symbol</th><th>Funding Rate</th><th>Annualized</th><th>Signal</th><th>Next</th></tr></thead><tbody>${frows}</tbody></table>`);
        makeTableInteractive('mkt-funding', 'market_funding');
        const prows = arr.map(it => {
          const chg = +(it.price_change_24h || it.priceChange || 0);
          const price = +(it.mark_price || it.markPrice || it.price || 0);
          return `<tr><td><b>${esc(it.symbol || '—')}</b></td><td>$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td><td class="${chg >= 0 ? 'pos' : 'neg'}">${chg.toFixed(2)}%</td><td class="text-sm text-muted">${it.open_interest || it.openInterest || '—'}</td></tr>`;
        }).join('');
        html('mkt-price', `<table><thead><tr><th>Symbol</th><th>Mark Price</th><th>24h Change</th><th>Open Interest</th></tr></thead><tbody>${prows}</tbody></table>`);
        makeTableInteractive('mkt-price', 'market_price');
        touchSection('mkt-price');
      }).catch(() => { html('mkt-funding', '<div class="empty">Market data unavailable</div>'); set('mkt-ts', 'Error'); });
    }

    // ─── Tab loader map ───
    // ─── Pitch / Investor tab ───
    let _ptChart = null;
    function loadPitch() {
      // Load champion metrics
      jx('/api/alpha_loop/champion').then(d => {
        if (d.error) { html('pt-sharpe', '—'); return; }
        const s = d.corrected_sharpe || d.summary?.sharpe || 0;
        const c = d.summary?.cagr || 0;
        const m = d.summary?.max_drawdown || 0;
        set('pt-sharpe', (+s).toFixed(3));
        set('pt-cagr', pct(c));
        set('pt-mdd', pct(m));
      }).catch(() => {
        // Fallback: load from metrics API
        jx('/api/metrics').then(d => {
          const s = d.summary?.sharpe || d.sharpe || 0;
          const c = d.summary?.cagr || d.cagr || 0;
          const m = d.summary?.max_drawdown || d.max_drawdown || 0;
          set('pt-sharpe', (+s).toFixed(3));
          set('pt-cagr', pct(c));
          set('pt-mdd', pct(m));
        }).catch(() => { });
      });

      // Load strategy rankings
      jx('/api/alpha_loop/rankings').then(rows => {
        if (!rows || rows.error) { html('pt-rankings', '<div class="empty">No rankings yet</div>'); return; }
        const tbl = rows.slice(0, 8).map((r, i) => {
          const medal = ['🥇', '🥈', '🥉'][i] || `${i + 1}.`;
          const sh = n2(r.corrected_sharpe || r.sharpe, 3);
          const pass = r.verdict_pass ? '<span class="bdg bg-g">PASS</span>' : '<span class="bdg bg-r">FAIL</span>';
          return `<tr><td>${medal} ${esc(r.run_name || r.strategy || '')}</td><td><strong class="pos">${sh}</strong></td><td>${pct(r.cagr)}</td><td>${pct(r.max_drawdown)}</td><td>${pass}</td></tr>`;
        }).join('');
        html('pt-rankings', `<table><thead><tr><th>Strategy</th><th>Sharpe</th><th>CAGR</th><th>MDD</th><th>Verdict</th></tr></thead><tbody>${tbl}</tbody></table>`);
      }).catch(() => html('pt-rankings', '<div class="empty">Run a backtest first</div>'));

      // Scientific verification
      jx('/api/metrics').then(d => {
        const v = d.verdict || {};
        const b = d.bias_check || {};
        const wf = d.walk_forward || {};
        const checks = [
          { label: 'Walk-Forward Out-of-Sample', pass: !!wf.windows, detail: wf.windows ? `${wf.windows} windows` : 'Not run yet' },
          { label: 'Benchmark Verdict', pass: !!v.pass, detail: v.reason || '—' },
          { label: 'Bias Check', pass: !(b.flags?.length > 0), detail: b.flags?.length ? `${b.flags.length} flags: ${(b.flags || []).slice(0, 2).join(', ')}` : 'No bias flags detected' },
          { label: 'Min Trades', pass: (d.summary?.num_trades || 0) > 30, detail: `${d.summary?.num_trades || 0} trades` },
          { label: 'Periods per Year', pass: !!(d.meta?.periods_per_year === 8760 || d.benchmark?.annualization?.periods_per_year === 8760), detail: `${d.meta?.periods_per_year || d.benchmark?.annualization?.periods_per_year || '?'} (1h bars need 8760)` },
        ];
        html('pt-verification', checks.map(c => `
      <div class="vbadge ${c.pass ? 'pass' : 'warn'}">
        <span>${c.pass ? '✅' : '⚠️'}</span>
        <div><strong>${esc(c.label)}</strong><div style="font-size:11px;color:#6B7280">${esc(c.detail)}</div></div>
      </div>`).join(''));
      }).catch(() => html('pt-verification', '<div class="empty">Load a backtest result</div>'));

      // Equity curve vs benchmarks
      jx('/api/equity').then(d => {
        const eq = d.equity || d.equity_curve || [];
        const bm = d.benchmarks || {};
        if (!eq.length) { html('pt-bench-compare', '<div class="empty">No equity data</div>'); return; }
        const ctx = document.getElementById('pt-equity');
        if (!ctx) return;
        const n = eq.length;
        const labels = eq.map((_, i) => i);
        const nexusNorm = eq.map(v => +v / eq[0]);

        // Build datasets
        const datasets = [{ label: 'NEXUS Champion', data: nexusNorm, borderColor: '#2563EB', backgroundColor: 'rgba(37,99,235,.07)', fill: true, tension: .4, borderWidth: 2.5 }];
        if (bm.btc_hold) {
          const b = bm.btc_hold; datasets.push({ label: 'BTC B&H', data: b.map(v => +v / b[0]), borderColor: '#F59E0B', borderWidth: 1.5, fill: false, tension: .3, pointRadius: 0 });
        }
        if (bm.eth_hold) {
          const b = bm.eth_hold; datasets.push({ label: 'ETH B&H', data: b.map(v => +v / b[0]), borderColor: '#8B5CF6', borderWidth: 1.5, fill: false, tension: .3, pointRadius: 0 });
        }
        if (_ptChart) _ptChart.destroy();
        _ptChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { title: { display: true, text: 'Normalized Return' }, ticks: { callback: v => `${((v - 1) * 100).toFixed(0)}%` } }, x: { ticks: { maxTicksLimit: 12 } } } } });

        // Summary table
        const nexusFinal = nexusNorm[n - 1];
        let rows = `<tr><td><strong style="color:#2563EB">NEXUS Champion</strong></td><td class="pos"><strong>+${((nexusFinal - 1) * 100).toFixed(1)}%</strong></td><td colspan="2">See KPIs above</td></tr>`;
        if (bm.btc_hold) {
          const f = +bm.btc_hold[n - 1] / +bm.btc_hold[0];
          rows += `<tr><td>BTC Buy & Hold</td><td class="${f > 1 ? 'pos' : 'neg'}">${f > 1 ? '+' : ''}${((f - 1) * 100).toFixed(1)}%</td><td colspan="2">Pure crypto exposure</td></tr>`;
        }
        if (bm.eth_hold) {
          const f = +bm.eth_hold[n - 1] / +bm.eth_hold[0];
          rows += `<tr><td>ETH Buy & Hold</td><td class="${f > 1 ? 'pos' : 'neg'}">${f > 1 ? '+' : ''}${((f - 1) * 100).toFixed(1)}%</td><td colspan="2">Pure crypto exposure</td></tr>`;
        }
        html('pt-bench-compare', `<table><thead><tr><th>Strategy</th><th>Total Return</th><th>Notes</th><th></th></tr></thead><tbody>${rows}</tbody></table>`);
      }).catch(() => { });

      // Learning stats
      jx('/api/learning/stats').then(d => {
        if (d.error) { html('pt-learning', '<div class="empty">Learning engine initializing...</div>'); return; }
        html('pt-learning', `
      <div class="card" style="text-align:center"><div class="ctitle">Hypotheses Tracked</div><div style="font-size:2rem;font-weight:700;color:var(--accent)">${d.total_hypotheses_tracked || 0}</div></div>
      <div class="card" style="text-align:center"><div class="ctitle">Learning Velocity</div><div style="font-size:2rem;font-weight:700;color:var(--green)">${(+(d.learning_velocity || 0) * 100).toFixed(1)}%</div></div>
      <div class="card" style="text-align:center"><div class="ctitle">Due for Review</div><div style="font-size:2rem;font-weight:700;color:var(--yellow)">${d.hypotheses_due_today || 0}</div></div>
    `);
      }).catch(() => html('pt-learning', '<div class="empty">Learning stats unavailable</div>'));
    }

    // ─── Analysis Logs (Research Journal) ───
    let _analysisEntries = [];
    let _analysisEntryKeys = new Set();
    let _analysisSource = null;
    let _analysisTimer = null;
    let _analysisExpectBootstrap = true;
    let _analysisStreamState = 'connecting';
    let _analysisFiltersSig = '';

    function _analysisEntryKey(e) {
      const msg = e && typeof e === 'object' ? (e.content || e.details || e.rationale || e.consensus || '') : '';
      return [e && e.ts || '', e && e.type || '', e && e.source || '', e && e.title || '', String(msg || '').slice(0, 360)].join('|');
    }

    function _analysisRenderStats(entries) {
      const rows = Array.isArray(entries) ? entries : [];
      if (!rows.length) {
        html('log-kpis', `
      <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_total'))}</div><div style="font-size:1.2rem;font-weight:700">0</div></div>
      <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_critical'))}</div><div style="font-size:1.2rem;font-weight:700;color:var(--red)">0</div></div>
      <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_decision'))}</div><div style="font-size:1.2rem;font-weight:700;color:var(--green)">0</div></div>
      <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_audit'))}</div><div style="font-size:1.2rem;font-weight:700;color:#8B5CF6">0</div></div>
    `);
        html('log-stats', `<div class="text-muted">${esc(t('logs.no_entries'))}</div>`);
        return;
      }
      const byType = {}, bySrc = {};
      let latest = '';
      let critical = 0;
      for (const e of rows) {
        byType[e.type] = (byType[e.type] || 0) + 1;
        if (e.source) bySrc[e.source] = (bySrc[e.source] || 0) + 1;
        if (e.ts && e.ts > latest) latest = e.ts;
        if (String(e.severity || '').toLowerCase() === 'critical') critical += 1;
      }
      const audits = byType.audit || 0;
      const decisions = byType.decision || 0;
      html('log-kpis', `
    <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_total'))}</div><div style="font-size:1.25rem;font-weight:700">${rows.length}</div></div>
    <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_critical'))}</div><div style="font-size:1.25rem;font-weight:700;color:var(--red)">${critical}</div></div>
    <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_decision'))}</div><div style="font-size:1.25rem;font-weight:700;color:var(--green)">${decisions}</div></div>
    <div class="card" style="padding:10px 12px"><div class="text-xs text-muted">${esc(t('logs.kpi_audit'))}</div><div style="font-size:1.25rem;font-weight:700;color:#8B5CF6">${audits}</div></div>
  `);
      let h = `<div><b>${rows.length}</b> ${t('logs.entries')} · Audit: <b>${audits}</b> · Decision: <b>${decisions}</b>${critical ? ` · Critical: <b style="color:var(--red)">${critical}</b>` : ''}</div>`;
      h += `<div style="margin-top:6px;font-weight:600;font-size:11px;color:var(--fg-muted)">${esc(t('logs.by_type'))}</div>`;
      const typeIcon = { analysis: '🔍', finding: '💡', decision: '✅', audit: '🤖' };
      for (const [k, c] of Object.entries(byType)) {
        h += `<div>${typeIcon[k] || '📝'} ${esc(k)}: <b>${c}</b></div>`;
      }
      h += `<div style="margin-top:6px;font-weight:600;font-size:11px;color:var(--fg-muted)">${esc(t('logs.by_source'))}</div>`;
      for (const [s, c] of Object.entries(bySrc)) {
        h += `<div>${esc(s)}: <b>${c}</b></div>`;
      }
      if (latest) {
        h += `<div style="margin-top:6px;font-size:11px;color:var(--fg-muted)">${esc(t('logs.latest'))}: ${new Date(latest).toLocaleString()}</div>`;
      }
      html('log-stats', h);
    }

    function _analysisMergeEntries(entries, replace = false) {
      const incoming = Array.isArray(entries) ? entries : [];
      if (replace) {
        _analysisEntries = [];
        _analysisEntryKeys = new Set();
      }
      let changed = false;
      for (const e of incoming) {
        if (!e || typeof e !== 'object') continue;
        const key = _analysisEntryKey(e);
        if (!key || _analysisEntryKeys.has(key)) continue;
        _analysisEntryKeys.add(key);
        _analysisEntries.push(e);
        changed = true;
      }
      if (changed) {
        _analysisEntries.sort((a, b) => String(a && a.ts || '').localeCompare(String(b && b.ts || '')));
        if (_analysisEntries.length > 1200) {
          _analysisEntries = _analysisEntries.slice(-1200);
          _analysisEntryKeys = new Set(_analysisEntries.map(_analysisEntryKey));
        }
      }
      return changed;
    }

    function _analysisRenderEntries() {
      set('log-count', `${_analysisEntries.length} ${t('logs.entries')}`);
      const entries = _analysisEntries.slice(-520).reverse();
      if (!entries.length) {
        html('logs-container', `<div class="empty">${esc(t('logs.no_entries'))}</div>`);
        return;
      }
      const typeIcon = { analysis: '🔍', finding: '💡', decision: '✅', audit: '🤖' };
      const typeColor = { analysis: '#3B82F6', finding: '#F59E0B', decision: '#10B981', audit: '#8B5CF6' };
      const sevColor = { critical: '#EF4444', warning: '#F59E0B', info: '#6B7280' };
      let h = '';
      for (const e of entries) {
        const icon = typeIcon[e.type] || '📝';
        const color = typeColor[e.type] || '#6B7280';
        const sev = e.severity ? `<span style="color:${sevColor[e.severity] || '#6B7280'};font-size:11px;font-weight:600">[${e.severity.toUpperCase()}]</span>` : '';
        const ts = e.ts ? new Date(e.ts).toLocaleString() : '';
        const src = e.source || '';
        const tags = (e.tags || []).map(x => `<span style="background:var(--border);padding:1px 6px;border-radius:10px;font-size:10px">${esc(x)}</span>`).join(' ');
        let content = esc(e.content || e.details || e.rationale || e.consensus || '');
        content = content.replace(/\n/g, '<br>');
        content = content.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
        content = content.replace(/`(.+?)`/g, '<code style="background:var(--border);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>');
        let responses = '';
        if (e.type === 'audit' && e.responses) {
          responses = '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">';
          for (const [model, resp] of Object.entries(e.responses)) {
            const r = esc(String(resp)).replace(/\n/g, '<br>');
            responses += `<div style="margin-bottom:8px"><b style="color:var(--accent)">${esc(model)}:</b><div style="font-size:12px;margin-top:4px;padding:6px 10px;background:rgba(0,0,0,0.03);border-radius:6px">${r}</div></div>`;
          }
          responses += '</div>';
        }
        let alts = '';
        if (e.alternatives && e.alternatives.length) {
          alts = '<div style="margin-top:6px;font-size:11px;color:var(--fg-muted)">' + esc(t('logs.alternatives')) + ': ' + e.alternatives.map(a => esc(a)).join(', ') + '</div>';
        }
        h += `<div class="card" style="border-left:3px solid ${color};padding:12px 16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:16px">${icon}</span>
          <span style="font-weight:600;font-size:14px">${esc(e.title || '')}</span>
          ${sev}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;padding:2px 8px;background:${color}22;color:${color};border-radius:10px;font-weight:500">${esc(src)}</span>
          <span class="text-sm text-muted">${ts}</span>
        </div>
      </div>
      <div style="font-size:13px;line-height:1.6;color:var(--fg)">${content}</div>
      ${responses}${alts}
      ${tags ? '<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap">' + tags + '</div>' : ''}
    </div>`;
      }
      html('logs-container', h);
    }

    function _analysisFilterState() {
      return {
        entry_type: $('log-filter-type')?.value || '',
        source: $('log-filter-source')?.value || '',
      };
    }

    function _analysisUrl(base, n = 200) {
      const f = _analysisFilterState();
      const q = new URLSearchParams({ n: String(n || 200) });
      if (f.entry_type) q.set('entry_type', f.entry_type);
      if (f.source) q.set('source', f.source);
      return `${base}?${q.toString()}`;
    }

    function onAnalysisFilterChange() {
      if (_tab !== 'logs') return;
      _analysisExpectBootstrap = true;
      loadLogs({ replace: true, skipStats: false });
      if (_analysisAutoRefreshEnabled()) startAnalysisLogRealtime(true);
      else setAnalysisStreamState('paused', t('logs.stream_paused'));
    }

    function setAnalysisStreamState(state, label) {
      _analysisStreamState = state || 'disconnected';
      const el = $('analysis-stream-state');
      if (!el) return;
      let cls = 'bg-gray';
      if (_analysisStreamState === 'live') cls = 'bg-g';
      else if (_analysisStreamState === 'connecting') cls = 'bg-b';
      else if (_analysisStreamState === 'polling') cls = 'bg-y';
      else if (_analysisStreamState === 'disconnected') cls = 'bg-r';
      else if (_analysisStreamState === 'paused') cls = 'bg-gray';
      el.className = 'bdg ' + cls;
      if (label) { el.textContent = label; return; }
      if (_analysisStreamState === 'live') el.textContent = t('logs.stream_live');
      else if (_analysisStreamState === 'connecting') el.textContent = t('logs.stream_connecting');
      else if (_analysisStreamState === 'polling') el.textContent = t('logs.stream_polling');
      else if (_analysisStreamState === 'paused') el.textContent = t('logs.stream_paused');
      else el.textContent = t('logs.stream_disconnected');
    }

    function stopAnalysisLogRealtime() {
      if (_analysisSource) { _analysisSource.close(); _analysisSource = null; }
      if (_analysisTimer) { clearInterval(_analysisTimer); _analysisTimer = null; }
    }

    function startAnalysisLogRealtime(force = false) {
      const f = _analysisFilterState();
      const sig = `${f.entry_type}|${f.source}`;
      if (!force && _analysisSource && _analysisFiltersSig === sig && _analysisAutoRefreshEnabled()) return;
      stopAnalysisLogRealtime();
      _analysisFiltersSig = sig;
      _analysisExpectBootstrap = true;
      if (!_analysisAutoRefreshEnabled()) {
        setAnalysisStreamState('paused', t('logs.stream_paused'));
        return;
      }
      if (!window.EventSource) {
        setAnalysisStreamState('polling', t('logs.stream_polling'));
        loadLogs({ replace: true, skipStats: true });
        _analysisTimer = setInterval(() => {
          if (_tab === 'logs' && _analysisAutoRefreshEnabled()) loadLogs({ replace: true, skipStats: true });
        }, 3000);
        return;
      }
      setAnalysisStreamState('connecting', t('logs.stream_connecting'));
      const src = new EventSource(_analysisUrl('/api/analysis_log_stream', 220));
      _analysisSource = src;
      src.onopen = () => setAnalysisStreamState('live', t('logs.stream_live'));
      src.onmessage = (ev) => {
        if (_analysisSource !== src) return;
        try {
          const d = JSON.parse(ev.data || '{}');
          if (d.error) {
            setAnalysisStreamState('disconnected', t('logs.stream_disconnected'));
            return;
          }
          const incoming = Array.isArray(d.entries) ? d.entries : [];
          if (_analysisExpectBootstrap) {
            _analysisMergeEntries(incoming, true);
            _analysisExpectBootstrap = false;
            _analysisRenderEntries();
            _analysisRenderStats(_analysisEntries);
            return;
          }
          if (_analysisMergeEntries(incoming, false)) {
            _analysisRenderEntries();
            _analysisRenderStats(_analysisEntries);
          }
        } catch (e) { }
      };
      src.onerror = () => {
        if (_analysisSource !== src) return;
        stopAnalysisLogRealtime();
        if (_analysisAutoRefreshEnabled() && _tab === 'logs') {
          setAnalysisStreamState('polling', t('logs.stream_polling'));
          loadLogs({ replace: true, skipStats: true });
          _analysisTimer = setInterval(() => {
            if (_tab === 'logs' && _analysisAutoRefreshEnabled()) loadLogs({ replace: true, skipStats: true });
          }, 3000);
        } else {
          setAnalysisStreamState('paused', t('logs.stream_paused'));
        }
      };
    }

    function loadLogs(opts) {
      const o = opts || {};
      const replace = o.replace !== false;
      const skipStats = !!o.skipStats;
      const url = _analysisUrl('/api/analysis_log', 200);
      return jx(url).then(d => {
        _analysisMergeEntries(d.entries || [], replace);
        _analysisRenderEntries();
        if (!skipStats) _analysisRenderStats(_analysisEntries);
        return d;
      }).catch(e => {
        html('logs-container', `<div class="empty">${esc(t('logs.load_error'))}: ${esc(e && e.message || 'unknown')}</div>`);
        if (!_analysisSource && _analysisAutoRefreshEnabled()) setAnalysisStreamState('polling', t('logs.stream_polling'));
        return null;
      });
    }

    // ─── Log Stats ───
    function loadLogStats() {
      if (_analysisEntries.length) {
        _analysisRenderStats(_analysisEntries);
        return Promise.resolve();
      }
      return jx(_analysisUrl('/api/analysis_log', 500))
        .then(d => _analysisRenderStats(d.entries || []))
        .catch(() => html('log-stats', `<div class="text-muted">${esc(t('log.unavailable'))}</div>`));
    }

    // ─── Log Auto-Refresh ───
    function _analysisAutoRefreshEnabled() {
      const cb = $('log-autorefresh');
      return !cb || cb.checked;
    }
    function toggleLogAutoRefresh() {
      if (_analysisAutoRefreshEnabled()) {
        if (_tab === 'logs') {
          startAnalysisLogRealtime(true);
          _runTabLoader('logs', AUTO_LOADERS.logs, 'manual', true);
        }
      } else {
        stopAnalysisLogRealtime();
        setAnalysisStreamState('paused', t('logs.stream_paused'));
      }
      _updateAutoSyncBadge();
    }

    // ─── Log AI Chat ───
    function sendLogChat() {
      const inp = $('log-chat-input');
      if (!inp) return;
      const txt = inp.value.trim();
      if (!txt) return;
      inp.value = '';
      const msgs = $('log-chat-messages');
      // Add user message
      msgs.innerHTML += `<div style="text-align:right"><div style="display:inline-block;background:var(--accent);color:#fff;padding:6px 12px;border-radius:12px 12px 2px 12px;font-size:13px;max-width:85%">${esc(txt)}</div></div>`;
      // Add typing indicator
      msgs.innerHTML += `<div id="log-typing" style="text-align:left"><div style="display:inline-block;background:var(--surface2,#F1F5F9);padding:6px 12px;border-radius:12px 12px 12px 2px;font-size:13px;color:var(--fg-muted)">Thinking...</div></div>`;
      msgs.scrollTop = msgs.scrollHeight;
      // Build context with recent log entries
      const model = $('log-chat-model')?.value || 'glm-5';
      const ctxMsg = '[NEXUS Research Assistant] You are analyzing the research log. Answer based on the findings below.\nUSER: ' + txt;
      jx('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: ctxMsg, raw_user: txt, model: model }) }).then(d => {
        const el = $('log-typing'); if (el) el.remove();
        const resp = d.response || d.reply || d.message || '(no response)';
        let formatted = esc(resp).replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<b>$1</b>').replace(/`(.+?)`/g, '<code style="background:var(--border);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>');
        msgs.innerHTML += `<div style="text-align:left"><div style="display:inline-block;background:var(--surface2,#F1F5F9);padding:8px 12px;border-radius:12px 12px 12px 2px;font-size:13px;max-width:85%;line-height:1.5">${formatted}</div><div style="font-size:10px;color:var(--fg-light);margin-top:2px">${esc(model)} · ${new Date().toLocaleTimeString()}</div></div>`;
        msgs.scrollTop = msgs.scrollHeight;
      }).catch(e => {
        const el = $('log-typing'); if (el) el.remove();
        msgs.innerHTML += `<div style="text-align:left"><div style="display:inline-block;background:var(--red-light);color:var(--red);padding:6px 12px;border-radius:12px;font-size:13px">Error: ${esc(e.message)}</div></div>`;
        msgs.scrollTop = msgs.scrollHeight;
      });
    }

    // ─── Add Log Note ───
    function addLogNote() {
      const note = prompt('Add a research note:');
      if (!note || !note.trim()) return;
      jx('/api/analysis_log', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'analysis', source: 'user', title: 'User Note', content: note.trim(), tags: ['user-note'] }) }).then(() => {
        toast('Note added');
        loadLogs({ replace: true, skipStats: false });
        if (_analysisAutoRefreshEnabled()) startAnalysisLogRealtime(true);
      }).catch(e => toast('Error: ' + e.message));
    }

    // ── Live Trading Engine ─────────────────────────────────────
    async function refreshLiveStatus() {
      try {
        const r = await fetch('/api/live/status');
        const d = await r.json();

        // Status cards
        const statusEl = document.getElementById('le-status');
        if (d.risk_halted) {
          statusEl.innerHTML = '<span style="color:#DC2626;font-weight:700">HALTED</span>';
        } else if (d.total_cycles > 0) {
          statusEl.innerHTML = '<span style="color:#16A34A">ACTIVE</span>';
        } else {
          statusEl.textContent = 'IDLE';
        }

        const balEl = document.getElementById('le-balance');
        balEl.textContent = d.last_cycle && d.last_cycle.balance_usd
          ? '$' + d.last_cycle.balance_usd.toLocaleString(undefined, {minimumFractionDigits:2})
          : (d.api_key_set ? '(fetching)' : 'No API key');

        const riskEl = document.getElementById('le-risk');
        if (d.risk_halted) {
          riskEl.innerHTML = '<span style="color:#DC2626">HALTED</span>';
        } else {
          riskEl.innerHTML = '<span style="color:#16A34A">OK</span>';
        }

        document.getElementById('le-cycles').textContent = d.total_cycles || 0;

        // Risk state detail
        const riskDetail = document.getElementById('le-risk-detail');
        if (d.risk_state) {
          const rs = d.risk_state;
          let html = '<table style="width:100%;border-collapse:collapse">';
          html += `<tr><td>Peak Equity</td><td style="text-align:right">$${(rs.peak_equity||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
          html += `<tr><td>Last Balance</td><td style="text-align:right">$${(rs.last_balance||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
          html += `<tr><td>Losing Streak</td><td style="text-align:right">${rs.consecutive_losing_days||0} days</td></tr>`;
          html += `<tr><td>Halted</td><td style="text-align:right">${rs.halted ? '<span style="color:#DC2626">YES</span>' : '<span style="color:#16A34A">NO</span>'}</td></tr>`;
          if (rs.halt_reason) html += `<tr><td>Reason</td><td style="text-align:right;color:#DC2626">${rs.halt_reason}</td></tr>`;
          const dailyRets = rs.daily_returns || [];
          if (dailyRets.length > 0) {
            html += `<tr><td colspan="2" style="border-top:1px solid var(--border);padding-top:8px;font-weight:600">Daily Returns (last ${dailyRets.length}d)</td></tr>`;
            for (const dr of dailyRets.slice(-7)) {
              const c = dr.return >= 0 ? '#16A34A' : '#DC2626';
              html += `<tr><td>${dr.date}</td><td style="text-align:right;color:${c}">${(dr.return*100).toFixed(3)}%</td></tr>`;
            }
          }
          html += '</table>';
          riskDetail.innerHTML = html;
        } else {
          riskDetail.textContent = 'No risk state — engine has not run yet.';
        }

        // Last cycle detail
        const lastEl = document.getElementById('le-last-cycle');
        if (d.last_cycle) {
          const lc = d.last_cycle;
          let html = '<table style="width:100%;border-collapse:collapse">';
          html += `<tr><td>Time</td><td style="text-align:right">${lc.timestamp || '?'}</td></tr>`;
          html += `<tr><td>Status</td><td style="text-align:right;font-weight:600">${lc.status || '?'}</td></tr>`;
          if (lc.balance_usd) html += `<tr><td>Balance</td><td style="text-align:right">$${lc.balance_usd.toLocaleString()}</td></tr>`;
          if (lc.signal) {
            html += `<tr><td>Vol Tilt</td><td style="text-align:right">${lc.signal.vol_tilt_active ? '<span style="color:#DC2626">ACTIVE</span>' : '<span style="color:#16A34A">OFF</span>'} (z=${lc.signal.vol_tilt_z})</td></tr>`;
            html += `<tr><td>Gross Lev.</td><td style="text-align:right">${lc.signal.gross_leverage}</td></tr>`;
          }
          if (lc.rebalance) {
            html += `<tr><td>Orders</td><td style="text-align:right">${lc.rebalance.orders_executed}/${lc.rebalance.orders_planned}</td></tr>`;
            html += `<tr><td>Turnover</td><td style="text-align:right">$${(lc.rebalance.turnover_usd||0).toLocaleString()}</td></tr>`;
            if (lc.rebalance.errors && lc.rebalance.errors.length > 0) {
              html += `<tr><td colspan="2" style="color:#DC2626">${lc.rebalance.errors.join('; ')}</td></tr>`;
            }
          }
          if (lc.elapsed_seconds) html += `<tr><td>Elapsed</td><td style="text-align:right">${lc.elapsed_seconds}s</td></tr>`;
          html += '</table>';
          lastEl.innerHTML = html;
        } else {
          lastEl.textContent = 'No cycles recorded yet.';
        }

        // Recent cycle history
        document.getElementById('le-cycle-count').textContent = d.total_cycles || 0;
        const histEl = document.getElementById('le-cycle-history');
        if (d.recent_cycles && d.recent_cycles.length > 0) {
          let html = '<table style="width:100%;border-collapse:collapse">';
          html += '<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left">Time</th><th>Status</th><th style="text-align:right">Balance</th><th style="text-align:right">Orders</th><th style="text-align:right">Turnover</th></tr>';
          for (const c of d.recent_cycles.reverse()) {
            const sc = c.status === 'ok' ? '#16A34A' : c.status === 'halted' ? '#DC2626' : '#F59E0B';
            const bal = c.balance_usd ? '$' + c.balance_usd.toLocaleString() : '—';
            const orders = c.rebalance ? `${c.rebalance.orders_executed}/${c.rebalance.orders_planned}` : '—';
            const turn = c.rebalance ? '$' + (c.rebalance.turnover_usd||0).toLocaleString() : '—';
            const ts = c.timestamp ? c.timestamp.substring(0, 19) : '?';
            html += `<tr><td class="text-sm">${ts}</td><td style="color:${sc};font-weight:600;text-align:center">${c.status}</td>`;
            html += `<td style="text-align:right">${bal}</td><td style="text-align:right">${orders}</td><td style="text-align:right">${turn}</td></tr>`;
          }
          html += '</table>';
          histEl.innerHTML = html;
        } else {
          histEl.textContent = 'No cycles yet. Start the engine with: python3 -m nexus_quant live --dry-run';
        }
      } catch (e) {
        console.error('Live engine status error:', e);
      }
    }

    async function resetRiskHalt() {
      if (!confirm('Reset risk halt? This will allow trading to resume.')) return;
      try {
        const r = await fetch('/api/live/risk_reset', { method: 'POST' });
        const d = await r.json();
        alert(d.message || d.error || 'Done');
        refreshLiveStatus();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // ── Live Signals (Paper Trading) ─────────────────────────────
    async function loadSignals() {
      try {
        const [latestRes, execRes, histRes] = await Promise.all([
          fetch('/api/signals/latest'),
          fetch('/api/executor/status'),
          fetch('/api/signals/history?n=20')
        ]);
        const d = await latestRes.json();
        const exec = await execRes.json();
        const hist = await histRes.json();
        const sig = d.signal;
        const paper = d.paper;

        // Paper summary
        if (paper) {
          const pnl = paper.equity - 100000;
          const pnlPct = (pnl / 100000 * 100).toFixed(2);
          const color = pnl >= 0 ? '#16A34A' : '#DC2626';
          document.getElementById('sig-equity').textContent = '$' + paper.equity.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
          document.getElementById('sig-pnl').innerHTML = `<span style="color:${color}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPct}%)</span>`;
        }

        if (!sig) {
          document.getElementById('sig-weights').textContent = 'No signal generated yet. Click "Generate Signal" to start.';
          document.getElementById('sig-trades').textContent = '—';
          document.getElementById('sig-exec-status').textContent = '—';
          document.getElementById('sig-history').textContent = 'No signals yet.';
          return;
        }

        // Vol tilt
        const vtEl = document.getElementById('sig-voltilt');
        if (sig.vol_tilt_active) {
          vtEl.innerHTML = `<span style="color:#DC2626">ACTIVE (z=${sig.vol_tilt_z_score.toFixed(2)})</span>`;
        } else {
          vtEl.innerHTML = `<span style="color:#16A34A">OFF (z=${sig.vol_tilt_z_score.toFixed(2)})</span>`;
        }
        document.getElementById('sig-leverage').textContent = sig.gross_leverage.toFixed(4);

        // Target weights
        const wEntries = Object.entries(sig.target_weights)
          .filter(([,w]) => Math.abs(w) > 0.001)
          .sort((a,b) => Math.abs(b[1]) - Math.abs(a[1]));
        let wHtml = '<table style="width:100%;border-collapse:collapse">';
        wHtml += '<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left">Symbol</th><th style="text-align:right">Weight</th><th style="text-align:center">Side</th></tr>';
        for (const [sym, w] of wEntries) {
          const side = w > 0 ? '<span style="color:#16A34A">LONG</span>' : '<span style="color:#DC2626">SHORT</span>';
          wHtml += `<tr><td>${sym}</td><td style="text-align:right">${w > 0 ? '+' : ''}${w.toFixed(4)}</td><td style="text-align:center">${side}</td></tr>`;
        }
        wHtml += '</table>';
        document.getElementById('sig-weights').innerHTML = wHtml;

        // Trades needed
        if (sig.trades_needed && sig.trades_needed.length > 0) {
          let tHtml = '<table style="width:100%;border-collapse:collapse">';
          tHtml += '<tr style="border-bottom:1px solid var(--border)"><th>Dir</th><th>Symbol</th><th style="text-align:right">Delta</th><th style="text-align:right">Notional</th></tr>';
          for (const t of sig.trades_needed) {
            const dirColor = t.direction === 'BUY' ? '#16A34A' : '#DC2626';
            tHtml += `<tr><td style="color:${dirColor};font-weight:600">${t.direction}</td><td>${t.symbol}</td>`;
            tHtml += `<td style="text-align:right">${t.delta > 0 ? '+' : ''}${t.delta.toFixed(4)}</td>`;
            tHtml += `<td style="text-align:right">$${t.notional_usd.toLocaleString()}</td></tr>`;
          }
          tHtml += '</table>';
          document.getElementById('sig-trades').innerHTML = tHtml;
        } else {
          document.getElementById('sig-trades').textContent = 'No trades needed (positions unchanged)';
        }

        // Sub-strategy breakdown
        if (sig.sub_signals) {
          let sHtml = '<table style="width:100%;border-collapse:collapse">';
          sHtml += '<tr style="border-bottom:1px solid var(--border)"><th>Signal</th>';
          const syms = Object.keys(sig.target_weights).filter(s => Math.abs(sig.target_weights[s]) > 0.001);
          for (const s of syms) sHtml += `<th style="text-align:right">${s.replace('USDT','')}</th>`;
          sHtml += '</tr>';
          for (const [sigName, weights] of Object.entries(sig.sub_signals)) {
            sHtml += `<tr><td style="font-weight:600">${sigName}</td>`;
            for (const s of syms) {
              const w = weights[s] || 0;
              const c = w > 0 ? '#16A34A' : w < 0 ? '#DC2626' : '#888';
              sHtml += `<td style="text-align:right;color:${c}">${w.toFixed(3)}</td>`;
            }
            sHtml += '</tr>';
          }
          sHtml += '</table>';
          document.getElementById('sig-subs').innerHTML = sHtml;
        }

        // Execution status
        const execEl = document.getElementById('sig-exec-status');
        const keyIcon = exec.api_key_set ? '🟢' : '🔴';
        const modIcon = exec.executor_available ? '🟢' : '🔴';
        let exHtml = '<table style="width:100%;border-collapse:collapse">';
        exHtml += `<tr><td>Executor module</td><td style="text-align:right">${modIcon} ${exec.executor_available ? 'Available' : 'Not loaded'}</td></tr>`;
        exHtml += `<tr><td>Binance API key</td><td style="text-align:right">${keyIcon} ${exec.api_key_set ? 'Set' : 'Not set'}</td></tr>`;
        exHtml += `<tr><td>Execution log</td><td style="text-align:right">${exec.execution_log_entries} entries</td></tr>`;
        exHtml += `<tr><td>Runner log</td><td style="text-align:right">${exec.runner_log_entries} entries</td></tr>`;
        if (exec.last_cycle) {
          const cyTs = new Date(exec.last_cycle.timestamp).toLocaleString();
          const cyMode = exec.last_cycle.mode || '—';
          exHtml += `<tr><td>Last cycle</td><td style="text-align:right">${cyMode} @ ${cyTs}</td></tr>`;
        }
        exHtml += '</table>';
        execEl.innerHTML = exHtml;

        // Signal history
        document.getElementById('sig-count').textContent = hist.total || 0;
        const histEl = document.getElementById('sig-history');
        if (hist.signals && hist.signals.length > 0) {
          let hHtml = '<table style="width:100%;border-collapse:collapse">';
          hHtml += '<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left">Time</th><th style="text-align:right">Bar</th><th style="text-align:right">Gross Lev</th><th style="text-align:center">Vol Tilt</th><th style="text-align:right">Net Exp</th><th style="text-align:right">Trades</th></tr>';
          for (const s of hist.signals) {
            const hts = new Date(s.timestamp).toLocaleString(undefined, {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            const bar = s.meta?.last_bar_utc ? new Date(s.meta.last_bar_utc).toLocaleString(undefined, {month:'short',day:'numeric',hour:'2-digit'}) : '—';
            const vt = s.vol_tilt_active ? '<span style="color:#DC2626">ON</span>' : '<span style="color:#16A34A">OFF</span>';
            const net = (s.net_exposure || 0).toFixed(4);
            const nTrades = (s.trades_needed || []).length;
            hHtml += `<tr><td>${hts}</td><td style="text-align:right">${bar}</td><td style="text-align:right">${(s.gross_leverage||0).toFixed(4)}</td><td style="text-align:center">${vt}</td><td style="text-align:right">${net}</td><td style="text-align:right">${nTrades}</td></tr>`;
          }
          hHtml += '</table>';
          histEl.innerHTML = hHtml;
        } else {
          histEl.innerHTML = '<div class="text-muted">No signal history yet. Generate your first signal above.</div>';
        }

        // Signal health monitor
        try {
          const healthRes = await fetch('/api/signals/health');
          const hd = await healthRes.json();
          const healthEl = document.getElementById('sig-health');
          if (hd.available && hd.health) {
            let hHtml = '<table style="width:100%;border-collapse:collapse">';
            hHtml += '<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left">Signal</th><th>Status</th><th style="text-align:right">Avg Sharpe</th><th style="text-align:right">Recent (24-25)</th><th style="text-align:right">Trend</th><th style="text-align:right">Weight</th></tr>';
            for (const [sk, info] of Object.entries(hd.health)) {
              const sc = info.status === 'HEALTHY' ? '#16A34A' : info.status === 'DECLINING' ? '#F59E0B' : '#DC2626';
              const icon = info.status === 'HEALTHY' ? '🟢' : info.status === 'DECLINING' ? '🟡' : '🔴';
              hHtml += `<tr>`;
              hHtml += `<td style="font-weight:600">${sk}</td>`;
              hHtml += `<td style="color:${sc}">${icon} ${info.status}</td>`;
              hHtml += `<td style="text-align:right">${info.avg_sharpe_all.toFixed(3)}</td>`;
              hHtml += `<td style="text-align:right">${info.avg_sharpe_recent.toFixed(3)}</td>`;
              hHtml += `<td style="text-align:right;color:${info.trend_pct >= 0 ? '#16A34A' : '#DC2626'}">${info.trend_pct >= 0 ? '+' : ''}${info.trend_pct.toFixed(1)}%</td>`;
              hHtml += `<td style="text-align:right">${((hd.current_weights || {})[sk] || 0).toFixed(1)}%</td>`;
              hHtml += '</tr>';
            }
            if (hd.contributions) {
              const years = Object.keys(hd.contributions).sort();
              hHtml += '<tr style="border-top:2px solid var(--border)"><td colspan="6" style="font-weight:600;padding-top:8px">Ensemble Sharpe by Year</td></tr>';
              for (const y of years) {
                const c = hd.contributions[y];
                if (c && c.ensemble_sharpe !== undefined) {
                  hHtml += `<tr><td>${y}</td><td colspan="5" style="text-align:right;font-weight:600">${c.ensemble_sharpe.toFixed(3)}</td></tr>`;
                }
              }
            }
            hHtml += '</table>';
            if (hd.alerts && hd.alerts.length > 0) {
              hHtml += '<div style="margin-top:8px;padding:6px 10px;background:var(--red-light);border-radius:6px;color:var(--red)">';
              for (const a of hd.alerts) hHtml += `<div>${a}</div>`;
              hHtml += '</div>';
            }
            healthEl.innerHTML = hHtml;
          } else {
            healthEl.textContent = hd.message || 'No health report available. Run Phase 123 analysis.';
          }
        } catch (e) { /* health is optional */ }

      } catch (e) {
        console.error('loadSignals error:', e);
      }
    }

    async function generateNewSignal() {
      const btn = document.getElementById('btn-gen-signal');
      btn.disabled = true;
      btn.textContent = 'Generating...';
      try {
        const r = await fetch('/api/signals/generate', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
          toast('Signal generated successfully', 3);
          await loadSignals();
        } else {
          toast('Error: ' + (d.error || 'unknown'), 5);
        }
      } catch (e) {
        toast('Network error: ' + e.message, 5);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Signal';
      }
    }

    const LOADERS = {
      overview: loadOv, chat: loadChat, benchmark: loadBM, performance: loadPerf,
      risk: loadRisk, research: loadResearch, tasks: loadTasks, files: loadFiles, market: loadMarket, pitch: loadPitch,
      signals: loadSignals,
      'live-engine': refreshLiveStatus,
      'track-record': loadTrackRecord,
      logs: () => { loadLogs({ replace: true, skipStats: false }); startAnalysisLogRealtime(false); },
      console: () => refreshConsole({ includeLogs: true, forceLogRefresh: true, forceStream: true })
    };

    const TAB_REFRESH_MS = {
      overview: 12000,
      chat: 16000,
      benchmark: 30000,
      performance: 30000,
      risk: 14000,
      research: 12000,
      tasks: 10000,
      files: 30000,
      market: 8000,
      pitch: 30000,
      signals: 60000,
      'live-engine': 15000,
      'track-record': 300000,
      logs: 8000,
      console: 2500,
    };

    const AUTO_LOADERS = {
      overview: loadOv,
      chat: loadChatMetrics,
      benchmark: loadBM,
      performance: loadPerf,
      risk: loadRisk,
      research: loadResearch,
      tasks: loadTasks,
      files: loadFiles,
      market: loadMarket,
      pitch: loadPitch,
      signals: loadSignals,
      'live-engine': refreshLiveStatus,
      logs: () => {
        if (!_analysisAutoRefreshEnabled()) {
          stopAnalysisLogRealtime();
          setAnalysisStreamState('paused', t('logs.stream_paused'));
          return;
        }
        startAnalysisLogRealtime(false);
        loadLogStats();
      },
      console: () => refreshConsole({ includeLogs: false }),
    };

    function _effectiveTabIntervalMs(tab) {
      const base = TAB_REFRESH_MS[tab] || 30000;
      if (document.hidden) return Math.round(base * 2.5);
      if (!APP_STATE.liveConnected && tab !== 'console' && tab !== 'logs') return Math.round(base * 1.25);
      return base;
    }

    function _tabLabel(tab) {
      const key = 'tab.' + String(tab || '');
      const label = t(key);
      return label === key ? String(tab || '') : label;
    }

    function _tabElement(tab) {
      const idx = TABS.indexOf(tab);
      if (idx < 0) return null;
      return $$('.tab')[idx] || null;
    }

    function _tabIndicatorState(tab) {
      const st = _tabState(tab);
      if (!st.lastStartAt && !st.lastSuccessAt && !st.lastErrorAt) {
        if (tab === _tab && (st.running || st.pending > 0)) return 'loading';
        return '';
      }
      const ageMs = st.lastSuccessAt ? (Date.now() - st.lastSuccessAt) : Infinity;
      const healthyMs = _effectiveTabIntervalMs(tab) * 2;
      if (tab === _tab && (st.running || st.pending > 0)) return 'loading';
      if (st.lastErrorAt && (!st.lastSuccessAt || st.lastErrorAt > st.lastSuccessAt) && Date.now() - st.lastErrorAt < 120000) return 'stale';
      if (st.lastSuccessAt && ageMs <= healthyMs) return 'live';
      return 'stale';
    }

    function _updateTabIndicators() {
      TABS.forEach(tab => {
        const el = _tabElement(tab);
        if (!el) return;
        el.classList.remove('live', 'loading', 'stale');
        const cls = _tabIndicatorState(tab);
        if (cls) el.classList.add(cls);
      });
      if (typeof updateTabFocusStatus === 'function') updateTabFocusStatus();
    }

    function _updateGlobalLoader() {
      const el = $('global-loader');
      if (!el) return;
      if (_globalPending > 0) el.classList.add('active');
      else el.classList.remove('active');
    }

    function _updateAutoSyncBadge() {
      const el = $('auto-sync-badge');
      if (!el) return;
      const st = _tabState(_tab);
      let cls = 'bg-gray';
      let msg = t('status.waiting_first_sync', { tab: _tabLabel(_tab) });
      if (!_isTabAutoEnabled(_tab)) {
        cls = 'bg-y';
        msg = t('status.auto_paused');
      } else if (st.running || st.pending > 0) {
        cls = 'bg-b';
        msg = t('status.syncing_tab', { tab: _tabLabel(_tab) });
      } else if (st.lastSuccessAt) {
        const ageSec = Math.max(0, Math.round((Date.now() - st.lastSuccessAt) / 1000));
        const nextSec = Math.max(0, Math.round((_effectiveTabIntervalMs(_tab) - (Date.now() - (st.lastStartAt || 0))) / 1000));
        cls = ageSec <= Math.ceil((_effectiveTabIntervalMs(_tab) / 1000) * 2) ? 'bg-g' : 'bg-y';
        msg = t('status.synced_tab', { tab: _tabLabel(_tab), age: ageSec });
        if (nextSec > 0) msg += ` · ${t('status.next_in', { n: nextSec })}`;
        if (st.lastErrorAt && st.lastErrorAt > st.lastSuccessAt && Date.now() - st.lastErrorAt < 120000) {
          cls = 'bg-y';
          msg += ` · ${t('status.retrying')}`;
        }
      }
      if (document.hidden) msg += ` · ${t('status.hidden_mode')}`;
      el.className = 'bdg ' + cls;
      el.textContent = msg;
      if (typeof updateTabFocusStatus === 'function') updateTabFocusStatus();
    }

    function _drainTabQueue(tab) {
      const st = _tabState(tab);
      if (st.pending > 0) return;
      if (st.running) {
        st.running = false;
        st.lastEndAt = Date.now();
        if ((!st.lastSuccessAt || st.lastSuccessAt < st.lastStartAt) && (!st.lastErrorAt || st.lastErrorAt < st.lastStartAt)) {
          st.lastSuccessAt = st.lastEndAt;
        }
      }
      if (st.queuedLoader) {
        const loader = st.queuedLoader;
        const reason = st.queuedReason || 'queued';
        st.queuedLoader = null;
        st.queuedReason = '';
        _runTabLoader(tab, loader, reason, true);
      }
    }

    function _runTabLoader(tab, loader, reason = 'auto', force = false) {
      if (typeof loader !== 'function') return false;
      const st = _tabState(tab);
      const nowTs = Date.now();
      const minGap = reason === 'auto' ? 1200 : 250;
      if (!force && st.lastStartAt && nowTs - st.lastStartAt < minGap) return false;
      if (st.running || st.pending > 0) {
        if (force || reason !== 'auto') {
          st.queuedLoader = loader;
          st.queuedReason = reason;
        }
        _updateAutoSyncBadge();
        return false;
      }
      st.running = true;
      st.lastStartAt = nowTs;
      st.lastReason = reason;
      _activeTabHint = tab;
      _updateTabIndicators();
      _updateAutoSyncBadge();
      try {
        _withLoaderCtx(tab, () => loader());
      } catch (e) {
        st.lastErrorAt = Date.now();
        st.running = false;
      }
      if (st.pending === 0) {
        st.running = false;
        st.lastEndAt = Date.now();
        if ((!st.lastSuccessAt || st.lastSuccessAt < st.lastStartAt) && (!st.lastErrorAt || st.lastErrorAt < st.lastStartAt)) {
          st.lastSuccessAt = st.lastEndAt;
        }
      }
      _updateTabIndicators();
      _updateAutoSyncBadge();
      return true;
    }

    function _isTabAutoEnabled(tab) {
      if (tab === 'logs') return _analysisAutoRefreshEnabled();
      return true;
    }

    function _tickTabRealtime(force = false) {
      const tab = _tab || 'overview';
      const st = _tabState(tab);
      const loader = AUTO_LOADERS[tab] || LOADERS[tab];
      const due = force || !st.lastStartAt || (Date.now() - st.lastStartAt) >= _effectiveTabIntervalMs(tab);
      if (_isTabAutoEnabled(tab) && due && loader) _runTabLoader(tab, loader, 'auto', force);
      _updateTabIndicators();
      _updateAutoSyncBadge();
    }

    function _initRealtimeManager() {
      if (APP_STATE.tabHeartbeatTimer) clearInterval(APP_STATE.tabHeartbeatTimer);
      APP_STATE.tabHeartbeatTimer = setInterval(() => _tickTabRealtime(false), 1000);
      document.addEventListener('visibilitychange', () => _tickTabRealtime(!document.hidden));
      window.addEventListener('focus', () => _tickTabRealtime(true));
      _tickTabRealtime(true);
    }

    // ─── Manual refresh ───
    function refresh() {
      loadKPI();
      if (LOADERS[_tab]) _runTabLoader(_tab, LOADERS[_tab], 'manual', true);
    }

    // ─── SSE live stream ───
    let _sseRetry = 0;
    function _connectSSE() {
      setLiveStatus('connecting', t('status.connecting'));
      APP_STATE.liveConnected = false;
      const src = new EventSource('/api/stream');
      src.onopen = () => {
        _sseRetry = 0;
        APP_STATE.liveConnected = true;
        APP_STATE.liveSeenAt = Date.now();
        setLiveStatus('connected', t('status.live'));
      };
      src.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          if (d.error) return;
          APP_STATE.liveSeenAt = Date.now();
          // Update header KPIs with animation
          if (d.sharpe != null) {
            animateKpiText('k-sharpe', n2(d.sharpe), 'kpi-v ' + (d.sharpe >= 1.5 ? 'pos' : d.sharpe >= 0.6 ? 'neu' : 'neg'));
            setHeaderChip('hc-sharpe', `${t('chip.sharpe')} ${n2(d.sharpe)}`, d.sharpe >= 1.5 ? 'pos' : d.sharpe >= 0.6 ? 'neu' : 'neg');
            updateMvpSummary({ sharpe: d.sharpe });
          }
          if (d.mdd != null) {
            animateKpiText('k-mdd', pct(d.mdd), 'kpi-v neg');
            updateMvpSummary({ mdd: d.mdd });
          }
          if (d.latest_equity != null) {
            const r = d.latest_equity - 1;
            animateKpiText('k-tot', pct(r), 'kpi-v ' + (r >= 0 ? 'pos' : 'neg'));
            setHeaderChip('hc-pnl', `${t('chip.pnl')} ${pct(r)}`, r >= 0 ? 'pos' : 'neg');
            updateMvpSummary({ total_return: r });
          }
          // Update header badge
          if (d.verdict != null) {
            const v = d.verdict ? 'PASS' : 'FAIL';
            const vLabel = localizeVerdict(v);
            const b = $('hdr-badge'); if (b) { b.textContent = vLabel; b.className = 'bdg ' + (v === 'PASS' ? 'bg-g' : 'bg-r'); }
            setHeaderChip('hc-status', `${t('chip.status')} ${vLabel}`, v === 'PASS' ? 'pos' : 'neg');
            updateMvpSummary({ verdict_label: vLabel });
          }
          // Live progress indicator
          if (d.active_run) {
            APP_STATE.activeRun = d.active_run;
            const pill = $('bt-progress');
            if (pill) { pill.classList.remove('idle'); set('bt-progress-text', d.active_run); }
            setLiveStatus('connected', d.active_run);
          } else if (APP_STATE.activeRun) {
            APP_STATE.activeRun = null;
            const pill = $('bt-progress');
            if (pill) { pill.classList.add('idle'); set('bt-progress-text', t('status.no_active_backtest')); }
            setLiveStatus('connected', t('status.live'));
          }
          updateMvpSummary();
          // Push SSE events into chat feed
          if (d.event || d.kind) {
            chatSseEvents.unshift(d);
            if (chatSseEvents.length > 5) chatSseEvents.length = 5;
            renderSSEFeed();
          }
          // Update overview ledger if on overview tab
          if (_tab === 'overview' && d.ledger_tail && d.ledger_tail.length) {
            _updateLiveLedger(d.ledger_tail);
          }
          // Update equity tail chart
          if (_tab === 'overview' && d.equity_tail && d.equity_tail.length && _eq) {
            _updateEquityTail(d.equity_tail);
          }
          // Learning progress update
          if (d.learning_velocity != null) {
            const lv = $('live-lv'); if (lv) lv.textContent = (d.learning_velocity * 100).toFixed(1) + '%';
          }
          set('kpi-updated', t('status.live_dot', { time: now() }));
        } catch (e) { }
      };
      src.onerror = () => {
        APP_STATE.liveConnected = false;
        setLiveStatus('connecting', t('status.reconnecting'));
        src.close();
        _sseRetry = Math.min(_sseRetry + 1, 5);
        setTimeout(_connectSSE, Math.pow(2, _sseRetry) * 1000);
      };
    }

    function _updateLiveLedger(events) {
      const el = $('ov-ledger'); if (!el) return;
      const rows = events.slice(0, 8).map(e => {
        const v = e.verdict;
        const badge = v === true ? '<span class="bdg bg-g">PASS</span>' : v === false ? '<span class="bdg bg-r">FAIL</span>' : '';
        return `<tr><td class="text-sm text-muted">${esc(e.ts || '').slice(11, 19)}</td><td>${esc(e.kind || '')}</td><td class="text-sm">${esc((e.run_name || '').slice(0, 20))}</td><td>${badge}</td></tr>`;
      }).join('');
      el.innerHTML = `<table><thead><tr><th>Time</th><th>Kind</th><th>Run</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function _updateEquityTail(tail) {
      if (!_eq || !tail.length) return;
      const vals = tail.map(e => typeof e === 'number' ? e : +e);
      _eq.data.datasets[0].data = vals;
      _eq.data.labels = vals.map((_, i) => i);
      _eq.update('none');
    }

    // ─── Multi-Model Debate ───
    let _debateMode = false;

    function toggleDebateMode() {
      _debateMode = !_debateMode;
      const btn = $('debate-toggle-btn');
      const banner = $('debate-banner');
      const ta = $('chat-in');
      if (_debateMode) {
        if (btn) { btn.classList.add('debate-btn-active'); btn.textContent = '⚔️ Debate ON'; }
        if (banner) banner.style.display = 'block';
        if (ta) ta.placeholder = 'Ask any question — all 4 models will analyze + debate + synthesize (30-60s)...';
      } else {
        if (btn) { btn.classList.remove('debate-btn-active'); btn.textContent = '⚔️ Debate'; }
        if (banner) banner.style.display = 'none';
        if (ta) ta.placeholder = 'Ask NEXUS anything... (Enter to send, Shift+Enter for newline)';
      }
    }

    function modelTag(model) {
      const m = (model || '').toLowerCase();
      if (m.includes('glm')) return `<span class="debate-model-tag tag-glm">🧠 SAGE (GLM-5)</span>`;
      if (m.includes('sonnet')) return `<span class="debate-model-tag tag-claude">🔵 SENTINEL (Sonnet)</span>`;
      if (m.includes('opus')) return `<span class="debate-model-tag tag-claude">🟣 NEXUS PRIME (Opus)</span>`;
      if (m.includes('claude')) return `<span class="debate-model-tag tag-claude">🔵 SENTINEL (Claude)</span>`;
      if (m.includes('codex') || m.includes('gpt')) return `<span class="debate-model-tag tag-codex">🟢 FORGE (GPT-5.2)</span>`;
      if (m.includes('gemini-cli')) return `<span class="debate-model-tag tag-gemini">💎 ORACLE-CLI (Gemini)</span>`;
      if (m.includes('gemini')) return `<span class="debate-model-tag tag-gemini">💎 ORACLE (Gemini)</span>`;
      if (m.includes('minimax')) return `<span class="debate-model-tag tag-minimax">🟠 SCOUT (MiniMax)</span>`;
      return `<span class="debate-model-tag" style="background:#f1f5f9">${escHtml(model)}</span>`;
    }

    function renderDebate(d) {
      if (!d || d.error) return `<div class="empty text-sm">Debate failed: ${escHtml(d && d.error || 'unknown error')}</div>`;
      const contribs = d.contributions || [];
      // Group by round
      const r1 = contribs.filter(c => c.round === 1 || c.round === 'analysis');
      const r2 = contribs.filter(c => c.round === 2 || c.round === 'critique');
      const conf = d.consensus_score != null ? Math.round(d.consensus_score * 100) : 50;
      const confColor = conf >= 70 ? 'var(--green)' : conf >= 40 ? 'var(--yellow)' : '#EF4444';
      let html = `<div class="debate-wrap">
    <div class="debate-header">⚔️ Multi-Model Debate &nbsp;·&nbsp; ${escHtml(d.topic || '')}
      <span class="debate-confidence" style="background:${confColor};color:#fff;float:right">Consensus: ${conf}%</span>
    </div>`;
      if (r1.length) {
        html += `<div class="debate-round"><div class="debate-round-title">Round 1 — Independent Analysis</div>`;
        r1.forEach(c => { html += `<div class="debate-contrib">${modelTag(c.model_name || c.model)}<div style="color:var(--fg);line-height:1.5;white-space:pre-wrap">${escHtml(c.content || '')}</div></div>`; });
        html += `</div>`;
      }
      if (r2.length) {
        html += `<div class="debate-round"><div class="debate-round-title">Round 2 — Cross-Critique</div>`;
        r2.forEach(c => { html += `<div class="debate-contrib">${modelTag(c.model_name || c.model)}<div style="color:var(--fg);line-height:1.5;white-space:pre-wrap">${escHtml(c.content || '')}</div></div>`; });
        html += `</div>`;
      }
      if (d.synthesis) {
        html += `<div class="debate-synthesis"><span class="debate-model-tag tag-synthesis" style="margin-bottom:6px;display:inline-block">🧩 Synthesis</span><div style="white-space:pre-wrap">${escHtml(d.synthesis)}</div></div>`;
      }
      if (d.action_items && d.action_items.length) {
        html += `<div class="debate-actions"><strong style="font-size:11px;color:var(--fg-muted);text-transform:uppercase">Action Items</strong>`;
        d.action_items.forEach((a, i) => { html += `<div class="debate-action-item">→ ${escHtml(a)}</div>`; });
        html += `</div>`;
      }
      html += `</div>`;
      return html;
    }

    function startDebate(topic) {
      const ta = $('chat-in'); if (ta) ta.value = topic;
      _debateMode = true;
      const btn = $('debate-toggle-btn'); const banner = $('debate-banner');
      if (btn) { btn.classList.add('debate-btn-active'); btn.textContent = '⚔️ Debate ON'; }
      if (banner) banner.style.display = 'block';
      sendMsg();
    }

    function loadDebateHistory() {
      jx('/api/debate_history?n=10').then(items => {
        if (!items || !items.length) { addMsg('a', 'No debate history yet. Ask a question with Debate Mode ON.'); return; }
        let html = '<strong>Recent Debates:</strong><br>';
        items.slice(0, 5).forEach((r, i) => {
          const conf = r.consensus_score != null ? Math.round(r.consensus_score * 100) + '%' : '?';
          html += `<div style="margin:6px 0;padding:6px 10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
        <div style="font-weight:600;font-size:12px">${escHtml(r.topic || '?')}</div>
        <div style="font-size:11px;color:var(--fg-muted)">Consensus: ${conf} · ${r.created_at || ''}</div>
        <div style="font-size:11px;margin-top:3px">${escHtml((r.synthesis || '').slice(0, 120))}...</div>
      </div>`;
        });
        addMsg('a', html, true);
      }).catch(() => addMsg('a', 'Debate history unavailable.'));
    }

    // sendMsg — supports both normal chat and debate mode
    function sendMsg() {
      const ta = $('chat-in');
      const msg = (ta ? ta.value.trim() : '');
      if (!msg) return;
      if (_debateMode) {
        // Debate mode: call /api/debate
        addMsg('u', msg);
        if (ta) { ta.value = ''; autoGrowTA(ta); }
        const thinkId = 'debate-thinking-' + Date.now();
        addMsg('a', `<div id="${thinkId}" style="display:flex;align-items:center;gap:8px;color:var(--fg-muted);font-size:13px">
      <div class="loading-dot"></div>
      ⚔️ Calling 4 agents in 3 rounds... (SAGE → SENTINEL → FORGE → ORACLE → Synthesis)
      <span style="font-size:11px">~30-60s</span>
    </div>`, true);
        fetch('/api/debate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic: msg, context: 'NexusAlpha P91b OOS Sharpe=1.931 (avg 6yr). Alpha=4-signal static ensemble. 2021-2026 all OOS.' })
        })
          .then(r => r.json()).then(d => {
            const el = document.getElementById(thinkId);
            const debHtml = renderDebate(d);
            if (el) { el.parentElement.innerHTML = `<div>${debHtml}</div><div class="cmsg-footer"><span class="cts">Debate · ${new Date().toLocaleTimeString()}</span><button class="copy-btn" onclick="copyBubble(this)">📋</button></div>`; }
            else { addMsg('a', debHtml, true); }
          }).catch(e => {
            const el = document.getElementById(thinkId);
            const errMsg = `Debate failed: ${escHtml(String(e))}`;
            if (el) el.parentElement.querySelector('.cbubble').innerHTML = errMsg;
            else addMsg('a', errMsg, true);
          });
        return;
      }
      // Normal mode: original sendMsg logic
      _sendMsgNormal(msg, ta);
    }

    // ─── Year Bar Chart (Overview) ───
    function renderYearBars() {
      const data = [
        { year: '2021', sharpe: 3.358, type: 'pos', tip: 'Bull market · OOS' },
        { year: '2022', sharpe: 1.782, type: 'pos', tip: 'Bear (BTC -65%) · OOS' },
        { year: '2023', sharpe: 1.480, type: 'pos', tip: 'Recovery · OOS' },
        { year: '2024', sharpe: 2.355, type: 'pos', tip: 'Bull ATH · OOS' },
        { year: '2025', sharpe: 1.782, type: 'pos', tip: 'Choppy · OOS' },
        { year: '2026', sharpe: 0.828, type: 'pos', tip: 'Crash (BTC -86%) · True OOS' },
      ];
      const maxS = 3.0;
      const el = $('year-bar-chart');
      if (!el) return;
      el.innerHTML = data.map(d => {
        const pct = Math.max(4, (d.sharpe / maxS) * 100);
        const cls = d.type === 'is' ? 'year-bar is' : 'year-bar pos';
        const valColor = d.type === 'is' ? 'var(--yellow)' : 'var(--green)';
        return `<div class="year-bar-col" title="${d.tip}">
      <div class="year-bar-val" style="color:${valColor}">${d.sharpe.toFixed(2)}</div>
      <div class="${cls}" style="height:${pct}%;"></div>
      <div class="year-bar-lbl">${d.year}${d.type === 'is' ? ' (IS)' : ''}</div>
    </div>`;
      }).join('');
    }

    // ─── Console ───
    let _logTarget = 'dashboard';
    let _logAutoRefresh = true;
    let _logTimer = null;
    let _logSource = null;
    let _logPaused = false;
    let _logBuffer = [];
    let _logLineCounter = 0;
    let _logLastPath = '';

    function escHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function colorLine(line) {
      if (/ERROR|CRITICAL|Exception|Traceback/.test(line)) return `<span class="lg-err">${escHtml(line)}</span>`;
      if (/WARNING|WARN/.test(line)) return `<span class="lg-warn">${escHtml(line)}</span>`;
      if (/INFO|started|loaded|done|success/i.test(line)) return `<span class="lg-info">${escHtml(line)}</span>`;
      if (/Sharpe|OOS|✓|✅/.test(line)) return `<span class="lg-ok">${escHtml(line)}</span>`;
      return `<span>${escHtml(line)}</span>`;
    }

    function setLogStreamState(state, label) {
      const pill = $('log-stream-state');
      const txt = $('log-stream-label');
      if (pill) {
        pill.classList.remove('connected', 'disconnected', 'paused');
        pill.classList.add(state || 'disconnected');
      }
      if (txt) txt.textContent = label || 'Disconnected';
    }

    function _isNearLogBottom() {
      const el = $('log-body');
      if (!el) return true;
      return (el.scrollHeight - el.scrollTop - el.clientHeight) < 40;
    }

    function appendLogLines(lines, replace = false) {
      const stickBottom = replace || _isNearLogBottom();
      if (replace) {
        _logBuffer = [];
        _logLineCounter = 0;
      }
      (lines || []).forEach(line => {
        _logLineCounter += 1;
        _logBuffer.push({ n: _logLineCounter, text: String(line || '') });
      });
      if (_logBuffer.length > 4000) _logBuffer = _logBuffer.slice(-4000);
      renderLogBody(stickBottom);
    }

    function renderLogBody(forceBottom) {
      const el = $('log-body');
      if (!el) return;
      const q = (($('log-search') || {}).value || '').trim().toLowerCase();
      let rows = _logBuffer;
      if (q) rows = rows.filter(r => r.text.toLowerCase().includes(q));
      const view = rows.slice(-1600);
      if (!view.length) {
        el.innerHTML = `<span class="lg-warn">${q ? t('log.no_lines_filtered') : t('log.no_lines')}</span>`;
        set('log-info', q ? `${t('log.lines')}: 0 (${t('log.filtered')})` : `${t('log.lines')}: 0`);
        set('log-updated', t('status.updated', { time: now() }));
        return;
      }
      el.innerHTML = view.map(r => `<div class="log-line"><span class="log-ln">${r.n}</span><span class="log-text">${colorLine(r.text)}</span></div>`).join('');
      if (forceBottom) el.scrollTop = el.scrollHeight;
      const suffix = q ? ` · ${t('log.filtered')}: ${view.length}` : '';
      set('log-info', `${t('log.lines')}: ${_logBuffer.length}${suffix}`);
      set('log-updated', t('status.updated', { time: now() }));
    }

    function copyVisibleLogs() {
      const q = (($('log-search') || {}).value || '').trim().toLowerCase();
      let rows = _logBuffer;
      if (q) rows = rows.filter(r => r.text.toLowerCase().includes(q));
      const text = rows.slice(-800).map(r => r.text).join('\n');
      if (!text) { toast(t('log.no_copy_data')); return; }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => toast(t('log.copied'))).catch(() => toast(t('log.copy_failed')));
        return;
      }
      toast(t('log.copy_failed'));
    }

    function stopLogRealtime() {
      if (_logSource) { _logSource.close(); _logSource = null; }
      if (_logTimer) { clearInterval(_logTimer); _logTimer = null; }
    }

    function startLogRealtime(force = false) {
      if (!force && _logSource && _logAutoRefresh && !_logPaused) return;
      stopLogRealtime();
      if (!_logAutoRefresh || _logPaused) {
        setLogStreamState('paused', _logPaused ? t('log.paused') : t('log.auto_off'));
        return;
      }
      if (!window.EventSource) {
        setLogStreamState('disconnected', t('log.polling'));
        refreshLog();
        _logTimer = setInterval(refreshLog, 3000);
        return;
      }
      setLogStreamState('disconnected', t('status.connecting'));
      const src = new EventSource(`/api/log_stream?target=${encodeURIComponent(_logTarget)}&n=220`);
      _logSource = src;
      src.onopen = () => setLogStreamState('connected', t('log.streaming'));
      src.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data || '{}');
          if (d.path) _logLastPath = d.path;
          if (d.error) {
            setLogStreamState('disconnected', t('log.disconnected'));
            return;
          }
          if (Array.isArray(d.lines) && d.lines.length) {
            appendLogLines(d.lines, false);
          } else {
            set('log-updated', t('status.updated', { time: now() }));
          }
        } catch (e) { }
      };
      src.onerror = () => {
        if (_logSource !== src) return;
        stopLogRealtime();
        if (_logAutoRefresh && !_logPaused) {
          setLogStreamState('disconnected', t('log.polling'));
          refreshLog();
          _logTimer = setInterval(refreshLog, 3000);
        } else {
          setLogStreamState('paused', t('log.paused'));
        }
      };
    }

    function refreshLog() {
      jx(`/api/log_tail?n=300&target=${_logTarget}`).then(d => {
        _logLastPath = d.path || '';
        appendLogLines(d.lines || [], true);
      }).catch(e => {
        const el = $('log-body');
        if (el) el.innerHTML = `<span class="lg-warn">${t('log.unavailable')}: ${escHtml(String(e))}</span>`;
        setLogStreamState('disconnected', t('log.unavailable'));
      });
    }

    function switchLogTab(name) {
      _logTarget = name;
      ['dashboard', 'brain', 'research', 'backtest'].forEach(t => {
        const el = $('ltab-' + t);
        if (el) el.classList[t === name ? 'add' : 'remove']('active');
      });
      _logBuffer = [];
      _logLineCounter = 0;
      renderLogBody(true);
      refreshLog();
      startLogRealtime(true);
    }

    function toggleLogAuto() {
      const cb = document.getElementById('log-auto');
      _logAutoRefresh = cb ? cb.checked : true;
      startLogRealtime(true);
    }

    function toggleLogPause() {
      _logPaused = !_logPaused;
      const btn = $('log-pause-btn');
      if (btn) btn.textContent = _logPaused ? t('log.resume') : t('log.pause');
      if (_logPaused) { setLogStreamState('paused', t('log.paused')); stopLogRealtime(); return; }
      startLogRealtime(true);
    }

    function _procDisplayName(p) {
      const target = String((p && p.target) || '').toLowerCase();
      if (target === 'dashboard') return 'Dashboard';
      if (target === 'brain') return t('console.target_brain');
      if (target === 'research') return t('console.target_research');
      if (target === 'backtest') return t('console.target_backtest');
      return p && p.name ? p.name : 'NEXUS';
    }

    function refreshConsole(opts) {
      const o = opts || {};
      const includeLogs = o.includeLogs !== false;
      const forceLogRefresh = !!o.forceLogRefresh;
      const forceStream = !!o.forceStream;
      // Processes
      jx('/api/processes').then(d => {
        const procs = d.processes || [];
        const running = procs.filter(p => String(p.status || '') === 'running').length;
        set('proc-count', running);
        updateMvpSummary({ running_processes: running });
        if (!procs.length) {
          html('proc-list', `<div class="empty text-sm">${t('console.no_processes')}</div>`); return;
        }
        html('proc-list', procs.map(p => `
      <div class="proc-item ${p.status}">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="proc-status ${p.status}"></div>
          <div>
            <div style="font-weight:600">${escHtml(_procDisplayName(p))}</div>
            <div style="font-size:10px;color:var(--fg-muted)">PID ${p.pid || '—'}</div>
          </div>
        </div>
        <div style="text-align:right;font-size:10px;color:var(--fg-muted)">
          <div>${escHtml(p.cpu_pct != null ? p.cpu_pct.toFixed(1) + '% CPU' : '')}</div>
          <div>${escHtml(p.mem_mb != null ? p.mem_mb.toFixed(0) + ' MB' : '')}</div>
        </div>
      </div>`).join(''));
      }).catch(() => html('proc-list', `<div class="empty text-sm">${t('console.proc_unavailable')}</div>`));
      // System status
      jx('/api/system_status').then(d => {
        const cpu = d.cpu_pct || 0, mem = d.mem_pct || 0, disk = d.disk_pct || 0;
        html('sys-status', `
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">CPU</span>
        <div class="sys-bar"><div class="sys-fill ${cpu > 80 ? 'crit' : cpu > 60 ? 'warn' : 'ok'}" style="width:${cpu}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${cpu.toFixed(1)}%</span>
      </div>
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">RAM</span>
        <div class="sys-bar"><div class="sys-fill ${mem > 80 ? 'crit' : mem > 60 ? 'warn' : 'ok'}" style="width:${mem}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${mem.toFixed(1)}%</span>
      </div>
      <div class="sys-meter">
        <span style="min-width:40px;color:var(--fg-muted)">Disk</span>
        <div class="sys-bar"><div class="sys-fill ${disk > 90 ? 'crit' : disk > 70 ? 'warn' : 'ok'}" style="width:${disk}%"></div></div>
        <span style="min-width:36px;text-align:right;font-weight:600">${disk.toFixed(1)}%</span>
      </div>
      <div style="font-size:11px;color:var(--fg-muted);margin-top:4px">Cache: ${escHtml(d.cache_size || '—')} · Artifacts: ${escHtml(d.artifacts_size || '—')}</div>
    `);
      }).catch(() => html('sys-status', `<div class="text-sm text-muted">${t('console.sys_unavailable')}</div>`));
      if (includeLogs) {
        if (forceLogRefresh || !_logBuffer.length) refreshLog();
        startLogRealtime(forceStream);
      }
    }

    function ctrlAction(action, target) {
      const cfg = target === 'backtest' ? (document.getElementById('backtest-cfg') || {}).value : '';
      set('ctrl-result', '⏳ Sending...');
      fetch('/api/control', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, target, config: cfg || '' })
      })
        .then(r => r.json()).then(d => {
          const ok = (d && d.ok) !== false;
          const extra = d && d.pid ? ` (PID ${d.pid})` : '';
          const aMap = { start: t('console.action_start'), stop: t('console.action_stop'), restart: t('console.action_restart') };
          const tMap = { brain: t('console.target_brain'), research: t('console.target_research'), backtest: t('console.target_backtest') };
          const msg = ok ? `✅ ${(aMap[action] || action)} ${(tMap[target] || target)}${extra}` : `❌ ${d && d.message ? d.message : 'Error'}`;
          set('ctrl-result', msg);
          toast(msg, 3);
          setTimeout(refreshConsole, 800);
        }).catch(e => { set('ctrl-result', `❌ ${t('console.request_failed')}`); });
    }

    // ─── Portfolio Optimizer ───────────────────────────────────────────────────
    function loadPortfolioOptimizer() {
      html('portfolio-summary', '<span class="text-muted text-sm">Computing…</span>');
      html('portfolio-frontier-table', '');

      jx('/api/portfolio_optimize').then(data => {
        if (!data || data.error) {
          html('portfolio-summary', `<span style="color:#ef4444">Error: ${esc(data&&data.error||'unknown')}</span>`);
          return;
        }

        const opt = data.optimal && data.optimal.max_sharpe;
        const maxMin = data.optimal && data.optimal.max_min_sharpe;

        if (opt) {
          const w = opt.weights || {};
          const wStr = Object.entries(w).map(([k,v]) => `${k.replace('crypto_','')}: <strong>${(v*100).toFixed(0)}%</strong>`).join(' + ');
          html('portfolio-summary', `
            <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:8px">
              <div style="padding:8px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--green)">
                <div style="font-size:11px;color:var(--fg-muted);text-transform:uppercase;margin-bottom:2px">Optimal (Max Sharpe)</div>
                <div style="font-size:13px">${wStr}</div>
                <div style="font-size:18px;font-weight:700;color:var(--green)">${n2(opt.avg_sharpe,3)} avg</div>
                <div style="font-size:12px;color:var(--fg-muted)">min ${n2(opt.min_sharpe,3)} · vol ${n2(opt.vol_pct,1)}% · ret ${n2(opt.return_pct,1)}%</div>
                <div style="font-size:11px;color:#86efac">diversification benefit: +${n2(opt.div_benefit,3)}</div>
              </div>
              <div style="padding:8px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
                <div style="font-size:11px;color:var(--fg-muted);text-transform:uppercase;margin-bottom:2px">Max Min Sharpe (Safest)</div>
                ${maxMin ? Object.entries(maxMin.weights||{}).map(([k,v]) => `${k.replace('crypto_','')}: <strong>${(v*100).toFixed(0)}%</strong>`).join(' + ') : '—'}
                <div style="font-size:18px;font-weight:700;color:var(--yellow)">${maxMin ? n2(maxMin.min_sharpe,3) : '—'} min</div>
                <div style="font-size:12px;color:var(--fg-muted)">avg ${maxMin ? n2(maxMin.avg_sharpe,3) : '—'}</div>
              </div>
            </div>
          `);
        }

        // Efficient frontier table
        const frontier = data.frontier || [];
        if (frontier.length) {
          const hdr = `<tr style="font-size:11px;color:var(--fg-muted);text-transform:uppercase">
            <th style="text-align:left;padding:4px 8px">Correlation</th>
            <th style="text-align:left">Optimal weights</th>
            <th style="text-align:center">Avg Sharpe</th>
            <th style="text-align:center">Min Sharpe</th>
            <th style="text-align:center">Vol%</th>
            <th style="text-align:center">Div.Benefit</th>
          </tr>`;
          const rows = frontier.map(f => {
            const wStr = Object.entries(f.weights||{}).map(([k,v]) => `${k.replace('crypto_','')}:${(v*100).toFixed(0)}%`).join(' + ');
            const isBase = Math.abs(f.correlation - 0.25) < 0.01;
            const bg = isBase ? 'background:var(--bg)' : '';
            return `<tr style="border-top:1px solid var(--border);${bg}">
              <td style="padding:5px 8px;font-weight:${isBase?700:400}">${f.correlation.toFixed(2)}</td>
              <td style="font-size:12px">${esc(wStr)}</td>
              <td style="text-align:center;font-weight:600;color:var(--green)">${n2(f.avg_sharpe,3)}</td>
              <td style="text-align:center;color:var(--fg-muted)">${n2(f.min_sharpe,3)}</td>
              <td style="text-align:center;color:var(--fg-muted)">${n2(f.vol_pct,1)}%</td>
              <td style="text-align:center;color:#86efac">+${n2(f.div_benefit,3)}</td>
            </tr>`;
          }).join('');
          html('portfolio-frontier-table', `
            <div style="font-size:11px;color:var(--fg-muted);margin-bottom:6px">Efficient Frontier — optimal allocation at each correlation assumption (highlighted: our estimate ρ=0.25)</div>
            <table style="width:100%;border-collapse:collapse;font-size:13px"><thead>${hdr}</thead><tbody>${rows}</tbody></table>
          `);
        }

        // Per-year grid chart (text-based sparkline)
        const grid = data.grid || [];
        if (grid.length && opt && opt.year_sharpe) {
          const yrs = Object.keys(opt.year_sharpe).sort();
          const yrCells = yrs.map(y => `<th style="text-align:center;width:60px;font-size:11px;color:var(--fg-muted)">${y}</th>`).join('');
          const rows = grid.filter(r => {
            const p = r.weights.crypto_perps || 0;
            return [0, 0.25, 0.35, 0.50, 0.60, 0.75, 1.0].some(w => Math.abs(p - w) < 0.01);
          }).map(r => {
            const perps_pct = Math.round((r.weights.crypto_perps||0)*100);
            const opts_pct = 100 - perps_pct;
            const yrCells2 = yrs.map(y => {
              const sh = r.year_sharpe[+y];
              const col = sh >= 1.8 ? '#22c55e' : sh >= 1.2 ? '#86efac' : sh >= 0.8 ? 'var(--yellow)' : '#f97316';
              return `<td style="text-align:center;color:${col};font-weight:600">${sh != null ? sh.toFixed(2) : '—'}</td>`;
            }).join('');
            const isOpt = perps_pct === 35;
            return `<tr style="border-top:1px solid var(--border);${isOpt?'background:var(--bg)':''}">
              <td style="padding:5px 8px;font-weight:${isOpt?700:400}">${perps_pct}% perps / ${opts_pct}% options${isOpt?' ★':''}</td>
              ${yrCells2}
              <td style="text-align:center;font-weight:700;color:var(--green)">${n2(r.avg_sharpe,3)}</td>
              <td style="text-align:center;color:var(--fg-muted)">${n2(r.min_sharpe,3)}</td>
            </tr>`;
          }).join('');
          html('portfolio-grid-chart', `
            <div style="font-size:11px;color:var(--fg-muted);margin-bottom:6px;margin-top:10px">Per-year Sharpe at different allocations (★ = optimal, ρ=0.25)</div>
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead><tr style="font-size:11px;color:var(--fg-muted)">
                <th style="text-align:left;padding:4px 8px">Allocation</th>${yrCells}
                <th style="text-align:center">AVG</th><th style="text-align:center">MIN</th>
              </tr></thead>
              <tbody>${rows}</tbody>
            </table>
          `);
        }

      }).catch(e => {
        html('portfolio-summary', `<span style="color:#ef4444">Load failed: ${esc(String(e))}</span>`);
      });
    }

    // ─── Track Record ─────────────────────────────────────────────────────────
    function loadTrackRecord() {
      const YEARS = [2021, 2022, 2023, 2024, 2025, 2026];

      function sharpeColor(v) {
        if (v === null || v === undefined) return 'var(--fg-muted)';
        if (v >= 1.5) return '#22c55e';
        if (v >= 0.8) return '#86efac';
        if (v >= 0.3) return 'var(--yellow)';
        if (v >= 0.0) return '#f97316';
        return '#ef4444';
      }
      function sharpeCell(v) {
        if (v === null || v === undefined) return `<td style="text-align:center;color:var(--fg-muted);opacity:.4">—</td>`;
        const col = sharpeColor(v);
        return `<td style="text-align:center;font-weight:600;color:${col}">${v.toFixed(2)}</td>`;
      }
      function statusBadge(s) {
        const map = {production:'#22c55e', validated:'#86efac', development:'#f59e0b', planned:'#6b7280'};
        return `<span style="display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;background:${map[s]||'#6b7280'};color:#fff">${s}</span>`;
      }

      jx('/api/track_record').then(data => {
        if (!data || data.error) {
          html('tr-badges', `<span style="color:#ef4444">Error: ${escHtml(data&&data.error||'unknown')}</span>`);
          return;
        }

        // ── Badges ──
        const badges = (data.projects || []).filter(p => p.avg_sharpe).map(p => {
          const col = p.meets_target ? '#22c55e' : '#f59e0b';
          return `<div style="padding:6px 12px;border-radius:8px;background:var(--bg);border:1px solid ${col};font-size:12px">
            <span style="font-weight:700;color:${col}">${escHtml(p.name)}</span>
            <span style="margin:0 4px;color:var(--fg-muted)">AVG</span>
            <span style="font-weight:700;color:var(--green)">${p.avg_sharpe.toFixed(3)}</span>
            <span style="margin:0 4px;color:var(--fg-muted)">MIN</span>
            <span style="font-weight:700;color:${p.min_sharpe>=p.target_sharpe?'var(--green)':'var(--yellow)'}">${p.min_sharpe ? p.min_sharpe.toFixed(3) : '—'}</span>
            <span style="margin-left:6px">${statusBadge(p.status)}</span>
          </div>`;
        }).join('');
        html('tr-badges', badges || '<span class="text-muted">No projects with data yet</span>');

        // ── Projects table ──
        const hdr = `<tr style="font-size:11px;color:var(--fg-muted);text-transform:uppercase"><th style="text-align:left;padding:4px 8px">Project</th>${YEARS.map(y=>`<th style="text-align:center;width:60px">${y}</th>`).join('')}<th style="text-align:center">AVG</th><th style="text-align:center">MIN</th><th style="text-align:center">Status</th></tr>`;
        const rows = (data.projects || []).map(p => {
          const yrs = YEARS.map(y => sharpeCell(p.year_sharpe && p.year_sharpe[y])).join('');
          const avg = p.avg_sharpe ? `<td style="text-align:center;font-weight:700;color:var(--green)">${p.avg_sharpe.toFixed(3)}</td>` : '<td style="text-align:center;color:var(--fg-muted)">—</td>';
          const min = p.min_sharpe ? `<td style="text-align:center;font-weight:700;color:${p.min_sharpe>=p.target_sharpe?'var(--green)':'var(--yellow)'}">${p.min_sharpe.toFixed(3)}</td>` : '<td style="text-align:center;color:var(--fg-muted)">—</td>';
          return `<tr style="border-top:1px solid var(--border)">
            <td style="padding:6px 8px">
              <div style="font-weight:600">${escHtml(p.name)}</div>
              <div style="font-size:10px;color:var(--fg-muted)">${escHtml(p.market)} · target ≥${p.target_sharpe}</div>
            </td>
            ${yrs}${avg}${min}
            <td style="text-align:center">${statusBadge(p.status)}</td>
          </tr>`;
        }).join('');
        html('tr-projects-table', `<table style="width:100%;border-collapse:collapse;font-size:13px"><thead>${hdr}</thead><tbody>${rows}</tbody></table>`);

        // ── Benchmarks table ──
        const bhdr = `<tr style="font-size:11px;color:var(--fg-muted);text-transform:uppercase"><th style="text-align:left;padding:4px 8px">Benchmark</th>${YEARS.map(y=>`<th style="text-align:center;width:60px">${y}</th>`).join('')}</tr>`;
        const brows = (data.benchmarks || []).map(b => {
          const yrs = YEARS.map(y => sharpeCell(b.year_sharpe && b.year_sharpe[y])).join('');
          return `<tr style="border-top:1px solid var(--border)"><td style="padding:6px 8px;font-weight:600">${escHtml(b.name)}</td>${yrs}</tr>`;
        }).join('');
        html('tr-benchmarks-table', `<table style="width:100%;border-collapse:collapse;font-size:13px"><thead>${bhdr}</thead><tbody>${brows}</tbody></table>
          <div style="font-size:11px;color:var(--fg-muted);margin-top:6px;padding:0 8px">
            Sharpe = (Annual Return − Risk-Free Rate) / Annual Volatility. NEXUS = OOS backtest. Benchmarks = estimated.
          </div>`);

      }).catch(e => {
        html('tr-badges', `<span style="color:#ef4444">Load failed: ${escHtml(String(e))}</span>`);
      });
    }

    // ─── Clock ───
    setInterval(() => set('hdr-clock', new Date().toLocaleTimeString()), 1000);

    // ─── Init ───
    initLanguage();
    initTheme();
    initKeyboardShortcuts();
    setDashboardMode('showcase');
    _connectSSE();
    renderYearBars();
    attachSectionStamps();
    initCardExpansion();
    updateMvpSummary();
    _runTabLoader('overview', LOADERS.overview, 'boot', true);
    _initRealtimeManager();
    _updateTabIndicators();
    _updateAutoSyncBadge();
    _updateGlobalLoader();
    // Stale check — mark disconnected if no event in 30s
    setInterval(() => {
      if (APP_STATE.liveConnected && Date.now() - APP_STATE.liveSeenAt > 30000) {
        setLiveStatus('stale', t('status.stale'));
      }
    }, 10000);
  </script>
</body>

</html>